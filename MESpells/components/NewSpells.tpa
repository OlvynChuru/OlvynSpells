/*
ACTION_IF MOD_IS_INSTALLED ~Faiths_and_Powers.tp2~ ~21~ OR MOD_IS_INSTALLED ~Faiths_and_Powers.tp2~ ~22~ BEGIN
	OUTER_SET ignore_add_class_spell = 1
END
*/
COPY ~MESpells/New_Spells~ ~override~
	PATCH_IF (~%SOURCE_EXT%~ STRING_EQUAL_CASE ~bcs~) BEGIN
		DECOMPILE_AND_PATCH BEGIN
		END
	END

OUTER_SET innate_hla = 0

COPY_EXISTING ~spwi920.spl~ ~override~
	READ_SHORT spelltype thespelltype
	PATCH_IF thespelltype = 4 BEGIN
		innate_hla = 1
	END
	IF_EXISTS
	BUT_ONLY_IF_IT_CHANGES

COPY ~MESpells/lua/M_MEALTC.lua~ ~override~

ACTION_IF GAME_IS ~bgee eet~ BEGIN
	COPY_EXISTING ~%arbg%0900.are~ ~override~ ~%arbg%2600.are~ ~override~ ~%arbg%2626.are~ ~override~ ~bd2000.are~ ~override~ ~bd4000.are~ ~override~ ~bd4300.are~ ~override~
		READ_SHORT 0x48 theareatype
		theareatype|=0x800
		WRITE_SHORT 0x48 theareatype
		IF_EXISTS
		BUT_ONLY_IF_IT_CHANGES
END

ACTION_IF GAME_IS ~bg2ee eet~ BEGIN
	COPY_EXISTING ~ar1515.are~ ~override~
		LPF DELETE_AREA_ITEM STR_VAR item_to_delete=~misc9j~ END
		LPF ALTER_AREA_CONTAINER STR_VAR container_name=~Desk 1~ container_script=~ME1515IJ~ END
		IF_EXISTS
		BUT_ONLY_IF_IT_CHANGES

	COPY_EXISTING ~ar5500.are~ ~override~
		LPF DELETE_AREA_ITEM STR_VAR item_to_delete=~misc9j~ END
		LPF ALTER_AREA_DOOR INT_VAR flag_open=0 flag_locked=1 lock_difficulty=100 STR_VAR door_name=~Door02~ door_script=~MEBALTHD~ END
		IF_EXISTS
		BUT_ONLY_IF_IT_CHANGES
END

ACTION_IF GAME_IS ~iwdee~ BEGIN

	COPY_EXISTING ~ar9200.are~ ~override~ ~ar9711.are~ ~override~
		READ_SHORT 0x48 theareatype
		theareatype|=0x800
		WRITE_SHORT 0x48 theareatype
		IF_EXISTS
		BUT_ONLY_IF_IT_CHANGES

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) AND !(FILE_EXISTS_IN_GAME ~M_MECEIL.lua~) BEGIN
	ACTION_IF GAME_IS ~bgee~ BEGIN
		COPY ~MESpells/no_overwrite/M_MECBG1.lua~ ~override/M_MECEIL.lua~
	END ELSE ACTION_IF GAME_IS ~bg2ee~ BEGIN
		COPY ~MESpells/no_overwrite/M_MECBG2.lua~ ~override/M_MECEIL.lua~
	END ELSE ACTION_IF GAME_IS ~iwdee~ BEGIN
		COPY ~MESpells/no_overwrite/M_MECIWD.lua~ ~override/M_MECEIL.lua~
	END ELSE ACTION_IF GAME_IS ~eet~ BEGIN
		COPY ~MESpells/no_overwrite/M_MECEET.lua~ ~override/M_MECEIL.lua~
	END

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) AND !(FILE_EXISTS_IN_GAME ~M_MESTR1.lua~) BEGIN
	COPY ~MESpells/lua/M_MESTR1.lua~ ~override~
END

ACTION_IF !(FILE_EXISTS_IN_GAME ~M_MEEXHL.lua~) BEGIN
	COPY ~MESpells/no_overwrite/M_MEEXHL.lua~ ~override~

COPY_EXISTING ~ui.menu~ ~override~
	REPLACE_TEXTUALLY CASE_INSENSITIVE ~CHARGEN_HIGH_LEVEL_ABILITIES\([^`]*\)currentHLASelection = nil~ ~~~~~CHARGEN_HIGH_LEVEL_ABILITIES\1
		local me_multiclassSubclass = {
{1, 0, 0},
{2, 0, 0},
{3, 0, 0},
{4, 0, 0},
{5, 0, 0},
{6, 0, 0},
{2, 1, 0},
{2, 3, 0},
{2, 4, 0},
{2, 1, 4},
{11, 0, 0},
{12, 0, 0},
{1, 4, 0},
{3, 1, 0},
{3, 4, 0},
{2, 11, 0},
{2, 1, 3},
{3, 12, 0},
{19, 0, 0},
{20, 0, 0},
{21, 0, 0},
}
		me_HLA_restricted_list = {}
		local me_realClass = -1
		local me_realKit = -1
		%get_class_from_record%
		local me_class = me_multiclassSubclass[me_realClass]
		if me_realClass <= 21 then
			local me_classLevels = {tonumber(string.match(characters[currentID].classlevel.first.details, '%d+')), 0, 0, tonumber(string.match(characters[currentID].classlevel.first.details, '%d+'))}
			if me_class[2] > 0 then
				me_classLevels[2] = tonumber(string.match(characters[currentID].classlevel.second.details, '%d+'))
				if me_classLevels[2] < me_classLevels[4] then
					me_classLevels[4] = me_classLevels[2]
				end
			end
			if me_class[3] > 0 then
				me_classLevels[3] = tonumber(string.match(characters[currentID].classlevel.third.details, '%d+'))
				if me_classLevels[3] < me_classLevels[4] then
					me_classLevels[4] = me_classLevels[3]
				end
			end
			for k, ability in ipairs(me_restrictHLA) do
				local me_clevel = ability['class_level']
				local me_isRestricted = false
				if me_clevel[me_class[1]] ~= nil or (me_class[2] ~= 0 and me_clevel[me_class[2]] ~= nil) or (me_class[3] ~= 0 and me_clevel[me_class[3]] ~= nil) or me_clevel[0] ~= nil then
					me_isRestricted = true
					if me_clevel[me_class[1]] ~= nil and me_classLevels[1] >= me_clevel[me_class[1]] then
						me_isRestricted = false
					elseif me_class[2] ~= 0 and me_clevel[me_class[2]] ~= nil and me_classLevels[2] >= me_clevel[me_class[2]] then
						me_isRestricted = false
					elseif me_class[3] ~= 0 and me_clevel[me_class[3]] ~= nil and me_classLevels[3] >= me_clevel[me_class[3]] then
						me_isRestricted = false
					elseif me_clevel[0] ~= nil and me_classLevels[4] >= me_clevel[0] then
						me_isRestricted = false
					end
				end
				if ability['kit_level'][me_realKit] ~= nil and me_classLevels[4] < ability['kit_level'][me_realKit] then
					me_isRestricted = true
				else
					for attribute_name, attribute_requirement in pairs(ability['attributes']) do
						if characters[currentID].attr[attribute_name]['base'] < attribute_requirement then
							me_isRestricted = true
						end
					end
				end
				if me_isRestricted then
					me_HLA_restricted_list[ability.resref] = true
				end
			end
			for k, ability in ipairs(chargen.HLAs) do
				if me_HLA_restricted_list[ability.resref] ~= nil then
					ability.canAdd = false
				end
			end
		end
		currentHLASelection = nil~~~~~
	REPLACE_TEXTUALLY CASE_INSENSITIVE ~createCharScreen:OnHLAButtonClick(currentHLASelection, 1)~ ~~~~~createCharScreen:OnHLAButtonClick(currentHLASelection, 1)
			for k, ability in ipairs(chargen.HLAs) do
				if me_HLA_restricted_list[ability.resref] ~= nil then
					ability.canAdd = false
				end
			end~~~~~
	REPLACE_TEXTUALLY CASE_INSENSITIVE EXACT_MATCH ~createCharScreen:OnHLAButtonClick(currentHLASelection, -1)~ ~~~~~createCharScreen:OnHLAButtonClick(currentHLASelection, -1)
			for k, ability in ipairs(chargen.HLAs) do
				if me_HLA_restricted_list[ability.resref] ~= nil then
					ability.canAdd = false
				end
			end~~~~~
END

COPY_EXISTING ~ui.menu~ ~override~
	REPLACE_TEXTUALLY CASE_SENSITIVE ~\"mageBookEnabled == false\"~ ~"mageBookEnabled == false and bookMode == 0"~
	REPLACE_TEXTUALLY CASE_SENSITIVE EXACT_MATCH ~contingencyDescription = mageBookStrings[contingencyResRef].tip~ ~~~~~ -- Fixing contingency crash
if bookMode == 1 and me_alt_contingency[contingencyResRef] ~= nil then
	if me_alt_contingency[contingencyResRef]['conditions'] ~= nil then
		contingencyConditions = me_alt_contingency[contingencyResRef]['conditions']
	end
	if me_alt_contingency[contingencyResRef]['targets'] ~= nil then
		contingencyTargets = me_alt_contingency[contingencyResRef]['targets']
	end
end
if mageBookStrings[contingencyResRef] == nil then
	contingencyDescription = 0
else
	contingencyDescription = mageBookStrings[contingencyResRef].tip
end~~~~~

	REPLACE_TEXTUALLY CASE_SENSITIVE EXACT_MATCH ~return Infinity_FetchString(bookSpells[currentBookSpell].description)~ ~~~~~if bookSpells[currentBookSpell] ~= nil then
					return Infinity_FetchString(bookSpells[currentBookSpell].description)
				else
					return ''
				end~~~~~
	REPLACE_TEXTUALLY CASE_SENSITIVE EXACT_MATCH ~if characters[id].mageSpells[currentSpellLevel][currentBookSpell]~ ~if characters[id].mageSpells[currentSpellLevel]~
	REPLACE_TEXTUALLY CASE_SENSITIVE EXACT_MATCH ~return Infinity_FetchString(characters[id].mageSpells[currentSpellLevel][currentBookSpell].description)~ ~~~~~if characters[id].mageSpells[currentSpellLevel][currentBookSpell] ~= nil then
					return Infinity_FetchString(characters[id].mageSpells[currentSpellLevel][currentBookSpell].description)
				else
					return t('SPELL_MEMORIZATION_HELP')
				end~~~~~
	UNLESS ~Fixing contingency crash~

COPY_EXISTING ~enginest.2da~ ~override~
	REPLACE_TEXTUALLY ~STRREF_ERROR_CAN_NOT_CAST_TWO_CONT.*[0-9]*~ ~STRREF_ERROR_CAN_NOT_CAST_TWO_CONT                       0~

ADD_PROJECTILE ~override/mewofire.pro~ //Wall of Fire
ADD_PROJECTILE ~override/memissto.pro~ //Missile Storm random creature select
ADD_PROJECTILE ~override/meranmis.pro~ //Magic Missile random path
ADD_PROJECTILE ~override/meinvglb.pro~ //Sphere of Invisibility
ADD_PROJECTILE ~override/mepatien.pro~ //Missile of Patience very slow projectile
ADD_PROJECTILE ~override/meportl.pro~ //Linked portal
ADD_PROJECTILE ~override/meintrv3.pro~ //Invisible traveling 3
ADD_PROJECTILE ~override/megrvglb.pro~ //Reversed Gravity Sphere
ADD_PROJECTILE ~override/meverdig.pro~ //Entangle 60-foot radius
ADD_PROJECTILE ~override/mepolera.pro~ //Agannazar's Scorcher cold
ADD_PROJECTILE ~override/memindfo.pro~ //Mind Fog
ADD_PROJECTILE ~override/melivlig.pro~ //Living Lightning
ADD_PROJECTILE ~override/mewavefr.pro~ //Freezing Wave
ADD_PROJECTILE ~override/merepuls.pro~ //Repulse
ADD_PROJECTILE ~override/mesacrif.pro~ //Sacrificial Explosion
ADD_PROJECTILE ~override/meconegr.pro~ //Cone of acid
ADD_PROJECTILE ~override/mewofir2.pro~ //Holy Wall of Fire
ADD_PROJECTILE ~override/memetafb.pro~ //Metafireball that explodes into other fireballs
ADD_PROJECTILE ~override/mehole.pro~ //Create Pit
ADD_PROJECTILE ~override/meconr01.pro~ //Cone shot: Arrow
ADD_PROJECTILE ~override/meconr02.pro~ //Cone shot: Bolt
ADD_PROJECTILE ~override/meconr03.pro~ //Cone shot: Bullet
ADD_PROJECTILE ~override/meconr04.pro~ //Cone shot: Dart
ADD_PROJECTILE ~override/meconr05.pro~ //Cone shot: Dagger
ADD_PROJECTILE ~override/meconr06.pro~ //Cone shot: Axe
ADD_PROJECTILE ~override/meconr11.pro~ //Cone shot: Flame Arrow
ADD_PROJECTILE ~override/meconr12.pro~ //Cone shot: Acid Arrow
ADD_PROJECTILE ~override/meconr13.pro~ //Cone shot: Ice Arrow
ADD_PROJECTILE ~override/meconr14.pro~ //Cone shot: Electricity Arrow
ADD_PROJECTILE ~override/meconr31.pro~ //Cone shot: Boulder
ADD_PROJECTILE ~override/melinr01.pro~ //Line shot: Arrow
ADD_PROJECTILE ~override/melinr02.pro~ //Line shot: Bolt
ADD_PROJECTILE ~override/melinr03.pro~ //Line shot: Bullet
ADD_PROJECTILE ~override/melinr04.pro~ //Line shot: Dart
ADD_PROJECTILE ~override/melinr05.pro~ //Line shot: Dagger
ADD_PROJECTILE ~override/melinr06.pro~ //Line shot: Axe
ADD_PROJECTILE ~override/melinr11.pro~ //Line shot: Flame Arrow
ADD_PROJECTILE ~override/melinr12.pro~ //Line shot: Acid Arrow
ADD_PROJECTILE ~override/melinr13.pro~ //Line shot: Ice Arrow
ADD_PROJECTILE ~override/melinr14.pro~ //Line shot: Electricity Arrow
ADD_PROJECTILE ~override/melinr31.pro~ //Line shot: Boulder
ADD_PROJECTILE ~override/meelyst.pro~ //Elysium's Tears
ADD_PROJECTILE ~override/mestwnst.pro~ //Steel Wind Strike
ADD_PROJECTILE ~override/meintrv4.pro~ //Invisible traveling 4
ADD_PROJECTILE ~override/meboulde.pro~ //Boulder
ADD_PROJECTILE ~override/mesannih.pro~ //Sphere of Annihilation
ADD_PROJECTILE ~override/metornad.pro~ //Tornado
ADD_PROJECTILE ~override/meinar15.pro~ //Instant area 15-foot radius
ADD_PROJECTILE ~override/meinap10.pro~ //Instant area 10-foot radius party only

ACTION_IF NOT GAME_IS ~iwdee~ BEGIN
	COPY_EXISTING ~lightb.pro~ ~override/meslight.pro~
END ELSE BEGIN
	COPY_EXISTING ~idpro40.pro~ ~override/meslight.pro~
END

ADD_PROJECTILE ~override/meslight.pro~ //Special lightning bolt used with Greater Living Lightning

LAF ADD_SPLPROT_CONDITION STR_VAR splprot_stat=~0x106~ splprot_value=~1~ splprot_relation=~9~ RET splprot_areaisnotoutdoor=splprot_slot END

LAF ADD_SPLPROT_CONDITION STR_VAR splprot_stat=~18~ splprot_value=~-1~ splprot_relation=~4~ RET splprot_magicresistancegreaterthanorequalto=splprot_slot END

LAF ADD_SPLPROT_CONDITION STR_VAR splprot_stat=~0x106~ splprot_value=~16~ splprot_relation=~9~ RET splprot_areaisnotforest=splprot_slot END

LAF ADD_SPLPROT_CONDITION STR_VAR splprot_stat=~0x106~ splprot_value=~2048~ splprot_relation=~8~ RET splprot_areaisanoteleportzone=splprot_slot END

LAF ADD_SPLPROT_CONDITION STR_VAR splprot_stat=~0x111~ splprot_value=~0x00000001~ splprot_relation=~9~ RET splprot_isnotsleeping=splprot_slot END

LAF ADD_SPLPROT_CONDITION STR_VAR splprot_stat=~640~ splprot_value=~-1~ splprot_relation=~1~ RET splprot_meflyingspeedequalto=splprot_slot END

LAF ADD_SPLPROT_CONDITION STR_VAR splprot_stat=~640~ splprot_value=~-1~ splprot_relation=~5~ RET splprot_meflyingspeednotequalto=splprot_slot END

LAF ADD_SPLPROT_CONDITION STR_VAR splprot_stat=~56~ splprot_value=~-1~ splprot_relation=~2~ RET splprot_backstabmultiplierlessthan=splprot_slot END

LAF ADD_SPLPROT_CONDITION STR_VAR splprot_stat=~56~ splprot_value=~-1~ splprot_relation=~4~ RET splprot_backstabmultipliergreaterthanorequalto=splprot_slot END

LAF ADD_SPLPROT_CONDITION STR_VAR splprot_stat=~0x10b~ splprot_value=~5~ splprot_relation=~1~ RET splprot_gianthumanoid=splprot_slot END

LAF ADD_SPLPROT_CONDITION STR_VAR splprot_stat=~0x104~ splprot_value=~5~ splprot_relation= EVAL ~%splprot_gianthumanoid%~ RET splprot_nothumanoidorgianthumanoid=splprot_slot END

LAF ADD_SPLPROT_CONDITION STR_VAR splprot_stat=~637~ splprot_value=~0~ splprot_relation=~3~ RET splprot_meinflight=splprot_slot END

LAF ADD_SPLPROT_CONDITION STR_VAR splprot_stat=~0~ splprot_value=~-1~ splprot_relation=~4~ RET splprot_currenthpgreaterthanorequalto=splprot_slot END

LAF ADD_SPLPROT_CONDITION STR_VAR splprot_stat=~0x106~ splprot_value=~-1~ splprot_relation=~8~ RET splprot_areais=splprot_slot END

LAF ADD_SPLPROT_CONDITION STR_VAR splprot_stat=~0x106~ splprot_value=~-1~ splprot_relation=~9~ RET splprot_areaisnot=splprot_slot END

LAF ADD_SPLPROT_CONDITION STR_VAR splprot_stat=~665~ splprot_value=~0~ splprot_relation=~3~ RET splprot_canhavemultiplesimulacra=splprot_slot END

LAF ADD_SPLPROT_CONDITION STR_VAR splprot_stat=~647~ splprot_value=~-1~ splprot_relation=~5~ RET splprot_minheightnotequalto=splprot_slot END

LAF ADD_SPLPROT_CONDITION STR_VAR splprot_stat=~647~ splprot_value=~-1~ splprot_relation=~4~ RET splprot_minheightgreaterthanorequalto=splprot_slot END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@31154) STR_VAR icon=~MEPR154D~ RET icon_index_mepr154=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@31156) STR_VAR icon=~MEPR156D~ RET icon_index_mepr156=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@31157) STR_VAR icon=~MEPR157D~ RET icon_index_mepr157=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@31354) STR_VAR icon=~MEPR354D~ RET icon_index_mepr354=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@31355) STR_VAR icon=~MEPR355D~ RET icon_index_mepr355=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@31356) STR_VAR icon=~MEPR356D~ RET icon_index_mepr356=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@31455) STR_VAR icon=~MEPR455D~ RET icon_index_mepr455=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@31456) STR_VAR icon=~MEPR456D~ RET icon_index_mepr456=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@31556) STR_VAR icon=~MEPR556D~ RET icon_index_mepr556=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@31558) STR_VAR icon=~MEPR558D~ RET icon_index_mepr558=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@31654) STR_VAR icon=~MEPR654D~ RET icon_index_mepr654=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@30099) STR_VAR icon=~MEPR656D~ RET icon_index_mepr656=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@31661) STR_VAR icon=~MEPR661D~ RET icon_index_mepr661=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@33157) STR_VAR icon=~MEWI157D~ RET icon_index_mewi157=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@33158) STR_VAR icon=~MEWI158D~ RET icon_index_mewi158=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@30067) STR_VAR icon=~MEWI255D~ RET icon_index_mewi255=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@30054) STR_VAR icon=~MEWI257D~ RET icon_index_mewi257=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@33259) STR_VAR icon=~MEWI259D~ RET icon_index_mewi259=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@30055) STR_VAR icon=~MEWI352D~ RET icon_index_mewi352=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@33353) STR_VAR icon=~MEWI353D~ RET icon_index_mewi353=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@33360) STR_VAR icon=~MEWI360D~ RET icon_index_mewi360=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@33453) STR_VAR icon=~MEWI453D~ RET icon_index_mewi453=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@30056) STR_VAR icon=~MEWI559D~ RET icon_index_mewi559=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@33562) STR_VAR icon=~MEWI562D~ RET icon_index_mewi562=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@30065) STR_VAR icon=~MEWI654D~ RET icon_index_mewi654=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@30059) STR_VAR icon=~MEWI851E~ RET icon_index_mewi851e=icon_index END
LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@30060) STR_VAR icon=~MEWI851F~ RET icon_index_mewi851f=icon_index END
LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@30061) STR_VAR icon=~MEWI851G~ RET icon_index_mewi851g=icon_index END
LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@30062) STR_VAR icon=~MEWI851H~ RET icon_index_mewi851h=icon_index END
LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@30063) STR_VAR icon=~MEWI851I~ RET icon_index_mewi851i=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@33855) STR_VAR icon=~MEWI855D~ RET icon_index_mewi855=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@30057) STR_VAR icon=~MEWI857D~ RET icon_index_mewi857=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@30064) STR_VAR icon=~MEWI953D~ RET icon_index_mewi953=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@33957) STR_VAR icon=~MEWI957D~ RET icon_index_mewi957=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@33959) STR_VAR icon=~MEWI959D~ RET icon_index_mewi959=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@33961) STR_VAR icon=~MEWI961D~ RET icon_index_mewi961=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@33962) STR_VAR icon=~MEWI962D~ RET icon_index_mewi962=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@33963) STR_VAR icon=~MEWI963D~ RET icon_index_mewi963=icon_index END

LAF ADD_ICON INT_VAR strref=RESOLVE_STR_REF(@33966) STR_VAR icon=~MEWI966D~ RET icon_index_mewi966=icon_index END

ACTION_IF !(FILE_EXISTS_IN_GAME ~7eyes.2da~) BEGIN
	COPY_EXISTING ~MESpells/no_overwrite/me7eyes.2da~ ~override/7eyes.2da~
		REPLACE 99999 @30066
END ELSE BEGIN
	COPY_EXISTING ~7eyes.2da~ ~override~
		COUNT_2DA_COLS numcolumns
		COUNT_2DA_ROWS numcolumns numrows
		INSERT_2DA_ROW numrows numcolumns ~MENULLHEAL   214        99999      17*0x0      17*0x1      17*0x2      98           *            *          *          *          *~
		REPLACE 99999 @30066
		UNLESS ~MENULLHEAL~
END

LAF ADD_ANIMATION INT_VAR minSlot=0x7000 STR_VAR directory=~MESpells/animations~ ini=~meanibe0~ RET slotbearblacklargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0x7000 STR_VAR directory=~MESpells/animations~ ini=~meanibe1~ RET slotbearbrownlargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0x7000 STR_VAR directory=~MESpells/animations~ ini=~meanibe2~ RET slotbearcavelargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0x7000 STR_VAR directory=~MESpells/animations~ ini=~meanibe3~ RET slotbearpolarlargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0x7000 STR_VAR directory=~MESpells/animations~ ini=~meanido0~ RET slotdogwildlargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0x7000 STR_VAR directory=~MESpells/animations~ ini=~meanido1~ RET slotdogwarlargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0x7000 STR_VAR directory=~MESpells/animations~ ini=~meanido2~ RET slotdogmoonlargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0x7000 STR_VAR directory=~MESpells/animations~ ini=~meanido3~ RET slotdoggraylargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0x7000 STR_VAR directory=~MESpells/animations~ ini=~meaniwl0~ RET slotwolflargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0x7000 STR_VAR directory=~MESpells/animations~ ini=~meaniwl1~ RET slotwolfworglargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0x7000 STR_VAR directory=~MESpells/animations~ ini=~meaniwl2~ RET slotwolfdirelargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0x7000 STR_VAR directory=~MESpells/animations~ ini=~meaniwl3~ RET slotwolfwinterlargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0x7000 STR_VAR directory=~MESpells/animations~ ini=~meaniwl4~ RET slotwolfvampiriclargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0x7000 STR_VAR directory=~MESpells/animations~ ini=~meaniwl5~ RET slotwolfdreadlargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0x7000 STR_VAR directory=~MESpells/animations~ ini=~meanisp0~ RET slotspidergiantlargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0x7000 STR_VAR directory=~MESpells/animations~ ini=~meanisp1~ RET slotspiderhugelargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0x7000 STR_VAR directory=~MESpells/animations~ ini=~meanisp2~ RET slotspiderphaselargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0x7000 STR_VAR directory=~MESpells/animations~ ini=~meanisp3~ RET slotspiderswordlargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0x7000 STR_VAR directory=~MESpells/animations~ ini=~meanisp4~ RET slotspiderwraithlargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0x7000 STR_VAR directory=~MESpells/animations~ ini=~meanisp5~ RET slotmyrlocharlargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0x7000 STR_VAR directory=~MESpells/animations~ ini=~meanisp6~ RET slotspiderwaterlargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0x7000 STR_VAR directory=~MESpells/animations~ ini=~meanirab~ RET slotrabbitlargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0x7000 STR_VAR directory=~MESpells/animations~ ini=~meanigro~ RET slotgroundhoglargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0x7000 STR_VAR directory=~MESpells/animations~ ini=~meaniphe~ RET slotpheasantlargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0x7000 STR_VAR directory=~MESpells/animations~ ini=~meanider~ RET slotdeerlargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0x7000 STR_VAR directory=~MESpells/animations~ ini=~meanimoo~ RET slotmooselargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0x7000 STR_VAR directory=~MESpells/animations~ ini=~meanigcl~ RET slotgreatcatleopardlargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0x7000 STR_VAR directory=~MESpells/animations~ ini=~meanigcp~ RET slotgreatcatpantherlargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0x7000 STR_VAR directory=~MESpells/animations~ ini=~meanisng~ RET slotsnakegiantdecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0x7000 STR_VAR directory=~MESpells/animations~ ini=~meanisn1~ RET slotsnakewaterlargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0xB000 STR_VAR directory=~MESpells/animations~ ini=~meanicow~ RET slotcowlargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0xB000 STR_VAR directory=~MESpells/animations~ ini=~meanihrs~ RET slothorselargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0xC000 STR_VAR directory=~MESpells/animations~ ini=~meanibat~ RET slotbatlargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0xC000 STR_VAR directory=~MESpells/animations~ ini=~meanicat~ RET slotcatlargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0xC000 STR_VAR directory=~MESpells/animations~ ini=~meanichk~ RET slotchickenlargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0xC000 STR_VAR directory=~MESpells/animations~ ini=~meanirat~ RET slotratlargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0xC000 STR_VAR directory=~MESpells/animations~ ini=~meanisqu~ RET slotsquirrellargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0xC000 STR_VAR directory=~MESpells/animations~ ini=~meanitci~ RET slotteleportcircledecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0xC000 STR_VAR directory=~MESpells/animations~ ini=~meanisan~ RET slotsphereofannihilationdecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0xD000 STR_VAR directory=~MESpells/animations~ ini=~meanibnu~ RET slotbirdnullcreaturedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0xD000 STR_VAR directory=~MESpells/animations~ ini=~meanieru~ RET sloteruptioncreaturedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0xE000 STR_VAR directory=~MESpells/animations~ ini=~meaniwor~ RET slotworglargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0xE000 STR_VAR directory=~MESpells/animations~ ini=~meanibo0~ RET slotboararcticlargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0xE000 STR_VAR directory=~MESpells/animations~ ini=~meanibo1~ RET slotboarwildlargedecimal=slotDecimal END

LAF ADD_ANIMATION INT_VAR minSlot=0xE000 STR_VAR directory=~MESpells/animations~ ini=~meanibbm~ RET slotbeetlebombardierlargedecimal=slotDecimal END

COPY_EXISTING_REGEXP ~.*\.are~ ~override~
	TEXT_SPRINT theareares ~%SOURCE_RES%~
	PATCH_IF NOT FILE_EXISTS_IN_GAME ~%theareares%SB.bmp~ BEGIN
		INNER_ACTION BEGIN
/*
			COPY_EXISTING ~%theareares%SR.bmp~ ~override~
				READ_LONG 0x2 thefilesize
				READ_LONG 0xA thedataoffset
				FOR (i = thedataoffset; i < thefilesize; ++i) BEGIN
					READ_BYTE i current
					currentA = current / 16
					currentB = current MODULO 16
					PATCH_IF currentA = 8 BEGIN
						currentA = 12
					END ELSE PATCH_IF currentA = 0 OR currentA = 10 OR currentA = 13 BEGIN
						currentA = 8
					END ELSE PATCH_IF currentA = 2 BEGIN
						currentA = 9
					END
					PATCH_IF currentB = 2 BEGIN
						currentB = 9
					END
					WRITE_BYTE i (currentA * 16 + currentB)
				END
				IF_EXISTS
*/
			COPY_EXISTING ~%theareares%SR.bmp~ ~override/%theareares%SB.bmp~
				IF_EXISTS
		END
	END
	BUT_ONLY_IF_IT_CHANGES
VERBOSE

COPY_EXISTING_REGEXP ~mefixwbu.cre~ ~override~ ~meportst.cre~ ~override~ ~meportl[0-9].cre~ ~override~ ~mesightm.cre~ ~override~
	WRITE_SHORT animation slotbirdnullcreaturedecimal

COPY_EXISTING ~meeruptc.cre~ ~override~
	WRITE_SHORT animation sloteruptioncreaturedecimal

COPY_EXISTING ~menofly.eff~ ~override~
	WRITE_LONG effparameter2 splprot_areaisnotoutdoor

COPY_EXISTING ~m_mestr1.lua~ ~override~
	ex_spell_ineffective_strref = RESOLVE_STR_REF(@30037)
	REPLACE_TEXTUALLY CASE_INSENSITIVE ~ex_spell_ineffective_strref[ %TAB%=].*~ ~ex_spell_ineffective_strref = %ex_spell_ineffective_strref%~
	ex_no_familiar_strref_1 = RESOLVE_STR_REF(@30041)
	REPLACE_TEXTUALLY CASE_INSENSITIVE ~ex_no_familiar_strref_1[ %TAB%=].*~ ~ex_no_familiar_strref_1 = %ex_no_familiar_strref_1%~
	ex_familiar_spell_strref_1 = RESOLVE_STR_REF(@30042)
	REPLACE_TEXTUALLY CASE_INSENSITIVE ~ex_familiar_spell_strref_1[ %TAB%=].*~ ~ex_familiar_spell_strref_1 = %ex_familiar_spell_strref_1%~
	me_teleport_circle_cut_off_strref = RESOLVE_STR_REF(@30134)
	REPLACE_TEXTUALLY CASE_INSENSITIVE ~me_teleport_circle_cut_off_strref[ %TAB%=].*~ ~me_teleport_circle_cut_off_strref = %me_teleport_circle_cut_off_strref%~
	SPRINT me_teleport_circle_feedback_string_1 @30137
	REPLACE_TEXTUALLY CASE_INSENSITIVE ~me_teleport_circle_feedback_string_1[ %TAB%=].*~ ~me_teleport_circle_feedback_string_1 = "%me_teleport_circle_feedback_string_1%"~
	ex_rewind_time_failure_strref = RESOLVE_STR_REF(@30178)
	REPLACE_TEXTUALLY CASE_INSENSITIVE ~ex_rewind_time_failure_strref[ %TAB%=].*~ ~ex_rewind_time_failure_strref = %ex_rewind_time_failure_strref%~
	IF_EXISTS

COPY_EXISTING ~m_mestr1.lua~ ~override~
	REPLACE_TEXTUALLY ~me_animal_growth_animations = {~ ~me_animal_growth_animations = {[0x7200] = %slotbearblacklargedecimal%, [0x7201] = %slotbearbrownlargedecimal%, [0x7202] = %slotbearcavelargedecimal%, [0x7203] = %slotbearpolarlargedecimal%, [0x7400] = %slotdogwildlargedecimal%, [0x7401] = %slotdogwarlargedecimal%, [0x7402] = %slotdogmoonlargedecimal%, [0x7602] = %slotmyrlocharlargedecimal%, [0x7603] = %slotdoggraylargedecimal%, [0x7604] = %slotspiderwaterlargedecimal%, [0x7A00] = %slotspidergiantlargedecimal%, [0x7A01] = %slotspiderhugelargedecimal%, [0x7A02] = %slotspiderphaselargedecimal%, [0x7A03] = %slotspiderswordlargedecimal%, [0x7A04] = %slotspiderwraithlargedecimal%, [0x7B00] = %slotwolflargedecimal%, [0x7B01] = %slotwolfworglargedecimal%, [0x7B02] = %slotwolfdirelargedecimal%, [0x7B03] = %slotwolfwinterlargedecimal%, [0x7B04] = %slotwolfvampiriclargedecimal%, [0x7B05] = %slotwolfdreadlargedecimal%, [0x7F0A] = %slotgreatcatpantherlargedecimal%, [0x7F0B] = %slotgreatcatleopardlargedecimal%, [0x7F13] = %slotsnakegiantdecimal%, [0x7F16] = %slotmooselargedecimal%, [0x7F17] = %slotrabbitlargedecimal%, [0x7F18] = %slotdeerlargedecimal%, [0x7F20] = %slotgroundhoglargedecimal%, [0x7F21] = %slotpheasantlargedecimal%, [0x7F60] = %slotsnakewaterlargedecimal%, [0xB000] = %slotcowlargedecimal%, [0xB100] = %slothorselargedecimal%, [0xC000] = %slotbatlargedecimal%, [0xC100] = %slotcatlargedecimal%, [0xC200] = %slotchickenlargedecimal%, [0xC300] = %slotratlargedecimal%, [0xC400] = %slotsquirrellargedecimal%, [0xC500] = %slotbatlargedecimal%, [0xCC04] = %slotratlargedecimal%, [0xE220] = %slotbeetlebombardierlargedecimal%, [0xE265] = %slotboararcticlargedecimal%, [0xE27F] = %slotboarwildlargedecimal%, [0xE280] = %slotworglargedecimal%, ~
	IF_EXISTS

COPY_EXISTING ~m_mestr1.lua~ ~override~
	REPLACE_TEXTUALLY CASE_INSENSITIVE ~me_line_shot = {~ ~me_line_shot = {[3] = %melinr11%, [4] = %melinr11%, [102] = %melinr12%, [103] = %melinr13%, ~
	REPLACE_TEXTUALLY CASE_INSENSITIVE ~me_cone_shot = {~ ~me_cone_shot = {[3] = %meconr11%, [4] = %meconr11%, [102] = %meconr12%, [103] = %meconr13%, ~
	SPRINT ex_hit_string2 @30105
	SPRINT ex_hit_string3 @30106
	SPRINT ex_hit_string5 @30108
	SPRINT ex_hit_string6 @30109
	REPLACE_TEXTUALLY CASE_INSENSITIVE ~ex_hit_strings *=.*~ ~ex_hit_strings = {"%ex_hit_string2%", "%ex_hit_string2%", "%ex_hit_string3%", "%ex_hit_string3%", "%ex_hit_string5%", "%ex_hit_string6%"}~
	ex_backstab_strref7 = RESOLVE_STR_REF(@30110)
	ex_backstab_strref8 = RESOLVE_STR_REF(@30111)
	ex_backstab_strref9 = RESOLVE_STR_REF(@30112)
	REPLACE_TEXTUALLY CASE_INSENSITIVE ~ex_backstab_strrefs *=.*~ ~ex_backstab_strrefs = {0, 16471, 16472, 16473, 16474, 16475, %ex_backstab_strref7%, %ex_backstab_strref8%, %ex_backstab_strref9%}~
	ex_exattack1 = RESOLVE_STR_REF(~<EXATTACKSTR1>~)
	ex_exattack2 = RESOLVE_STR_REF(~<EXATTACKSTR2>~)
	ex_exattack3 = RESOLVE_STR_REF(~<EXATTACKSTR3>~)
	ex_exattack4 = RESOLVE_STR_REF(~<EXATTACKSTR4>~)
	ex_exattack5 = RESOLVE_STR_REF(~<EXATTACKSTR5>~)
	ex_exattack6 = RESOLVE_STR_REF(~<EXATTACKSTR6>~)
	ex_exattack7 = RESOLVE_STR_REF(~<EXATTACKSTR7>~)
	ex_exattack8 = RESOLVE_STR_REF(~<EXATTACKSTR8>~)
	ex_exattack9 = RESOLVE_STR_REF(~<EXATTACKSTR9>~)
	ex_exattack10 = RESOLVE_STR_REF(~<EXATTACKSTR10>~)
	ex_exattack11 = RESOLVE_STR_REF(~<EXATTACKSTR11>~)
	ex_exattack12 = RESOLVE_STR_REF(~<EXATTACKSTR12>~)
	ex_exattack13 = RESOLVE_STR_REF(~<EXATTACKSTR13>~)
	ex_exattack14 = RESOLVE_STR_REF(~<EXATTACKSTR14>~)
	ex_exattack15 = RESOLVE_STR_REF(~<EXATTACKSTR15>~)
	ex_exattack16 = RESOLVE_STR_REF(~<EXATTACKSTR16>~)
	ex_exattack17 = RESOLVE_STR_REF(~<EXATTACKSTR17>~)
	ex_exattack18 = RESOLVE_STR_REF(~<EXATTACKSTR18>~)
	ex_exattack19 = RESOLVE_STR_REF(~<EXATTACKSTR19>~)
	ex_exattack20 = RESOLVE_STR_REF(~<EXATTACKSTR20>~)
	ex_exattack21 = RESOLVE_STR_REF(~<EXATTACKSTR21>~)
	ex_exattack22 = RESOLVE_STR_REF(~<EXATTACKSTR22>~)
	ex_exattack23 = RESOLVE_STR_REF(~<EXATTACKSTR23>~)
	ex_exattack24 = RESOLVE_STR_REF(~<EXATTACKSTR24>~)
	ex_exattack25 = RESOLVE_STR_REF(~<EXATTACKSTR25>~)
	ex_exattack26 = RESOLVE_STR_REF(~<EXATTACKSTR26>~)
	ex_exattack27 = RESOLVE_STR_REF(~<EXATTACKSTR27>~)
	ex_exattack28 = RESOLVE_STR_REF(~<EXATTACKSTR28>~)
	ex_exattack29 = RESOLVE_STR_REF(~<EXATTACKSTR29>~)
	ex_exattack30 = RESOLVE_STR_REF(~<EXATTACKSTR30>~)
	ex_exattack31 = RESOLVE_STR_REF(~<EXATTACKSTR31>~)
	ex_exattack32 = RESOLVE_STR_REF(~<EXATTACKSTR32>~)
	ex_exattack33 = RESOLVE_STR_REF(~<EXATTACKSTR33>~)
	ex_exattack34 = RESOLVE_STR_REF(~<EXATTACKSTR34>~)
	ex_exattack35 = RESOLVE_STR_REF(~<EXATTACKSTR35>~)
	ex_exattack36 = RESOLVE_STR_REF(~<EXATTACKSTR36>~)
	ex_exattack37 = RESOLVE_STR_REF(~<EXATTACKSTR37>~)
	ex_exattack38 = RESOLVE_STR_REF(~<EXATTACKSTR38>~)
	ex_exattack39 = RESOLVE_STR_REF(~<EXATTACKSTR39>~)
	ex_exattack40 = RESOLVE_STR_REF(~<EXATTACKSTR40>~)
	REPLACE_TEXTUALLY CASE_INSENSITIVE ~ex_exattack *=.*~ ~ex_exattack = {%ex_exattack1%,%ex_exattack2%,%ex_exattack3%,%ex_exattack4%,%ex_exattack5%,%ex_exattack6%,%ex_exattack7%,%ex_exattack8%,%ex_exattack9%,%ex_exattack10%,%ex_exattack11%,%ex_exattack12%,%ex_exattack13%,%ex_exattack14%,%ex_exattack15%,%ex_exattack16%,%ex_exattack17%,%ex_exattack18%,%ex_exattack19%,%ex_exattack20%,%ex_exattack21%,%ex_exattack22%,%ex_exattack23%,%ex_exattack24%,%ex_exattack25%,%ex_exattack26%,%ex_exattack27%,%ex_exattack28%,%ex_exattack29%,%ex_exattack30%,%ex_exattack31%,%ex_exattack32%,%ex_exattack33%,%ex_exattack34%,%ex_exattack35%,%ex_exattack36%,%ex_exattack37%,%ex_exattack38%,%ex_exattack39%,%ex_exattack40%}~
	IF_EXISTS

COPY_EXISTING ~projectl.ids~ ~override~
	COUNT_2DA_ROWS 2 numrows
	FOR (i = 1; i < numrows; ++i) BEGIN
		line_projectile_id = 0
		cone_projectile_id = 0
		boulder_projectile_id = 0
		is_lightning_projectile = 0
		READ_2DA_ENTRY i 1 2 theprojectileres
		INNER_ACTION BEGIN
			COPY_EXISTING ~%theprojectileres%.pro~ ~override~
				READ_ASCII 0x104 theprojectileanimation ELSE ~~
				PATCH_IF (~%theprojectileanimation%~ STRING_EQUAL_CASE ~ARARROW~) BEGIN
					line_projectile_id = melinr01
					cone_projectile_id = meconr01
				END ELSE PATCH_IF (~%theprojectileanimation%~ STRING_EQUAL_CASE ~BOLT~) BEGIN
					line_projectile_id = melinr02
					cone_projectile_id = meconr02
				END ELSE PATCH_IF (~%theprojectileanimation%~ STRING_EQUAL_CASE ~MAGICSTN~) BEGIN
					line_projectile_id = melinr03
					cone_projectile_id = meconr03
					boulder_projectile_id = meboulde
				END ELSE PATCH_IF (~%theprojectileanimation%~ STRING_EQUAL_CASE ~DART~) BEGIN
					line_projectile_id = melinr04
					cone_projectile_id = meconr04
				END ELSE PATCH_IF (~%theprojectileanimation%~ STRING_EQUAL_CASE ~DAGGER~) BEGIN
					line_projectile_id = melinr05
					cone_projectile_id = meconr05
				END ELSE PATCH_IF (~%theprojectileanimation%~ STRING_EQUAL_CASE ~AXE~) BEGIN
					line_projectile_id = melinr06
					cone_projectile_id = meconr06
				END ELSE PATCH_IF (~%theprojectileanimation%~ STRING_EQUAL_CASE ~SPSPEART~) BEGIN
					line_projectile_id = melinr14
					cone_projectile_id = meconr14
				END ELSE PATCH_IF (~%theprojectileanimation%~ STRING_EQUAL_CASE ~SPLIGHTB~) OR (~%theprojectileanimation%~ STRING_EQUAL_CASE ~LIGHTNT~) OR (~%theprojectileanimation%~ STRING_EQUAL_CASE ~CLIGHTT~) BEGIN
					is_lightning_projectile = 1
				END
				IF_EXISTS
				BUT_ONLY_IF_IT_CHANGES
		END
		PATCH_IF line_projectile_id > 0 OR cone_projectile_id > 0 OR boulder_projectile_id > 0 OR is_lightning_projectile > 0 BEGIN
			READ_2DA_ENTRY i 0 2 theprojectileid
			theprojectileid += 1
			INNER_ACTION BEGIN
				COPY_EXISTING ~m_mestr1.lua~ ~override~
					PATCH_IF line_projectile_id > 0 BEGIN
						REPLACE_TEXTUALLY CASE_INSENSITIVE ~me_line_shot = {~ ~me_line_shot = {[%theprojectileid%] = %line_projectile_id%, ~
					END
					PATCH_IF line_projectile_id > 0 BEGIN
						REPLACE_TEXTUALLY CASE_INSENSITIVE ~me_cone_shot = {~ ~me_cone_shot = {[%theprojectileid%] = %cone_projectile_id%, ~
					END
					PATCH_IF boulder_projectile_id > 0 BEGIN
						REPLACE_TEXTUALLY CASE_INSENSITIVE ~me_boulder_shot = {~ ~me_boulder_shot = {[%theprojectileid%] = %boulder_projectile_id%, ~
					END
					PATCH_IF is_lightning_projectile > 0 BEGIN
						REPLACE_TEXTUALLY CASE_INSENSITIVE ~me_lightning_projectiles = {~ ~me_lightning_projectiles = {[%theprojectileid%] = true, ~
					END
					IF_EXISTS
			END
		END
	END
	BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING ~m_mestr1.lua~ ~override~
	REPLACE_TEXTUALLY CASE_INSENSITIVE ~me_line_shot = {~ ~me_line_shot = {[%meboulde%] = %melinr31%, ~
	REPLACE_TEXTUALLY CASE_INSENSITIVE ~me_cone_shot = {~ ~me_cone_shot = {[%meboulde%] = %meconr31%, ~
	REPLACE_TEXTUALLY CASE_INSENSITIVE ~me_boulder_shot = {~ ~me_boulder_shot = {[%melinr03%] = %melinr31%, ~
	REPLACE_TEXTUALLY CASE_INSENSITIVE ~me_boulder_shot = {~ ~me_boulder_shot = {[%meconr03%] = %meconr31%, ~
	REPLACE_TEXTUALLY CASE_INSENSITIVE ~me_special_lightning_projectile = .*~ ~me_special_lightning_projectile = %meslight%~
	REPLACE_TEXTUALLY CASE_INSENSITIVE ~me_tornado_projectile = .*~ ~me_tornado_projectile = %metornad%~
	IF_EXISTS

ACTION_IF GAME_IS ~iwdee~ BEGIN
	COPY_EXISTING_REGEXP ~mewi[0-9][0-9][0-9]\.spl~ ~override~
		READ_BYTE 0x25 theschool
		PATCH_IF theschool >= 1 AND theschool <= 8 BEGIN
			READ_LONG 0x1E thespellunusability
			thespellunusability&=0xFFFFC03F
			PATCH_IF theschool = 1 BEGIN
				thespellunusability|=0x2400
			END ELSE PATCH_IF theschool = 2 BEGIN
				thespellunusability|=0x900
			END ELSE PATCH_IF theschool = 3 BEGIN
				thespellunusability|=0x800
			END ELSE PATCH_IF theschool = 4 BEGIN
				thespellunusability|=0x1000
			END ELSE PATCH_IF theschool = 5 BEGIN
				thespellunusability|=0x1040
			END ELSE PATCH_IF theschool = 6 BEGIN
				thespellunusability|=0x280
			END ELSE PATCH_IF theschool = 7 BEGIN
				thespellunusability|=0x2400
			END ELSE PATCH_IF theschool = 8 BEGIN
				thespellunusability|=0x40
			END
			WRITE_LONG 0x1E thespellunusability
			TEXT_SPRINT thesourceres ~%SOURCE_RES%~
			INNER_ACTION BEGIN
				COPY_EXISTING ~%thesourceres%X.itm~ ~override~
					READ_BYTE 0x2D thekitunusability3
					READ_BYTE 0x2F thekitunusability4
					thekitunusability3&=0xC0
					thekitunusability4&=0x3F
					PATCH_IF theschool = 1 BEGIN
						thekitunusability3|=0x24
					END ELSE PATCH_IF theschool = 2 BEGIN
						thekitunusability3|=0x9
					END ELSE PATCH_IF theschool = 3 BEGIN
						thekitunusability3|=0x8
					END ELSE PATCH_IF theschool = 4 BEGIN
						thekitunusability3|=0x10
					END ELSE PATCH_IF theschool = 5 BEGIN
						thekitunusability3|=0x10
						thekitunusability4|=0x40
					END ELSE PATCH_IF theschool = 6 BEGIN
						thekitunusability3|=0x2
						thekitunusability4|=0x80
					END ELSE PATCH_IF theschool = 7 BEGIN
						thekitunusability3|=0x24
					END ELSE PATCH_IF theschool = 8 BEGIN
						thekitunusability4|=0x40
					END
					WRITE_BYTE 0x2D thekitunusability3
					WRITE_BYTE 0x2F thekitunusability4
					IF_EXISTS
					BUT_ONLY_IF_IT_CHANGES
			END
		END
		BUT_ONLY_IF_IT_CHANGES

	COPY_EXISTING ~mewi452.spl~ ~override~
		READ_LONG 0x1E thespellunusability
		thespellunusability&=0xFFFFEFFF
		WRITE_LONG 0x1E thespellunusability

	COPY_EXISTING ~mewi452x.itm~ ~override~
		READ_BYTE 0x2D thekitunusability3
		thekitunusability3&=0xEF
		WRITE_BYTE 0x2D thekitunusability3

	COPY_EXISTING ~mewi556.spl~ ~override~
		READ_LONG 0x1E thespellunusability
		thespellunusability|=0x2FC0
		WRITE_LONG 0x1E thespellunusability

	COPY_EXISTING ~mewi556x.itm~ ~override~
		READ_BYTE 0x2D thekitunusability3
		READ_BYTE 0x2F thekitunusability4
		thekitunusability3|=0x2F
		thekitunusability4|=0xC0
		WRITE_BYTE 0x2D thekitunusability3
		WRITE_BYTE 0x2F thekitunusability4

	COPY_EXISTING ~mewi654.spl~ ~override~
		READ_LONG 0x1E thespellunusability
		thespellunusability|=0x80
		WRITE_LONG 0x1E thespellunusability

	COPY_EXISTING ~mewi654x.itm~ ~override~
		READ_BYTE 0x2F thekitunusability4
		thekitunusability4|=0x80
		WRITE_BYTE 0x2F thekitunusability4

	COPY_EXISTING ~mewi951.spl~ ~override~
		READ_LONG 0x1E thespellunusability
		thespellunusability|=0x3BC0
		WRITE_LONG 0x1E thespellunusability

	COPY_EXISTING ~mewi951x.itm~ ~override~
		READ_BYTE 0x2D thekitunusability3
		READ_BYTE 0x2F thekitunusability4
		thekitunusability3|=0x3B
		thekitunusability4|=0xC0
		WRITE_BYTE 0x2D thekitunusability3
		WRITE_BYTE 0x2F thekitunusability4

	COPY_EXISTING ~mewi959.spl~ ~override~
		READ_LONG 0x1E thespellunusability
		thespellunusability|=0x3F80
		WRITE_LONG 0x1E thespellunusability

	COPY_EXISTING ~mewi959x.itm~ ~override~
		READ_BYTE 0x2D thekitunusability3
		READ_BYTE 0x2F thekitunusability4
		thekitunusability3|=0x3F
		thekitunusability4|=0x80
		WRITE_BYTE 0x2D thekitunusability3
		WRITE_BYTE 0x2F thekitunusability4

	COPY_EXISTING ~mewi966.spl~ ~override~
		READ_LONG 0x1E thespellunusability
		thespellunusability&=0xFFFFDFFF
		WRITE_LONG 0x1E thespellunusability

	COPY_EXISTING ~mewi966x.itm~ ~override~
		READ_BYTE 0x2D thekitunusability3
		thekitunusability3&=0xDF
		WRITE_BYTE 0x2D thekitunusability3
END

COPY_EXISTING ~instant.ids~ ~override~
	REPLACE_TEXTUALLY ~49 MoveViewPoint~ ~48 JumpToPoint(P:Target*)
49 MoveViewPoint~
	UNLESS ~48 JumpToPoint~

ACTION_IF MOD_IS_INSTALLED ~BetterHOF.TP2~ ~1024~ BEGIN

	COPY_EXISTING_REGEXP ~.......\.spl~ ~override~
		READ_SHORT spelltype thespelltype
		READ_LONG spelllevel thelevel
		LPF ADD_SPELL_CFEFFECT INT_VAR opcode=removeeffectsbyresource target=1 timing=1 insert_point=0 STR_VAR resource=~MEQUICSP~ END
		PATCH_IF (thespelltype = 1 OR thespelltype = 2) AND (thelevel >= 1 AND thelevel <= 5) BEGIN
			LPF ADD_SPELL_CFEFFECT INT_VAR opcode=applyeffectslist target=1 timing=1 parameter1=238 parameter2=110 insert_point=1 dicenumber=62 dicesize=(thelevel * 10) STR_VAR resource=~MEQUICSP~ END
		END
		IF_EXISTS
		UNLESS ~MEQUICSP~
		BUT_ONLY_IF_IT_CHANGES

END

EXTEND_TOP ~baldur.bcs~ ~override/mepermlu.bcs~

COPY_EXISTING ~mepr151.spl~ ~override~
	SAY NAME1 @31151
	SAY UNIDENTIFIED_DESC @32151
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR151~ class_include=~{208, 209, 21}~ END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mepr152.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi157 END
	SAY NAME1 @31152
	SAY UNIDENTIFIED_DESC @32152
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_range= EVAL ~%stringrangelong%~ new_savingthrow= EVAL ~%stringsavingthrowpolymorphnegates%~ END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR152~ class_include=~{21}~ END

COPY_EXISTING ~sppr307.spl~ ~override~ ~spwi410.spl~ ~override~
	LPF ADD_SPELL_EFFECT INT_VAR opcode=321 target=2 timing=1 STR_VAR resource=~mepr152~ END

END
COPY_EXISTING ~mepr153.spl~ ~override~
	SAY NAME1 @31153
	SAY UNIDENTIFIED_DESC @32153
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR153~ class_include=~{209}~ END

COPY_EXISTING ~mepr154.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mepr154 END
	SAY NAME1 @31154
	SAY UNIDENTIFIED_DESC @32154
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR154~ class_include=~{207}~ END

COPY_EXISTING ~mepr155.spl~ ~override~
	LPF ALTER_SPELL_HEADER INT_VAR projectile=merepuls END
	SAY NAME1 @31155
	SAY UNIDENTIFIED_DESC @32155

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR155~ class_include=~{204, 207}~ END

OUTER_SET do_not_install_camouflage = 0
OUTER_SET camouflage_found = 0

ACTION_IF (MOD_IS_INSTALLED ~SetUp-B_Spells.tp2~ ~101~) OR (MOD_IS_INSTALLED ~SetUp-B_Spells.tp2~ ~103~) BEGIN

PRINT @1500

ACTION_READLN ~camouflage_decision~

OUTER_WHILE !(IS_AN_INT %camouflage_decision%) OR (%camouflage_decision% != 2 AND %camouflage_decision% != 3 AND %camouflage_decision% != 4) BEGIN
	ACTION_IF %camouflage_decision% = 1 BEGIN
		PRINT @1501
	END ELSE BEGIN
		PRINT @1502
	END
	ACTION_READLN ~camouflage_decision~
END

ACTION_IF camouflage_decision = 2 BEGIN
	OUTER_SET do_not_install_camouflage = 1
END ELSE ACTION_IF camouflage_decision = 3 BEGIN

	OUTER_SPRINT stringcamouflagename @31156
	COPY_EXISTING_REGEXP ~sppr1[0-9][0-9]\.spl~ ~override~
		READ_LONG NAME1 thespellnameref
		GET_STRREF thespellnameref thespellname
		PATCH_IF (camouflage_found = 0) AND (~%thespellname%~ STRING_EQUAL_CASE ~%stringcamouflagename%~) BEGIN
			camouflage_found = 1
			TEXT_SPRINT thecamouflageres ~%SOURCE_RES%~
		END
		BUT_ONLY_IF_IT_CHANGES

END

END

ACTION_IF do_not_install_camouflage = 0 BEGIN

	ACTION_IF camouflage_found = 0 BEGIN
		COPY_EXISTING ~mepr156.spl~ ~override~
			LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mepr156 END
			SAY NAME1 @31156
			SAY UNIDENTIFIED_DESC @32156

		LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR156~ class_include=~{208, 209, 21}~ END

	END ELSE BEGIN
		COPY_EXISTING ~mepr156.spl~ ~override/%thecamouflageres%.spl~
			LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mepr156 END
			LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 STR_VAR match_resource=~mepr156~ resource= EVAL ~%thecamouflageres%~ END
			SAY NAME1 @31156
			SAY UNIDENTIFIED_DESC @32156
	END
	

	
	ACTION_IF !(MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN
	
	COPY_EXISTING_REGEXP ~mepr156.*\.spl~ ~override~
		LPF DELETE_EFFECT INT_VAR silent=1 check_headers=0 check_globals=1 match_opcode=402 END
		BUT_ONLY_IF_IT_CHANGES

	END

END

COPY_EXISTING ~mepr157.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mepr157 END
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		LPF ALTER_SPELL_EFFECT INT_VAR header=(i + 1) duration_high=((i + 1) * 60) END
		numheaders = numheaders + 1
	END
	SAY NAME1 @31157
	SAY UNIDENTIFIED_DESC @32157
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR157~ class_include=~{207}~ END

OUTER_SET do_not_install_beast_sense = 0
OUTER_SET animal_eyes_found = 0

ACTION_IF (MOD_IS_INSTALLED ~SetUp-B_Spells.tp2~ ~101~) OR (MOD_IS_INSTALLED ~SetUp-B_Spells.tp2~ ~103~) BEGIN

PRINT @1510

ACTION_READLN ~beast_sense_decision~

OUTER_WHILE !(IS_AN_INT %beast_sense_decision%) OR (%beast_sense_decision% != 2 AND %beast_sense_decision% != 3 AND %beast_sense_decision% != 4) BEGIN
	ACTION_IF %beast_sense_decision% = 1 BEGIN
		PRINT @1511
	END ELSE BEGIN
		PRINT @1502
	END
	ACTION_READLN ~beast_sense_decision~
END

ACTION_IF beast_sense_decision = 2 BEGIN
	OUTER_SET do_not_install_beast_sense = 1
END ELSE ACTION_IF beast_sense_decision = 3 BEGIN

	OUTER_SPRINT stringanimaleyesname @4031
	COPY_EXISTING_REGEXP ~sppr1[0-9][0-9]\.spl~ ~override~
		READ_LONG NAME1 thespellnameref
		GET_STRREF thespellnameref thespellname
		PATCH_IF (animal_eyes_found = 0) AND (~%thespellname%~ STRING_EQUAL_CASE ~%stringanimaleyesname%~) BEGIN
			animal_eyes_found = 1
			TEXT_SPRINT animal_eyes_res ~%SOURCE_RES%~
		END
		BUT_ONLY_IF_IT_CHANGES

ACTION_IF animal_eyes_found = 1 BEGIN

	COPY_EXISTING ~hidespl.2da~ ~override~
		COUNT_2DA_COLS numcolumns
		COUNT_2DA_ROWS numcolumns numrows
		PATCH_IF numcolumns = 3 BEGIN
			INSERT_2DA_ROW numrows numcolumns ~%animal_eyes_res%    1          0~
		END ELSE PATCH_IF numcolumns = 4 BEGIN
			INSERT_2DA_ROW numrows numcolumns ~%animal_eyes_res%    1          0          1~
		END

END

END

END

ACTION_IF do_not_install_beast_sense = 0 BEGIN

COPY_EXISTING ~mepr251.spl~ ~override~
	SAY NAME1 @31251
	SAY UNIDENTIFIED_DESC @32251
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR251~ class_include=~{208, 209, 21}~ END

END

COPY_EXISTING ~mepr252.spl~ ~override~
	SAY NAME1 @31252
	SAY UNIDENTIFIED_DESC @32252
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowbreathhalf%~ END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR252~ class_include=~{208, 209, 21}~ END

COPY_EXISTING ~mepr253.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi255 END
	SAY NAME1 @31253
	SAY UNIDENTIFIED_DESC @32253
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowspellnegates%~ END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR253~ class_include=~{204, 207}~ END

COPY_EXISTING ~sppr307.spl~ ~override~ ~spwi410.spl~ ~override~
	LPF ADD_SPELL_EFFECT INT_VAR opcode=321 target=2 timing=1 STR_VAR resource= EVAL ~mepr253~ END

COPY_EXISTING ~mepr254.spl~ ~override~
	SAY NAME1 @31254
	SAY UNIDENTIFIED_DESC @32254
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR254~ class_include=~{207, 209}~ END

LAF EXCLUDE_SPELL_FROM_CONTINGENCY STR_VAR resource= EVAL ~MEPR254~ END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mepr255.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi559 END
//	LPF ALTER_EFFECT INT_VAR check_headers=1 check_globals=0 match_opcode=protectionfromspell2 match_parameter2=2500 parameter2=splprot_meinflight END
	LPF ADD_SPELL_EFFECT INT_VAR insert_point=0 opcode=immunitytospellandmessage target=2 timing=0 duration=1 parameter2=splprot_areaisanoteleportzone special=RESOLVE_STR_REF(@30030) STR_VAR resource=~MEPR255~ END
	SAY NAME1 @31255
	SAY UNIDENTIFIED_DESC @32255
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR255~ class_include=~{21}~ END

END
/*
ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mepr256.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi259 END
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		LPF ALTER_SPELL_EFFECT INT_VAR header=(i + 1) duration_high=((i + 1) * 60) END
		numheaders = numheaders + 1
	END
	SAY NAME1 @31256
	SAY UNIDENTIFIED_DESC @32256

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR256~ class_include=~{204, 207, 208, 209, 21}~ END

COPY_EXISTING ~eeex_ini.lua~ ~override~
	REPLACE_TEXTUALLY ~\[\"B3_EfMen\"\] = false~ ~["B3_EfMen"] = true~
	IF_EXISTS
	BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING ~B3_EfMen.lua~ ~override~
	REPLACE_TEXTUALLY ~B3EffectMenu_Stat_Required = .*~ ~B3EffectMenu_Stat_Required = true~
	IF_EXISTS
	BUT_ONLY_IF_IT_CHANGES

END
*/
ACTION_IF !(GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~mepr351.spl~ ~override~
	SAY NAME1 @31351
	SAY UNIDENTIFIED_DESC @32351
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR351~ class_include=~{208, 209, 21}~ END

COPY_EXISTING ~mewaterw.cre~ ~override~
	SAY NAME1 @30003
	SAY NAME2 @30003

ACTION_IF GAME_IS ~bgee~ BEGIN
	LAF ADD_AREA_ACTORS_2DA STR_VAR variablename=~ME_Add_Water_Weirds~ the2da=~mewatbg1~ END
END ELSE ACTION_IF GAME_IS ~bg2ee~ BEGIN
	LAF ADD_AREA_ACTORS_2DA STR_VAR variablename=~ME_Add_Water_Weirds~ the2da=~mewatbg2~ END
END ELSE ACTION_IF GAME_IS ~iwdee~ BEGIN
//	LAF ADD_AREA_ACTORS_2DA STR_VAR variablename=~ME_Add_Water_Weirds~ the2da=~mewatiwd~ END
END ELSE ACTION_IF GAME_IS ~eet~ BEGIN
	LAF ADD_AREA_ACTORS_2DA STR_VAR variablename=~ME_Add_Water_Weirds~ the2da=~mewateet~ END
END

EXTEND_TOP ~baldur.bcs~ ~override/mewatwsp.bcs~

END


ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mepr352.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR check_headers=1 check_globals=0 match_opcode=displaystring match_parameter1=30021 parameter1=RESOLVE_STR_REF(@30021) END
	SAY NAME1 @31352
	SAY UNIDENTIFIED_DESC @32352
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR352~ class_include=~{204, 207}~ END

COPY_EXISTING ~mepr352d.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR check_headers=1 check_globals=0 match_opcode=displaystring match_parameter1=30022 parameter1=RESOLVE_STR_REF(@30022) END

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mepr353.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR check_headers=1 check_globals=0 match_opcode=displaystring match_parameter1=30031 parameter1=RESOLVE_STR_REF(@30031) END
	SAY NAME1 @31353
	SAY UNIDENTIFIED_DESC @32353
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR353~ class_include=~{208, 209, 21}~ END

COPY_EXISTING ~sppr307.spl~ ~override~ ~spwi410.spl~ ~override~
	LPF ADD_SPELL_EFFECT INT_VAR opcode=321 target=2 timing=1 STR_VAR resource= EVAL ~mepr353~ END

END

COPY_EXISTING ~mepr354.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mepr354 END
	LPF ALTER_EFFECT INT_VAR check_headers=1 check_globals=0 match_opcode=displaystring match_parameter1=30035 parameter1=RESOLVE_STR_REF(@30035) END
	SAY NAME1 @31354
	SAY UNIDENTIFIED_DESC @32354
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR354~ class_include=~{204, 207}~ END

COPY_EXISTING ~sppr307.spl~ ~override~ ~spwi410.spl~ ~override~
	LPF ADD_SPELL_EFFECT INT_VAR opcode=321 target=2 timing=1 STR_VAR resource= EVAL ~mepr354~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode=321 target=2 timing=1 STR_VAR resource=~mepr354d~ END

COPY_EXISTING ~mepr354d.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mepr354 END
	LPF ALTER_EFFECT INT_VAR check_headers=1 check_globals=0 match_opcode=displaystring match_parameter1=30035 parameter1=RESOLVE_STR_REF(@30035) END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mepr355.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mepr355 END
	SAY NAME1 @31355
	SAY UNIDENTIFIED_DESC @32355
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_range= EVAL ~%stringrangeshort%~ END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR355~ class_include=~{207}~ END

END

COPY_EXISTING ~mepr356.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mepr356 END
	SAY NAME1 @31356
	SAY UNIDENTIFIED_DESC @32356
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR356~ class_include=~{209}~ END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mepr357.spl~ ~override~
	LPF ADD_SPELL_EFFECT INT_VAR insert_point=0 opcode=immunitytospellandmessage target=2 timing=0 duration=1 parameter2=splprot_areaisanoteleportzone special=RESOLVE_STR_REF(@30030) STR_VAR resource=~MEPR357~ END
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi352 END
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		LPF ALTER_SPELL_EFFECT INT_VAR header=(i + 1) duration_high=(i * 6 + 66) END
		LPF ALTER_EFFECT INT_VAR silent=1 header=i match_opcode=eeexsetextendedstat match_special=640 parameter1=(i + 21) END
		LPF ALTER_EFFECT INT_VAR silent=1 header=i duration=(i * 6 + 69) STR_VAR match_resource=~MEFALDMG~ END
		numheaders = numheaders + 1
	END
	SAY NAME1 @31357
	SAY UNIDENTIFIED_DESC @32357
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR357~ class_include=~{209}~ END

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

OUTER_SPRINT me_30043 @30043
OUTER_SPRINT me_31358 @31358
LAF ADD_CONTINGENCY INT_VAR new_action=1 description=RESOLVE_STR_REF(@32358) STR_VAR resource= EVAL ~mepr358~ title=~ME_FAMILIAR_SPELL_TITLE~ title_name= EVAL ~%me_31358%~ action=~ME_ADD_SPELLS_FAMILIAR_LABEL~ action_name= EVAL ~%me_30043%~ END

COPY_EXISTING ~mepr358.spl~ ~override~
	SAY NAME1 @31358
	SAY UNIDENTIFIED_DESC @32358
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR358~ kit_include=~{0x4009}~ END

COPY_EXISTING ~m_mealtc.lua~ ~override~
	ref_30077 = RESOLVE_STR_REF(@30077)
	ref_30078 = RESOLVE_STR_REF(@30078)
	ref_30079 = RESOLVE_STR_REF(@30079)
	ref_30080 = RESOLVE_STR_REF(@30080)
	ref_30081 = RESOLVE_STR_REF(@30081)
	ref_30082 = RESOLVE_STR_REF(@30082)
	REPLACE_TEXTUALLY CASE_INSENSITIVE ~me_alt_contingency = {~ ~me_alt_contingency = {
['MEPR358'] = {['conditions'] = {{['strref'] = %ref_30077%, ['desc'] = %ref_30078%}}, ['targets'] = {{['strref'] = %ref_30079%, ['desc'] = %ref_30080%}, {['strref'] = %ref_30081%, ['desc'] = %ref_30082%}},},~

END

OUTER_SPRINT stringspheredivination @30051
OUTER_SPRINT stringwizard @30052
OUTER_SPRINT stringpriest @30053

COPY_EXISTING ~spwi301.spl~ ~override/mepr359.spl~
	WRITE_ASCII castingsound ~CAS_P04~ #8
	WRITE_SHORT spelltype 2
	WRITE_LONG spellunusability 0x40000000
	PATCH_IF !(MOD_IS_INSTALLED ~setup-spell_rev.tp2~ ~0~) BEGIN
		LPF REPLACE_IN_SPELL_DESCRIPTION INT_VAR new_string=1 STR_VAR match= EVAL ~\(%stringlevel%\)~ replace_with= EVAL ~\1
%stringspheredivination%~ END
		LPF REPLACE_IN_SPELL_DESCRIPTION INT_VAR new_string=1 STR_VAR match= EVAL ~%stringwizard%~ replace_with= EVAL ~%stringpriest%~ END
	END ELSE BEGIN
		LPF REPLACE_IN_SPELL_DESCRIPTION INT_VAR new_string=1 STR_VAR match= EVAL ~\(%stringrange%\)~ replace_with= EVAL ~%stringspheredivination%
\1~ END
	END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR359~ class_include=~{208, 209, 21}~ END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mepr360.spl~ ~override~
	SAY NAME1 @31360
	SAY UNIDENTIFIED_DESC @32360
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR360~ class_include=~{204, 207}~ END

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mepr361.spl~ ~override~
	LPF ALTER_SPELL_HEADER INT_VAR projectile=mestwnst END
	SAY NAME1 @31361
	SAY UNIDENTIFIED_DESC @32361
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR361~ class_include=~{209}~ END

LAF EXCLUDE_SPELL_FROM_CONTINGENCY STR_VAR resource= EVAL ~MEPR361~ END

COPY_EXISTING ~mestwnst.pro~ ~override~
	WRITE_SHORT 0x21A meintrv4

END



COPY_EXISTING ~mepr451.spl~ ~override~
	SAY NAME1 @31451
	SAY UNIDENTIFIED_DESC @32451
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowwandsnegates%~ END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR451~ class_include=~{204, 207}~ END

COPY_EXISTING ~mepr451d.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR check_headers=1 check_globals=0 match_opcode=displaystring match_parameter1=30000 parameter1=RESOLVE_STR_REF(@30000) END
	LPF ALTER_EFFECT INT_VAR check_headers=1 check_globals=0 match_opcode=protectionfromstring match_parameter1=30001 parameter1=RESOLVE_STR_REF(@30001) END

COPY_EXISTING ~mepr451s.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR check_headers=1 check_globals=0 match_opcode=displaystring match_parameter1=30001 parameter1=RESOLVE_STR_REF(@30001) END

ACTION_IF !(GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~mepr452.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR check_headers=1 check_globals=0 match_opcode=immunitytospellandmessage match_parameter2=1250 parameter2=splprot_areaisnotforest special=RESOLVE_STR_REF(@30002) END
	SAY NAME1 @31452
	SAY UNIDENTIFIED_DESC @32452
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR452~ class_include=~{208, 209, 21}~ END

END

COPY_EXISTING ~mepr453.spl~ ~override~
	SAY NAME1 @31453
	SAY UNIDENTIFIED_DESC @32453
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowpolymorphnegates%~ END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR453~ class_include=~{204, 207}~ END

OUTER_SET produce_fire_found = 0
OUTER_SPRINT stringproducefirename @4020
COPY_EXISTING_REGEXP ~sppr4[0-9][0-9]\.spl~ ~override~
	READ_LONG NAME1 thespellnameref
	GET_STRREF thespellnameref thespellname
	PATCH_IF (produce_fire_found = 0) AND (~%thespellname%~ STRING_EQUAL_CASE ~%stringproducefirename%~) BEGIN
		produce_fire_found = 1
		TEXT_SPRINT meproducefireres ~%SOURCE_RES%~
	END
	BUT_ONLY_IF_IT_CHANGES

ACTION_IF produce_fire_found = 0 BEGIN
	COPY_EXISTING ~mepr454.spl~ ~override~
		LPF ALTER_SPELL_HEADER INT_VAR projectile=mewofire END
			SAY NAME1 @31454
		SAY UNIDENTIFIED_DESC @32454
		LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

	LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR454~ class_include=~{208, 209, 21}~ END
END ELSE BEGIN
	COPY_EXISTING ~mepr454.spl~ ~override/%meproducefireres%.spl~
		LPF ALTER_SPELL_HEADER INT_VAR projectile=mewofire END
			SAY NAME1 @31454
		SAY UNIDENTIFIED_DESC @32454
		LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END
END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mepr455.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mepr455 END
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		numheaders = numheaders + 1
	END
	FOR (i = 1; i <= numheaders; ++i) BEGIN
		LPF ALTER_SPELL_EFFECT INT_VAR header=i duration_high=(i * 6) END
	END
	SAY NAME1 @31455
	SAY UNIDENTIFIED_DESC @32455
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR455~ class_include=~{209}~ END

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mepr456.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mepr456 END
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		numheaders = numheaders + 1
	END
	FOR (i = 1; i <= numheaders; ++i) BEGIN
		LPF ALTER_SPELL_EFFECT INT_VAR header=i duration_high=(i * 6) END
		LPF ALTER_SPELL_EFFECT INT_VAR header=i match_opcode=408 special=(i / 3) END
	END
	LPF ALTER_SPELL_EFFECT INT_VAR header=1 match_opcode=408 special=1 END
	LPF ALTER_SPELL_EFFECT INT_VAR header=2 match_opcode=408 special=1 END
	SAY NAME1 @31456
	SAY UNIDENTIFIED_DESC @32456
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR456~ class_include=~{208, 209, 21}~ END

END

OUTER_SPRINT stringspherenecromantic @30115
OUTER_SPRINT stringwizard @30052
OUTER_SPRINT stringpriest @30053
COPY_EXISTING ~spwi414.spl~ ~override/mepr457.spl~
	WRITE_ASCII castingsound ~CAS_P07~ #8
	WRITE_SHORT spelltype 2
	WRITE_LONG spellunusability 0x40000000
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 STR_VAR match_resource=~spwi414~ resource= EVAL ~mepr457~ END
	LPF REPLACE_IN_SPELL_DESCRIPTION INT_VAR new_string=1 STR_VAR match= EVAL ~\(%stringlevel%\)~ replace_with= EVAL ~\1
%stringspherenecromantic%~ END
	LPF REPLACE_IN_SPELL_DESCRIPTION INT_VAR new_string=1 STR_VAR match= EVAL ~%stringwizard%~ replace_with= EVAL ~%stringpriest%~ END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR457~ class_include=~{21}~ END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) AND (me_power_spells = 1) BEGIN

COPY_EXISTING ~mepr551.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR check_headers=1 check_globals=0 match_opcode=displaystring match_parameter1=30020 parameter1=RESOLVE_STR_REF(@30020) END
	SAY NAME1 @31551
	SAY UNIDENTIFIED_DESC @32551
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR551~ class_include=~{204, 207}~ END

COPY_EXISTING ~mepr551d.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR check_headers=1 check_globals=0 match_opcode=displaystring match_parameter1=30019 parameter1=RESOLVE_STR_REF(@30019) END

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) AND (me_power_spells = 1) BEGIN

COPY_EXISTING ~mepr552.spl~ ~override~
	SAY NAME1 @31552
	SAY UNIDENTIFIED_DESC @32552
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR552~ class_include=~{204, 207}~ END

COPY_EXISTING ~instant.ids~ ~override~
	REPLACE_TEXTUALLY ~327~ ~323 CreateCreatureImpassableAllowOverlap(S:NewObject*,P:Location*,I:Face*DIR)
323 CreateCreatureImpassableAllowOverlapEffect(S:NewObject*,S:Effect*,P:Location*,I:Face*DIR)
327~
	UNLESS ~323~
END

ACTION_IF !(MOD_IS_INSTALLED ~setup-spell_rev.tp2~ ~0~) BEGIN

OUTER_SPRINT stringlevel5 @3505
OUTER_SPRINT stringlevel7 @3507
OUTER_SPRINT stringsphereprotection @30044
COPY_EXISTING ~spwi702.spl~ ~override/mepr553.spl~
	WRITE_ASCII castingsound ~CAS_P02~ #8
	WRITE_SHORT spelltype 2
	WRITE_LONG spelllevel 5
	WRITE_LONG spellunusability 0x40000000
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=1 match_power=7 power=5 END
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 STR_VAR match_resource=~spwi702~ resource= EVAL ~mepr553~ END
	LPF REPLACE_IN_SPELL_DESCRIPTION INT_VAR new_string=1 STR_VAR match= EVAL ~%stringlevel7%~ replace_with= EVAL ~%stringlevel5%~ END
	PATCH_IF !(MOD_IS_INSTALLED ~setup-spell_rev.tp2~ ~0~) BEGIN
		LPF REPLACE_IN_SPELL_DESCRIPTION INT_VAR new_string=1 STR_VAR match= EVAL ~\(%stringlevel%\)~ replace_with= EVAL ~\1
%stringsphereprotection%~ END
	END ELSE BEGIN
		LPF REPLACE_IN_SPELL_DESCRIPTION INT_VAR new_string=1 STR_VAR match= EVAL ~\(%stringrange%\)~ replace_with= EVAL ~%stringsphereprotection%
\1~ END
	END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR553~ class_include=~{208, 209, 21}~ END

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mepr554.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi559 END
//	LPF ALTER_EFFECT INT_VAR check_headers=1 check_globals=0 match_opcode=protectionfromspell2 match_parameter2=2500 parameter2=splprot_meinflight END
	LPF ADD_SPELL_EFFECT INT_VAR insert_point=0 opcode=immunitytospellandmessage target=1 timing=0 duration=1 parameter2=splprot_areaisanoteleportzone special=RESOLVE_STR_REF(@30030) STR_VAR resource=~MEPR554~ END
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		LPF ALTER_SPELL_EFFECT INT_VAR header=(i + 1) duration_high=((i + 7) * 3) END
//		LPF ALTER_EFFECT INT_VAR header=i match_opcode=eeexsetextendedstat match_special=640 parameter1=(i + 21) END
		numheaders = numheaders + 1
	END
	SAY NAME1 @31554
	SAY UNIDENTIFIED_DESC @32554
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR554~ class_include=~{21}~ END

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) AND (me_power_spells = 1) BEGIN

COPY_EXISTING ~mepr555.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi562 END
	SAY NAME1 @33562
	SAY UNIDENTIFIED_DESC @34562
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR555~ class_include=~{207, 209}~ END

OUTER_SPRINT me_30076 @30076
OUTER_SPRINT me_31555 @31555
LAF ADD_CONTINGENCY INT_VAR new_action=1 description=RESOLVE_STR_REF(@32555) STR_VAR resource= EVAL ~MEPR555~ title=~ME_CRITICAL_SPELL_TITLE~ title_name= EVAL ~%me_31555%~ action=~ME_CRITICAL_SPELL_LABEL~ action_name= EVAL ~%me_30076%~ END

COPY_EXISTING ~m_mealtc.lua~ ~override~
	ref_30068 = RESOLVE_STR_REF(@30068)
	ref_30069 = RESOLVE_STR_REF(@30069)
	ref_30070 = RESOLVE_STR_REF(@30070)
	ref_30071 = RESOLVE_STR_REF(@30071)
	ref_30072 = RESOLVE_STR_REF(@30072)
	ref_30073 = RESOLVE_STR_REF(@30073)
	REPLACE_TEXTUALLY CASE_INSENSITIVE ~me_alt_contingency = {~ ~me_alt_contingency = {
['MEPR555'] = {['conditions'] = {{['strref'] = %ref_30068%, ['desc'] = %ref_30069%}}, ['targets'] = {{['strref'] = %ref_30070%, ['desc'] = %ref_30071%}, {['strref'] = %ref_30072%, ['desc'] = %ref_30073%}},},~

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) AND (me_power_spells = 1) BEGIN

COPY_EXISTING ~mepr556.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mepr556 END
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		numheaders = numheaders + 1
	END
	FOR (i = 1; i <= numheaders; ++i) BEGIN
		LPF ALTER_SPELL_EFFECT INT_VAR header=i duration_high=(i * 3) END
	END
	SAY NAME1 @31556
	SAY UNIDENTIFIED_DESC @32556
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR556~ class_include=~{209}~ END

END

COPY_EXISTING ~mepr557.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displaystring parameter1=RESOLVE_STR_REF(@30151) END
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		numheaders = numheaders + 1
	END
	FOR (i = 1; i <= numheaders; ++i) BEGIN
		LPF ALTER_SPELL_EFFECT INT_VAR header=i duration_high=(i * 6) END
	END
	SAY NAME1 @31557
	SAY UNIDENTIFIED_DESC @32557
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR557~ class_include=~{208, 209, 21}~ END

COPY_EXISTING ~mepr558.spl~ ~override~
	SAY NAME1 @31558
	SAY UNIDENTIFIED_DESC @32558
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR558~ class_include=~{204, 207}~ END

COPY_EXISTING ~mesos01.spl~ ~override~
	SAY NAME1 @30141

COPY_EXISTING ~mesos02.spl~ ~override~
	SAY NAME1 @30142

COPY_EXISTING ~mesos03.spl~ ~override~
	SAY NAME1 @30143

COPY_EXISTING ~mesos04.spl~ ~override~
	SAY NAME1 @30144

COPY_EXISTING ~mesos05.spl~ ~override~
	SAY NAME1 @30145

COPY_EXISTING ~mesos06.spl~ ~override~
	SAY NAME1 @30146

COPY_EXISTING ~mesos07.spl~ ~override~
	SAY NAME1 @30147

COPY_EXISTING_REGEXP ~mesos0[1-7]\.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mepr558 END
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		numheaders = numheaders + 1
	END
	FOR (i = 1; i <= numheaders; ++i) BEGIN
		LPF ALTER_SPELL_EFFECT INT_VAR header=i duration_high=(i * 6) END
	END
	SAY UNIDENTIFIED_DESC @32558

COPY_EXISTING_REGEXP ~mesos0[1-7]d\.spl~ ~override~
	LPF ALTER_SPELL_HEADER INT_VAR projectile=meinap10 END

COPY_EXISTING ~mepr652.spl~ ~override~
	SAY NAME1 @31652
	SAY UNIDENTIFIED_DESC @32652
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowbreathnegates%~ END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR652~ class_include=~{208, 209, 21}~ END

COPY_EXISTING ~mepr653.spl~ ~override~
	SAY NAME1 @31653
	SAY UNIDENTIFIED_DESC @32653
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR653~ class_include=~{204, 207}~ END

COPY_EXISTING ~mepr654.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mepr654 END
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		LPF ALTER_SPELL_EFFECT INT_VAR header=(i + 1) match_opcode=333 parameter1=(i + 1) parameter2=(i + 1) END
		LPF ALTER_SPELL_EFFECT INT_VAR header=(i + 1) duration_high=((i + 1) * 6) END
		numheaders = numheaders + 1
	END
	SAY NAME1 @31654
	SAY UNIDENTIFIED_DESC @32654
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowspellnegates%~ END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR654~ class_include=~{208, 209, 21}~ END

COPY_EXISTING ~mepr654d.spl~ ~override~
	PATCH_IF NOT MOD_IS_INSTALLED ~EEex.tp2~ ~0~ BEGIN
		LPF ALTER_SPELL_HEADER INT_VAR projectile=melivlig END
	END ELSE BEGIN
		LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=castspell opcode=eeexinvokelua parameter1=0x5250454D parameter2=0x45343536 savingthrow=0x1740000 special=240 STR_VAR match_resource=~mepr654e~ resource=~MERANDSP~ END
	END

COPY_EXISTING ~mepr654e.spl~ ~override~
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		LPF ALTER_SPELL_EFFECT INT_VAR header=(i + 1) match_opcode=damage dicenumber=((i + 1) / 2) END
		LPF ALTER_SPELL_EFFECT INT_VAR header=(i + 1) duration_high=((i + 1) * 6) END
		numheaders = numheaders + 1
	END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) AND (me_power_spells = 1) BEGIN

COPY_EXISTING ~mepr655.spl~ ~override~
	SAY NAME1 @31655
	SAY UNIDENTIFIED_DESC @32655
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

COPY_EXISTING ~mepr655d.spl~ ~override~
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		LPF ALTER_SPELL_EFFECT INT_VAR header=(i + 1) duration_high=((i + 1) * 6) END
		numheaders = numheaders + 1
	END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR655~ class_include=~{21}~ END

END

COPY_EXISTING ~mepr656.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displaystring parameter1=RESOLVE_STR_REF(@30099) END
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mepr656 END
	SAY NAME1 @31656
	SAY UNIDENTIFIED_DESC @32656
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR656~ kit_include=~{0x4011}~ END

COPY_EXISTING ~mepr657.spl~ ~override~
	LPF ALTER_SPELL_HEADER INT_VAR projectile=mewofir2 END
	SAY NAME1 @31657
	SAY UNIDENTIFIED_DESC @32657
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR657~ class_include=~{204, 207}~ END

OUTER_SPRINT stringlevel6 @3506
OUTER_SPRINT stringlevel7 @3507
COPY_EXISTING ~sppr702.spl~ ~override/mepr658.spl~
	WRITE_LONG spelllevel 6
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=1 match_power=7 power=6 END
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 STR_VAR match_resource=~sppr702~ resource= EVAL ~mepr658~ END
	LPF REPLACE_IN_SPELL_DESCRIPTION INT_VAR new_string=1 STR_VAR match= EVAL ~%stringlevel7%~ replace_with= EVAL ~%stringlevel6%~ END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR658~ class_include=~{208, 209, 21}~ END

COPY_EXISTING ~hidespl.2da~ ~override~
	COUNT_2DA_COLS numcolumns
	COUNT_2DA_ROWS numcolumns numrows
	PATCH_IF numcolumns = 3 BEGIN
		INSERT_2DA_ROW numrows numcolumns ~SPPR702    1          0~
	END ELSE PATCH_IF numcolumns = 4 BEGIN
		INSERT_2DA_ROW numrows numcolumns ~SPPR702    1          0          0~
	END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) AND (me_power_spells = 1) BEGIN

COPY_EXISTING ~mepr659.spl~ ~override~
	LPF ALTER_SPELL_HEADER INT_VAR projectile=mestwnst END
	SAY NAME1 @31659
	SAY UNIDENTIFIED_DESC @32659
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF EXCLUDE_SPELL_FROM_CONTINGENCY STR_VAR resource= EVAL ~MEPR659~ END

LAF RESTRICT_HLA STR_VAR resref=~MEPR659~ class_level=~{[12] = 30, }~ END

OUTER_SET ranger_level_six = 1
COPY_EXISTING ~mxsplran.2da~ ~override~
	COUNT_2DA_COLS numcolumns
	COUNT_2DA_ROWS numcolumns numrows
	PATCH_IF numcolumns > 5 BEGIN
		FOR (i = 0; i < numrows; ++i) BEGIN
			READ_2DA_ENTRY i 5 numcolumns num_spells_level_six
			PATCH_IF num_spells_level_six > 0 BEGIN
				READ_2DA_ENTRY i 0 numcolumns ranger_level_six
				i = numrows
			END
		END
	END
	BUT_ONLY_IF_IT_CHANGES

ACTION_IF ranger_level_six > 1 BEGIN

COPY_EXISTING ~lura0.2da~ ~override~ ~lucr0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEPR659~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEPR659~

COPY_EXISTING ~kitlist.2da~ ~override~
	COUNT_2DA_COLS numcolumns
	COUNT_2DA_ROWS numcolumns numrows
	FOR (i = 1; i < numrows; ++i) BEGIN
		READ_2DA_ENTRY i 8 numcolumns theclass
		PATCH_IF (~%theclass%~ STRING_EQUAL_CASE ~12~) BEGIN
			READ_2DA_ENTRY i 1 numcolumns theclassname
			PATCH_IF NOT (~%theclassname%~ STRING_EQUAL_CASE ~FERALAN~) BEGIN
				INNER_ACTION BEGIN
					COPY_EXISTING ~luabbr.2da~ ~override~
						LPF GET_2DA_ROW INT_VAR found_it=1 STR_VAR match= EVAL ~%theclassname%~ RET numcolumns2=numcols row=matched END
						PATCH_IF row > ~-1~ BEGIN
							READ_2DA_ENTRY row 1 numcolumns2 thehlatable
							INNER_ACTION BEGIN
								COPY_EXISTING ~lu%thehlatable%.2da~ ~override~
									LPF ADD_HLA STR_VAR ability=~GA_MEPR659~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
									IF_EXISTS
									UNLESS ~GA_MEPR659~
							END
						END
						BUT_ONLY_IF_IT_CHANGES
				END
			END
		END
	END
	BUT_ONLY_IF_IT_CHANGES


/*

	COPY_EXISTING ~kitlist.2da~ ~override~
		COUNT_2DA_ROWS 10 numrows
		FOR (i = 1; i < numrows; ++i) BEGIN
			READ_2DA_ENTRY i 8 10 class_of_kit
			PATCH_IF class_of_kit=classranger BEGIN
				READ_2DA_ENTRY i 5 10 abilities_of_kit
				INNER_ACTION BEGIN
					COPY_EXISTING ~%abilities_of_kit%.2da~ ~override~
						COUNT_2DA_ROWS 1 numrows_2
						INSERT_2DA_ROW numrows_2 1 ~ME_PR659   ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****~
						SET_2DA_ENTRY numrows_2 ranger_level_six 1 ~GA_MEPR659~
						IF_EXISTS
						UNLESS ~GA_MEPR659~
				END
			END
		END

	COPY_EXISTING ~clabrn01.2da~ ~override~
		COUNT_2DA_ROWS 1 numrows
		INSERT_2DA_ROW numrows 1 ~ME_PR659   ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****~
		SET_2DA_ENTRY numrows ranger_level_six 1 ~GA_MEPR659~
		IF_EXISTS
		UNLESS ~GA_MEPR659~
*/
END


END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

OUTER_SET do_not_install_animal_growth = 0
OUTER_SET animal_growth_found = 0

ACTION_IF (MOD_IS_INSTALLED ~setup-spell_rev.tp2~ ~0~) BEGIN

PRINT @1530

ACTION_READLN ~animal_growth_decision~

OUTER_WHILE !(IS_AN_INT %animal_growth_decision%) OR (%animal_growth_decision% != 2 AND %animal_growth_decision% != 3 AND %animal_growth_decision% != 4) BEGIN
	ACTION_IF %animal_growth_decision% = 1 BEGIN
		PRINT @1531
	END ELSE BEGIN
		PRINT @1502
	END
	ACTION_READLN ~animal_growth_decision~
END

ACTION_IF animal_growth_decision = 2 BEGIN
	OUTER_SET do_not_install_animal_growth = 1
END ELSE ACTION_IF animal_growth_decision = 3 BEGIN

	OUTER_SPRINT stringanimalgrowthname @31660
	COPY_EXISTING_REGEXP ~sppr5[0-9][0-9]\.spl~ ~override~
		READ_LONG NAME1 thespellnameref
		GET_STRREF thespellnameref thespellname
		PATCH_IF (camouflage_found = 0) AND (~%thespellname%~ STRING_EQUAL_CASE ~%stringanimalgrowthname%~) BEGIN
			animal_growth_found = 1
			TEXT_SPRINT animal_growth_res ~%SOURCE_RES%~
		END
		BUT_ONLY_IF_IT_CHANGES

END

END

ACTION_IF animal_growth_found = 1 BEGIN

	COPY_EXISTING ~hidespl.2da~ ~override~
		COUNT_2DA_COLS numcolumns
		COUNT_2DA_ROWS numcolumns numrows
		PATCH_IF numcolumns = 3 BEGIN
			INSERT_2DA_ROW numrows numcolumns ~%animal_growth_res%    1          0~
		END ELSE PATCH_IF numcolumns = 4 BEGIN
			INSERT_2DA_ROW numrows numcolumns ~%animal_growth_res%    1          0          1~
		END

END

ACTION_IF do_not_install_animal_growth = 0 BEGIN

COPY_EXISTING ~mepr660.spl~ ~override~
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		numheaders = numheaders + 1
	END
	FOR (i = 1; i <= numheaders; ++i) BEGIN
		LPF ALTER_SPELL_EFFECT INT_VAR header=i duration_high=((i * 3) + 30) END
	END
	SAY NAME1 @31660
	SAY UNIDENTIFIED_DESC @32660
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR660~ class_include=~{208, 209, 21}~ END

END

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mepr661.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mepr661 END
	SAY NAME1 @31661
	SAY UNIDENTIFIED_DESC @32661
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_range= EVAL ~%stringrangemedium%~ END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR661~ class_include=~{207}~ END

END

COPY_EXISTING ~mepr751.spl~ ~override~
	SAY NAME1 @31751
	SAY UNIDENTIFIED_DESC @32751
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR751~ class_include=~{204, 207, 208, 209, 21}~ END

ACTION_IF (me_power_spells = 1) BEGIN

COPY_EXISTING ~mepr753.spl~ ~override~
	SAY NAME1 @31753
	SAY UNIDENTIFIED_DESC @32753
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR753~ class_include=~{204, 207}~ END

END

COPY_EXISTING ~mepr754.spl~ ~override~
	LPF ALTER_SPELL_HEADER INT_VAR projectile=meverdig END
	PATCH_IF innate_hla = 1 BEGIN
		WRITE_SHORT spelltype 4
		WRITE_LONG spelllevel 1
		LPF ALTER_SPELL_HEADER INT_VAR location=4 END
	END
	SAY NAME1 @31754
	SAY UNIDENTIFIED_DESC @32754
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowdeathnegates%~ END
/*
ACTION_IF NOT FILE_EXISTS_IN_GAME ~AvengerHLAFix.txt~ BEGIN

COPY ~MESpells/mrk/AvengerHLAFix.txt~ ~override~

APPEND ~luabbr.2da~
~
AVENGER                 Dr0
~

END
*/

COPY_EXISTING ~ludr0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEPR754~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEPR754~

COPY_EXISTING ~lufd0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEPR754~ min_lev=~16~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEPR754~

COPY_EXISTING ~kitlist.2da~ ~override~
	COUNT_2DA_COLS numcolumns
	COUNT_2DA_ROWS numcolumns numrows
	FOR (i = 1; i < numrows; ++i) BEGIN
		READ_2DA_ENTRY i 8 numcolumns theclass
		PATCH_IF (~%theclass%~ STRING_EQUAL_CASE ~11~) BEGIN
			READ_2DA_ENTRY i 1 numcolumns theclassname
			INNER_ACTION BEGIN
				COPY_EXISTING ~luabbr.2da~ ~override~
					LPF GET_2DA_ROW INT_VAR found_it=1 STR_VAR match= EVAL ~%theclassname%~ RET numcolumns2=numcols row=matched END
					PATCH_IF row > ~-1~ BEGIN
						READ_2DA_ENTRY row 1 numcolumns2 thehlatable
						INNER_ACTION BEGIN
							COPY_EXISTING ~lu%thehlatable%.2da~ ~override~
								LPF ADD_HLA STR_VAR ability=~GA_MEPR754~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
								IF_EXISTS
								UNLESS ~GA_MEPR754~
						END
					END
					BUT_ONLY_IF_IT_CHANGES
			END
		END
	END
	BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING ~mepr755.spl~ ~override~
	SAY NAME1 @31755
	SAY UNIDENTIFIED_DESC @32755
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR755~ class_include=~{204, 207}~ END

COPY_EXISTING ~mepr756.spl~ ~override~
	PATCH_IF innate_hla = 1 BEGIN
		WRITE_SHORT spelltype 4
		WRITE_LONG spelllevel 1
		LPF ALTER_SPELL_HEADER INT_VAR location=4 END
	END
	SAY NAME1 @31756
	SAY UNIDENTIFIED_DESC @32756
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

COPY_EXISTING ~mepr756d.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR match_opcode=protectionfromspell match_parameter1=30037 parameter1=RESOLVE_STR_REF(@30037) END
	SAY NAME1 @31756
	SAY UNIDENTIFIED_DESC @32756

COPY_EXISTING_REGEXP ~.*\.are~ ~override~
	READ_LONG 0x14 theareaflags
	theareaflags|=0x10
	WRITE_LONG 0x14 theareaflags
	BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING ~baldur.bcs~ ~override~ ~baldur25.bcs~ ~override~ ~bdbaldur.bcs~ ~override~
	DECOMPILE_AND_PATCH BEGIN
		REPLACE_TEXTUALLY ~!InParty(Player1)~ ~!InParty(Player1)
!CheckSpellState(Player1,FAVORED_OF_THE_SPIRITS)~
	END
	IF_EXISTS
	BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING ~lucl0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEPR756~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEPR756~

COPY_EXISTING ~lucm0.2da~ ~override~ ~lucr0.2da~ ~override~ ~luct0.2da~ ~override~ ~lufc0.2da~ ~override~ ~lufmc.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEPR756~ min_lev=~16~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEPR756~

COPY_EXISTING ~kitlist.2da~ ~override~
	COUNT_2DA_COLS numcolumns
	COUNT_2DA_ROWS numcolumns numrows
	FOR (i = 1; i < numrows; ++i) BEGIN
		READ_2DA_ENTRY i 8 numcolumns theclass
		PATCH_IF (~%theclass%~ STRING_EQUAL_CASE ~3~) BEGIN
			READ_2DA_ENTRY i 1 numcolumns theclassname
			INNER_ACTION BEGIN
				COPY_EXISTING ~luabbr.2da~ ~override~
					LPF GET_2DA_ROW INT_VAR found_it=1 STR_VAR match= EVAL ~%theclassname%~ RET numcolumns2=numcols row=matched END
					PATCH_IF row > ~-1~ BEGIN
						READ_2DA_ENTRY row 1 numcolumns2 thehlatable
						INNER_ACTION BEGIN
							COPY_EXISTING ~lu%thehlatable%.2da~ ~override~
								LPF ADD_HLA STR_VAR ability=~GA_MEPR756~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
								IF_EXISTS
								UNLESS ~GA_MEPR756~
						END
					END
					BUT_ONLY_IF_IT_CHANGES
			END
		END
	END
	BUT_ONLY_IF_IT_CHANGES

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mepr757.spl~ ~override~
	SAY NAME1 @31757
	SAY UNIDENTIFIED_DESC @32757
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR757~ class_include=~{204, 207}~ END

END

COPY_EXISTING ~mepr758.spl~ ~override~
	PATCH_IF innate_hla = 1 BEGIN
		WRITE_SHORT spelltype 4
		WRITE_LONG spelllevel 1
		LPF ALTER_SPELL_HEADER INT_VAR location=4 END
	END
	SAY NAME1 @31758
	SAY UNIDENTIFIED_DESC @32758
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

COPY_EXISTING ~lucl0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEPR758~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEPR758~

COPY_EXISTING ~lucm0.2da~ ~override~ ~lucr0.2da~ ~override~ ~luct0.2da~ ~override~ ~lufc0.2da~ ~override~ ~lufmc.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEPR758~ min_lev=~16~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEPR758~

COPY_EXISTING ~kitlist.2da~ ~override~
	COUNT_2DA_COLS numcolumns
	COUNT_2DA_ROWS numcolumns numrows
	FOR (i = 1; i < numrows; ++i) BEGIN
		READ_2DA_ENTRY i 8 numcolumns theclass
		PATCH_IF (~%theclass%~ STRING_EQUAL_CASE ~3~) BEGIN
			READ_2DA_ENTRY i 1 numcolumns theclassname
			INNER_ACTION BEGIN
				COPY_EXISTING ~luabbr.2da~ ~override~
					LPF GET_2DA_ROW INT_VAR found_it=1 STR_VAR match= EVAL ~%theclassname%~ RET numcolumns2=numcols row=matched END
					PATCH_IF row > ~-1~ BEGIN
						READ_2DA_ENTRY row 1 numcolumns2 thehlatable
						INNER_ACTION BEGIN
							COPY_EXISTING ~lu%thehlatable%.2da~ ~override~
								LPF ADD_HLA STR_VAR ability=~GA_MEPR758~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
								IF_EXISTS
								UNLESS ~GA_MEPR758~
						END
					END
					BUT_ONLY_IF_IT_CHANGES
			END
		END
	END
	BUT_ONLY_IF_IT_CHANGES

ACTION_IF (me_power_spells = 1) BEGIN

COPY_EXISTING ~mepr759.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi855 END
	SAY NAME1 @31759
	SAY UNIDENTIFIED_DESC @32759
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR759~ class_include=~{21}~ END
/*
COPY_EXISTING ~lush0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEPR759~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEPR759~

COPY_EXISTING ~kitlist.2da~ ~override~
	COUNT_2DA_COLS numcolumns
	COUNT_2DA_ROWS numcolumns numrows
	FOR (i = 1; i < numrows; ++i) BEGIN
		READ_2DA_ENTRY i 8 numcolumns theclass
		PATCH_IF (~%theclass%~ STRING_EQUAL_CASE ~21~) BEGIN
			READ_2DA_ENTRY i 1 numcolumns theclassname
			INNER_ACTION BEGIN
				COPY_EXISTING ~luabbr.2da~ ~override~
					LPF GET_2DA_ROW INT_VAR found_it=1 STR_VAR match= EVAL ~%theclassname%~ RET numcolumns2=numcols row=matched END
					PATCH_IF row > ~-1~ BEGIN
						READ_2DA_ENTRY row 1 numcolumns2 thehlatable
						INNER_ACTION BEGIN
							COPY_EXISTING ~lu%thehlatable%.2da~ ~override~
								LPF ADD_HLA STR_VAR ability=~GA_MEPR759~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
								IF_EXISTS
								UNLESS ~GA_MEPR759~
						END
					END
					BUT_ONLY_IF_IT_CHANGES
			END
		END
	END
	BUT_ONLY_IF_IT_CHANGES
*/
END

ACTION_IF (me_power_spells = 1) AND !(GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~mepr760.spl~ ~override~
	SAY NAME1 @31760
	SAY UNIDENTIFIED_DESC @32760
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR760~ class_include=~{204, 207, 208, 209, 21}~ END

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mepr761.spl~ ~override~
	PATCH_IF innate_hla = 1 BEGIN
		WRITE_SHORT spelltype 4
		WRITE_LONG spelllevel 1
		LPF ALTER_SPELL_HEADER INT_VAR location=4 END
	END
	SAY NAME1 @31761
	SAY UNIDENTIFIED_DESC @32761
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowbreathhalf%~ END

COPY_EXISTING ~ludr0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEPR761~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEPR761~

COPY_EXISTING ~lufd0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEPR761~ min_lev=~16~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEPR761~

COPY_EXISTING ~kitlist.2da~ ~override~
	COUNT_2DA_COLS numcolumns
	COUNT_2DA_ROWS numcolumns numrows
	FOR (i = 1; i < numrows; ++i) BEGIN
		READ_2DA_ENTRY i 8 numcolumns theclass
		PATCH_IF (~%theclass%~ STRING_EQUAL_CASE ~11~) BEGIN
			READ_2DA_ENTRY i 1 numcolumns theclassname
			INNER_ACTION BEGIN
				COPY_EXISTING ~luabbr.2da~ ~override~
					LPF GET_2DA_ROW INT_VAR found_it=1 STR_VAR match= EVAL ~%theclassname%~ RET numcolumns2=numcols row=matched END
					PATCH_IF row > ~-1~ BEGIN
						READ_2DA_ENTRY row 1 numcolumns2 thehlatable
						INNER_ACTION BEGIN
							COPY_EXISTING ~lu%thehlatable%.2da~ ~override~
								LPF ADD_HLA STR_VAR ability=~GA_MEPR761~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
								IF_EXISTS
								UNLESS ~GA_MEPR761~
						END
					END
					BUT_ONLY_IF_IT_CHANGES
			END
		END
	END
	BUT_ONLY_IF_IT_CHANGES

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

ACTION_IF NOT MOD_IS_INSTALLED ~MESpells.tp2~ ~29111~ BEGIN

	COPY ~MESpells/New_Meteor_Swarm~ ~override~

	COPY_EXISTING ~missile.ids~ ~override~
		COUNT_2DA_ROWS 2 numrows
		READ_2DA_ENTRY (numrows - 1) 0 2 newrow
		newrow = newrow + 1
		startrow = newrow
		FOR (i = 1; i <= 50; ++i) BEGIN
	 		INSERT_2DA_ROW numrows 2 ~%newrow% New Meteor Swarm %i%~
			numrows = numrows + 1
			newrow = newrow + 1
		END
	
	COPY_EXISTING ~projectl.ids~ ~override~
		COUNT_2DA_ROWS 2 numrows
		READ_2DA_ENTRY (numrows - 1) 0 2 newrow
		newrow = newrow + 1
		FOR (i = 1; i <= 50; ++i) BEGIN
			INSERT_2DA_ROW numrows 2 ~%newrow% memswa%i%~
			numrows = numrows + 1
			newrow = newrow + 1
		END
	
	COPY_EXISTING ~memswarx.pro~ ~override~
		READ_SHORT 0x200 theareaflags
		theareaflags&=0xFEFF
		WRITE_SHORT 0x200 theareaflags
	
	OUTER_FOR (i = 1; i <= 50; ++i) BEGIN
		COPY_EXISTING ~memswarx.pro~ ~override/memswa%i%.pro~
			WRITE_BYTE 0x216 i
	END
END ELSE BEGIN
	COPY_EXISTING ~projectl.ids~ ~override~
		COUNT_2DA_ROWS 2 numrows
		FOR (i = 1; i < numrows; ++i) BEGIN
			READ_2DA_ENTRY i 1 2 theprojectilename
			PATCH_IF (~%theprojectilename%~ STRING_EQUAL_CASE ~memswa1~) BEGIN
				READ_2DA_ENTRY (i + 1) 0 2 startrow
			END
		END
END

COPY_EXISTING ~mepr762.spl~ ~override~
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		numheaders = numheaders + 1
	END
	FOR (i = 1; i <= numheaders; ++i) BEGIN
		LPF ALTER_SPELL_HEADER INT_VAR header=i projectile=startrow END
		startrow = startrow + 1
	END
	SAY NAME1 @31762
	SAY UNIDENTIFIED_DESC @32762
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowspellhalf%~ END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEPR762~ class_include=~{204, 207}~ END

COPY_EXISTING ~mepr762d.spl~ ~override~
	LPF ALTER_SPELL_HEADER INT_VAR projectile=meelyst END

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~missile.ids~ ~override~
	COUNT_2DA_ROWS 2 numrows
	READ_2DA_ENTRY (numrows - 1) 0 2 newrow
	newrow = newrow + 1
	startrow = newrow
	FOR (i = 1; i <= 5; ++i) BEGIN
 		INSERT_2DA_ROW numrows 2 ~%newrow% True Living Lightning %i%~
		numrows = numrows + 1
		newrow = newrow + 1
	END

COPY_EXISTING ~projectl.ids~ ~override~
	COUNT_2DA_ROWS 2 numrows
	READ_2DA_ENTRY (numrows - 1) 0 2 newrow
	newrow = newrow + 1
	FOR (i = 1; i <= 5; ++i) BEGIN
		INSERT_2DA_ROW numrows 2 ~%newrow% meligl%i%~
		numrows = numrows + 1
		newrow = newrow + 1
	END

COPY_EXISTING ~meligl1.pro~ ~override~
	WRITE_SHORT 0x21A meslight

OUTER_FOR (i = 2; i <= 5; ++i) BEGIN
	COPY_EXISTING ~meligl1.pro~ ~override/meligl%i%.pro~
		WRITE_SHORT 0x202 i
		WRITE_SHORT 0x224 (360 / i)
END

COPY_EXISTING ~mepr763.spl~ ~override~
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 5; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=((i * 10) + 5) END
		numheaders = numheaders + 1
	END
	FOR (i = 1; i <= numheaders; ++i) BEGIN
		LPF ALTER_SPELL_HEADER INT_VAR header=i projectile=startrow END
		startrow = startrow + 1
	END
	SAY NAME1 @31763
	SAY UNIDENTIFIED_DESC @32763
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowbreathhalf%~ END

COPY_EXISTING ~ludr0.2da~ ~override~ ~lush0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEPR763~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEPR763~

COPY_EXISTING ~lufd0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEPR763~ min_lev=~16~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEPR763~

COPY_EXISTING ~kitlist.2da~ ~override~
	COUNT_2DA_COLS numcolumns
	COUNT_2DA_ROWS numcolumns numrows
	FOR (i = 1; i < numrows; ++i) BEGIN
		READ_2DA_ENTRY i 8 numcolumns theclass
		PATCH_IF (~%theclass%~ STRING_EQUAL_CASE ~11~) OR (~%theclass%~ STRING_EQUAL_CASE ~21~) BEGIN
			READ_2DA_ENTRY i 1 numcolumns theclassname
			INNER_ACTION BEGIN
				COPY_EXISTING ~luabbr.2da~ ~override~
					LPF GET_2DA_ROW INT_VAR found_it=1 STR_VAR match= EVAL ~%theclassname%~ RET numcolumns2=numcols row=matched END
					PATCH_IF row > ~-1~ BEGIN
						READ_2DA_ENTRY row 1 numcolumns2 thehlatable
						INNER_ACTION BEGIN
							COPY_EXISTING ~lu%thehlatable%.2da~ ~override~
								LPF ADD_HLA STR_VAR ability=~GA_MEPR763~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
								IF_EXISTS
								UNLESS ~GA_MEPR763~
						END
					END
					BUT_ONLY_IF_IT_CHANGES
			END
		END
	END
	BUT_ONLY_IF_IT_CHANGES

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mepr764.spl~ ~override~
	PATCH_IF innate_hla = 1 BEGIN
		WRITE_SHORT spelltype 4
		WRITE_LONG spelllevel 1
		LPF ALTER_SPELL_HEADER INT_VAR location=4 END
	END
	LPF ALTER_SPELL_HEADER INT_VAR projectile=metornad END
	SAY NAME1 @31764
	SAY UNIDENTIFIED_DESC @32764
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

COPY_EXISTING ~ludr0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEPR764~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEPR764~

COPY_EXISTING ~lufd0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEPR764~ min_lev=~16~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEPR764~

COPY_EXISTING ~kitlist.2da~ ~override~
	COUNT_2DA_COLS numcolumns
	COUNT_2DA_ROWS numcolumns numrows
	FOR (i = 1; i < numrows; ++i) BEGIN
		READ_2DA_ENTRY i 8 numcolumns theclass
		PATCH_IF (~%theclass%~ STRING_EQUAL_CASE ~11~) BEGIN
			READ_2DA_ENTRY i 1 numcolumns theclassname
			INNER_ACTION BEGIN
				COPY_EXISTING ~luabbr.2da~ ~override~
					LPF GET_2DA_ROW INT_VAR found_it=1 STR_VAR match= EVAL ~%theclassname%~ RET numcolumns2=numcols row=matched END
					PATCH_IF row > ~-1~ BEGIN
						READ_2DA_ENTRY row 1 numcolumns2 thehlatable
						INNER_ACTION BEGIN
							COPY_EXISTING ~lu%thehlatable%.2da~ ~override~
								LPF ADD_HLA STR_VAR ability=~GA_MEPR764~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
								IF_EXISTS
								UNLESS ~GA_MEPR764~
						END
					END
					BUT_ONLY_IF_IT_CHANGES
			END
		END
	END
	BUT_ONLY_IF_IT_CHANGES

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) AND (me_power_spells = 1) BEGIN

COPY_EXISTING ~mepr765.spl~ ~override~
	PATCH_IF innate_hla = 1 BEGIN
		WRITE_SHORT spelltype 4
		WRITE_LONG spelllevel 1
		LPF ALTER_SPELL_HEADER INT_VAR location=4 END
	END
	SAY NAME1 @31765
	SAY UNIDENTIFIED_DESC @32765

COPY_EXISTING ~mepr765e.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=protectionfromspell parameter1=RESOLVE_STR_REF(@30116) STR_VAR match_resource=~MEPR765~ END
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displaystring parameter1=RESOLVE_STR_REF(@30117) STR_VAR match_resource=~MEPR765~ END
	SAY NAME1 @30118
	SAY UNIDENTIFIED_DESC @30119

EXTEND_BOTTOM ~baldur.bcs~ ~override/mespipol.bcs~

ACTION_IF FILE_EXISTS_IN_GAME ~baldur25.bcs~ BEGIN
	EXTEND_BOTTOM ~baldur25.bcs~ ~override/mespipol.bcs~
END

END

COPY_EXISTING ~mepr766.spl~ ~override~
	PATCH_IF innate_hla = 1 BEGIN
		WRITE_SHORT spelltype 4
		WRITE_LONG spelllevel 1
		LPF ALTER_SPELL_HEADER INT_VAR location=4 END
	END
	SAY NAME1 @31766
	SAY UNIDENTIFIED_DESC @32766
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowspellnegates%~ END

COPY_EXISTING ~mepr766.spl~ ~override~ ~mepr766d.spl~ ~override~
	LPF ALTER_SPELL_HEADER INT_VAR projectile=meinar15 END

COPY_EXISTING ~lucl0.2da~ ~override~ ~lush0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEPR766~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEPR766~

COPY_EXISTING ~lucm0.2da~ ~override~ ~lucr0.2da~ ~override~ ~luct0.2da~ ~override~ ~lufc0.2da~ ~override~ ~lufmc.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEPR766~ min_lev=~16~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEPR766~

COPY_EXISTING ~kitlist.2da~ ~override~
	COUNT_2DA_COLS numcolumns
	COUNT_2DA_ROWS numcolumns numrows
	FOR (i = 1; i < numrows; ++i) BEGIN
		READ_2DA_ENTRY i 8 numcolumns theclass
		PATCH_IF (~%theclass%~ STRING_EQUAL_CASE ~3~) OR (~%theclass%~ STRING_EQUAL_CASE ~21~) BEGIN
			READ_2DA_ENTRY i 1 numcolumns theclassname
			INNER_ACTION BEGIN
				COPY_EXISTING ~luabbr.2da~ ~override~
					LPF GET_2DA_ROW INT_VAR found_it=1 STR_VAR match= EVAL ~%theclassname%~ RET numcolumns2=numcols row=matched END
					PATCH_IF row > ~-1~ BEGIN
						READ_2DA_ENTRY row 1 numcolumns2 thehlatable
						INNER_ACTION BEGIN
							COPY_EXISTING ~lu%thehlatable%.2da~ ~override~
								LPF ADD_HLA STR_VAR ability=~GA_MEPR766~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
								IF_EXISTS
								UNLESS ~GA_MEPR766~
						END
					END
					BUT_ONLY_IF_IT_CHANGES
			END
		END
	END
	BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING ~mewi151.spl~ ~override~
	SAY NAME1 @33151
	SAY UNIDENTIFIED_DESC @34151

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI151~ scroll=~MEWI151X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi151x.itm~ ~override~
	SAY NAME2 @33151
	SAY IDENTIFIED_DESC @34151
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~neadoy.dlg~ ~override~
	DECOMPILE_AND_PATCH BEGIN
		REPLACE_TEXTUALLY ~GiveItem(\"NEBELT01\",Player1)~ ~GiveItem("NEBELT01",Player1)
GiveItemCreate("MEWI151X",Player1,1,0,0)~
	END
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi151x~ AFTER ~scrl70~ #1 #0 #0 ~IDENTIFIED~ #5
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~oh6100.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=3 STR_VAR item_to_add=~mewi151x~ END
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi151x~ BEFORE ~scrl71~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi151x~ AFTER ~scrl70~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~kuork0.sto~ ~override~
	ADD_STORE_ITEM ~mewi151x~ #1 #0 #0 ~IDENTIFIED~ #1

END

COPY_EXISTING ~mewi152.spl~ ~override~
	SAY NAME1 @33152
	SAY UNIDENTIFIED_DESC @34152

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI152~ scroll=~MEWI152X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi152x.itm~ ~override~
	SAY NAME2 @33152
	SAY IDENTIFIED_DESC @34152
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowpolymorphnegates%~ END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~%arbg%5405.are~ ~override~
	LPF REPLACE_AREA_ITEM INT_VAR STR_VAR old_item=~scrl81~ new_item=~mewi152x~ END
	
COPY_EXISTING ~sto0703.sto~ ~override~ //Sorcerous Sundries
	ADD_STORE_ITEM ~mewi152x~ AFTER ~scrl76~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS	

COPY_EXISTING ~bdbeleg3.sto~ ~override~
	ADD_STORE_ITEM ~mewi152x~ BEFORE ~scrl76~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi152x~ BEFORE ~scrl76~ #1 #0 #0 ~IDENTIFIED~ #5
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0603.are~ ~override~ //Chateau Irenicus, second floor
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=17 STR_VAR item_to_add=~mewi152x~ END

COPY_EXISTING ~shop08.sto~ ~override~ //Galoomp the Bookkeeper
	ADD_STORE_ITEM ~mewi152x~ AFTER ~scrl76~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi152x~ AFTER ~scrl76~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi152x~ BEFORE ~scrl76~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~kuork0.sto~ ~override~
	ADD_STORE_ITEM ~mewi152x~ #1 #0 #0 ~IDENTIFIED~ #1

END
/*

COPY_EXISTING ~mewi153.spl~ ~override~
	SAY NAME1 @33153
	SAY UNIDENTIFIED_DESC @34153

COPY_EXISTING ~mewi153x.itm~ ~override~
	SAY NAME2 @33153
	SAY IDENTIFIED_DESC @34153

COPY_EXISTING ~friend.sto~ ~override~ //Friendly Arm Inn
	ADD_STORE_ITEM ~mewi153x~ BEFORE ~book40~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~sto0703.sto~ ~override~ //Sorcerous Sundries
	ADD_STORE_ITEM ~mewi153x~ AFTER ~scrl70~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi153x~ AFTER ~scrl70~ #1 #0 #0 ~IDENTIFIED~ #5
	IF_EXISTS

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI153~ scroll=~MEWI153X~ class_include=~{202, 5, 19}~ END
*/
ACTION_IF !(MOD_IS_INSTALLED ~setup-spell_rev.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi154.spl~ ~override~
	SAY NAME1 @33154
	SAY UNIDENTIFIED_DESC @34154

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI154~ scroll=~MEWI154X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi154x.itm~ ~override~
	SAY NAME2 @33154
	SAY IDENTIFIED_DESC @34154

COPY_EXISTING ~mekobosu.cre~ ~override~
	SAY NAME1 @30033
	SAY NAME2 @30033

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~tarnes.cre~ ~override~
	ADD_CRE_ITEM ~mewi154x~ #0 #0 #0 ~NONE~ ~INV5~

COPY_EXISTING ~highhedg.sto~ ~override~ //High Hedge
	ADD_STORE_ITEM ~mewi154x~ AFTER ~scrl81~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~sto0703.sto~ ~override~ //Sorcerous Sundries
	ADD_STORE_ITEM ~mewi154x~ AFTER ~scrl81~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi154x~ AFTER ~scrla6~ #1 #0 #0 ~IDENTIFIED~ #5
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0602.are~ ~override~ //Chateau Irenicus, first floor
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=22 STR_VAR item_to_add=~mewi154x~ END

COPY_EXISTING ~shop08.sto~ ~override~ //Galoomp the Bookkeeper
	ADD_STORE_ITEM ~mewi154x~ AFTER ~scrl70~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi154x~ AFTER ~scrla6~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi154x~ AFTER ~scrla6~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar1201.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=2 STR_VAR item_to_add=~mewi154x~ END

COPY_EXISTING ~kuork0.sto~ ~override~
	ADD_STORE_ITEM ~mewi154x~ #1 #0 #0 ~IDENTIFIED~ #1

END
END

ACTION_IF !(MOD_IS_INSTALLED ~setup-spell_rev.tp2~ ~0~) BEGIN

COPY_EXISTING ~spwi402.spl~ ~override/mewi155.spl~
	READ_LONG 0x18 thespellflags
	thespellflags|=0x800
	WRITE_LONG 0x18 thespellflags
	WRITE_LONG spelllevel 1
	LPF ALTER_SPELL_HEADER INT_VAR speed=0 END
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=1 match_power=4 power=1 END
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=1 match_timing=4 timing=1 END
	LPF ADD_SPELL_EFFECT INT_VAR insert_point=0 opcode=immunitytospellandmessage target=1 timing=0 duration=1 parameter2=splprot_areaisanoteleportzone special=RESOLVE_STR_REF(@30030) STR_VAR resource = EVAL ~mewi155~ END
	SAY NAME1 @33155
	SAY UNIDENTIFIED_DESC @34155

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI155~ scroll=~MEWI155X~ class_include=~{202, 5, 19}~ END

ACTION_IF !(GAME_IS ~iwdee~) BEGIN
COPY_EXISTING ~mewi155x.itm~ ~override~
	SAY NAME2 @33155
	SAY IDENTIFIED_DESC @34155
END ELSE BEGIN
COPY_EXISTING ~mewi155x.itm~ ~override/scrl1v.itm~
	SAY NAME2 @33155
	SAY IDENTIFIED_DESC @34155

COPY_EXISTING ~hidespl.2da~ ~override~
	COUNT_2DA_COLS numcolumns
	COUNT_2DA_ROWS numcolumns numrows
	PATCH_IF numcolumns = 3 BEGIN
		INSERT_2DA_ROW numrows numcolumns ~spwi402    1          0~
	END ELSE PATCH_IF numcolumns = 4 BEGIN
		INSERT_2DA_ROW numrows numcolumns ~spwi402    1          0          0~
	END
END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~highhedg.sto~ ~override~ //High Hedge
	ADD_STORE_ITEM ~mewi155x~ AFTER ~scrl83~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~friend.sto~ ~override~ //Friendly Arm Inn
	ADD_STORE_ITEM ~mewi155x~ BEFORE ~book40~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~kirian.cre~ ~override~
	REPLACE_CRE_ITEM ~mewi155x~ #0 #0 #0 ~NONE~ ~INV1~

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi155x~ AFTER ~scrl70~ #1 #0 #0 ~IDENTIFIED~ #5
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar1302.are~ ~override~ //D'Arnise keep, first floor
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=2 STR_VAR item_to_add=~mewi155x~ END

COPY_EXISTING ~ar1512.are~ ~override~ //Spellhold dungeon, first floor
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=18 STR_VAR item_to_add=~mewi155x~ END

COPY_EXISTING ~shop08.sto~ ~override~ //Galoomp the Bookkeeper
	ADD_STORE_ITEM ~mewi155x~ AFTER ~scrl76~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi155x~ AFTER ~scrl76~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi155x~ AFTER ~scrl70~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~kuork0.sto~ ~override~
	ADD_STORE_ITEM ~scrl1v~ AFTER ~scrl70~ #1 #0 #0 ~IDENTIFIED~ #1

END
END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi156.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR check_headers=1 check_globals=0 match_opcode=displaystring parameter1=RESOLVE_STR_REF(@30024) END
	LPF ADD_SPELL_EFFECT INT_VAR insert_point=0 opcode=immunitytospellandmessage target=2 timing=0 duration=1 parameter2=splprot_areaisanoteleportzone special=RESOLVE_STR_REF(@30030) STR_VAR resource = EVAL ~mewi156~ END
	SAY NAME1 @33156
	SAY UNIDENTIFIED_DESC @34156

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI156~ scroll=~MEWI156X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mejmps01.spl~ ~override~ ~mejmps05.spl~ ~override~ ~mejmps10.spl~ ~override~ ~mejmps15.spl~ ~override~ ~mejmps20.spl~ ~override~ ~mejmps25.spl~ ~override~ ~mejmps30.spl~ ~override~
	LPF ADD_SPELL_EFFECT INT_VAR insert_point=2 opcode=immunitytospellandmessage target=1 timing=0 duration=1 parameter2=splprot_areaisanoteleportzone special=RESOLVE_STR_REF(@30030) STR_VAR resource = EVAL ~%SOURCE_RES%~ END
	SAY NAME1 @30025
	SAY UNIDENTIFIED_DESC @30026

COPY_EXISTING ~mewi156x.itm~ ~override~
	SAY NAME2 @33156
	SAY IDENTIFIED_DESC @34156
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~inn3351.sto~ ~override~ //Feldepost's Inn
	ADD_STORE_ITEM ~mewi156x~ AFTER ~scrl5u~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~sto4906.sto~ ~override~ //Carnival Magic Trinkets Shop
	ADD_STORE_ITEM ~mewi156x~ BEFORE ~amul01~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~bdbeleg3.sto~ ~override~
	ADD_STORE_ITEM ~mewi156x~ BEFORE ~scrl84~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi156x~ BEFORE ~scrl84~ #1 #0 #0 ~IDENTIFIED~ #5
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ppmag01.cre~ ~override~
	REPLACE_CRE_ITEM ~mewi156x~ #0 #0 #0 ~NONE~ ~INV3~

COPY_EXISTING ~ribald.sto~ ~override~ //Adventurer Mart
	ADD_STORE_ITEM ~mewi156x~ BEFORE ~scrla5~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi156x~ AFTER ~scrl67~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi156x~ BEFORE ~scrl84~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar5004.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=2 STR_VAR item_to_add=~mewi156x~ END

COPY_EXISTING ~kieran2.sto~ ~override~
	ADD_STORE_ITEM ~mewi156x~ BEFORE ~scrl5u~ #1 #0 #0 ~IDENTIFIED~ #2

END
END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi157.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi157 END
	SAY NAME1 @33157
	SAY UNIDENTIFIED_DESC @34157

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI157~ scroll=~MEWI157X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi157x.itm~ ~override~
	SAY NAME2 @33157
	SAY IDENTIFIED_DESC @34157
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_range= EVAL ~%stringrangelong%~ new_savingthrow= EVAL ~%stringsavingthrowpolymorphnegates%~ END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~yago.cre~ ~override~
	REPLACE_CRE_ITEM ~mewi157x~ #0 #0 #0 ~NONE~ ~INV2~

COPY_EXISTING ~%arbg%5001.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=2 STR_VAR item_to_add=~mewi157x~ END

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi157x~ AFTER ~scrl66~ #1 #0 #0 ~IDENTIFIED~ #5
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~pthral02.cre~ ~override~
	REPLACE_CRE_ITEM ~mewi157x~ #0 #0 #0 ~NONE~ ~INV3~
	IF_EXISTS

COPY_EXISTING ~ar0602.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=23 STR_VAR item_to_add=~mewi157x~ END

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi157x~ AFTER ~scrl67~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi157x~ AFTER ~scrl66~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar3401.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=2 STR_VAR item_to_add=~mewi157x~ END

END
END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi158.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi158 END
	SAY NAME1 @33158
	SAY UNIDENTIFIED_DESC @34158

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI158~ scroll=~MEWI158X~ class_include=~{202, 5, 19}~ END

LAF EXCLUDE_SPELL_FROM_CONTINGENCY STR_VAR resource= EVAL ~mewi158~ END

COPY_EXISTING ~mewi158x.itm~ ~override~
	SAY NAME2 @33158
	SAY IDENTIFIED_DESC @34158
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~jemby.cre~ ~override~
	REPLACE_CRE_ITEM ~mewi158x~ #0 #0 #0 ~NONE~ ~QITEM3~
	IF_EXISTS

COPY_EXISTING ~sto4906.sto~ ~override~ //Carnival Magic Trinkets Shop
	ADD_STORE_ITEM ~mewi158x~ BEFORE ~amul01~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi158x~ BEFORE ~scrl5u~ #1 #0 #0 ~IDENTIFIED~ #5
	IF_EXISTS

COPY_EXISTING ~bdbeleg3.sto~ ~override~
	ADD_STORE_ITEM ~mewi158x~ BEFORE ~scrl5u~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0603.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=17 STR_VAR item_to_add=~mewi158x~ END

COPY_EXISTING ~shop08.sto~ ~override~
	ADD_STORE_ITEM ~mewi158x~ BEFORE ~scrl5u~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi158x~ BEFORE ~scrl5u~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi158x~ BEFORE ~scrl5u~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar3101.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=3 STR_VAR item_to_add=~mewi158x~ END

END
END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi159.spl~ ~override~
	SAY NAME1 @33159
	SAY UNIDENTIFIED_DESC @34159
/*
LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI159~ scroll=~MEWI159X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi159d.spl~ ~override~

COPY_EXISTING ~mewi159x.itm~ ~override~
	SAY NAME2 @33159
	SAY IDENTIFIED_DESC @34159
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowbreathnegates%~ END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~inn3351.sto~ ~override~ //Feldepost's Inn
	ADD_STORE_ITEM ~mewi159x~ AFTER ~mewi156x~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~%arbg%1900.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=7 STR_VAR item_to_add=~mewi159x~ END

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi159x~ AFTER ~mewi154x~ #1 #0 #0 ~IDENTIFIED~ #5
	IF_EXISTS

COPY_EXISTING ~bdbeleg3.sto~ ~override~
	ADD_STORE_ITEM ~mewi159x~ AFTER ~scrl6a~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0405.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=7 STR_VAR item_to_add=~mewi159x~ END

COPY_EXISTING ~shop08.sto~ ~override~
	ADD_STORE_ITEM ~mewi159x~ AFTER ~scrl81~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi159x~ AFTER ~mewi154x~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi159x~ AFTER ~mewi154x~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar3503.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=6 STR_VAR item_to_add=~mewi159x~ END

END
*/
END

COPY_EXISTING ~mewi160.spl~ ~override~
	SAY NAME1 @33160
	SAY UNIDENTIFIED_DESC @34160

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI160~ scroll=~MEWI160X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~medimche.cre~ ~override~
	SAY NAME1 @33160
	SAY NAME2 @33160

COMPILE ~override/medimche.d~

COPY_EXISTING ~medimche.sto~ ~override~
	SAY NAME2 @33160

COPY_EXISTING ~mewi160x.itm~ ~override~
	SAY NAME2 @33160
	SAY IDENTIFIED_DESC @34160
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~gorion.cre~ ~override~
	ADD_CRE_ITEM ~mewi160x~ #0 #0 #0 ~UNSTEALABLE~ ~QITEM3~
	IF_EXISTS

COPY_EXISTING ~highhedg.sto~ ~override~
	ADD_STORE_ITEM ~mewi160x~ AFTER ~scrl70~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi160x~ AFTER ~scrl70~ #1 #0 #0 ~IDENTIFIED~ #5
	IF_EXISTS

COPY_EXISTING ~bd0120.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=16 STR_VAR item_to_add=~mewi160x~ END
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0602.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=23 STR_VAR item_to_add=~mewi160x~ END

COPY_EXISTING ~shop08.sto~ ~override~
	ADD_STORE_ITEM ~mewi160x~ AFTER ~scrl70~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi160x~ AFTER ~scrl70~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi160x~ AFTER ~scrl70~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar1016.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=1 STR_VAR item_to_add=~mewi160x~ END

COPY_EXISTING ~kuork0.sto~ ~override~
	ADD_STORE_ITEM ~mewi160x~ AFTER ~scrl70~ #1 #0 #0 ~IDENTIFIED~ #1

END

COPY_EXISTING ~mewi251.spl~ ~override~
	LPF ADD_SPELL_EFFECT INT_VAR insert_point=0 opcode=protectionfromspell2 target=2 timing=0 duration=1 parameter2=splprot_areaisanoteleportzone special=RESOLVE_STR_REF(@30030) STR_VAR resource = EVAL ~mewi251~ END
	SAY NAME1 @33251
	SAY UNIDENTIFIED_DESC @34251

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI251~ scroll=~MEWI251X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi251x.itm~ ~override~
	SAY NAME2 @33251
	SAY IDENTIFIED_DESC @34251
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~%arbg%0512.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=25 STR_VAR item_to_add=~mewi251x~ END

COPY_EXISTING ~%arbg%1401.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=1 STR_VAR item_to_add=~mewi251x~ END

COPY_EXISTING ~highhedg.sto~ ~override~ //High Hedge
	ADD_STORE_ITEM ~mewi251x~ AFTER ~scrl6e~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~bdbeleg3.sto~ ~override~
	ADD_STORE_ITEM ~mewi251x~ BEFORE ~scrl6e~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi251x~ BEFORE ~scrl6e~ #1 #0 #0 ~IDENTIFIED~ #5
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~slmage1.cre~ ~override~
	REPLACE_CRE_ITEM ~mewi251x~ #0 #0 #0 ~NONE~ ~INV3~

COPY_EXISTING ~ar2209.are~ ~override~ //Ust Natha, House Jae'llat
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=4 STR_VAR item_to_add=~mewi251x~ END

COPY_EXISTING ~scrolls.sto~ ~override~ //Scroll store in Adventurer Mart
	ADD_STORE_ITEM ~mewi251x~ AFTER ~scrl95~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi251x~ AFTER ~scrl6e~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi251x~ BEFORE ~scrl6e~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~kuork0.sto~ ~override~
	ADD_STORE_ITEM ~mewi251x~ #1 #0 #0 ~IDENTIFIED~ #1

COPY_EXISTING ~kieran2.sto~ ~override~
	ADD_STORE_ITEM ~mewi251x~ AFTER ~scrl95~ #1 #0 #0 ~IDENTIFIED~ #1

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi252.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi559 END
//	LPF ALTER_EFFECT INT_VAR check_headers=1 check_globals=0 match_opcode=protectionfromspell2 match_parameter2=2500 parameter2=splprot_meinflight END
	LPF ADD_SPELL_EFFECT INT_VAR insert_point=0 opcode=immunitytospellandmessage target=2 timing=0 duration=1 parameter2=splprot_areaisanoteleportzone special=RESOLVE_STR_REF(@30030) STR_VAR resource = EVAL ~mewi252~ END
	SAY NAME1 @33252
	SAY UNIDENTIFIED_DESC @34252

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI252~ scroll=~MEWI252X~ class_include=~{202, 5, 19}~ END
/*
COPY_EXISTING ~ar0900.are~ ~override~ ~ar2600.are~ ~override~ ~ar2626.are~ ~override~
	LPF fj_are_structure STR_VAR fj_structure_type=~region~ fj_name=~Prevent Ghostwalking~ fj_reg_script=~MENOTEL~ END
*/

COPY_EXISTING ~mewi252x.itm~ ~override~
	SAY NAME2 @33252
	SAY IDENTIFIED_DESC @34252
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~%arbg%0504.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=5 STR_VAR item_to_add=~mewi252x~ END

COPY_EXISTING ~%arbg%3901.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=2 STR_VAR item_to_add=~mewi252x~ END

COPY_EXISTING ~bdbeleg3.sto~ ~override~
	ADD_STORE_ITEM ~mewi252x~ BEFORE ~scrl1c~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi252x~ BEFORE ~scrl1c~ #1 #0 #0 ~IDENTIFIED~ #5
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0602.are~ ~override~ //Chateau Irenicus, first floor
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=12 STR_VAR item_to_add=~mewi252x~ END

COPY_EXISTING ~ar0906.are~ ~override~ //Guarded Compound, first floor
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=6 STR_VAR item_to_add=~mewi252x~ END

COPY_EXISTING ~bmthief.sto~ ~override~ //Black Market Thief (in Shadow Thief main building)
	ADD_STORE_ITEM ~mewi252x~ AFTER ~scrl90~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi252x~ AFTER ~scrl3g~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi252x~ BEFORE ~scrl1c~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar3201.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=2 STR_VAR item_to_add=~mewi252x~ END

COPY_EXISTING ~edion.sto~ ~override~
	ADD_STORE_ITEM ~mewi252x~ AFTER ~scrl96~ #1 #0 #0 ~IDENTIFIED~ #1

END

END

COPY_EXISTING ~mewi253.spl~ ~override~
	LPF ADD_SPELL_EFFECT INT_VAR insert_point=0 opcode=protectionfromspell2 target=2 timing=0 duration=1 parameter2=splprot_areaisanoteleportzone special=RESOLVE_STR_REF(@30030) STR_VAR resource = EVAL ~mewi253~ END
	SAY NAME1 @33253
	SAY UNIDENTIFIED_DESC @34253

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI253~ scroll=~MEWI253X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi253x.itm~ ~override~
	SAY NAME2 @33253
	SAY IDENTIFIED_DESC @34253
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~%arbg%0615.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=3 STR_VAR item_to_add=~mewi253x~ END

COPY_EXISTING ~friend.sto~ ~override~ //Friendly Arm Inn
	ADD_STORE_ITEM ~mewi253x~ BEFORE ~book40~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~bdbeleg3.sto~ ~override~
	ADD_STORE_ITEM ~mewi253x~ BEFORE ~scrl6e~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi253x~ BEFORE ~scrl6e~ #1 #0 #0 ~IDENTIFIED~ #5
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0411.are~ ~override~ //Planar Sphere, first floor
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=4 STR_VAR item_to_add=~mewi253x~ END

COPY_EXISTING ~ar1303.are~ ~override~ //D'Arnise keep, second floor
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=9 STR_VAR item_to_add=~mewi253x~ END

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi253x~ AFTER ~scrl6e~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi253x~ BEFORE ~scrl6e~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~kuork0.sto~ ~override~
	ADD_STORE_ITEM ~mewi253x~ #1 #0 #0 ~IDENTIFIED~ #1

COPY_EXISTING ~kieran2.sto~ ~override~
	ADD_STORE_ITEM ~mewi253x~ AFTER ~scrl95~ #1 #0 #0 ~IDENTIFIED~ #1

END

COPY_EXISTING ~mewi254.spl~ ~override~
	SAY NAME1 @33254
	SAY UNIDENTIFIED_DESC @34254

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI254~ scroll=~MEWI254X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi254x.itm~ ~override~
	SAY NAME2 @33254
	SAY IDENTIFIED_DESC @34254
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowspellnegates%~ END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~inn3351.sto~ ~override~ //Feldepost's Inn
	ADD_STORE_ITEM ~mewi254x~ AFTER ~scrla3~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~ulgoth.sto~ ~override~ //Ulgoth's Beard Inn
	ADD_STORE_ITEM ~mewi254x~ BEFORE ~scrl5g~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi254x~ BEFORE ~scrl90~ #1 #0 #0 ~IDENTIFIED~ #5
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~bernard.sto~ ~override~ ~bernard2.sto~ ~override~ //Copper Coronet
	ADD_STORE_ITEM ~mewi254x~ AFTER ~scrl1c~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~sarbar01.sto~ ~override~ //Saradush tavern
	ADD_STORE_ITEM ~mewi254x~ BEFORE ~boot01~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi254x~ BEFORE ~scrl90~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~kuork0.sto~ ~override~
	ADD_STORE_ITEM ~mewi254x~ #1 #0 #0 ~IDENTIFIED~ #1

COPY_EXISTING ~kieran2.sto~ ~override~
	ADD_STORE_ITEM ~mewi254x~ AFTER ~scrl95~ #1 #0 #0 ~IDENTIFIED~ #1

END

COPY_EXISTING ~mewi255.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi255 END
	SAY NAME1 @33255
	SAY UNIDENTIFIED_DESC @34255

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI255~ scroll=~MEWI255X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~sppr307.spl~ ~override~ ~spwi410.spl~ ~override~
	LPF ADD_SPELL_EFFECT INT_VAR opcode=321 target=2 timing=1 STR_VAR resource= EVAL ~mewi255~ END

COPY_EXISTING ~mewi255x.itm~ ~override~
	SAY NAME2 @33255
	SAY IDENTIFIED_DESC @34255
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowspellnegates%~ END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~%arbg%0505.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=4 STR_VAR item_to_add=~mewi255x~ END

COPY_EXISTING ~%arbg%4400.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=2 STR_VAR item_to_add=~mewi255x~ END

COPY_EXISTING ~vayya.cre~ ~override~
	ADD_CRE_ITEM ~mewi255x~ #0 #0 #0 ~NONE~ ~INV1~

COPY_EXISTING ~bdbeleg3.sto~ ~override~
	ADD_STORE_ITEM ~mewi255x~ AFTER ~scrl96~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi255x~ AFTER ~scrl96~ #1 #0 #0 ~IDENTIFIED~ #5
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0502.are~ ~override~ //Tanner shop, second floor
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=3 STR_VAR item_to_add=~mewi255x~ END

COPY_EXISTING ~ar0802.are~ ~override~ //Graveyard District, optional crypt
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=6 STR_VAR item_to_add=~mewi255x~ END

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi255x~ AFTER ~scrl89~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi255x~ AFTER ~scrl96~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar3601.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=9 STR_VAR item_to_add=~mewi255x~ END

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) AND (me_power_spells = 1) BEGIN

COPY_EXISTING ~mewi256.spl~ ~override~
	SAY NAME1 @33256
	SAY UNIDENTIFIED_DESC @34256

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI256~ scroll=~MEWI256X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi256f.spl~ ~override~
	READ_LONG 0x6a effectsoffset
	READ_SHORT 0x90 numeffects
	FOR (i = 0; i < numeffects; ++i) BEGIN
		me_off = effectsoffset + (i * 0x30)
		READ_SHORT me_off theopcode
		READ_ASCII (me_off + 0x14) theresource
		PATCH_IF theopcode = 402 AND (~%theresource%~ STRING_EQUAL_CASE ~MESPLIM1~) BEGIN
			WRITE_ASCIIE (me_off + 0x4) ~MEWI256~ #8
		END
	END

OUTER_SPRINT me_30012 @30012
OUTER_SPRINT me_30013 @30013
LAF ADD_CONTINGENCY INT_VAR new_title=0 new_action=1 description=RESOLVE_STR_REF(@34256) STR_VAR resource= EVAL ~mesplim1~ title=~ME_SPECIFIC_IMMUNITY_TITLE~ title_name= EVAL ~%me_30012%~ action=~ME_ADD_SPELLS_IMMUNITY_LABEL~ action_name= EVAL ~%me_30013%~ END
LAF ADD_CONTINGENCY INT_VAR new_title=0 description=RESOLVE_STR_REF(@34256) STR_VAR resource= EVAL ~mesplim2~ title=~ME_SPECIFIC_IMMUNITY_TITLE~ title_name= EVAL ~%me_30012%~ action=~ME_ADD_SPELLS_IMMUNITY_LABEL~ END
LAF ADD_CONTINGENCY INT_VAR new_title=0 description=RESOLVE_STR_REF(@34256) STR_VAR resource= EVAL ~mesplim3~ title=~ME_SPECIFIC_IMMUNITY_TITLE~ title_name= EVAL ~%me_30012%~ action=~ME_ADD_SPELLS_IMMUNITY_LABEL~ END

COPY_EXISTING ~mewi256x.itm~ ~override~
	SAY NAME2 @33256
	SAY IDENTIFIED_DESC @34256
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~%arbg%4501.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=1 STR_VAR item_to_add=~mewi256x~ END

COPY_EXISTING ~bdsorcsc.sto~ ~override~
	ADD_STORE_ITEM ~mewi256x~ BEFORE ~scrl97~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi256x~ BEFORE ~scrl97~ #1 #0 #0 ~IDENTIFIED~ #5
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ribald.sto~ ~override~ //Adventurer Mart
	ADD_STORE_ITEM ~mewi256x~ AFTER ~scrl3g~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi256x~ AFTER ~scrl94~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi256x~ BEFORE ~scrl97~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~kuork0.sto~ ~override~
	ADD_STORE_ITEM ~mewi256x~ AFTER ~spwi223a~ #1 #0 #0 ~IDENTIFIED~ #1

END
END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi257.spl~ ~override~
	SAY NAME1 @33257
	SAY UNIDENTIFIED_DESC @34257

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI257~ scroll=~MEWI257X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi257.spl~ ~override~ ~mewi257d.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi257 END
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		LPF ALTER_SPELL_EFFECT INT_VAR header=(i + 1) duration_high=((i * 3) + 21) END
		LPF ALTER_EFFECT INT_VAR header=i duration=((i * 3) + 24) STR_VAR match_resource=~MEFALDMG~ END
		numheaders = numheaders + 1
	END

COPY_EXISTING ~mewi257x.itm~ ~override~
	SAY NAME2 @33257
	SAY IDENTIFIED_DESC @34257
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowpolymorphnegates%~ END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~sto0703.sto~ ~override~ //Sorcerous Sundries
	ADD_STORE_ITEM ~mewi257x~ AFTER ~scrl1c~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~rndscrol.2da~ ~override~
	REPLACE_TEXTUALLY CASE_INSENSITIVE ~SCRL98~ ~MEWI257X~
END

COPY_EXISTING ~bdbeleg3.sto~ ~override~
	ADD_STORE_ITEM ~mewi257x~ BEFORE ~scrl93~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi257x~ BEFORE ~scrl93~ #1 #0 #0 ~IDENTIFIED~ #5
	IF_EXISTS

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~shop08.sto~ ~override~
	ADD_STORE_ITEM ~mewi257x~ BEFORE ~scrl93~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ar1302.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=2 STR_VAR item_to_add=~mewi257x~ END

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi257x~ BEFORE ~scrl93~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi257x~ BEFORE ~scrl93~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~kuork0.sto~ ~override~
	ADD_STORE_ITEM ~mewi257x~ BEFORE ~scrl96~ #1 #0 #0 ~IDENTIFIED~ #1

END

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi258.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 opcode=403 parameter1=1 parameter2=9 savingthrow=0x6C0000 special=1 STR_VAR match_resource=~mewi258b~ resource=~EXSPLDEF~ END
	LPF CLONE_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=403 opcode=198 parameter1=0 parameter2=121 savingthrow=0 special=0 END
	LPF DELETE_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=spellturning END
	SAY NAME1 @33258
	SAY UNIDENTIFIED_DESC @34258

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI258~ scroll=~MEWI258X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi258b.spl~ ~override~

END ELSE BEGIN

COPY_EXISTING ~mewi258.spl~ ~override~
	SAY NAME1 @33258
	SAY UNIDENTIFIED_DESC @34258

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI258~ scroll=~MEWI258X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi258b.spl~ ~override~

END

COPY_EXISTING ~mewi258x.itm~ ~override~
	SAY NAME2 @33258
	SAY IDENTIFIED_DESC @34258
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~friend.sto~ ~override~ //Friendly Arm Inn
	ADD_STORE_ITEM ~mewi258x~ BEFORE ~book40~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~sto0703.sto~ ~override~ ~bdsorcsc.sto~ ~override~ //Sorcerous Sundries
	ADD_STORE_ITEM ~mewi258x~ AFTER ~scrl85~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~%arbg%0145.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=1 STR_VAR item_to_add=~mewi258x~ END

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi258x~ AFTER ~scrl85~ #1 #0 #0 ~IDENTIFIED~ #4
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0602.are~ ~override~ //Chateau Irenicus, first floor
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=9 STR_VAR item_to_add=~mewi258x~ END

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi258x~ AFTER ~scrl85~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi258x~ AFTER ~scrl85~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~kuork0.sto~ ~override~
	ADD_STORE_ITEM ~mewi258x~ AFTER ~spwi223x~ #1 #0 #0 ~IDENTIFIED~ #1

END
/*
ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi259.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi259 END
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		LPF ALTER_SPELL_EFFECT INT_VAR header=(i + 1) duration_high=((i + 1) * 60) END
		numheaders = numheaders + 1
	END
	SAY NAME1 @33259
	SAY UNIDENTIFIED_DESC @34259

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI259~ scroll=~MEWI259X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi259x.itm~ ~override~
	SAY NAME2 @33259
	SAY IDENTIFIED_DESC @34259
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~sto0703.sto~ ~override~
	ADD_STORE_ITEM ~mewi259x~ AFTER ~scrl87~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~bdsorcsc.sto~ ~override~
	ADD_STORE_ITEM ~mewi259x~ AFTER ~scrl87~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi259x~ AFTER ~scrl87~ #1 #0 #0 ~IDENTIFIED~ #5
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar1513.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=5 STR_VAR item_to_add=~mewi259x~ END

COPY_EXISTING ~scrolls.sto~ ~override~
	ADD_STORE_ITEM ~mewi259x~ AFTER ~scrl87~ #1 #0 #0 ~IDENTIFIED~ #4
	IF_EXISTS

COPY_EXISTING ~shop08.sto~ ~override~
	ADD_STORE_ITEM ~mewi259x~ AFTER ~scrl87~ #1 #0 #0 ~IDENTIFIED~ #4
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi259x~ AFTER ~scrl87~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi259x~ AFTER ~scrl87~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~kuork0.sto~ ~override~
	ADD_STORE_ITEM ~mewi259x~ AFTER ~scrl87~ #1 #0 #0 ~IDENTIFIED~ #1

COPY_EXISTING ~kieran3.sto~ ~override~
	ADD_STORE_ITEM ~mewi259x~ AFTER ~scrl3g~ #0 #0 #0 ~IDENTIFIED~ #1

END

END
*/
ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi260.spl~ ~override~
	SAY NAME1 @33260
	SAY UNIDENTIFIED_DESC @34260
/*
LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI260~ scroll=~MEWI260X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi260x.itm~ ~override~
	SAY NAME2 @33260
	SAY IDENTIFIED_DESC @34260
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~sto0703.sto~ ~override~
	ADD_STORE_ITEM ~mewi260x~ BEFORE ~scrl89~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~bdsorcsc.sto~ ~override~
	ADD_STORE_ITEM ~mewi260x~ BEFORE ~scrl89~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi260x~ BEFORE ~scrl89~ #1 #0 #0 ~IDENTIFIED~ #5
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0202.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=11 STR_VAR item_to_add=~mewi260x~ END

COPY_EXISTING ~scrolls.sto~ ~override~
	ADD_STORE_ITEM ~mewi260x~ AFTER ~scrlai~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi260x~ BEFORE ~scrl89~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi260x~ BEFORE ~scrl89~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar3601.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=4 STR_VAR item_to_add=~mewi260x~ END

END
*/

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi351.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 opcode=403 parameter1=1 parameter2=9 savingthrow=0xAC0000 special=1 STR_VAR match_resource=~mewi351b~ resource=~EXSPLDEF~ END
	LPF CLONE_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=403 opcode=205 parameter1=0 parameter2=121 savingthrow=0 special=0 END
	LPF DELETE_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=spelltrap END
	SAY NAME1 @33351
	SAY UNIDENTIFIED_DESC @34351

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI351~ scroll=~MEWI351X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi351b.spl~ ~override~

END ELSE BEGIN

COPY_EXISTING ~mewi351.spl~ ~override~
	SAY NAME1 @33351
	SAY UNIDENTIFIED_DESC @34351

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI351~ scroll=~MEWI351X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi351b.spl~ ~override~

END

COPY_EXISTING ~mewi351x.itm~ ~override~
	SAY NAME2 @33351
	SAY IDENTIFIED_DESC @34351
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~%arbg%1803.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=7 STR_VAR item_to_add=~mewi351x~ END

COPY_EXISTING ~bdsorcsc.sto~ ~override~
	ADD_STORE_ITEM ~mewi351x~ BEFORE ~scrl1d~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi351x~ BEFORE ~scrl1d~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0516.are~ ~override~ //Planar Prison
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=3 STR_VAR item_to_add=~mewi351x~ END

COPY_EXISTING ~suelf10.sto~ ~override~ //Temple of Rillifane
	ADD_STORE_ITEM ~mewi351x~ BEFORE ~scrl1d~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi351x~ BEFORE ~scrl1s~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi351x~ BEFORE ~scrl1d~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar2100.bcs~ ~override~
	DECOMPILE_AND_PATCH BEGIN
		REPLACE_TEXTUALLY CASE_INSENSITIVE ~AddStoreItem(\"KUORK0\",\"SPWI319X\",1,1)~ ~AddStoreItem("KUORK0","MEWI351X",1,1)
AddStoreItem("KUORK0","SPWI319X",1,1)~
	END

COPY_EXISTING ~bandoth.sto~ ~override~
	ADD_STORE_ITEM ~mewi351x~ AFTER ~scssha~ #1 #0 #0 ~IDENTIFIED~ #1

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi352.spl~ ~override~
	LPF ADD_SPELL_EFFECT INT_VAR insert_point=0 opcode=immunitytospellandmessage target=2 timing=0 duration=1 parameter2=splprot_areaisanoteleportzone special=RESOLVE_STR_REF(@30030) STR_VAR resource = EVAL ~mewi352~ END
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi352 END
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		LPF ALTER_SPELL_EFFECT INT_VAR header=(i + 1) duration_high=(i * 6 + 66) END
		LPF ALTER_EFFECT INT_VAR silent=1 header=i match_opcode=eeexsetextendedstat match_special=640 parameter1=(i + 21) END
		LPF ALTER_EFFECT INT_VAR silent=1 header=i duration=(i * 6 + 69) STR_VAR match_resource=~MEFALDMG~ END
		numheaders = numheaders + 1
	END
	SAY NAME1 @33352
	SAY UNIDENTIFIED_DESC @34352

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI352~ scroll=~MEWI352X~ class_include=~{202, 5, 19}~ END
/*
COPY_EXISTING ~mewi352d.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi352 END
	LPF ALTER_EFFECT INT_VAR check_headers=1 check_globals=0 match_opcode=protectionfromspell2 match_parameter2=2500 parameter2=splprot_meinflight END
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		LPF ALTER_SPELL_EFFECT INT_VAR header=(i + 1) duration_high=((i + 11) * 6) END
		LPF ALTER_EFFECT INT_VAR silent=1 header=i match_opcode=eeexsetextendedstat match_special=640 parameter1=(i + 21) END
		numheaders = numheaders + 1
	END
*/
COPY_EXISTING ~mewi352x.itm~ ~override~
	SAY NAME2 @33352
	SAY IDENTIFIED_DESC @34352
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~highhedg.sto~ ~override~ //High Hedge
	ADD_STORE_ITEM ~mewi352x~ AFTER ~scrl1q~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

COPY_EXISTING ~sto0703.sto~ ~override~ ~bdsorcsc.sto~ ~override~ //Sorcerous Sundries
	ADD_STORE_ITEM ~mewi352x~ AFTER ~scrl1t~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~bdbeleg3.sto~ ~override~
	ADD_STORE_ITEM ~mewi352x~ AFTER ~scrl1f~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

COPY_EXISTING ~denak.cre~ ~override~
	ADD_CRE_ITEM ~mewi352x~ #0 #0 #0 ~NONE~ ~INV2~

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi352x~ AFTER ~scrl1f~ #1 #0 #0 ~IDENTIFIED~ #4
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~shop08.sto~ ~override~ //Galoomp the Bookkeeper
	ADD_STORE_ITEM ~mewi352x~ AFTER ~scrl1g~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

COPY_EXISTING ~trgeni01.sto~ ~override~ //Trademeet genie
	ADD_STORE_ITEM ~mewi352x~ BEFORE ~scrl1f~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi352x~ AFTER ~scrl1h~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi352x~ AFTER ~scrl1f~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~kuork0.sto~ ~override~
	ADD_STORE_ITEM ~mewi352x~ AFTER ~mewi351x~ #1 #0 #0 ~IDENTIFIED~ #1

COPY_EXISTING ~kieran2.sto~ ~override~
	ADD_STORE_ITEM ~mewi352x~ BEFORE ~scrl1h~ #1 #0 #0 ~IDENTIFIED~ #1

END
END

COPY_EXISTING ~mewi353.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi353 END
	SAY NAME1 @33353
	SAY UNIDENTIFIED_DESC @34353

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI353~ scroll=~MEWI353X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi353.spl~ ~override~ ~mewi353d.spl~ ~override~
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		LPF ALTER_SPELL_EFFECT INT_VAR header=(i + 1) duration_high=((i + 1) * 6) END
		numheaders = numheaders + 1
	END

COPY_EXISTING ~mewi353x.itm~ ~override~
	SAY NAME2 @33353
	SAY IDENTIFIED_DESC @34353
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~halaca.cre~ ~override~
	ADD_CRE_ITEM ~mewi353x~ #0 #0 #0 ~NONE~ ~INV4~

COPY_EXISTING ~bdbeleg3.sto~ ~override~
	ADD_STORE_ITEM ~mewi353x~ AFTER ~scrl1e~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi353x~ AFTER ~scrl1e~ #1 #0 #0 ~IDENTIFIED~ #4
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~bernard2.sto~ ~override~ //Copper Coronet (discount)
	ADD_STORE_ITEM ~mewi353x~ AFTER ~scrl1s~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~udsvir05.sto~ ~override~ //Underdark Svirfneblin store
	ADD_STORE_ITEM ~mewi353x~ BEFORE ~scrl6h~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi353x~ AFTER ~scrl1e~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi353x~ AFTER ~scrl1e~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar2100.bcs~ ~override~
	DECOMPILE_AND_PATCH BEGIN
		REPLACE_TEXTUALLY CASE_INSENSITIVE ~AddStoreItem(\"KUORK0\",\"SPWI319X\",1,1)~ ~AddStoreItem("KUORK0","MEWI353X",1,1)
AddStoreItem("KUORK0","SPWI319X",1,1)~
	END
END


/*
COPY_EXISTING ~rndscrol.2da~ ~override~
	REPLACE_TEXTUALLY CASE_INSENSITIVE ~SCRL1T~ ~MEWI353X~
*/

OUTER_SPRINT stringnecromancy @3407
OUTER_SPRINT stringenchantmentcharm @3414

COPY_EXISTING ~spwi104.spl~ ~override~
	READ_LONG spellunusability thespellunusability
	BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING ~spwi205.spl~ ~override~
	WRITE_ASCII castingsound ~CAS_M05~ #8
	WRITE_SHORT castinganimation 11
	WRITE_BYTE school enchantment
	WRITE_LONG spellunusability thespellunusability
	READ_SHORT 0x98 theprojectile ELSE 0
	PATCH_IF theprojectile = 169 BEGIN
		LPF ALTER_SPELL_HEADER INT_VAR projectile=170 END
	END ELSE PATCH_IF (GAME_IS ~iwdee~) AND (theprojectile = 361) BEGIN
		LPF ALTER_SPELL_HEADER INT_VAR projectile=371 END
	END
	READ_LONG UNIDENTIFIED_DESC description_ref
	LPF PATCH_REPLACE_IN_STRING INT_VAR strref=description_ref new_string=1 STR_VAR match= EVAL ~%stringnecromancy%~ replace_with= EVAL ~%stringenchantment%~ RET description_ref_new=new_strref END
	WRITE_LONG UNIDENTIFIED_DESC description_ref_new

COPY_EXISTING ~scrl69.itm~ ~override~
	READ_BYTE kitunusability3 thekitunusability3
	READ_BYTE kitunusability4 thekitunusability4
	BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING ~scrl89.itm~ ~override~
	WRITE_BYTE kitunusability3 thekitunusability3
	WRITE_BYTE kitunusability4 thekitunusability4
	READ_LONG IDENTIFIED_DESC description_ref
	LPF PATCH_REPLACE_IN_STRING INT_VAR strref=description_ref new_string=1 STR_VAR match= EVAL ~%stringnecromancy%~ replace_with= EVAL ~%stringenchantment%~ RET description_ref_new=new_strref END
	WRITE_LONG IDENTIFIED_DESC description_ref_new

COPY_EXISTING ~mewi354.spl~ ~override~
	SAY NAME1 @33354
	SAY UNIDENTIFIED_DESC @34354

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI354~ scroll=~MEWI354X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi354x.itm~ ~override~
	SAY NAME2 @33354
	SAY IDENTIFIED_DESC @34354
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowwandsnegates%~ END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~%arbg%2613.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=3 STR_VAR item_to_add=~mewi354x~ END

COPY_EXISTING ~bd7230.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=4 STR_VAR item_to_add=~mewi354x~ END
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi354x~ AFTER ~scrl6j~ #1 #0 #0 ~IDENTIFIED~ #4
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~xappren1.cre~ ~override~
	ADD_CRE_ITEM ~mewi354x~ #0 #0 #0 ~NONE~ ~INV3~

COPY_EXISTING ~ar1202.are~ ~override~ //Firkraag's dungeon, second floor
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=2 STR_VAR item_to_add=~mewi354x~ END

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi354x~ AFTER ~scrl1i~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi354x~ AFTER ~scrl6j~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar4003.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=1 STR_VAR item_to_add=~mewi354x~ END

END

COPY_EXISTING ~mewi355.spl~ ~override~
	SAY NAME1 @33355
	SAY UNIDENTIFIED_DESC @34355

COPY_EXISTING ~mewi355x.itm~ ~override~
	SAY NAME2 @33355
	SAY IDENTIFIED_DESC @34355
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END
/*
ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~narcil.cre~ ~override~
	ADD_CRE_ITEM ~mewi355x~ #0 #0 #0 ~NONE~ ~INV3~

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi355x~ AFTER ~scrl1d~ #1 #0 #0 ~IDENTIFIED~ #4
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar3016.are~ ~override~ //Watcher's Keep, second floor
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=15 STR_VAR item_to_add=~mewi355x~ END

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~hobart.sto~ ~override~
	ADD_STORE_ITEM ~mewi355x~ AFTER ~flamoil~ #1 #0 #0 ~IDENTIFIED~ #1

END
*/

COPY_EXISTING ~mewi356.spl~ ~override~
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		LPF ALTER_SPELL_EFFECT INT_VAR header=(i + 1) duration_high=((i + 1) * 6) END
		numheaders = numheaders + 1
	END
	SAY NAME1 @33356
	SAY UNIDENTIFIED_DESC @34356

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI356~ scroll=~MEWI356X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi356x.itm~ ~override~
	SAY NAME2 @33356
	SAY IDENTIFIED_DESC @34356
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~tem2601.sto~ ~override~ //Temple of Oghma
	ADD_STORE_ITEM ~mewi356x~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~sto0703.sto~ ~override~ //Sorcerous Sundries
	ADD_STORE_ITEM ~mewi356x~ AFTER ~scrl1i~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~bdsorcsc.sto~ ~override~
	ADD_STORE_ITEM ~mewi356x~ BEFORE ~scrl1k~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi356x~ BEFORE ~scrl1k~ #1 #0 #0 ~IDENTIFIED~ #4
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~doghma.sto~ ~override~ //Temple of Oghma
	ADD_STORE_ITEM ~mewi356x~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi356x~ AFTER ~scrl1d~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi356x~ BEFORE ~scrl1k~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar2100.bcs~ ~override~
	DECOMPILE_AND_PATCH BEGIN
		REPLACE_TEXTUALLY CASE_INSENSITIVE ~AddStoreItem(\"KUORK0\",\"SPWI319X\",1,1)~ ~AddStoreItem("KUORK0","MEWI356X",1,1)
AddStoreItem("KUORK0","SPWI319X",1,1)~
	END
END

COPY_EXISTING ~mewi357.spl~ ~override~
	SAY NAME1 @33357
	SAY UNIDENTIFIED_DESC @34357

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI357~ scroll=~MEWI357X~ class_include=~{202, 5, 19}~ END

OUTER_SPRINT me_33357 @33357
LAF ADD_CONTINGENCY INT_VAR description=RESOLVE_STR_REF(@34357) STR_VAR resource= EVAL ~MEWI357~ title=~ME_GLYPH_STORING_TITLE~ title_name= EVAL ~%me_33357%~ action=~ADD_SPELLS_SEQUENCER_LABEL~ END

COPY_EXISTING ~mewi357x.itm~ ~override~
	SAY NAME2 @33357
	SAY IDENTIFIED_DESC @34357
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_range= EVAL ~%stringrangelong%~ END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~%arbg%3901.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=7 STR_VAR item_to_add=~mewi357x~ END

COPY_EXISTING ~bdbeleg3.sto~ ~override~
	ADD_STORE_ITEM ~mewi357x~ AFTER ~scrl1t~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi357x~ AFTER ~scrl1t~ #1 #0 #0 ~IDENTIFIED~ #4
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~scrolls.sto~ ~override~
	ADD_STORE_ITEM ~mewi357x~ AFTER ~scrl1e~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi357x~ AFTER ~scrl1e~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi357x~ AFTER ~scrl1t~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar2100.bcs~ ~override~
	DECOMPILE_AND_PATCH BEGIN
		REPLACE_TEXTUALLY CASE_INSENSITIVE ~AddStoreItem(\"KUORK0\",\"SPWI319X\",1,1)~ ~AddStoreItem("KUORK0","MEWI357X",1,1)
AddStoreItem("KUORK0","SPWI319X",1,1)~
	END
END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi358.spl~ ~override~
	SAY NAME1 @33358
	SAY UNIDENTIFIED_DESC @34358

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI358~ scroll=~MEWI358X~ class_include=~{202, 5, 19}~ END

OUTER_SPRINT me_30043 @30043
OUTER_SPRINT me_33358 @33358
LAF ADD_CONTINGENCY INT_VAR new_title=0 description=RESOLVE_STR_REF(@34358) STR_VAR resource= EVAL ~MEWI358~ title=~ME_FAMILIAR_SPELL_TITLE~ action=~ME_ADD_SPELLS_FAMILIAR_LABEL~ END

COPY_EXISTING ~m_mealtc.lua~ ~override~
	ref_30077 = RESOLVE_STR_REF(@30077)
	ref_30078 = RESOLVE_STR_REF(@30078)
	ref_30079 = RESOLVE_STR_REF(@30079)
	ref_30080 = RESOLVE_STR_REF(@30080)
	ref_30081 = RESOLVE_STR_REF(@30081)
	ref_30082 = RESOLVE_STR_REF(@30082)
	REPLACE_TEXTUALLY CASE_INSENSITIVE ~me_alt_contingency = {~ ~me_alt_contingency = {
['MEWI358'] = {['conditions'] = {{['strref'] = %ref_30077%, ['desc'] = %ref_30078%}}, ['targets'] = {{['strref'] = %ref_30079%, ['desc'] = %ref_30080%}, {['strref'] = %ref_30081%, ['desc'] = %ref_30082%}},},~

COPY_EXISTING ~mewi358x.itm~ ~override~
	SAY NAME2 @33358
	SAY IDENTIFIED_DESC @34358
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~%arbg%2612.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=5 STR_VAR item_to_add=~mewi358x~ END

COPY_EXISTING ~bdsorcsc.sto~ ~override~
	ADD_STORE_ITEM ~mewi358x~ BEFORE ~scrl1g~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi358x~ BEFORE ~scrl1g~ #1 #0 #0 ~IDENTIFIED~ #4
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~sevpat02.cre~ ~override~
	ADD_CRE_ITEM ~mewi358x~ #0 #0 #0 ~NONE~ ~INV3~

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi358x~ AFTER ~scrl1e~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi358x~ BEFORE ~scrl1g~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar2100.bcs~ ~override~
	DECOMPILE_AND_PATCH BEGIN
		REPLACE_TEXTUALLY CASE_INSENSITIVE ~AddStoreItem(\"KUORK0\",\"SPWI319X\",1,1)~ ~AddStoreItem("KUORK0","MEWI358X",1,1)
AddStoreItem("KUORK0","SPWI319X",1,1)~
	END
END

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi359.spl~ ~override~
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		LPF ALTER_EFFECT INT_VAR header=i match_savingthrow=0 match_special=1 parameter1=(i / 2 * 3 + 27) STR_VAR match_resource=~MEHGTST~ END
		LPF ALTER_EFFECT INT_VAR header=i match_savingthrow=16 match_special=1 parameter1=((i + 1) / 2 * 3) STR_VAR match_resource=~MEHGTST~ END
		numheaders = numheaders + 1
	END
	SAY NAME1 @33359
	SAY UNIDENTIFIED_DESC @34359

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI359~ scroll=~MEWI359X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi359x.itm~ ~override~
	SAY NAME2 @33359
	SAY IDENTIFIED_DESC @34359
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowpolymorphpartial%~ END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~highhedg.sto~ ~override~
	ADD_STORE_ITEM ~mewi359x~ AFTER ~mewi352x~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

COPY_EXISTING ~ulgoth.sto~ ~override~
	ADD_STORE_ITEM ~mewi359x~ AFTER ~mewi254x~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi359x~ BEFORE ~scrl1q~ #1 #0 #0 ~IDENTIFIED~ #4
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0603.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=3 STR_VAR item_to_add=~mewi359x~ END

COPY_EXISTING ~scrolls.sto~ ~override~
	ADD_STORE_ITEM ~mewi359x~ BEFORE ~scrlai~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi359x~ BEFORE ~scrl1q~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi359x~ BEFORE ~scrl1q~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar2100.bcs~ ~override~
	DECOMPILE_AND_PATCH BEGIN
		REPLACE_TEXTUALLY CASE_INSENSITIVE ~AddStoreItem(\"KUORK0\",\"SPWI319X\",1,1)~ ~AddStoreItem("KUORK0","MEWI359X",1,1)
AddStoreItem("KUORK0","SPWI319X",1,1)~
	END
END

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi360.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi360 END
	SAY NAME1 @33360
	SAY UNIDENTIFIED_DESC @34360

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI360~ scroll=~MEWI360X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi360x.itm~ ~override~
	SAY NAME2 @33360
	SAY IDENTIFIED_DESC @34360
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~highhedg.sto~ ~override~
	ADD_STORE_ITEM ~mewi360x~ AFTER ~mewi359x~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~%arbg%0511.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=8 STR_VAR item_to_add=~mewi360x~ END

COPY_EXISTING ~bdsorcsc.sto~ ~override~
	ADD_STORE_ITEM ~mewi360x~ AFTER ~scrl1h~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi360x~ AFTER ~scrl1h~ #1 #0 #0 ~IDENTIFIED~ #4
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0315.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=1 STR_VAR item_to_add=~mewi360x~ END

COPY_EXISTING ~shop08.sto~ ~override~ //Galoomp the Bookkeeper
	ADD_STORE_ITEM ~mewi360x~ AFTER ~scrl1h~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi360x~ AFTER ~scrl1h~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi360x~ AFTER ~scrl1h~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar2100.bcs~ ~override~
	DECOMPILE_AND_PATCH BEGIN
		REPLACE_TEXTUALLY CASE_INSENSITIVE ~AddStoreItem(\"KUORK0\",\"SPWI319X\",1,1)~ ~AddStoreItem("KUORK0","MEWI360X",1,1)
AddStoreItem("KUORK0","SPWI319X",1,1)~
	END

COPY_EXISTING ~bandoth.sto~ ~override~
	ADD_STORE_ITEM ~mewi360x~ BEFORE ~sccfe~ #1 #0 #0 ~IDENTIFIED~ #1

END

END

COPY_EXISTING ~mewi361.spl~ ~override~
	LPF ALTER_SPELL_HEADER INT_VAR projectile=meconegr END
	SAY NAME1 @33361
	SAY UNIDENTIFIED_DESC @34361

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI361~ scroll=~MEWI361X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi361x.itm~ ~override~
	SAY NAME2 @33361
	SAY IDENTIFIED_DESC @34361
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowbreathhalf%~ END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~highhedg.sto~ ~override~
	ADD_STORE_ITEM ~mewi361x~ AFTER ~mewi360x~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~sto0703.sto~ ~override~
	ADD_STORE_ITEM ~mewi361x~ AFTER ~scrl1k~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~bdsorcsc.sto~ ~override~
	ADD_STORE_ITEM ~mewi361x~ AFTER ~scrl1k~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi361x~ AFTER ~scrla5~ #1 #0 #0 ~IDENTIFIED~ #4
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0315.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=1 STR_VAR item_to_add=~mewi361x~ END

COPY_EXISTING ~shop08.sto~ ~override~ //Galoomp the Bookkeeper
	ADD_STORE_ITEM ~mewi361x~ AFTER ~scrl1k~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi361x~ AFTER ~scrla5~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi361x~ AFTER ~scrla5~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar2100.bcs~ ~override~
	DECOMPILE_AND_PATCH BEGIN
		REPLACE_TEXTUALLY CASE_INSENSITIVE ~AddStoreItem(\"KUORK0\",\"SPWI319X\",1,1)~ ~AddStoreItem("KUORK0","MEWI361X",1,1)
AddStoreItem("KUORK0","SPWI319X",1,1)~
	END

END

COPY_EXISTING ~mewi451.spl~ ~override~
	LPF ALTER_SPELL_HEADER INT_VAR projectile=mewofire END
	SAY NAME1 @33451
	SAY UNIDENTIFIED_DESC @34451

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI451~ scroll=~MEWI451X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi451x.itm~ ~override~
	SAY NAME2 @33451
	SAY IDENTIFIED_DESC @34451
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~%arbg%0511.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=10 STR_VAR item_to_add=~mewi451x~ END

COPY_EXISTING ~%arbg%1802.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=42 STR_VAR item_to_add=~mewi451x~ END

COPY_EXISTING ~bd0130.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=24 STR_VAR item_to_add=~mewi451x~ END
	IF_EXISTS

COPY_EXISTING ~bdbeleg3.sto~ ~override~
	ADD_STORE_ITEM ~mewi451x~ BEFORE ~scrla1~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi451x~ BEFORE ~scrla1~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0412.are~ ~override~ //Planar Sphere, elemental area
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=2 STR_VAR item_to_add=~mewi451x~ END
/*
COPY_EXISTING ~ar5204.are~ ~override~ //Yaga-Shura Temple, second floor
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=4 STR_VAR item_to_add=~mewi451x~ END
*/

COPY_EXISTING ~bernard2.sto~ ~override~ //Copper Coronet (discount)
	ADD_STORE_ITEM ~mewi451x~ AFTER ~scrl1t~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi451x~ AFTER ~scrl1w~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi451x~ BEFORE ~scrlal~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar2100.bcs~ ~override~
	DECOMPILE_AND_PATCH BEGIN
		REPLACE_TEXTUALLY CASE_INSENSITIVE ~AddStoreItem(\"KUORK0\",\"SPWI319X\",1,1)~ ~AddStoreItem("KUORK0","MEWI451X",1,1)
AddStoreItem("KUORK0","SPWI319X",1,1)~
	END
END

COPY_EXISTING ~mewi452.spl~ ~override~
	SAY NAME1 @33452
	SAY UNIDENTIFIED_DESC @34452

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI452~ scroll=~MEWI452X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi452x.itm~ ~override~
	SAY NAME2 @33452
	SAY IDENTIFIED_DESC @34452
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowdeathpartial%~ END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~%arbg%0511.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=8 STR_VAR item_to_add=~mewi452x~ END

COPY_EXISTING ~mutami.cre~ ~override~
	ADD_CRE_ITEM ~mewi452x~ #0 #0 #0 ~NONE~ ~INV8~

COPY_EXISTING ~bd0130.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=10 STR_VAR item_to_add=~mewi452x~ END
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi452x~ BEFORE ~scrl5l~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0202.are~ ~override~ //Unseeing Eye sewers
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=11 STR_VAR item_to_add=~mewi452x~ END

COPY_EXISTING ~ar0603.are~ ~override~ //Chateau Irenicus, second floor
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=5 STR_VAR item_to_add=~mewi452x~ END

COPY_EXISTING ~udsvir05.sto~ ~override~ //Underdark Svirfneblin store
	ADD_STORE_ITEM ~mewi452x~ AFTER ~scrl6o~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi452x~ BEFORE ~scrl51~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar4005.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=3 STR_VAR item_to_add=~mewi452x~ END

END

COPY_EXISTING ~mewi453.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi453 END
	SAY NAME1 @33453
	SAY UNIDENTIFIED_DESC @34453

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI453~ scroll=~MEWI453X~ class_include=~{202, 5, 19}~ END

ACTION_IF GAME_IS ~iwdee~ BEGIN

COPY_EXISTING ~mewi453d.eff~ ~override~
	WRITE_ASCII 0x30 ~MS3GHL~ #8

END

COPY_EXISTING ~mewi453x.itm~ ~override~
	SAY NAME2 @33453
	SAY IDENTIFIED_DESC @34453
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~%arbg%5001.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=5 STR_VAR item_to_add=~mewi453x~ END

COPY_EXISTING ~cult2.cre~ ~override~
	ADD_CRE_ITEM ~mewi453x~ #0 #0 #0 ~NONE~ ~INV8~

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi453x~ BEFORE ~scrl5i~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~theshal.cre~ ~override~
	ADD_CRE_ITEM ~mewi453x~ #0 #0 #0 ~NONE~ ~INV4~

COPY_EXISTING ~ar2207.are~ ~override~ //Deirex's lair
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=2 STR_VAR item_to_add=~mewi453x~ END

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi453x~ BEFORE ~scrl5i~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar3503.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=3 STR_VAR item_to_add=~mewi453x~ END

END

COPY_EXISTING ~mewi454.spl~ ~override~
	SAY NAME1 @33454
	SAY UNIDENTIFIED_DESC @34454

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI454~ scroll=~MEWI454X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi454e.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR check_headers=1 check_globals=0 match_opcode=protectionfromspell2 match_parameter2=250 parameter2=splprot_backstabmultiplierlessthan END

COPY_EXISTING ~mewi454f.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR check_headers=1 check_globals=0 match_opcode=protectionfromspell2 match_parameter2=750 parameter2=splprot_backstabmultipliergreaterthanorequalto END

OUTER_SPRINT me_30023 @30023
LAF ADD_CONTINGENCY INT_VAR description=RESOLVE_STR_REF(@34454) STR_VAR resource= EVAL ~MEWI454~ title=~ME_BACKSTAB_SEQUENCER_TITLE~ title_name= EVAL ~%me_30023%~ action=~ADD_SPELLS_SEQUENCER_LABEL~ END

COPY_EXISTING ~mewi454x.itm~ ~override~
	SAY NAME2 @33454
	SAY IDENTIFIED_DESC @34454
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~wiven.cre~ ~override~
	ADD_CRE_ITEM ~mewi454x~ #0 #0 #0 ~NONE~ ~INV5~

COPY_EXISTING ~bdwaizah.sto~ ~override~
	ADD_STORE_ITEM ~mewi454x~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~bd0122.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=6 STR_VAR item_to_add=~mewi454x~ END
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi454x~ BEFORE ~scrl1u~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

/*
COPY_EXISTING ~arnfgt06.cre~ ~override~ ~arnwar06.cre~ ~override~
	ADD_CRE_ITEM ~mewi454x~ #0 #0 #0 ~NONE~ ~INV5~
*/

COPY_EXISTING ~maevar.cre~ ~override~
	ADD_CRE_ITEM ~mewi454x~ #0 #0 #0 ~NONE~ ~INV1~

COPY_EXISTING ~amsmug02.sto~ ~override~ //Amkethran smugglers
	ADD_STORE_ITEM ~mewi454x~ AFTER ~misc3p~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi454x~ BEFORE ~scrl1u~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ldd_nym.sto~ ~override~
	ADD_STORE_ITEM ~mewi454x~ AFTER ~sclich~ #1 #0 #0 ~IDENTIFIED~ #1

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi455.spl~ ~override~
	SAY NAME1 @33455
	SAY UNIDENTIFIED_DESC @34455

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI455~ scroll=~MEWI455X~ class_include=~{202, 5, 19}~ END

LAF EXCLUDE_SPELL_FROM_CONTINGENCY STR_VAR resource= EVAL ~MEWI455~ END

COPY_EXISTING ~mewi455x.itm~ ~override~
	SAY NAME2 @33455
	SAY IDENTIFIED_DESC @34455
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~kahrk.cre~ ~override~
	ADD_CRE_ITEM ~mewi455x~ #0 #0 #0 ~NONE~ ~INV7~

COPY_EXISTING ~bdsorcsc.sto~ ~override~
	ADD_STORE_ITEM ~mewi455x~ AFTER ~scrl5m~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi455x~ BEFORE ~scrl5g~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0309.are~ ~override~ //Harper Hold, 2nd floor
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=2 STR_VAR item_to_add=~mewi455x~ END

COPY_EXISTING ~udsvir05.sto~ ~override~ //Underdark Svirfneblin store
	ADD_STORE_ITEM ~mewi455x~ BEFORE ~scrl6p~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi455x~ AFTER ~scrl1z~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi455x~ BEFORE ~scrl5g~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar2100.bcs~ ~override~
	DECOMPILE_AND_PATCH BEGIN
		REPLACE_TEXTUALLY CASE_INSENSITIVE ~AddStoreItem(\"KUORK0\",\"SPWI319X\",1,1)~ ~AddStoreItem("KUORK0","MEWI455X",1,1)
AddStoreItem("KUORK0","SPWI319X",1,1)~
	END
END
END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) AND (me_power_spells = 1) BEGIN

COPY_EXISTING ~mewi456.spl~ ~override~
	SAY NAME1 @33456
	SAY UNIDENTIFIED_DESC @34456

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI456~ scroll=~MEWI456X~ class_include=~{202, 5, 19}~ END

LAF EXCLUDE_SPELL_FROM_CONTINGENCY STR_VAR resource= EVAL ~MEWI456~ END

COPY_EXISTING ~mewi456x.itm~ ~override~
	SAY NAME2 @33456
	SAY IDENTIFIED_DESC @34456
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~highhedg.sto~ ~override~ //High Hedge
	ADD_STORE_ITEM ~mewi456x~ AFTER ~scrl6g~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~sto0703.sto~ ~override~ //Sorcerous Sundries
	ADD_STORE_ITEM ~mewi456x~ AFTER ~scrl6o~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~bdsorcsc.sto~ ~override~
	ADD_STORE_ITEM ~mewi456x~ AFTER ~scrl5m~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi456x~ AFTER ~scrla8~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0530.are~ ~override~ //Bridge District warehouse with enemy party
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=3 STR_VAR item_to_add=~mewi456x~ END

COPY_EXISTING ~ar1605.are~ ~override~ //Perth the Adept's house
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=2 STR_VAR item_to_add=~mewi456x~ END

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi456x~ AFTER ~scrl1z~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi456x~ AFTER ~scrla8~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar2100.bcs~ ~override~
	DECOMPILE_AND_PATCH BEGIN
		REPLACE_TEXTUALLY CASE_INSENSITIVE ~AddStoreItem(\"KUORK0\",\"SPWI319X\",1,1)~ ~AddStoreItem("KUORK0","MEWI456X",1,1)
AddStoreItem("KUORK0","SPWI319X",1,1)~
	END
END

END

COPY_EXISTING ~mewi457.spl~ ~override~
	LPF ADD_SPELL_EFFECT INT_VAR insert_point=0 opcode=immunitytospellandmessage target=1 timing=0 duration=1 parameter2=splprot_areaisanoteleportzone special=RESOLVE_STR_REF(@30030) STR_VAR resource = EVAL ~mewi457~ END
	SAY NAME1 @33457
	SAY UNIDENTIFIED_DESC @34457

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI457~ scroll=~MEWI457X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~meportl1.spl~ ~override~ ~meportl2.spl~ ~override~
	LPF ALTER_SPELL_HEADER INT_VAR projectile=meportl END

LAF EXCLUDE_SPELL_FROM_CONTINGENCY STR_VAR resource= EVAL ~MEWI457~ END

COPY_EXISTING ~mewi457x.itm~ ~override~
	SAY NAME2 @33457
	SAY IDENTIFIED_DESC @34457
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~sto4906.sto~ ~override~ //Carnival Magic Trinkets Shop
	ADD_STORE_ITEM ~mewi457x~ BEFORE ~amul01~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi457x~ BEFORE ~scrl1z~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0705.are~ ~override~ //Mekrath's lair
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=6 STR_VAR item_to_add=~mewi457x~ END

COPY_EXISTING ~ribald.sto~ ~override~ //Adventurer Mart
	ADD_STORE_ITEM ~mewi457x~ AFTER ~scrl6m~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi457x~ AFTER ~scrl1z~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi457x~ BEFORE ~scrl1z~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar2100.bcs~ ~override~
	DECOMPILE_AND_PATCH BEGIN
		REPLACE_TEXTUALLY CASE_INSENSITIVE ~AddStoreItem(\"KUORK0\",\"SPWI319X\",1,1)~ ~AddStoreItem("KUORK0","MEWI457X",1,1)
AddStoreItem("KUORK0","SPWI319X",1,1)~
	END
END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi458.spl~ ~override~
	SAY NAME1 @33458
	SAY UNIDENTIFIED_DESC @34458

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI458~ scroll=~MEWI458X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi458x.itm~ ~override~
	SAY NAME2 @33458
	SAY IDENTIFIED_DESC @34458
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~%arbg%0138.are~ ~override~ //Ramazith's tower, top floor
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=3 STR_VAR item_to_add=~mewi458x~ END

COPY_EXISTING ~bd0115.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=2 STR_VAR item_to_add=~mewi458x~ END
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi458x~ AFTER ~scrl2b~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0803.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=1 STR_VAR item_to_add=~mewi458x~ END

COPY_EXISTING ~ar5006.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=2 STR_VAR item_to_add=~mewi458x~ END

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi458x~ AFTER ~scrl2b~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~bandoth.sto~ ~override~
	ADD_STORE_ITEM ~mewi458x~ BEFORE ~sccfe~ #1 #0 #0 ~IDENTIFIED~ #1

END

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi459.spl~ ~override~
	SAY NAME1 @33459
	SAY UNIDENTIFIED_DESC @34459

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI459~ scroll=~MEWI459X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi459x.itm~ ~override~
	SAY NAME2 @33459
	SAY IDENTIFIED_DESC @34459
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~highhedg.sto~ ~override~
	ADD_STORE_ITEM ~mewi459x~ BEFORE ~wand08~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~bdbeleg3.sto~ ~override~
	ADD_STORE_ITEM ~mewi459x~ BEFORE ~scrl6o~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi459x~ AFTER ~scrl5m~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0202.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=11 STR_VAR item_to_add=~mewi459x~ END

COPY_EXISTING ~shop08.sto~ ~override~
	ADD_STORE_ITEM ~mewi459x~ AFTER ~scrl5j~ #1 #0 #0 ~IDENTIFIED~ #3

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi459x~ AFTER ~scrl5m~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar5203.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=2 STR_VAR item_to_add=~mewi459x~ END

END

END

ACTION_IF (me_power_spells = 1) BEGIN

COPY_EXISTING ~mewi551.spl~ ~override~
	SAY NAME1 @33551
	SAY UNIDENTIFIED_DESC @34551

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI551~ scroll=~MEWI551X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi551x.itm~ ~override~
	SAY NAME2 @33551
	SAY IDENTIFIED_DESC @34551
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowpolymorphnegates%~ END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~ramazi.dlg~ ~override~
	DECOMPILE_AND_PATCH BEGIN
		REPLACE_TEXTUALLY CASE_INSENSITIVE ~GiveItem(\"BRAC02\",LastTalkedToBy)~ ~GiveItem("BRAC02",LastTalkedToBy)
GiveItemCreate("MEWI551X",Player1,1,0,0)~
    END

COPY_EXISTING ~bd1200.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=6 STR_VAR item_to_add=~mewi551x~ END
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi551x~ BEFORE ~scrl6v~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0808.are~ ~override~ //Vampire crypts (Chapter 6)
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=6 STR_VAR item_to_add=~mewi551x~ END

COPY_EXISTING ~ar1513.are~ ~override~ //Spellhold Dungeon, area with Dace and kobolds
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=5 STR_VAR item_to_add=~mewi551x~ END
/*
COPY_EXISTING ~ar1515.are~ ~override~ //Spellhold, first floor
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=5 STR_VAR item_to_add=~mewi551x~ END
*/

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi551x~ AFTER ~scrl6z~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi551x~ BEFORE ~scrl6v~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~edion.sto~ ~override~
	ADD_STORE_ITEM ~mewi551x~ BEFORE ~spwi618x~ #1 #0 #0 ~IDENTIFIED~ #1

END
END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi552.spl~ ~override~
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		LPF ALTER_EFFECT INT_VAR header=i match_opcode=402 parameter1=((i + 1) / 3) STR_VAR match_resource=~MESTEALS~ END
		numheaders = numheaders + 1
	END
	LPF ALTER_EFFECT INT_VAR header=0 match_opcode=402 parameter1=1 STR_VAR match_resource=~MESTEALS~ END
	LPF ALTER_EFFECT INT_VAR header=1 match_opcode=402 parameter1=1 STR_VAR match_resource=~MESTEALS~ END
	SAY NAME1 @33552
	SAY UNIDENTIFIED_DESC @34552

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI552~ scroll=~MEWI552X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi552x.itm~ ~override~
	SAY NAME2 @33552
	SAY IDENTIFIED_DESC @34552
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

COPY_EXISTING ~hidespl.2da~ ~override~
	COUNT_2DA_COLS numcolumns
	COUNT_2DA_ROWS numcolumns numrows
	PATCH_IF numcolumns = 3 BEGIN
		INSERT_2DA_ROW numrows numcolumns ~mewi552    1          0~
	END ELSE PATCH_IF numcolumns = 4 BEGIN
		INSERT_2DA_ROW numrows numcolumns ~mewi552    1          0          0~
	END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~bdsethyl.cre~ ~override~
	ADD_CRE_ITEM ~mewi552x~ #0 #0 #0 ~NONE~ ~INV7~
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi552x~ BEFORE ~scrlal~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~gorch.sto~ ~override~
	ADD_STORE_ITEM ~mewi552x~ AFTER ~scrl91~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi552x~ BEFORE ~scrlal~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi552x~ BEFORE ~scrlal~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar5104.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=4 STR_VAR item_to_add=~mewi552x~ END

END

END

COPY_EXISTING ~missile.ids~ ~override~
	COUNT_2DA_ROWS 2 numrows
	READ_2DA_ENTRY (numrows - 1) 0 2 newrow
	newrow = newrow + 1
	startrow = newrow + 8
	FOR (i = 1; i <= 30; ++i) BEGIN
 		INSERT_2DA_ROW numrows 2 ~%newrow% Ball Lightning %i%~
		INNER_ACTION BEGIN
			COPY_EXISTING ~m_mestr1.lua~ ~override~
				REPLACE_TEXTUALLY CASE_INSENSITIVE ~me_lightning_projectiles = {~ ~me_lightning_projectiles = {[%newrow%] = true, ~
				IF_EXISTS
		END
		numrows = numrows + 1
		newrow = newrow + 1

	END

COPY_EXISTING ~projectl.ids~ ~override~
	COUNT_2DA_ROWS 2 numrows
	READ_2DA_ENTRY (numrows - 1) 0 2 newrow
	newrow = newrow + 1
	INSERT_2DA_ROW numrows 2 ~%newrow% meballi~
	numrows = numrows + 1
	newrow = newrow + 1
	FOR (i = 2; i <= 30; ++i) BEGIN
		INSERT_2DA_ROW numrows 2 ~%newrow% meballi2~
		numrows = numrows + 1
		newrow = newrow + 1
	END

COPY_EXISTING ~mewi554.spl~ ~override~
	READ_SHORT 0x68 numheaders
	FOR (i = 1; i <= numheaders; ++i) BEGIN
		LPF ALTER_SPELL_HEADER INT_VAR header=i projectile=startrow END
		startrow = startrow + 1
	END
	SAY NAME1 @33554
	SAY UNIDENTIFIED_DESC @34554

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI554~ scroll=~MEWI554X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi554x.itm~ ~override~
	SAY NAME2 @33554
	SAY IDENTIFIED_DESC @34554
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~%arbg%0161.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=3 STR_VAR item_to_add=~mewi554x~ END

COPY_EXISTING ~%arbg%3901.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=7 STR_VAR item_to_add=~mewi554x~ END

COPY_EXISTING ~bdsorcsc.sto~ ~override~
	ADD_STORE_ITEM ~mewi554x~ AFTER ~scrl2d~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi554x~ AFTER ~scrl2d~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0904.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=6 STR_VAR item_to_add=~mewi554x~ END

COPY_EXISTING ~ar3016.are~ ~override~ //Watcher's Keep, second floor
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=17 STR_VAR item_to_add=~mewi554x~ END

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi554x~ AFTER ~scrl2f~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi554x~ AFTER ~scrl2d~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar2100.bcs~ ~override~
	DECOMPILE_AND_PATCH BEGIN
		REPLACE_TEXTUALLY CASE_INSENSITIVE ~AddStoreItem(\"KUORK0\",\"SPWI319X\",1,1)~ ~AddStoreItem("KUORK0","MEWI554X",1,1)
AddStoreItem("KUORK0","SPWI319X",1,1)~
	END

COPY_EXISTING ~bandoth.sto~ ~override~
	ADD_STORE_ITEM ~mewi554x~ AFTER ~scssha~ #1 #0 #0 ~IDENTIFIED~ #1

END

COPY_EXISTING ~mewi555.spl~ ~override~
	SAY NAME1 @33555
	SAY UNIDENTIFIED_DESC @34555

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI555~ scroll=~MEWI555X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi555d.spl~ ~override~
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		numheaders = numheaders + 1
		LPF ADD_SPELL_EFFECT INT_VAR header=(i + 1) power=5 opcode=projectimage target=1 timing=0 duration=6 parameter2=1 resist_dispel=3 END
		LPF ALTER_SPELL_EFFECT INT_VAR header=(i + 1) duration_high=((i + 4) * 6) END
	END
	LPF ADD_SPELL_EFFECT INT_VAR opcode=removeeffectsbyresource target=1 timing=1 STR_VAR resource= EVAL ~mewi555~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode=removeinvisibility1 target=1 timing=1 END
	LPF ADD_SPELL_EFFECT INT_VAR opcode=removeinvisibility2 target=1 timing=1 END
	LPF ADD_SPELL_EFFECT INT_VAR opcode=removeinvisibility1 target=1 timing=4 duration=1 END
	LPF ADD_SPELL_EFFECT INT_VAR opcode=removeinvisibility2 target=1 timing=4 duration=1 END

COPY_EXISTING ~mislead.spl~ ~override~
	LPF ADD_SPELL_EFFECT INT_VAR opcode=applyeffectslist target=1 timing=1 parameter1=69 parameter2=110 STR_VAR resource= EVAL ~mewi555i~ END

COPY_EXISTING ~mewi555x.itm~ ~override~
	SAY NAME2 @33555
	SAY IDENTIFIED_DESC @34555
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~krysti.cre~ ~override~
	ADD_CRE_ITEM ~mewi555x~ #0 #0 #0 ~NONE~ ~INV5~

COPY_EXISTING ~bdsorcsc.sto~ ~override~
	ADD_STORE_ITEM ~mewi555x~ BEFORE ~scrl2g~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi555x~ BEFORE ~scrl7d~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~kalah2.cre~ ~override~
	ADD_CRE_ITEM ~mewi555x~ #1 #0 #0 ~NONE~ ~INV7~

COPY_EXISTING ~suelf10.sto~ ~override~ //Temple of Rillifane
	ADD_STORE_ITEM ~mewi555x~ BEFORE ~scrl5t~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi555x~ BEFORE ~scrl6u~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi555x~ BEFORE ~scrl7d~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar2100.bcs~ ~override~
	DECOMPILE_AND_PATCH BEGIN
		REPLACE_TEXTUALLY CASE_INSENSITIVE ~AddStoreItem(\"KUORK0\",\"SPWI319X\",1,1)~ ~AddStoreItem("KUORK0","MEWI555X",1,1)
AddStoreItem("KUORK0","SPWI319X",1,1)~
	END
END

ACTION_IF !(MOD_IS_INSTALLED ~MESpells.tp2~ ~25011~) AND !(MOD_IS_INSTALLED ~MESpells.tp2~ ~25012~) BEGIN

COPY_EXISTING ~mewi556.spl~ ~override~
	SAY NAME1 @33556
	SAY UNIDENTIFIED_DESC @34556

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI556~ scroll=~MEWI556X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mehordsu.cre~ ~override~
	SAY NAME1 @30028
	SAY NAME2 @30028

COPY_EXISTING ~mewi556x.itm~ ~override~
	SAY NAME2 @33556
	SAY IDENTIFIED_DESC @34556
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

STRING_SET_EVALUATE 15015 @30027

COPY_EXISTING ~arkion.cre~ ~override~
	ADD_CRE_ITEM ~mewi556x~ #0 #0 #0 ~NONE~ ~INV7~

COPY_EXISTING ~arkion.dlg~ ~override~
	DECOMPILE_AND_PATCH BEGIN
		REPLACE_TEXTUALLY CASE_INSENSITIVE ~GivePartyGold(250)~ ~GivePartyGold(250)
GiveItem("MEWI556X",LastTalkedToBy)~
    END

COPY_EXISTING ~bd0130.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=26 STR_VAR item_to_add=~mewi556x~ END
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi556x~ AFTER ~scrl2h~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~xzar.cre~ ~override~
	ADD_CRE_ITEM ~mewi556x~ #0 #0 #0 ~NONE~ ~INV4~

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi556x~ AFTER ~scrl2h~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~presio.cre~ ~override~
	ADD_CRE_ITEM ~mewi556x~ #0 #0 #0 ~NONE~ ~INV10~

END
END

COPY_EXISTING ~mewi557.spl~ ~override~
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		LPF ALTER_SPELL_EFFECT INT_VAR header=(i + 1) duration_high=((i + 1) * 6) END
		numheaders = numheaders + 1
	END
	SAY NAME1 @33557
	SAY UNIDENTIFIED_DESC @34557

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI557~ scroll=~MEWI557X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mekob8su.cre~ ~override~
	SAY NAME1 @30029
	SAY NAME2 @30029

COPY_EXISTING ~mewi557x.itm~ ~override~
	SAY NAME2 @33557
	SAY IDENTIFIED_DESC @34557
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~ogrema02.cre~ ~override~
	ADD_CRE_ITEM ~mewi557x~ #0 #0 #0 ~NONE~ ~INV1~

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi557x~ BEFORE ~scrl2g~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~sewrak01.cre~ ~override~
	ADD_CRE_ITEM ~mewi557x~ #0 #0 #0 ~NONE~ ~INV6~

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi557x~ AFTER ~scrl2g~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi557x~ BEFORE ~scrl2g~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar2100.bcs~ ~override~
	DECOMPILE_AND_PATCH BEGIN
		REPLACE_TEXTUALLY CASE_INSENSITIVE ~AddStoreItem(\"KUORK0\",\"SPWI319X\",1,1)~ ~AddStoreItem("KUORK0","MEWI557X",1,1)
AddStoreItem("KUORK0","SPWI319X",1,1)~
	END
END

ACTION_IF (me_power_spells = 1) BEGIN

COPY_EXISTING ~mewi558.spl~ ~override~
	LPF ALTER_SPELL_HEADER INT_VAR projectile=mepatien END
	SAY NAME1 @33558
	SAY UNIDENTIFIED_DESC @34558

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI558~ scroll=~MEWI558X~ class_include=~{202, 5, 19}~ END

LAF EXCLUDE_SPELL_FROM_CONTINGENCY STR_VAR resource= EVAL ~MEWI558~ END

COPY_EXISTING ~mewi558x.itm~ ~override~
	SAY NAME2 @33558
	SAY IDENTIFIED_DESC @34558
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowspellhalf%~ END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~%arbg%1504.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=1 STR_VAR item_to_add=~mewi558x~ END

COPY_EXISTING ~bdolvena.cre~ ~override~
	ADD_CRE_ITEM ~mewi558x~ #0 #0 #0 ~NONE~ ~INV7~
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi558x~ AFTER ~scrl7d~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar1800.are~ ~override~ //Wilderness area with graves and genie
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=1 STR_VAR item_to_add=~mewi558x~ END

/*
COPY_EXISTING ~ar1513.are~ ~override~ //Spellhold Dungeon, area with Dace and kobolds
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=5 STR_VAR item_to_add=~mewi558x~ END
*/
COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi558x~ AFTER ~scrl5q~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi558x~ AFTER ~scrl7d~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~kieran2.sto~ ~override~
	ADD_STORE_ITEM ~mewi558x~ AFTER ~scrl6u~ #1 #0 #0 ~IDENTIFIED~ #1

END
END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi559.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi559 END
//	LPF ALTER_EFFECT INT_VAR check_headers=1 check_globals=0 match_opcode=protectionfromspell2 match_parameter2=2500 parameter2=splprot_meinflight END
	LPF ADD_SPELL_EFFECT INT_VAR insert_point=0 opcode=immunitytospellandmessage target=1 timing=0 duration=1 parameter2=splprot_areaisanoteleportzone special=RESOLVE_STR_REF(@30030) STR_VAR resource = EVAL ~mewi559~ END
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		LPF ALTER_SPELL_EFFECT INT_VAR header=(i + 1) duration_high=((i + 7) * 3) END
//		LPF ALTER_EFFECT INT_VAR header=i match_opcode=eeexsetextendedstat match_special=640 parameter1=(i + 21) END
		numheaders = numheaders + 1
	END
	SAY NAME1 @33559
	SAY UNIDENTIFIED_DESC @34559

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI559~ scroll=~MEWI559X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi559d.spl~ ~override~

COPY_EXISTING ~mewi559d.eff~ ~override~
	WRITE_LONG effparameter1 0
	WRITE_LONG effparameter2 splprot_meflyingspeedequalto

COPY_EXISTING ~meethreo.eff~ ~override~
	WRITE_LONG effparameter1 0
	WRITE_LONG effparameter2 splprot_meflyingspeedequalto

COPY_EXISTING ~mewi559x.itm~ ~override~
	SAY NAME2 @33559
	SAY IDENTIFIED_DESC @34559
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~andris.cre~ ~override~
	ADD_CRE_ITEM ~mewi559x~ #0 #0 #0 ~NONE~ ~INV7~

COPY_EXISTING ~%arbg%2613.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=1 STR_VAR item_to_add=~mewi559x~ END

COPY_EXISTING ~bdsorcsc.sto~ ~override~
	ADD_STORE_ITEM ~mewi559x~ AFTER ~scrl2f~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi559x~ BEFORE ~scrl5q~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar1401.are~ ~override~ //Temple Ruins, first floor
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=9 STR_VAR item_to_add=~mewi559x~ END

COPY_EXISTING ~bernard2.sto~ ~override~ //Copper Coronet (discount)
	ADD_STORE_ITEM ~mewi559x~ BEFORE ~arow08~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi559x~ AFTER ~scrl2h~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi559x~ BEFORE ~scrl5q~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~de_lib.sto~ ~override~
	ADD_STORE_ITEM ~mewi559x~ AFTER ~scrl5m~ #1 #0 #0 ~IDENTIFIED~ #1

END
END

COPY_EXISTING ~mewi560.spl~ ~override~
	SAY NAME1 @33560
	SAY UNIDENTIFIED_DESC @34560

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI560~ scroll=~MEWI560X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi560x.itm~ ~override~
	SAY NAME2 @33560
	SAY IDENTIFIED_DESC @34560
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowspellpartial%~ END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~schlum.cre~ ~override~
	ADD_CRE_ITEM ~mewi560x~ #0 #0 #0 ~NONE~ ~INV7~

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi560x~ BEFORE ~scrl6s~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~dagmag01.cre~ ~override~
	ADD_CRE_ITEM ~mewi560x~ #0 #0 #0 ~NONE~ ~INV7~

COPY_EXISTING ~ar3016.are~ ~override~ //Watcher's Keep, second floor
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=16 STR_VAR item_to_add=~mewi560x~ END

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi560x~ BEFORE ~scrl6s~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar8010.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=1 STR_VAR item_to_add=~mewi560x~ END

END
/*


LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI561~ scroll=~MEWI561X~ class_include=~{202, 5, 19}~ END
COPY_EXISTING ~mewi561.spl~ ~override~
	SAY NAME1 @33561
	SAY UNIDENTIFIED_DESC @34561

COPY_EXISTING ~mewi561x.itm~ ~override~
	SAY NAME2 @33561
	SAY IDENTIFIED_DESC @34561

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~friend.sto~ ~override~ //Friendly Arm Inn
	ADD_STORE_ITEM ~mewi561x~ BEFORE ~book40~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

END
*/

COPY_EXISTING ~mewi563.spl~ ~override~
	SAY NAME1 @33563
	SAY UNIDENTIFIED_DESC @34563

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI563~ scroll=~MEWI563X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi563d.spl~ ~override~
	LPF CLONE_EFFECT INT_VAR check_headers=1 check_globals=0 match_opcode=protectionfromspell opcode=protectionfromspell2 parameter2=splprot_canhavemultiplesimulacra special=0 STR_VAR match_resource=~mewi563~ insert=~above~ END

	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		LPF ALTER_SPELL_EFFECT INT_VAR header=(i + 1) duration_high=((i + 1) * 6) END
		numheaders = numheaders + 1
	END

COPY_EXISTING ~mewi563x.itm~ ~override~
	SAY NAME2 @33563
	SAY IDENTIFIED_DESC @34563
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~bd7230.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=4 STR_VAR item_to_add=~mewi563x~ END
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi563x~ AFTER ~scrlal~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~pwarden.cre~ ~override~
	ADD_CRE_ITEM ~mewi563x~ #0 #0 #0 ~NONE~ ~INV8~

COPY_EXISTING ~ar2100.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=6 STR_VAR item_to_add=~mewi563x~ END

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi563x~ AFTER ~scrlar~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar5403.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=2 STR_VAR item_to_add=~mewi563x~ END

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) AND (me_power_spells = 1) BEGIN

COPY_EXISTING ~mewi564.spl~ ~override~
	SAY NAME1 @33564
	SAY UNIDENTIFIED_DESC @34564

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI564~ scroll=~MEWI564X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~instant.ids~ ~override~
	REPLACE_TEXTUALLY ~327~ ~323 CreateCreatureImpassableAllowOverlap(S:NewObject*,P:Location*,I:Face*DIR)
323 CreateCreatureImpassableAllowOverlapEffect(S:NewObject*,S:Effect*,P:Location*,I:Face*DIR)
327~
	UNLESS ~323~

COPY_EXISTING ~mewi564x.itm~ ~override~
	SAY NAME2 @33564
	SAY IDENTIFIED_DESC @34564
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~sto0703.sto~ ~override~ //Sorcerous Sundries
	ADD_STORE_ITEM ~mewi564x~ AFTER ~scrlal~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~bdcrus13.cre~ ~override~
	ADD_CRE_ITEM ~mewi564x~ #0 #0 #0 ~NONE~ ~INV4~
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi564x~ AFTER ~scrlal~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar1202.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=12 STR_VAR item_to_add=~mewi564x~ END

COPY_EXISTING ~udduer01.sto~ ~override~
	ADD_STORE_ITEM ~mewi564x~ AFTER ~scrl8x~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~
	ADD_STORE_ITEM ~mewi564x~ AFTER ~scrl5q~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi564x~ AFTER ~scrlar~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar2100.bcs~ ~override~
	DECOMPILE_AND_PATCH BEGIN
		REPLACE_TEXTUALLY CASE_INSENSITIVE ~AddStoreItem(\"KUORK0\",\"SCRL6W\",1,1)~ ~AddStoreItem("KUORK0","SCRL6W",1,1)
		AddStoreItem("KUORK0","MEWI564X",1,1)~
	END

END

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) AND (me_power_spells = 1) BEGIN

COPY_EXISTING ~mewi562.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi562 END
	SAY NAME1 @33562
	SAY UNIDENTIFIED_DESC @34562

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI562~ scroll=~MEWI562X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi562e.spl~ ~override~
	READ_LONG 0x6a effectsoffset
	READ_SHORT 0x90 numeffects
	FOR (i = 0; i < numeffects; ++i) BEGIN
		me_off = effectsoffset + (i * 0x30)
		READ_SHORT me_off theopcode
		READ_ASCII (me_off + 0x14) theresource
		PATCH_IF theopcode = 402 AND (~%theresource%~ STRING_EQUAL_CASE ~MECRTSPL~) BEGIN
			WRITE_ASCIIE (me_off + 0x4) ~MEWI562~ #8
		END
	END

OUTER_SPRINT me_30076 @30076
OUTER_SPRINT me_33562 @33562
LAF ADD_CONTINGENCY INT_VAR new_title=0 description=RESOLVE_STR_REF(@34562) STR_VAR resource= EVAL ~MEWI562~ title=~ME_CRITICAL_SPELL_TITLE~ action=~ME_CRITICAL_SPELL_LABEL~ END

COPY_EXISTING ~m_mealtc.lua~ ~override~
	ref_30068 = RESOLVE_STR_REF(@30068)
	ref_30069 = RESOLVE_STR_REF(@30069)
	ref_30070 = RESOLVE_STR_REF(@30070)
	ref_30071 = RESOLVE_STR_REF(@30071)
	ref_30072 = RESOLVE_STR_REF(@30072)
	ref_30073 = RESOLVE_STR_REF(@30073)
	REPLACE_TEXTUALLY CASE_INSENSITIVE ~me_alt_contingency = {~ ~me_alt_contingency = {
['MEWI562'] = {['conditions'] = {{['strref'] = %ref_30068%, ['desc'] = %ref_30069%}}, ['targets'] = {{['strref'] = %ref_30070%, ['desc'] = %ref_30071%}, {['strref'] = %ref_30072%, ['desc'] = %ref_30073%}},},~

COPY_EXISTING ~mewi562x.itm~ ~override~
	SAY NAME2 @33562
	SAY IDENTIFIED_DESC @34562
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~bd4300.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=2 STR_VAR item_to_add=~mewi562x~ END
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi562x~ AFTER ~scrl6x~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar1301.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=2 STR_VAR item_to_add=~mewi562x~ END

COPY_EXISTING ~amarch01.cre~ ~override~
	ADD_CRE_ITEM ~mewi562x~ #0 #0 #0 ~NONE~ ~INV6~

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi562x~ AFTER ~scrl6x~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar8006.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=3 STR_VAR item_to_add=~mewi562x~ END

END

END

COPY_EXISTING ~mewi565.spl~ ~override~
	SAY NAME1 @33565
	SAY UNIDENTIFIED_DESC @34565

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI565~ scroll=~MEWI565X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi565d.spl~ ~override~
	LPF ALTER_SPELL_HEADER INT_VAR projectile=mesacrif END

COPY_EXISTING ~mewi565x.itm~ ~override~
	SAY NAME2 @33565
	SAY IDENTIFIED_DESC @34565
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowdeathhalf%~ END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~bd1200.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=12 STR_VAR item_to_add=~mewi565x~ END
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi565x~ BEFORE ~scrl2h~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0410.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=1 STR_VAR item_to_add=~mewi565x~ END

COPY_EXISTING ~uddrow25.sto~ ~override~
	ADD_STORE_ITEM ~mewi565x~ BEFORE ~scrl7c~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi565x~ BEFORE ~scrl2h~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar4003.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=1 STR_VAR item_to_add=~mewi565x~ END

END

COPY_EXISTING ~mewi566.spl~ ~override~
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_EFFECT INT_VAR header=(i + 1) duration_high=((i + 1) * 6) END
		numheaders = numheaders + 1
	END
	FOR (i = 1; i <= numheaders; ++i) BEGIN
		LPF ALTER_SPELL_HEADER INT_VAR header=i min_level=i END
		LPF ALTER_SPELL_EFFECT INT_VAR header=i duration_high=((i + 3) * 6) END
	END
	SAY NAME1 @33566
	SAY UNIDENTIFIED_DESC @34566

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI566~ scroll=~MEWI566X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi566x.itm~ ~override~
	SAY NAME2 @33566
	SAY IDENTIFIED_DESC @34566
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowpolymorphpartial%~ END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~%arbg%3901.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=7 STR_VAR item_to_add=~mewi566x~ END

COPY_EXISTING ~sto0703.sto~ ~override~
	ADD_STORE_ITEM ~mewi566x~ AFTER ~scrlal~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~bdsorcsc.sto~ ~override~
	ADD_STORE_ITEM ~mewi566x~ AFTER ~scrl2g~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi566x~ AFTER ~scrl5q~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0407.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=3 STR_VAR item_to_add=~mewi566x~ END

COPY_EXISTING ~scrolls.sto~ ~override~
	ADD_STORE_ITEM ~mewi566x~ AFTER ~scrlal~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~
	ADD_STORE_ITEM ~mewi566x~ AFTER ~scrl5q~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi566x~ AFTER ~scrl5q~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar2100.bcs~ ~override~
	DECOMPILE_AND_PATCH BEGIN
		REPLACE_TEXTUALLY CASE_INSENSITIVE ~AddStoreItem(\"KUORK0\",\"SCRL6W\",1,1)~ ~AddStoreItem("KUORK0","SCRL6W",1,1)
		AddStoreItem("KUORK0","MEWI566X",1,1)~
	END

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi567.spl~ ~override~
	SAY NAME1 @33567
	SAY UNIDENTIFIED_DESC @34567

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI567~ scroll=~MEWI567X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi567x.itm~ ~override~
	SAY NAME2 @33567
	SAY IDENTIFIED_DESC @34567
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~%arbg%1505.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=1 STR_VAR item_to_add=~mewi567x~ END

COPY_EXISTING ~%arbg%3901.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=7 STR_VAR item_to_add=~mewi567x~ END

COPY_EXISTING ~bdnazram.sto~ ~override~
	ADD_STORE_ITEM ~mewi567x~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~bpding01.sto~ ~override~ //Black Pits scroll store
	ADD_STORE_ITEM ~mewi567x~ AFTER ~scrl6t~ #1 #0 #0 ~IDENTIFIED~ #3
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0411.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=4 STR_VAR item_to_add=~mewi567x~ END

COPY_EXISTING ~scrolls.sto~ ~override~
	ADD_STORE_ITEM ~mewi567x~ AFTER ~scrlal~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~
	ADD_STORE_ITEM ~mewi567x~ AFTER ~scrl6t~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi567x~ AFTER ~scrl6t~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar5104.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=3 STR_VAR item_to_add=~mewi567x~ END

END

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi568.spl~ ~override~
	SAY NAME1 @33568
	SAY UNIDENTIFIED_DESC @34568

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI568~ scroll=~MEWI568X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~metelc1.spl~ ~override~
	READ_LONG 0x18 ulgiash
	ulgiash|=0x80000000
	WRITE_LONG 0x18 ulgiash
	SAY NAME1 @30171
	SAY NAME2 @30121
	SAY UNIDENTIFIED_DESC @34568

COPY_EXISTING ~metelc2.spl~ ~override~
	READ_LONG 0x18 ulgiash
	ulgiash|=0x80000000
	WRITE_LONG 0x18 ulgiash
	SAY NAME1 @30172
	SAY NAME2 @30122
	SAY UNIDENTIFIED_DESC @34568

COPY_EXISTING ~metelc3.spl~ ~override~
	READ_LONG 0x18 ulgiash
	ulgiash|=0x80000000
	WRITE_LONG 0x18 ulgiash
	SAY NAME1 @30173
	SAY NAME2 @30123
	SAY UNIDENTIFIED_DESC @34568

COPY_EXISTING ~metelc4.spl~ ~override~
	READ_LONG 0x18 ulgiash
	ulgiash|=0x80000000
	WRITE_LONG 0x18 ulgiash
	SAY NAME1 @30174
	SAY NAME2 @30124
	SAY UNIDENTIFIED_DESC @34568

COPY_EXISTING ~metelc5.spl~ ~override~
	READ_LONG 0x18 ulgiash
	ulgiash|=0x80000000
	WRITE_LONG 0x18 ulgiash
	SAY NAME1 @30175
	SAY NAME2 @30125
	SAY UNIDENTIFIED_DESC @34568

COPY_EXISTING ~metelc6.spl~ ~override~
	READ_LONG 0x18 ulgiash
	ulgiash|=0x80000000
	WRITE_LONG 0x18 ulgiash
	SAY NAME1 @30176
	SAY NAME2 @30126
	SAY UNIDENTIFIED_DESC @34568

COPY_EXISTING ~metelc7.spl~ ~override~
	READ_LONG 0x18 ulgiash
	ulgiash|=0x80000000
	WRITE_LONG 0x18 ulgiash
	SAY NAME1 @30177
	SAY NAME2 @30127
	SAY UNIDENTIFIED_DESC @34568

COPY_EXISTING ~metelci1.cre~ ~override~
	WRITE_LONG animation slotteleportcircledecimal
	SAY NAME1 @30121
	SAY NAME2 @30121

COPY_EXISTING ~metelci2.cre~ ~override~
	WRITE_LONG animation slotteleportcircledecimal
	SAY NAME1 @30122
	SAY NAME2 @30122

COPY_EXISTING ~metelci3.cre~ ~override~
	WRITE_LONG animation slotteleportcircledecimal
	SAY NAME1 @30123
	SAY NAME2 @30123

COPY_EXISTING ~metelci4.cre~ ~override~
	WRITE_LONG animation slotteleportcircledecimal
	SAY NAME1 @30124
	SAY NAME2 @30124

COPY_EXISTING ~metelci5.cre~ ~override~
	WRITE_LONG animation slotteleportcircledecimal
	SAY NAME1 @30125
	SAY NAME2 @30125

COPY_EXISTING ~metelci6.cre~ ~override~
	WRITE_LONG animation slotteleportcircledecimal
	SAY NAME1 @30126
	SAY NAME2 @30126

COPY_EXISTING ~metelci7.cre~ ~override~
	WRITE_LONG animation slotteleportcircledecimal
	SAY NAME1 @30127
	SAY NAME2 @30127

COMPILE ~override/metelcir.d~

COPY_EXISTING ~metelcir.bcs~ ~override~
	DECOMPILE_AND_PATCH BEGIN
		REPLACE ~30133~ @30133
	END

COPY_EXISTING ~mewi568x.itm~ ~override~
	SAY NAME2 @33568
	SAY IDENTIFIED_DESC @34568
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~highhedg.sto~ ~override~
	ADD_STORE_ITEM ~mewi568x~ BEFORE ~wand08~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~sto0703.sto~ ~override~
	ADD_STORE_ITEM ~mewi568x~ AFTER ~scrlal~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~bdsorcsc.sto~ ~override~
	ADD_STORE_ITEM ~mewi568x~ AFTER ~scrl2g~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0705.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=6 STR_VAR item_to_add=~mewi568x~ END

COPY_EXISTING ~scrolls.sto~ ~override~
	ADD_STORE_ITEM ~mewi568x~ BEFORE ~scrlal~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~
	ADD_STORE_ITEM ~mewi568x~ AFTER ~scrlar~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi568x~ AFTER ~scrlar~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar2100.bcs~ ~override~
	DECOMPILE_AND_PATCH BEGIN
		REPLACE_TEXTUALLY CASE_INSENSITIVE ~AddStoreItem(\"KUORK0\",\"SCRL6W\",1,1)~ ~AddStoreItem("KUORK0","SCRL6W",1,1)
		AddStoreItem("KUORK0","MEWI568X",1,1)~
	END

END

END

COPY_EXISTING ~mewi651.spl~ ~override~
	PATCH_IF NOT MOD_IS_INSTALLED ~EEex.tp2~ ~0~ BEGIN
		READ_SHORT 0x68 numheaders
		FOR (i = numheaders; i < 50; ++i) BEGIN
			LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
			LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
			numheaders = numheaders + 1
			LPF ADD_SPELL_EFFECT INT_VAR header=(i + 1) opcode=castspell target=2 timing=1 parameter2=1 resist_dispel=2 STR_VAR resource=~MEWI651D~ END
		END
		SAY NAME1 @33651
		SAY UNIDENTIFIED_DESC @34651
	END ELSE BEGIN
		LPF ALTER_EFFECT INT_VAR check_headers=1 check_globals=0 match_opcode=castspell opcode=eeexinvokelua target=2 timing=0 duration=0 parameter1=0x4957454D parameter2=0x44313536 savingthrow=0x700000 special=256 STR_VAR match_resource=~MEWI651D~ resource=~MERANDSP~ END
		READ_SHORT 0x68 numheaders
		FOR (i = numheaders; i < 50; ++i) BEGIN
			LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
			LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
			numheaders = numheaders + 1
			LPF ADD_SPELL_EFFECT INT_VAR header=(i + 1) opcode=eeexinvokelua target=2 timing=0 parameter1=0x4957454D parameter2=0x44313536 savingthrow=0x700000 special=256 STR_VAR resource=~MERANDSP~ END
		END
		SAY NAME1 @33651
		SAY UNIDENTIFIED_DESC @30100
	END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI651~ scroll=~MEWI651X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi651d.spl~ ~override~
	LPF ALTER_SPELL_HEADER INT_VAR projectile=meranmis END

COPY_EXISTING ~mewi651x.itm~ ~override~
	SAY NAME2 @33651
	SAY IDENTIFIED_DESC @34651
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0317.are~ ~override~ //Guarded Compound, top floor
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=17 STR_VAR item_to_add=~mewi651x~ END

COPY_EXISTING ~scrolls.sto~ ~override~ //Scroll store in Adventurer Mart
	ADD_STORE_ITEM ~mewi651x~ AFTER ~mewi556x~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi651x~ AFTER ~scrl7s~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi651x~ AFTER ~scrl7e~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar2100.bcs~ ~override~
	DECOMPILE_AND_PATCH BEGIN
		REPLACE_TEXTUALLY CASE_INSENSITIVE ~AddStoreItem(\"KUORK0\",\"SCRL6W\",1,1)~ ~AddStoreItem("KUORK0","MEWI651X",1,1)
AddStoreItem("KUORK0","SCRL6W",1,1)~
	END

COPY_EXISTING ~alpheus.cre~ ~override~ ~alpheusd.cre~ ~override~
	ADD_CRE_ITEM ~mewi651x~ #0 #0 #0 ~NONE~ ~INV12~

END

COPY_EXISTING ~mewi652.spl~ ~override~
	SAY NAME1 @33652
	SAY UNIDENTIFIED_DESC @34652

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI652~ scroll=~MEWI652X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi652x.itm~ ~override~
	SAY NAME2 @33652
	SAY IDENTIFIED_DESC @34652
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar1103.are~ ~override~ //Jermien's house
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=4 STR_VAR item_to_add=~mewi652x~ END

COPY_EXISTING ~udduer01.sto~ ~override~ //Duergar store (worse goods)
	ADD_STORE_ITEM ~mewi652x~ AFTER ~scrl7q~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi652x~ AFTER ~scrl7k~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi652x~ AFTER ~scrl7h~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar2100.bcs~ ~override~
	DECOMPILE_AND_PATCH BEGIN
		REPLACE_TEXTUALLY CASE_INSENSITIVE ~AddStoreItem(\"KUORK0\",\"SCRL6W\",1,1)~ ~AddStoreItem("KUORK0","MEWI652X",1,1)
AddStoreItem("KUORK0","SCRL6W",1,1)~
	END
END

COPY_EXISTING ~mewi653.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR check_headers=1 check_globals=0 match_opcode=protectionfromspell2 match_parameter2=2250 parameter2=splprot_isnotsleeping END
	SAY NAME1 @33653
	SAY UNIDENTIFIED_DESC @34653

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI653~ scroll=~MEWI653X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi653x.itm~ ~override~
	SAY NAME2 @33653
	SAY IDENTIFIED_DESC @34653
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~uddrow25.sto~ ~override~ //Ust Natha drow scroll store
	ADD_STORE_ITEM ~mewi653x~ AFTER ~scrl7r~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi653x~ AFTER ~scrl7f~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ldd_nym.sto~ ~override~
	ADD_STORE_ITEM ~mewi653x~ AFTER ~scrl8b~ #1 #0 #0 ~IDENTIFIED~ #1

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi654.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi654 END
	SAY NAME1 @33654
	SAY UNIDENTIFIED_DESC @34654
/*
LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI654~ scroll=~MEWI654X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi654x.itm~ ~override~
	SAY NAME2 @33654
	SAY IDENTIFIED_DESC @34654
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~shandal2.dlg~ ~override~
	DECOMPILE_AND_PATCH BEGIN
		REPLACE_TEXTUALLY CASE_INSENSITIVE ~TakePartyItem(\"MISC2H\")~ ~TakePartyItem("MISC2H")
GiveItemCreate("MEWI654X",Player1,1,0,0)~
    END

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~firrak01.cre~ ~override~
	ADD_CRE_ITEM ~mewi654x~ #0 #0 #0 ~NONE~ ~INV7~

COPY_EXISTING ~ar5201.are~ ~override~ //Yaga-Shura Temple, first floor
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=1 STR_VAR item_to_add=~mewi654x~ END

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi654x~ AFTER ~scrl7v~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~bandoth.sto~ ~override~
	ADD_STORE_ITEM ~mewi654x~ BEFORE ~potn08~ #1 #0 #0 ~IDENTIFIED~ #1

END
*/
END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) AND (me_power_spells = 1) BEGIN

COPY_EXISTING ~mewi655.spl~ ~override~
	SAY NAME1 @33655
	SAY UNIDENTIFIED_DESC @34655

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI655~ scroll=~MEWI655X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi655e.spl~ ~override~
	READ_LONG 0x6a effectsoffset
	READ_SHORT 0x90 numeffects
	FOR (i = 0; i < numeffects; ++i) BEGIN
		me_off = effectsoffset + (i * 0x30)
		READ_SHORT me_off theopcode
		READ_ASCII (me_off + 0x14) theresource
		PATCH_IF theopcode = 402 AND (~%theresource%~ STRING_EQUAL_CASE ~MEKILLCN~) BEGIN
			WRITE_ASCIIE (me_off + 0x4) ~MEWI655~ #8
		END
	END

OUTER_SPRINT me_30014 @30014
OUTER_SPRINT me_30015 @30015
LAF ADD_CONTINGENCY INT_VAR new_action=1 description=RESOLVE_STR_REF(@34655) STR_VAR resource= EVAL ~MEWI655~ title=~ME_SLAYING_SEQUENCER_TITLE~ title_name= EVAL ~%me_30014%~ action=~ME_SLAYING_SEQUENCER_LABEL~ action_name= EVAL ~%me_30015%~ END

COPY_EXISTING ~mewi655x.itm~ ~override~
	SAY NAME2 @33655
	SAY IDENTIFIED_DESC @34655
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~lavok01.cre~ ~override~ ~lavok02.cre~ ~override~
	REPLACE_CRE_ITEM ~mewi655x~ #0 #0 #0 ~UNSTEALABLE~ ~INV6~

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi655x~ BEFORE ~scrl7v~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ldd_nym.sto~ ~override~
	ADD_STORE_ITEM ~mewi655x~ AFTER ~scrl8b~ #1 #0 #0 ~IDENTIFIED~ #1

END
END

COPY_EXISTING ~mewi656.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR multi_match=1 match_opcode=immunitytospellandmessage match_parameter2=113 parameter2=splprot_nothumanoidorgianthumanoid END
	SAY NAME1 @33656
	SAY UNIDENTIFIED_DESC @34656

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI656~ scroll=~MEWI656X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi656x.itm~ ~override~
	SAY NAME2 @33656
	SAY IDENTIFIED_DESC @34656
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowspellnegates%~ END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0317.are~ ~override~ //Rayic Gethras' home, top floor
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=2 STR_VAR item_to_add=~mewi656x~ END

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi656x~ BEFORE ~scrl7k~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi656x~ AFTER ~scrl7l~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar5104.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=2 STR_VAR item_to_add=~mewi656x~ END

END

COPY_EXISTING ~mewi657.spl~ ~override~
	LPF ALTER_SPELL_HEADER INT_VAR projectile=memindfo END
	SAY NAME1 @33657
	SAY UNIDENTIFIED_DESC @34657

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI657~ scroll=~MEWI657X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mindflay.itm~ ~override~ ~plyjelly.itm~ ~override~
	LPF ADD_ITEM_EQEFFECT INT_VAR opcode=protectionfromspell target=1 timing=2 parameter1=RESOLVE_STR_REF(@30037) STR_VAR resource= EVAL ~mewi657~ END
	IF_EXISTS

COPY_EXISTING ~mewi657x.itm~ ~override~
	SAY NAME2 @33657
	SAY IDENTIFIED_DESC @34657
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar2400.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=5 STR_VAR item_to_add=~mewi657x~ END

COPY_EXISTING ~ar3021.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=5 STR_VAR item_to_add=~mewi657x~ END

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi657x~ AFTER ~scrl7l~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi657x~ BEFORE ~scrl7k~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar8010.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=1 STR_VAR item_to_add=~mewi657x~ END

END

ACTION_IF !(MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi658m.spl~ ~override/mewi658.spl~ ~mewi658n.spl~ ~override/mewi658d.spl~

COPY_EXISTING ~spwi123.spl~ ~override~
	LPF ADD_ITEM_EQEFFECT INT_VAR opcode=removeeffectsbyresource target=3 timing=1 STR_VAR resource=~mefamsta~ END
	LPF ADD_ITEM_EQEFFECT INT_VAR opcode=castspell target=1 timing=4 duration=1 parameter1=1 parameter2=2 STR_VAR resource=~mefamsta~ END
	IF_EXISTS

END

COPY_EXISTING ~mewi658.spl~ ~override~
	SAY NAME1 @33658
	SAY UNIDENTIFIED_DESC @34658

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI658~ scroll=~MEWI658X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi658d.spl~ ~override~
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 25; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=((i + 1) * 2) END
		LPF ALTER_SPELL_EFFECT INT_VAR header=(i + 1) check_headers=1 check_globals=0 match_opcode=modifydamage parameter1=(i + 1) END
		LPF ALTER_SPELL_EFFECT INT_VAR header=(i + 1) check_headers=1 check_globals=0 match_opcode=modifythac0 parameter1=(i + 1) END
		numheaders = numheaders + 1
	END

COPY_EXISTING ~mewi658x.itm~ ~override~
	SAY NAME2 @33658
	SAY IDENTIFIED_DESC @34658
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~gpmage1.cre~ ~override~
	ADD_CRE_ITEM ~mewi658x~ #0 #0 #0 ~NONE~ ~INV6~

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi658x~ AFTER ~scrl7l~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi658x~ AFTER ~scrl7t~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar2100.bcs~ ~override~
	DECOMPILE_AND_PATCH BEGIN
		REPLACE_TEXTUALLY CASE_INSENSITIVE ~AddStoreItem(\"KUORK0\",\"SCRL6W\",1,1)~ ~AddStoreItem("KUORK0","MEWI658X",1,1)
AddStoreItem("KUORK0","SCRL6W",1,1)~
	END
END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) AND (me_power_spells = 1) BEGIN

COPY_EXISTING ~mewi659.spl~ ~override~
	PATCH_IF innate_hla = 1 BEGIN
		WRITE_SHORT spelltype 4
		WRITE_LONG spelllevel 1
		LPF ALTER_SPELL_HEADER INT_VAR location=4 END
	END
	SAY NAME1 @33659
	SAY UNIDENTIFIED_DESC @34659
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

COPY_EXISTING ~mewi659e.spl~ ~override~
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		LPF ALTER_SPELL_EFFECT INT_VAR header=(i + 1) check_headers=1 check_globals=0 match_opcode=401 probability1=((i * 2) + 1) END
		numheaders = numheaders + 1
	END

OUTER_SPRINT me_33659 @33659
LAF ADD_CONTINGENCY INT_VAR description=RESOLVE_STR_REF(@34659) STR_VAR resource=~MEWI659~ title=~ME_BARDIC_SEQUENCER_TITLE~ title_name= EVAL ~%me_33659%~ action=~ADD_SPELLS_SEQUENCER_LABEL~ END

COPY_EXISTING_REGEXP ~.*\.spl~ ~override~
	READ_SHORT spelltype thespelltype
	PATCH_IF thespelltype = 5 BEGIN
		LPF CLONE_EFFECT INT_VAR silent=1 multi_match=1 check_headers=1 check_globals=0 match_target=3 opcode=402 parameter1=0x4957454D parameter2=0x393536 probability1=100 probability2=0 timing=0 duration=0 dicenumber=0 dicesize=0 special=0 STR_VAR resource=~MEBRDSEQ~ insert=~last~ END
	END
	UNLESS ~MEBRDSEQ~
	BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING_REGEXP ~.*\.spl~ ~override~
	READ_SHORT spelltype thespelltype
	PATCH_IF thespelltype = 5 BEGIN
		LPF CLONE_EFFECT INT_VAR silent=1 multi_match=1 check_headers=1 check_globals=0 match_target=2 opcode=402 parameter1=0x4957454D parameter2=0x393536 probability1=100 probability2=0 timing=0 duration=0 dicenumber=0 dicesize=0 special=0 STR_VAR resource=~MEBRDSEQ~ insert=~last~ END
	END
	UNLESS ~MEBRDSEQ~
	BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING ~luba0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEWI659~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEWI659~

COPY_EXISTING ~kitlist.2da~ ~override~
	COUNT_2DA_COLS numcolumns
	COUNT_2DA_ROWS numcolumns numrows
	FOR (i = 1; i < numrows; ++i) BEGIN
		READ_2DA_ENTRY i 8 numcolumns theclass
		READ_2DA_ENTRY i 1 numcolumns theclassname
		PATCH_IF (~%theclass%~ STRING_EQUAL_CASE ~5~) AND !(~%theclassname%~ STRING_EQUAL_CASE ~C0WLOCK~) BEGIN
			INNER_ACTION BEGIN
				COPY_EXISTING ~luabbr.2da~ ~override~
					LPF GET_2DA_ROW INT_VAR found_it=1 STR_VAR match= EVAL ~%theclassname%~ RET numcolumns2=numcols row=matched END
					PATCH_IF row > ~-1~ BEGIN
						READ_2DA_ENTRY row 1 numcolumns2 thehlatable
						INNER_ACTION BEGIN
							COPY_EXISTING ~lu%thehlatable%.2da~ ~override~
								LPF ADD_HLA STR_VAR ability=~GA_MEWI659~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
								IF_EXISTS
								UNLESS ~GA_MEWI659~
						END
					END
					BUT_ONLY_IF_IT_CHANGES
			END
		END
	END
	BUT_ONLY_IF_IT_CHANGES

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) AND (me_power_spells = 1) BEGIN

COPY_EXISTING ~mewi660.spl~ ~override~
	LPF ALTER_SPELL_HEADER INT_VAR projectile=mehole END
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=protectionfromspell2 match_parameter2=216 parameter2=splprot_minheightnotequalto END
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=protectionfromspell2 match_parameter2=217 parameter2=splprot_minheightgreaterthanorequalto END
	SAY NAME1 @33660
	SAY UNIDENTIFIED_DESC @34660

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI660~ scroll=~MEWI660X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi660x.itm~ ~override~
	SAY NAME2 @33660
	SAY IDENTIFIED_DESC @34660
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~udduer01.sto~ ~override~
	ADD_STORE_ITEM ~mewi660x~ AFTER ~scrl8c~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~udduer02.sto~ ~override~
	ADD_STORE_ITEM ~mewi660x~ AFTER ~scrl7h~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi660x~ AFTER ~scrl7u~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi660x~ AFTER ~scrl7u~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar8010.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=1 STR_VAR item_to_add=~mewi660x~ END

END
END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) AND (me_power_spells = 1) BEGIN

COPY_EXISTING ~mewi751.spl~ ~override~
	SAY NAME1 @33751
	SAY UNIDENTIFIED_DESC @34751
/*
LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI751~ scroll=~MEWI751X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi751x.itm~ ~override~
	SAY NAME2 @33751
	SAY IDENTIFIED_DESC @34751
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~hlshang.cre~ ~override~
	ADD_CRE_ITEM ~mewi751x~ #0 #0 #0 ~NONE~ ~INV6~

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi751x~ BEFORE ~scrl8w~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~vaarglan.cre~ ~override~ ~vaarglnd.cre~ ~override~
	ADD_CRE_ITEM ~mewi751x~ #0 #0 #0 ~NONE~ ~INV12~

END
*/
END
/*
LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI752~ scroll=~MEWI752X~ class_include=~{202, 5, 19}~ END
COPY_EXISTING ~mewi752.spl~ ~override~
	SAY NAME1 @33752
	SAY UNIDENTIFIED_DESC @34752

COPY_EXISTING ~mewi752e.spl~ ~override~

LAF ADD_CONTINGENCY INT_VAR description=RESOLVE_STR_REF(@34752) STR_VAR resource= EVAL ~MEWI752~ title=~ME_FAR_SEQUENCER_TITLE~ title_name=~Far Sequencer~ action=~ADD_SPELLS_SEQUENCER_LABEL~ END

COPY_EXISTING ~mewi752x.itm~ ~override~
	SAY NAME2 @33752
	SAY IDENTIFIED_DESC @34752
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar1513.are~ ~override~ //Spellhold Dungeon, area with Dace and kobolds
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=6 STR_VAR item_to_add=~mewi752x~ END

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi752x~ AFTER ~scrl8o~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi752x~ BEFORE ~scrl8o~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar5104.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=3 STR_VAR item_to_add=~mewi752x~ END

END
*/

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi758.spl~ ~override~
	SAY NAME1 @33758
	SAY UNIDENTIFIED_DESC @34758

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI758~ scroll=~MEWI758X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi758x.itm~ ~override~
	SAY NAME2 @33758
	SAY IDENTIFIED_DESC @34758
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar1605.are~ ~override~ //Perth the Adept's house
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=2 STR_VAR item_to_add=~mewi758x~ END

COPY_EXISTING ~ribald3.sto~ ~override~
	ADD_STORE_ITEM ~mewi758x~ BEFORE ~scrl9a~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~
	ADD_STORE_ITEM ~mewi758x~ BEFORE ~scrl8g~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi758x~ BEFORE ~scrl8g~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar9101.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=1 STR_VAR item_to_add=~mewi758x~ END

END

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi753.spl~ ~override~
	SAY NAME1 @33753
	SAY UNIDENTIFIED_DESC @34753

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI753~ scroll=~MEWI753X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi753x.itm~ ~override~
	SAY NAME2 @33753
	SAY IDENTIFIED_DESC @34753
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar1516.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=2 STR_VAR item_to_add=~mewi753x~ END

COPY_EXISTING ~ar3017.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=8 STR_VAR item_to_add=~mewi753x~ END

COPY_EXISTING ~scrolls.sto~ ~override~ //Scroll store in Adventurer Mart
	ADD_STORE_ITEM ~mewi753x~ AFTER ~scrl8g~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi753x~ AFTER ~scrl8o~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi753x~ AFTER ~scrl8o~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ldd_nym.sto~ ~override~
	ADD_STORE_ITEM ~mewi753x~ AFTER ~scrl8m~ #1 #0 #0 ~IDENTIFIED~ #1

END
END

ACTION_IF NOT (MOD_IS_INSTALLED ~MESpells.tp2~ ~24042~ OR GAME_IS ~iwdee~) BEGIN

	COPY_EXISTING ~mewi754.spl~ ~override~
			SAY NAME1 @33754
		SAY UNIDENTIFIED_DESC @34754

END ELSE BEGIN

	OUTER_SET iwd_ice_storm_missile_id = 98
	COPY_EXISTING ~missile.ids~ ~override~
		LPF GET_2DA_ROW INT_VAR numcolumns=2 match_column=1 STR_VAR match=~idpro98~ RET row=matched END
		PATCH_IF row != (0 - 1) BEGIN
			READ_2DA_ENTRY row 0 2 iwd_ice_storm_missile_id
		END

	COPY_EXISTING ~mewi754.spl~ ~override~
		LPF ALTER_SPELL_HEADER INT_VAR projectile=iwd_ice_storm_missile_id END
			LPF ALTER_EFFECT INT_VAR check_headers=1 check_globals=0 match_opcode=damage dicenumber=9 dicesize=10 END
		LPF ALTER_EFFECT INT_VAR check_headers=1 check_globals=0 match_opcode=drainwizardspells paramter1=5 END
		SAY NAME1 @33754
		SAY UNIDENTIFIED_DESC @30113

END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI754~ scroll=~MEWI754X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi754.eff~ ~override~
	SAY effparameter1 @30011

COPY_EXISTING ~mewi754x.itm~ ~override~
	SAY NAME2 @33754
	SAY IDENTIFIED_DESC @34754
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~uddrow25.sto~ ~override~ //Ust Natha drow scroll store
	ADD_STORE_ITEM ~mewi754x~ AFTER ~scrl8p~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~ar3013.are~ ~override~ //Watcher's Keep, Karashur lair
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=1 STR_VAR item_to_add=~mewi754x~ END

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi754x~ AFTER ~scrl8l~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar7004.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=8 STR_VAR item_to_add=~mewi754x~ END

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi755.spl~ ~override~
	SAY NAME1 @33755
	SAY UNIDENTIFIED_DESC @34755

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI755~ scroll=~MEWI755X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi755e.spl~ ~override~
	READ_LONG 0x6a effectsoffset
	READ_SHORT 0x90 numeffects
	FOR (i = 0; i < numeffects; ++i) BEGIN
		me_off = effectsoffset + (i * 0x30)
		READ_SHORT me_off theopcode
		READ_ASCII (me_off + 0x14) theresource
		PATCH_IF theopcode = 402 AND (~%theresource%~ STRING_EQUAL_CASE ~MEDEATCS~) BEGIN
			WRITE_ASCIIE (me_off + 0x4) ~MEWI755~ #8
		END
	END

COPY_EXISTING ~mewi755f.spl~ ~override~
	READ_LONG 0x6a effectsoffset
	READ_SHORT 0x90 numeffects
	FOR (i = 0; i < numeffects; ++i) BEGIN
		me_off = effectsoffset + (i * 0x30)
		READ_SHORT me_off theopcode
		READ_ASCII (me_off + 0x14) theresource
		PATCH_IF theopcode = 402 AND (~%theresource%~ STRING_EQUAL_CASE ~MEDEATCN~) BEGIN
			WRITE_ASCIIE (me_off + 0x4) ~MEWI755~ #8
		END
	END

OUTER_SPRINT me_30016 @30016
LAF ADD_CONTINGENCY INT_VAR description=RESOLVE_STR_REF(@34755) STR_VAR resource= EVAL ~MEWI755~ title=~ME_DEATH_TRIGGER_TITLE~ title_name= EVAL ~%me_30016%~ action=~ADD_SPELLS_TRIGGER_LABEL~ END

COPY_EXISTING ~m_mealtc.lua~ ~override~
	ref_30074 = RESOLVE_STR_REF(@30074)
	ref_30075 = RESOLVE_STR_REF(@30075)
	REPLACE_TEXTUALLY CASE_INSENSITIVE ~me_alt_contingency = {~ ~me_alt_contingency = {
['MEWI755'] = {['conditions'] = {{['strref'] = %ref_30074%, ['desc'] = %ref_30075%}},},~

COPY_EXISTING ~mewi755x.itm~ ~override~
	SAY NAME2 @33755
	SAY IDENTIFIED_DESC @34755
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar2210.are~ ~override~ //Deirex's tower treasury
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=1 STR_VAR item_to_add=~mewi755x~ END

COPY_EXISTING ~telwrai.cre~ ~override~ //Demon Wraith
	ADD_CRE_ITEM ~mewi755x~ #0 #0 #0 ~NONE~ ~INV4~

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi755x~ BEFORE ~scrl8n~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar6006.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=10 STR_VAR item_to_add=~mewi755x~ END

END
END

COPY_EXISTING ~mewi756.spl~ ~override~
	SAY NAME1 @33756
	SAY UNIDENTIFIED_DESC @34756

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI756~ scroll=~MEWI756X~ class_include=~{202, 5, 19}~ END

OUTER_SPRINT me_33756 @33756
LAF ADD_CONTINGENCY INT_VAR description=RESOLVE_STR_REF(@34756) STR_VAR resource= EVAL ~MEWI756~ title=~ME_CRITICAL_SEQUENCER_TITLE~ title_name= EVAL ~%me_33756%~ action=~ADD_SPELLS_SEQUENCER_LABEL~ END

COPY_EXISTING ~hidespl.2da~ ~override~
	COUNT_2DA_COLS numcolumns
	COUNT_2DA_ROWS numcolumns numrows
	PATCH_IF numcolumns = 3 BEGIN
		INSERT_2DA_ROW numrows numcolumns ~mewi756    1          0~
	END ELSE PATCH_IF numcolumns = 4 BEGIN
		INSERT_2DA_ROW numrows numcolumns ~mewi756    1          0          0~
	END

COPY_EXISTING ~mewi756x.itm~ ~override~
	SAY NAME2 @33756
	SAY IDENTIFIED_DESC @34756
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END
/*
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ribald3.sto~ ~override~ //Adventurer Mart special goods
	ADD_STORE_ITEM ~mewi756x~ BEFORE ~scrl9a~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~amarch01.cre~ ~override~
	ADD_CRE_ITEM ~mewi756x~ #0 #0 #0 ~NONE~ ~INV6~

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi756x~ AFTER ~scrl8v~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar8006.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=3 STR_VAR item_to_add=~mewi756x~ END

END
*/
ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi757.spl~ ~override~
	SAY NAME1 @33757
	SAY UNIDENTIFIED_DESC @34757

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI757~ scroll=~MEWI757X~ class_include=~{202, 5, 19}~ END
/*
COPY_EXISTING_REGEXP ~.*\.cre~ ~override~
	LPF ADD_CRE_EFFECT INT_VAR opcode=castspelloncondition target=1 timing=9 parameter2=15 special=0x800 STR_VAR resource=~MEDEADID~ END
	UNLESS ~MEDEADID~
*/
COPY_EXISTING ~mewi757x.itm~ ~override~
	SAY NAME2 @33757
	SAY IDENTIFIED_DESC @34757
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0802.are~ ~override~ //Graveyard District, optional crypt
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=3 STR_VAR item_to_add=~mewi757x~ END

COPY_EXISTING ~uddrow25.sto~ ~override~ //Ust Natha scroll store
	ADD_STORE_ITEM ~mewi757x~ BEFORE ~scrl8g~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi757x~ BEFORE ~scrl8g~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar6006.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=10 STR_VAR item_to_add=~mewi757x~ END

COPY_EXISTING ~edion.sto~ ~override~
	ADD_STORE_ITEM ~mewi757x~ AFTER ~scrla4~ #1 #0 #0 ~IDENTIFIED~ #1

END
END

COPY_EXISTING ~mewi759.spl~ ~override~
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		numheaders = numheaders + 1
	END
	FOR (i = 1; i <= 50; ++i) BEGIN
		LPF ALTER_EFFECT INT_VAR silent=1 header=(i - 1) match_parameter1=5 parameter1=(i * 5) END
		LPF ALTER_EFFECT INT_VAR silent=1 header=(i - 1) match_parameter1=1 parameter1=i END
	END
	SAY NAME1 @33759
	SAY UNIDENTIFIED_DESC @34759

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI759~ scroll=~MEWI759X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi759x.itm~ ~override~
	SAY NAME2 @33759
	SAY IDENTIFIED_DESC @34759
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~maevar.cre~ ~override~
	ADD_CRE_ITEM ~mewi759x~ #0 #0 #0 ~NONE~ ~INV2~

COPY_EXISTING ~rndscrol.2da~ ~override~
	SET_2DA_ENTRY 1 6 21 ~MEWI759X~

COPY_EXISTING ~25spell.sto~ ~override~
	ADD_STORE_ITEM ~mewi759x~ AFTER ~scrl8n~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi759x~ AFTER ~scrl8n~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar7004.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=10 STR_VAR item_to_add=~mewi759x~ END

END

COPY_EXISTING ~mewi760.spl~ ~override~
	SAY NAME1 @33760
	SAY UNIDENTIFIED_DESC @34760

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI760~ scroll=~MEWI760X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi760x.itm~ ~override~
	SAY NAME2 @33760
	SAY IDENTIFIED_DESC @34760
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowspellhalf%~ END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~scrolls.sto~ ~override~
	ADD_STORE_ITEM ~mewi760x~ BEFORE ~scrl8g~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~ar0413.are~ ~override~ //Planar Sphere, core
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=1 STR_VAR item_to_add=~mewi760x~ END

COPY_EXISTING ~25spell.sto~ ~override~
	ADD_STORE_ITEM ~mewi760x~ BEFORE ~scrl8r~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi760x~ BEFORE ~scrl8r~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar7004.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=10 STR_VAR item_to_add=~mewi760x~ END

END

//LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI761~ scroll=~MEWI761X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi762.spl~ ~override~
	SAY NAME1 @33762
	SAY UNIDENTIFIED_DESC @34762

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI762~ scroll=~MEWI762X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~sppr607.spl~ ~override~
	LPF ADD_SPELL_EFFECT INT_VAR opcode=removeeffectsbyresource target=2 timing=1 STR_VAR resource= EVAL ~mewi762~ END

COPY_EXISTING ~mewi762x.itm~ ~override~
	SAY NAME2 @33762
	SAY IDENTIFIED_DESC @34762
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowspellnegates%~ END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~uddrow25.sto~ ~override~ //Ust Natha drow scroll store
	ADD_STORE_ITEM ~mewi762x~ AFTER ~scrl8o~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~ar1513.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=6 STR_VAR item_to_add=~mewi762x~ END

COPY_EXISTING ~ar3001.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=10 STR_VAR item_to_add=~mewi762x~ END

COPY_EXISTING ~25spell.sto~ ~override~
	ADD_STORE_ITEM ~mewi762x~ BEFORE ~scrla4~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi762x~ BEFORE ~scrla4~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar8010.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=1 STR_VAR item_to_add=~mewi762x~ END

END

COPY_EXISTING ~mewi851.spl~ ~override~
	SAY NAME1 @33851
	SAY UNIDENTIFIED_DESC @34851

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI851~ scroll=~MEWI851X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi851d.spl~ ~override~
	SAY NAME1 @30004

COPY_EXISTING ~mewi851e.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi851e END
	SAY NAME1 @30005

COPY_EXISTING ~mewi851f.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi851f END
	SAY NAME1 @30006

COPY_EXISTING ~mewi851g.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi851g END
	SAY NAME1 @30007

COPY_EXISTING ~mewi851h.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi851h END
	SAY NAME1 @30008

COPY_EXISTING ~mewi851i.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi851i END
	SAY NAME1 @30009

COPY_EXISTING ~mewi851x.itm~ ~override~
	SAY NAME2 @33851
	SAY IDENTIFIED_DESC @34851
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~scrolls.sto~ ~override~ //Scroll store in Adventurer Mart
	ADD_STORE_ITEM ~mewi851x~ BEFORE ~scrlam~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi851x~ AFTER ~scrlb1~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi851x~ AFTER ~scrlb1~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar2100.bcs~ ~override~
	DECOMPILE_AND_PATCH BEGIN
		REPLACE_TEXTUALLY CASE_INSENSITIVE ~AddStoreItem(\"KUORK0\",\"SCRL6W\",1,1)~ ~AddStoreItem("KUORK0","MEWI851X",1,1)
AddStoreItem("KUORK0","SCRL6W",1,1)~
	END

COPY_EXISTING ~ldd_nym.sto~ ~override~
	ADD_STORE_ITEM ~mewi851x~ AFTER ~scblank~ #1 #0 #0 ~IDENTIFIED~ #1

END

COPY_EXISTING ~mewi852.spl~ ~override~
	LPF ALTER_SPELL_HEADER INT_VAR projectile=meinvglb END
	SAY NAME1 @33852
	SAY UNIDENTIFIED_DESC @34852

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI852~ scroll=~MEWI852X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi852x.itm~ ~override~
	SAY NAME2 @33852
	SAY IDENTIFIED_DESC @34852
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~udsvir05.sto~ ~override~ //Underdark Svirfneblin store
	ADD_STORE_ITEM ~mewi852x~ AFTER ~scrl7i~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi852x~ BEFORE ~scrl9e~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi852x~ BEFORE ~scrl9c~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ldd_nym.sto~ ~override~
	ADD_STORE_ITEM ~mewi852x~ AFTER ~scblank~ #1 #0 #0 ~IDENTIFIED~ #1

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi853.spl~ ~override~
	SAY NAME1 @33853
	SAY UNIDENTIFIED_DESC @34853

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI853~ scroll=~MEWI853X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi853x.itm~ ~override~
	SAY NAME2 @33853
	SAY IDENTIFIED_DESC @34853
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~mage18z.cre~ ~override~
	ADD_CRE_ITEM ~mewi853x~ #0 #0 #0 ~NONE~ ~INV9~

COPY_EXISTING ~ar2206.are~ ~override~ //Qilue's home
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=5 STR_VAR item_to_add=~mewi853x~ END

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi853x~ AFTER ~scrl9j~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi853x~ AFTER ~scrl9h~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ldd_nym.sto~ ~override~
	ADD_STORE_ITEM ~mewi853x~ AFTER ~scblank~ #1 #0 #0 ~IDENTIFIED~ #1

END
END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) AND (me_power_spells = 1) BEGIN

COPY_EXISTING ~mewi854.spl~ ~override~
	SAY NAME1 @33854
	SAY UNIDENTIFIED_DESC @34854

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI854~ scroll=~MEWI854X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi854d.spl~ ~override~
	READ_LONG 0x6a effectsoffset
	READ_SHORT 0x90 numeffects
	FOR (i = 0; i < numeffects; ++i) BEGIN
		me_off = effectsoffset + (i * 0x30)
		READ_SHORT me_off theopcode
		READ_ASCII (me_off + 0x14) theresource
		PATCH_IF theopcode = 402 AND (~%theresource%~ STRING_EQUAL_CASE ~MEPERMCN~) BEGIN
			WRITE_ASCIIE (me_off + 0x4) ~MEWI854~ #8
		END
	END

OUTER_SPRINT me_30017 @30017
LAF ADD_CONTINGENCY INT_VAR description=RESOLVE_STR_REF(@34854) STR_VAR resource= EVAL ~MEWI854~ title=~ME_RECURRING_CONTINGENCY_TITLE~ title_name= EVAL ~%me_30017%~ action=~ADD_SPELLS_CONTINGENCY_LABEL~ END

COPY_EXISTING ~mewi854x.itm~ ~override~
	SAY NAME2 @33854
	SAY IDENTIFIED_DESC @34854
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar3027.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=1 STR_VAR item_to_add=~mewi854x~ END

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi854x~ BEFORE ~scrl8z~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar9101.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=1 STR_VAR item_to_add=~mewi854x~ END

END
END

ACTION_IF (me_power_spells = 1) BEGIN

COPY_EXISTING ~mewi855.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi855 END
	SAY NAME1 @33855
	SAY UNIDENTIFIED_DESC @34855

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI855~ scroll=~MEWI855X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi855x.itm~ ~override~
	SAY NAME2 @33855
	SAY IDENTIFIED_DESC @34855
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ribald3.sto~ ~override~ //Adventurer Mart special goods
	ADD_STORE_ITEM ~mewi855x~ AFTER ~scrl9h~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~ar5204.are~ ~override~ //Yaga-Shura Temple, second floor
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=3 STR_VAR item_to_add=~mewi855x~ END

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi855x~ AFTER ~scrl9h~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~edion.sto~ ~override~
	ADD_STORE_ITEM ~mewi855x~ AFTER ~scrl8y~ #1 #0 #0 ~IDENTIFIED~ #1

END
END

OUTER_SET do_not_install_extend_vision = 0
OUTER_SET farseer_found = 0

ACTION_IF (MOD_IS_INSTALLED ~SetUp-B_Spells.tp2~ ~101~) OR (MOD_IS_INSTALLED ~SetUp-B_Spells.tp2~ ~103~) BEGIN

PRINT @1520

ACTION_READLN ~extend_vision_decision~

OUTER_WHILE !(IS_AN_INT %extend_vision_decision%) OR (%extend_vision_decision% != 2 AND %extend_vision_decision% != 3) BEGIN
	ACTION_IF %extend_vision_decision% = 1 BEGIN
		PRINT @1521
	END ELSE BEGIN
		PRINT @1522
	END
	ACTION_READLN ~extend_vision_decision~
END

ACTION_IF extend_vision_decision = 2 BEGIN
	OUTER_SET do_not_install_extend_vision = 1
END /*ELSE ACTION_IF extend_vision_decision = 3 BEGIN

	OUTER_SPRINT stringfarseername @4032
	COPY_EXISTING_REGEXP ~spwi1[0-9][0-9]\.spl~ ~override~
		READ_LONG NAME1 thespellnameref
		GET_STRREF thespellnameref thespellname
		PATCH_IF (farseer_found = 0) AND (~%thespellname%~ STRING_EQUAL_CASE ~%stringfarseername%~) BEGIN
			farseer_found = 1
			TEXT_SPRINT farseer_res ~%SOURCE_RES%~
		END
		BUT_ONLY_IF_IT_CHANGES

ACTION_IF farseer_found = 1 BEGIN

	COPY_EXISTING ~hidespl.2da~ ~override~
		COUNT_2DA_COLS numcolumns
		COUNT_2DA_ROWS numcolumns numrows
		PATCH_IF numcolumns = 3 BEGIN
			INSERT_2DA_ROW numrows numcolumns ~%farseer_res%    1          0~
		END ELSE PATCH_IF numcolumns = 4 BEGIN
			INSERT_2DA_ROW numrows numcolumns ~%farseer_res%    1          0          1~
		END

END

END*/

END

ACTION_IF do_not_install_extend_vision = 0 BEGIN

COPY_EXISTING ~mewi857.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi857 END
	SAY NAME1 @33857
	SAY UNIDENTIFIED_DESC @34857

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI857~ scroll=~MEWI857X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi857x.itm~ ~override~
	SAY NAME2 @33857
	SAY IDENTIFIED_DESC @34857
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~mage18z.cre~ ~override~
	ADD_CRE_ITEM ~mewi857x~ #0 #0 #0 ~NONE~ ~INV10~

COPY_EXISTING ~udduer02.sto~ ~override~ //Duergar store (better goods)
	ADD_STORE_ITEM ~mewi857x~ AFTER ~scrl9c~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi857x~ AFTER ~mewi851x~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi857x~ AFTER ~mewi851x~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar8010.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=2 STR_VAR item_to_add=~mewi857x~ END

END
END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi858.spl~ ~override~
	LPF ALTER_SPELL_HEADER INT_VAR projectile=megrvglb END
	SAY NAME1 @33858
	SAY UNIDENTIFIED_DESC @34858

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI858~ scroll=~MEWI858X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi858x.itm~ ~override~
	SAY NAME2 @33858
	SAY IDENTIFIED_DESC @34858
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~firmag01.cre~ ~override~ //Conster (mage in Firkraag Dungeon)
	ADD_CRE_ITEM ~mewi858x~ #0 #0 #0 ~UNSTEALABLE~ ~INV8~

COPY_EXISTING ~udduer02.sto~ ~override~ //Duergar store (better goods)
	ADD_STORE_ITEM ~mewi858x~ AFTER ~mewi857x~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi858x~ AFTER ~mewi852x~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi858x~ BEFORE ~scrl8z~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~bandoth.sto~ ~override~
	ADD_STORE_ITEM ~mewi858x~ BEFORE ~potn08~ #1 #0 #0 ~IDENTIFIED~ #1

END

END

COPY_EXISTING ~mewi859.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi255 END
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		LPF ALTER_SPELL_EFFECT INT_VAR header=(i + 1) match_opcode=modifycurrenthp parameter1=((i + 1) * 10) END
		LPF ALTER_SPELL_EFFECT INT_VAR header=(i + 1) match_opcode=modifymaxhp parameter1=((i + 1) * 10) END
		numheaders = numheaders + 1
	END
	SAY NAME1 @33859
	SAY UNIDENTIFIED_DESC @34859

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI859~ scroll=~MEWI859X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi859x.itm~ ~override~
	SAY NAME2 @33859
	SAY IDENTIFIED_DESC @34859
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bgee eet~) BEGIN

COPY_EXISTING ~bd1200.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=12 STR_VAR item_to_add=~mewi859x~ END
	IF_EXISTS

END
ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~lavok01.cre~ ~override~ ~lavok02.cre~ ~override~
	ADD_CRE_ITEM ~mewi859x~ #0 #0 #0 ~UNSTEALABLE~ ~INV7~

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi859x~ AFTER ~scrl9h~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi859x~ BEFORE ~mewi852x~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~edion.sto~ ~override~
	ADD_STORE_ITEM ~mewi859x~ AFTER ~scrl8y~ #1 #0 #0 ~IDENTIFIED~ #1

END

COPY_EXISTING ~mewi860.spl~ ~override~
	PATCH_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN
		LPF ALTER_EFFECT INT_VAR check_headers=1 check_globals=0 match_opcode=82 opcode=400 END
		LPF ADD_SPELL_EFFECT INT_VAR insert_point=0 opcode=eeexinvokelua target=2 parameter2=charm1 STR_VAR resource=~MEPRTOPC~ END
	END
	SAY NAME1 @33860
	SAY UNIDENTIFIED_DESC @34860

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI860~ scroll=~MEWI860X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi860x.itm~ ~override~
	SAY NAME2 @33860
	SAY IDENTIFIED_DESC @34860
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowspellnegates%~ END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0711.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=1 STR_VAR item_to_add=~mewi860x~ END

COPY_EXISTING ~ar3021.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=3 STR_VAR item_to_add=~mewi860x~ END

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi860x~ AFTER ~mewi851x~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar8007.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=3 STR_VAR item_to_add=~mewi860x~ END

END

ACTION_IF !(MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi861.spl~ ~override~
	LPF ALTER_SPELL_HEADER INT_VAR projectile=mepolera END
	SAY NAME1 @33861
	SAY UNIDENTIFIED_DESC @34861

COPY_EXISTING ~mewi861x.itm~ ~override~
	SAY NAME2 @33861
	SAY IDENTIFIED_DESC @34861
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_range= EVAL ~%stringrangemedium%~ END

END ELSE BEGIN

COPY_EXISTING ~mewi861n.spl~ ~override/mewi861.spl~
	SAY NAME1 @33861
	SAY UNIDENTIFIED_DESC @30098

COPY_EXISTING ~mewi861d.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=damage dicenumber=24 END
	LPF ALTER_SPELL_HEADER INT_VAR projectile=mepolera END
	SAY NAME1 @33861

COPY_EXISTING ~mepolera.pro~ ~override~
	READ_LONG 0xC thebehavior
	thebehavior|=0x10000
	WRITE_LONG 0xC thebehavior
	WRITE_SHORT 0x38 120
	WRITE_ASCII 0x104 ~MEPOLERA~

COPY_EXISTING ~mewi861x.itm~ ~override~
	LPF ALTER_ITEM_HEADER INT_VAR header=1 target=4 END
	SAY NAME2 @33861
	SAY IDENTIFIED_DESC @30098
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_range= EVAL ~%stringrangelong%~ END

END

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI861~ scroll=~MEWI861X~ class_include=~{202, 5, 19}~ END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ribald3.sto~ ~override~
	ADD_STORE_ITEM ~mewi861x~ AFTER ~scrl9e~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~ar3016.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=7 STR_VAR item_to_add=~mewi861x~ END

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi861x~ BEFORE ~scrl9j~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~tiernon.sto~ ~override~
	ADD_STORE_ITEM ~mewi861x~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

END

COPY_EXISTING ~mewi862.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR match_opcode=displaystring match_parameter1=30036 parameter1=RESOLVE_STR_REF(@30036) END
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		numheaders = numheaders + 1
	END
	FOR (i = 0; i < numheaders; ++i) BEGIN
		LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=1 header=i match_dicenumber=1 dicenumber=(i + 1) END
		LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=1 header=i match_dicesize=2 dicesize=(i + 2) END
	END
	SAY NAME1 @33862
	SAY UNIDENTIFIED_DESC @34862

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI862~ scroll=~MEWI862X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~spwi804.spl~ ~override~ ~spcl936.spl~ ~override~
	LPF CLONE_EFFECT INT_VAR silent=1 multi_match=1 check_headers=1 check_globals=1 match_opcode=protectionfromspell STR_VAR match_resource= EVAL ~%SOURCE_RES%~ resource= EVAL ~MEWI862~ insert=~above~ END
	IF_EXISTS

COPY_EXISTING ~mewi862x.itm~ ~override~
	SAY NAME2 @33862
	SAY IDENTIFIED_DESC @34862
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar1514.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=1 STR_VAR item_to_add=~mewi862x~ END

COPY_EXISTING ~ar5014.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=3 STR_VAR item_to_add=~mewi862x~ END

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi862x~ AFTER ~scrlb1~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~kieran2.sto~ ~override~
	ADD_STORE_ITEM ~mewi862x~ AFTER ~scrlb1~ #1 #0 #0 ~IDENTIFIED~ #1

END

ACTION_IF (me_power_spells = 1) AND (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi856.spl~ ~override~
	SAY NAME1 @33856
	SAY UNIDENTIFIED_DESC @34856

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI856~ scroll=~MEWI856X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi856e.spl~ ~override~
	LPF ALTER_SPELL_HEADER INT_VAR projectile=meintrv3 END
	READ_LONG 0x6a effectsoffset
	READ_SHORT 0x90 numeffects
	FOR (i = 0; i < numeffects; ++i) BEGIN
		me_off = effectsoffset + (i * 0x30)
		READ_SHORT me_off theopcode
		READ_ASCII (me_off + 0x14) theresource
		PATCH_IF theopcode = 402 AND (~%theresource%~ STRING_EQUAL_CASE ~MECURSCN~) BEGIN
			WRITE_ASCIIE (me_off + 0x4) ~MEWI856~ #8
		END
	END

COPY_EXISTING ~sppr307.spl~ ~override~ ~spwi410.spl~ ~override~
	LPF ADD_SPELL_EFFECT INT_VAR opcode=321 target=2 timing=1 STR_VAR resource=~mecurscn~ END

OUTER_SPRINT me_33856 @33856
LAF ADD_CONTINGENCY INT_VAR description=RESOLVE_STR_REF(@34856) STR_VAR resource= EVAL ~mewi856d~ title=~ME_CURSE_CONTINGENCY_TITLE~ title_name= EVAL ~%me_33856%~ action=~ADD_SPELLS_CONTINGENCY_LABEL~ END

COPY_EXISTING ~mewi856x.itm~ ~override~
	SAY NAME2 @33856
	SAY IDENTIFIED_DESC @34856
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar2101.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=5 STR_VAR item_to_add=~mewi856x~ END

COPY_EXISTING ~gromg08.cre~ ~override~
	ADD_CRE_ITEM ~mewi856x~ #0 #0 #0 ~NONE~ ~INV7~

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi856x~ AFTER ~mewi862x~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~kieran2.sto~ ~override~
	ADD_STORE_ITEM ~mewi856x~ AFTER ~scrlb1~ #1 #0 #0 ~IDENTIFIED~ #1

END

END

ACTION_IF (me_power_spells = 1) BEGIN

COPY_EXISTING ~mewi863.spl~ ~override~
	LPF ALTER_SPELL_HEADER INT_VAR projectile=memetafb END
	SAY NAME1 @33863
	SAY UNIDENTIFIED_DESC @34863

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI863~ scroll=~MEWI863X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi863x.itm~ ~override~
	SAY NAME2 @33863
	SAY IDENTIFIED_DESC @34863
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowspellhalf%~ END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar3017.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=11 STR_VAR item_to_add=~mewi863x~ END

COPY_EXISTING ~susuneer.cre~ ~override~
	ADD_CRE_ITEM ~mewi863x~ #0 #0 #0 ~NONE~ ~INV7~

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi863x~ AFTER ~scrl9h~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~adran.cre~ ~override~
	ADD_CRE_ITEM ~mewi863x~ #0 #0 #0 ~NONE~ ~INV10~

END

END

COPY_EXISTING ~mewi951.spl~ ~override~
	SAY NAME1 @33951
	SAY UNIDENTIFIED_DESC @34951

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI951~ scroll=~MEWI951X~ class_include=~{202}~ END

COPY_EXISTING ~mewi951x.itm~ ~override~
	SAY NAME2 @33951
	SAY IDENTIFIED_DESC @34951
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar3026.are~ ~override~ //Watcher's Keep, Imp Challenge
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=1 STR_VAR item_to_add=~mewi951x~ END

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi951x~ BEFORE ~scrl9u~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~kieran2.sto~ ~override~
	ADD_STORE_ITEM ~mewi951x~ AFTER ~spwi805x~ #1 #0 #0 ~IDENTIFIED~ #1

END

COPY_EXISTING ~mewi952.spl~ ~override~
	SAY NAME1 @33952
	SAY UNIDENTIFIED_DESC @34952

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI952~ scroll=~MEWI952X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi952x.itm~ ~override~
	SAY NAME2 @33952
	SAY IDENTIFIED_DESC @34952
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowspellnegates%~ END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar2400.are~ ~override~ //Underdark, mind flayer city
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=7 STR_VAR item_to_add=~mewi952x~ END

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi952x~ AFTER ~scrl9q~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi952x~ BEFORE ~scrl9t~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar8010.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=3 STR_VAR item_to_add=~mewi952x~ END

END

COPY_EXISTING ~mewi953.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi953 END
	SAY NAME1 @33953
	SAY UNIDENTIFIED_DESC @34953

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI953~ scroll=~MEWI953X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi953x.itm~ ~override~
	SAY NAME2 @33953
	SAY IDENTIFIED_DESC @34953
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar1515.are~ ~override~ //Spellhold, first floor
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=3 STR_VAR item_to_add=~mewi953x~ END

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi953x~ AFTER ~scrl9p~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi953x~ AFTER ~scrl9p~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~edion.sto~ ~override~
	ADD_STORE_ITEM ~mewi953x~ AFTER ~scrl9z~ #1 #0 #0 ~IDENTIFIED~ #1

END

COPY_EXISTING ~mewi954.spl~ ~override~
/*
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		numheaders = numheaders + 1
	END
	FOR (i = 1; i <= 50; ++i) BEGIN
		LPF ALTER_SPELL_EFFECT INT_VAR header=i match_opcode=damage parameter1=(i * 3) END
		LPF ALTER_SPELL_EFFECT INT_VAR header=i match_opcode=modifycurrenthp parameter1=(i * 3) END
		LPF ALTER_SPELL_EFFECT INT_VAR header=i match_opcode=modifymaxhp parameter1=(i * 3) END
	END
*/
	SAY NAME1 @33954
	SAY UNIDENTIFIED_DESC @34954

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI954~ scroll=~MEWI954X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi954x.itm~ ~override~
	SAY NAME2 @33954
	SAY IDENTIFIED_DESC @34954
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar0809.are~ ~override~ //Bodhi's lair (Chapter 6)
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=2 STR_VAR item_to_add=~mewi954x~ END

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi954x~ AFTER ~scrl9v~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi954x~ BEFORE ~scrl9v~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~edion.sto~ ~override~
	ADD_STORE_ITEM ~mewi954x~ AFTER ~scrl9w~ #1 #0 #0 ~IDENTIFIED~ #1

END

ACTION_IF (me_power_spells = 1) BEGIN

COPY_EXISTING ~mewi955.spl~ ~override~ ~mewi955d.spl~ ~override~ ~mewi955p.spl~ ~override~
	SAY NAME1 @33955
	SAY UNIDENTIFIED_DESC @34955

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI955~ scroll=~MEWI955X~ class_include=~{202, 5, 19}~ END

OUTER_SPRINT me_30018 @30018
LAF ADD_CONTINGENCY INT_VAR description=RESOLVE_STR_REF(@34955) STR_VAR resource= EVAL ~MEWI955~ title=~ME_MASS_SEQUENCER_TITLE~ title_name= EVAL ~%me_30018%~ action=~ADD_SPELLS_SEQUENCER_LABEL~ END

COPY_EXISTING ~inarea.pro~ ~override~
	WRITE_SHORT 0x21A 0
	IF_EXISTS

COPY_EXISTING ~mewi955x.itm~ ~override~
	SAY NAME2 @33955
	SAY IDENTIFIED_DESC @34955
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar6003.are~ ~override~ //Abazigal's Lair, eyes area
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=1 STR_VAR item_to_add=~mewi955x~ END

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi955x~ BEFORE ~scrl9t~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar9711.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=1 STR_VAR item_to_add=~mewi955x~ END

END
END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) AND (me_power_spells = 1) BEGIN

COPY_EXISTING ~mewi956.spl~ ~override~
	SAY NAME1 @33956
	SAY UNIDENTIFIED_DESC @34956
/*
LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI956~ scroll=~MEWI956X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi956x.itm~ ~override~
	SAY NAME2 @33956
	SAY IDENTIFIED_DESC @34956
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar3017.are~ ~override~ //Watcher's Keep, fourth level
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=2 STR_VAR item_to_add=~mewi956x~ END

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi956x~ AFTER ~scrl9q~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~adran.cre~ ~override~
	ADD_CRE_ITEM ~mewi956x~ #1 #0 #0 ~NONE~ ~INV13~

END
END

ACTION_IF (me_power_spells = 1) BEGIN

COPY_EXISTING ~mewi957.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi957 END
	SAY NAME1 @33957
	SAY UNIDENTIFIED_DESC @34957

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI957~ scroll=~MEWI957X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi957x.itm~ ~override~
	SAY NAME2 @33957
	SAY IDENTIFIED_DESC @34957
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ribald3.sto~ ~override~ //Adventurer Mart special goods
	ADD_STORE_ITEM ~mewi957x~ BEFORE ~scrl9z~ #1 #0 #0 ~IDENTIFIED~ #1
	IF_EXISTS

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi957x~ BEFORE ~scrl9z~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi957x~ BEFORE ~scrl9w~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar9714.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=12 STR_VAR item_to_add=~mewi957x~ END

END
*/
END

COPY_EXISTING ~mewi958.spl~ ~override~
	SAY NAME1 @33958
	SAY UNIDENTIFIED_DESC @34958

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI958~ scroll=~MEWI958X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~medragph.cre~ ~override~
	SAY NAME1 @30032
	SAY NAME2 @30032

ACTION_IF NOT FILE_EXISTS_IN_GAME ~spin682.spl~ BEGIN
	COPY ~MESpells/no_overwrite/spin682.spl~ ~override~
		SAY NAME1 @4021
END
ACTION_IF NOT FILE_EXISTS_IN_GAME ~spin692.spl~ BEGIN
	COPY ~MESpells/no_overwrite/spin692.spl~ ~override~
		SAY NAME1 @4022
END
ACTION_IF NOT FILE_EXISTS_IN_GAME ~spin693.spl~ BEGIN
	COPY ~MESpells/no_overwrite/spin693.spl~ ~override~
END
ACTION_IF NOT FILE_EXISTS_IN_GAME ~spin694.spl~ BEGIN
	COPY ~MESpells/no_overwrite/spin694.spl~ ~override~
		SAY NAME1 @4023
END
ACTION_IF NOT FILE_EXISTS_IN_GAME ~spin695.spl~ BEGIN
	COPY ~MESpells/no_overwrite/spin695.spl~ ~override~
		SAY NAME1 @4024
END
ACTION_IF NOT FILE_EXISTS_IN_GAME ~spin894.spl~ BEGIN
	COPY ~MESpells/no_overwrite/spin894.spl~ ~override~
		SAY NAME1 @4025
END
ACTION_IF NOT FILE_EXISTS_IN_GAME ~spin895.spl~ BEGIN
	COPY ~MESpells/no_overwrite/spin895.spl~ ~override~
		SAY NAME1 @4026
END

COPY_EXISTING ~mewi958x.itm~ ~override~
	SAY NAME2 @33958
	SAY IDENTIFIED_DESC @34958
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~dragblac.cre~ ~override~
	ADD_CRE_ITEM ~mewi958x~ #0 #0 #0 ~NONE~ ~INV11~

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi958x~ BEFORE ~scrl9u~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar9602.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=2 STR_VAR item_to_add=~mewi958x~ END

END

COPY_EXISTING ~mewi959.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi959 END
	LPF ALTER_EFFECT INT_VAR match_opcode=displaystring match_parameter1=30038 parameter1=RESOLVE_STR_REF(@30038) END
	SAY NAME1 @33959
	SAY UNIDENTIFIED_DESC @34959

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI959~ scroll=~MEWI959X~ class_include=~{202}~ END

COPY_EXISTING ~mewi959x.itm~ ~override~
	SAY NAME2 @33959
	SAY IDENTIFIED_DESC @34959
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~hgkar01.sto~ ~override~
	ADD_STORE_ITEM ~mewi959x~ AFTER ~scrl9m~ #1 #0 #0 ~IDENTIFIED~ #1

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi959x~ AFTER ~scrl9q~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~kieran2.sto~ ~override~
	ADD_STORE_ITEM ~mewi959x~ AFTER ~spwi805x~ #1 #0 #0 ~IDENTIFIED~ #1

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

//LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI960~ scroll=~MEWI960X~ class_include=~{204, 207, 208, 209, 21}~ END
COPY_EXISTING ~mewi960.spl~ ~override~
	PATCH_IF innate_hla = 1 BEGIN
		WRITE_SHORT spelltype 4
		WRITE_LONG spelllevel 1
		LPF ALTER_SPELL_HEADER INT_VAR location=4 END
	END
	SAY NAME1 @33960
	SAY UNIDENTIFIED_DESC @34960
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

/*
COPY_EXISTING ~m_mestr1.lua~ ~override~
	SPRINT me_eclectic_recall_string_1 @30039
	REPLACE_TEXTUALLY CASE_INSENSITIVE ~me_eclectic_recall_string_1[ %TAB%=].*~ ~me_eclectic_recall_string_1 = "%me_eclectic_recall_string_1%"~
*/

COPY_EXISTING ~luma0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEWI960~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEWI960~

COPY_EXISTING ~lucm0.2da~ ~override~ ~lufm0.2da~ ~override~ ~lumt0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEWI960~ min_lev=~32~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEWI960~

COPY_EXISTING ~lufmc.2da~ ~override~ ~lufmt.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEWI960~ min_lev=~32~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	IF ~GA_SPWI921~
	UNLESS ~GA_MEWI960~

COPY_EXISTING ~kitlist.2da~ ~override~
	COUNT_2DA_COLS numcolumns
	COUNT_2DA_ROWS numcolumns numrows
	FOR (i = 1; i < numrows; ++i) BEGIN
		READ_2DA_ENTRY i 8 numcolumns theclass
		PATCH_IF (~%theclass%~ STRING_EQUAL_CASE ~1~) BEGIN
			READ_2DA_ENTRY i 1 numcolumns theclassname
			INNER_ACTION BEGIN
				COPY_EXISTING ~luabbr.2da~ ~override~
					LPF GET_2DA_ROW INT_VAR found_it=1 STR_VAR match= EVAL ~%theclassname%~ RET numcolumns2=numcols row=matched END
					PATCH_IF row > ~-1~ BEGIN
						READ_2DA_ENTRY row 1 numcolumns2 thehlatable
						INNER_ACTION BEGIN
							COPY_EXISTING ~lu%thehlatable%.2da~ ~override~
								LPF ADD_HLA STR_VAR ability=~GA_MEWI960~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
								IF_EXISTS
								UNLESS ~GA_MEWI960~
						END
					END
					BUT_ONLY_IF_IT_CHANGES
			END
		END
	END
	BUT_ONLY_IF_IT_CHANGES

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mewi961.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi961 END
	SAY NAME1 @33961
	SAY UNIDENTIFIED_DESC @34961

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI961~ scroll=~MEWI961X~ class_include=~{202, 5, 19}~ END

COPY_EXISTING ~mewi961x.itm~ ~override~
	SAY NAME2 @33961
	SAY IDENTIFIED_DESC @34961
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~udtrap04.cre~ ~override~
	ADD_CRE_ITEM ~mewi961x~ #0 #0 #0 ~NONE~ ~INV7~

COPY_EXISTING ~25spell.sto~ ~override~ //Arcana Archives
	ADD_STORE_ITEM ~mewi961x~ AFTER ~scrl9l~ #1 #0 #0 ~IDENTIFIED~ #2
	IF_EXISTS

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi961x~ BEFORE ~scrl9r~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar9714.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=15 STR_VAR item_to_add=~mewi961x~ END

END

END

ACTION_IF (me_power_spells = 1) BEGIN

COPY_EXISTING ~mewi962.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi962 END
	PATCH_IF innate_hla = 1 BEGIN
		WRITE_SHORT spelltype 4
		WRITE_LONG spelllevel 1
		LPF ALTER_SPELL_HEADER INT_VAR location=4 END
	END
	SAY NAME1 @33962
	SAY UNIDENTIFIED_DESC @34962
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END
/*
COPY_EXISTING_REGEXP ~menecrp[0-9]\.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR check_headers=1 check_globals=0 match_opcode=protectionfromspell2 parameter1=1 parameter2=splprot_currenthpgreaterthanorequalto END
*/

COPY_EXISTING ~menecrde.spl~ ~override~
	LPF ALTER_SPELL_HEADER INT_VAR projectile=meintrv3 END
	LPF ALTER_EFFECT INT_VAR check_headers=1 check_globals=0 match_opcode=protectionfromspell2 parameter1=1 parameter2=splprot_currenthpgreaterthanorequalto END

COPY_EXISTING ~luma0.2da~ ~override~ ~luso0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEWI962~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEWI962~

COPY_EXISTING ~lucm0.2da~ ~override~ ~lufm0.2da~ ~override~ ~lumt0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEWI962~ min_lev=~32~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEWI962~

COPY_EXISTING ~lufmc.2da~ ~override~ ~lufmt.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEWI962~ min_lev=~32~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	IF ~GA_SPWI921~
	UNLESS ~GA_MEWI962~

COPY_EXISTING ~kitlist.2da~ ~override~
	COUNT_2DA_COLS numcolumns
	COUNT_2DA_ROWS numcolumns numrows
	FOR (i = 1; i < numrows; ++i) BEGIN
		READ_2DA_ENTRY i 8 numcolumns theclass
		PATCH_IF (~%theclass%~ STRING_EQUAL_CASE ~1~) OR (~%theclass%~ STRING_EQUAL_CASE ~19~) BEGIN
			READ_2DA_ENTRY i 1 numcolumns theclassname
			INNER_ACTION BEGIN
				COPY_EXISTING ~luabbr.2da~ ~override~
					LPF GET_2DA_ROW INT_VAR found_it=1 STR_VAR match= EVAL ~%theclassname%~ RET numcolumns2=numcols row=matched END
					PATCH_IF row > ~-1~ BEGIN
						READ_2DA_ENTRY row 1 numcolumns2 thehlatable
						INNER_ACTION BEGIN
							COPY_EXISTING ~lu%thehlatable%.2da~ ~override~
								LPF ADD_HLA STR_VAR ability=~GA_MEWI962~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
								IF_EXISTS
								UNLESS ~GA_MEWI962~
						END
					END
					BUT_ONLY_IF_IT_CHANGES
			END
		END
	END
	BUT_ONLY_IF_IT_CHANGES

ACTION_IF MOD_IS_INSTALLED ~EEex.tp2~ ~0~ BEGIN

COPY_EXISTING_REGEXP ~spwi[1-9][0-9][0-9]\.spl~ ~override~ ~mewi[1-9][0-9][0-9]\.spl~ ~override~
	LPF ADD_SPELL_CFEFFECT INT_VAR insert_point=0 opcode=402 target=1 timing=0 STR_VAR resource=~MENECROP~ END
	TO_UPPER %SOURCE_RES%
	READ_LONG 0x6A effectoffset
	WRITE_ASCIIE (effectoffset + 0x4) ~%SOURCE_RES%~ #8
	UNLESS ~MENECROP~
	BUT_ONLY_IF_IT_CHANGES

END ELSE BEGIN

COPY_EXISTING_REGEXP ~spwi[1-9][0-9][0-9]\.spl~ ~override~ ~mewi[1-9][0-9][0-9]\.spl~ ~override~
	READ_LONG spelllevel thespelllevel
	PATCH_IF thespelllevel = 0 BEGIN
		thespelllevel = 1
	END ELSE PATCH_IF thespelllevel > 9 BEGIN
		thespelllevel = 9
	END
	PATCH_IF innate_hla = 1 BEGIN
		READ_SHORT spelltype thespelltype
		PATCH_IF thespelltype = 4 BEGIN
			thespelllevel = 9
		END
	END
	LPF ADD_SPELL_CFEFFECT INT_VAR opcode=applyeffectslist target=1 timing=9 parameter1=212 parameter2=110 STR_VAR resource= EVAL ~MENECRP%thespelllevel%~ END
	UNLESS ~MENECRP~
	BUT_ONLY_IF_IT_CHANGES

END

END

ACTION_IF (me_power_spells = 1) BEGIN

COPY_EXISTING ~mewi963.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi963 END
	PATCH_IF innate_hla = 1 BEGIN
		WRITE_SHORT spelltype 4
		WRITE_LONG spelllevel 1
		LPF ALTER_SPELL_HEADER INT_VAR location=4 END
	END
/*
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		LPF ALTER_SPELL_EFFECT INT_VAR header=(i + 1) match_opcode=modifycastingtime parameter1=((i + 1) / 3) END
		numheaders = numheaders + 1
	END
	FOR (i = 1; i <= 50; ++i) BEGIN
		LPF ALTER_SPELL_EFFECT INT_VAR header=i duration=(i * 2) END
	END
*/
	SAY NAME1 @33963
	SAY UNIDENTIFIED_DESC @34963
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

COPY_EXISTING ~luma0.2da~ ~override~ ~luso0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEWI963~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEWI963~

COPY_EXISTING ~lucm0.2da~ ~override~ ~lufm0.2da~ ~override~ ~lumt0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEWI963~ min_lev=~32~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEWI963~

COPY_EXISTING ~lufmc.2da~ ~override~ ~lufmt.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEWI963~ min_lev=~32~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	IF ~GA_SPWI921~
	UNLESS ~GA_MEWI963~

COPY_EXISTING ~kitlist.2da~ ~override~
	COUNT_2DA_COLS numcolumns
	COUNT_2DA_ROWS numcolumns numrows
	FOR (i = 1; i < numrows; ++i) BEGIN
		READ_2DA_ENTRY i 8 numcolumns theclass
		PATCH_IF (~%theclass%~ STRING_EQUAL_CASE ~1~) OR (~%theclass%~ STRING_EQUAL_CASE ~19~) BEGIN
			READ_2DA_ENTRY i 1 numcolumns theclassname
			INNER_ACTION BEGIN
				COPY_EXISTING ~luabbr.2da~ ~override~
					LPF GET_2DA_ROW INT_VAR found_it=1 STR_VAR match= EVAL ~%theclassname%~ RET numcolumns2=numcols row=matched END
					PATCH_IF row > ~-1~ BEGIN
						READ_2DA_ENTRY row 1 numcolumns2 thehlatable
						INNER_ACTION BEGIN
							COPY_EXISTING ~lu%thehlatable%.2da~ ~override~
								LPF ADD_HLA STR_VAR ability=~GA_MEWI963~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
								IF_EXISTS
								UNLESS ~GA_MEWI963~
						END
					END
					BUT_ONLY_IF_IT_CHANGES
			END
		END
	END
	BUT_ONLY_IF_IT_CHANGES

END

COPY_EXISTING ~mewi964.spl~ ~override~
	LPF ALTER_SPELL_HEADER INT_VAR projectile=mewavefr END
	PATCH_IF innate_hla = 1 BEGIN
		WRITE_SHORT spelltype 4
		WRITE_LONG spelllevel 1
		LPF ALTER_SPELL_HEADER INT_VAR location=4 END
	END
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		LPF ALTER_SPELL_EFFECT INT_VAR header=(i + 1) match_opcode=damage dicenumber=(i + 1) END
		numheaders = numheaders + 1
	END
	SAY NAME1 @33964
	SAY UNIDENTIFIED_DESC @34964
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowbreathhalf%~ END

COPY_EXISTING ~luma0.2da~ ~override~ ~luso0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEWI964~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEWI964~

COPY_EXISTING ~lucm0.2da~ ~override~ ~lufm0.2da~ ~override~ ~lumt0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEWI964~ min_lev=~32~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEWI964~

COPY_EXISTING ~lufmc.2da~ ~override~ ~lufmt.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEWI964~ min_lev=~32~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	IF ~GA_SPWI921~
	UNLESS ~GA_MEWI964~

COPY_EXISTING ~kitlist.2da~ ~override~
	COUNT_2DA_COLS numcolumns
	COUNT_2DA_ROWS numcolumns numrows
	FOR (i = 1; i < numrows; ++i) BEGIN
		READ_2DA_ENTRY i 8 numcolumns theclass
		PATCH_IF (~%theclass%~ STRING_EQUAL_CASE ~1~) OR (~%theclass%~ STRING_EQUAL_CASE ~19~) BEGIN
			READ_2DA_ENTRY i 1 numcolumns theclassname
			INNER_ACTION BEGIN
				COPY_EXISTING ~luabbr.2da~ ~override~
					LPF GET_2DA_ROW INT_VAR found_it=1 STR_VAR match= EVAL ~%theclassname%~ RET numcolumns2=numcols row=matched END
					PATCH_IF row > ~-1~ BEGIN
						READ_2DA_ENTRY row 1 numcolumns2 thehlatable
						INNER_ACTION BEGIN
							COPY_EXISTING ~lu%thehlatable%.2da~ ~override~
								LPF ADD_HLA STR_VAR ability=~GA_MEWI964~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
								IF_EXISTS
								UNLESS ~GA_MEWI964~
						END
					END
					BUT_ONLY_IF_IT_CHANGES
			END
		END
	END
	BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING ~missile.ids~ ~override~
	COUNT_2DA_ROWS 2 numrows
	READ_2DA_ENTRY (numrows - 1) 0 2 newrow
	newrow = newrow + 1
	startrow = newrow
	FOR (i = 1; i <= 50; ++i) BEGIN
 		INSERT_2DA_ROW numrows 2 ~%newrow% Rampant Lightning %i%~
		numrows = numrows + 1
		newrow = newrow + 1
	END

COPY_EXISTING ~projectl.ids~ ~override~
	COUNT_2DA_ROWS 2 numrows
	READ_2DA_ENTRY (numrows - 1) 0 2 newrow
	newrow = newrow + 1
	FOR (i = 1; i <= 50; ++i) BEGIN
		INSERT_2DA_ROW numrows 2 ~%newrow% meligr%i%~
		numrows = numrows + 1
		newrow = newrow + 1
	END

ACTION_IF NOT GAME_IS ~iwdee~ BEGIN
	COPY_EXISTING ~meligr1.pro~ ~override~
		WRITE_SHORT 0x21A 40
END

OUTER_FOR (i = 2; i <= 50; ++i) BEGIN
	COPY_EXISTING ~meligr1.pro~ ~override/meligr%i%.pro~
		WRITE_SHORT 0x202 i
		WRITE_SHORT 0x224 (360 / i)
END

//LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI965~ scroll=~MEWI965X~ class_include=~{204, 207, 208, 209, 21}~ END
COPY_EXISTING ~mewi965.spl~ ~override~
	PATCH_IF innate_hla = 1 BEGIN
		WRITE_SHORT spelltype 4
		WRITE_LONG spelllevel 1
		LPF ALTER_SPELL_HEADER INT_VAR location=4 END
	END
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		numheaders = numheaders + 1
	END
	FOR (i = 1; i <= numheaders; ++i) BEGIN
		LPF ALTER_SPELL_HEADER INT_VAR header=i projectile=startrow END
		startrow = startrow + 1
	END
/*
	PATCH_IF NOT GAME_IS ~iwdee~ BEGIN
		PATCH_IF MOD_IS_INSTALLED ~EEex.tp2~ ~0~ BEGIN
			LPF ALTER_SPELL_EFFECT INT_VAR check_headers=1 check_globals=0 match_opcode=damage dicenumber=3 END
		END ELSE BEGIN
		END
	END
*/
	SAY NAME1 @33965
	SAY UNIDENTIFIED_DESC @34965

COPY_EXISTING ~mewi965x.itm~ ~override~
	SAY NAME2 @33965
	SAY IDENTIFIED_DESC @34965
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowbreathhalf%~ END

COPY_EXISTING ~luma0.2da~ ~override~ ~luso0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEWI965~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEWI965~

COPY_EXISTING ~lucm0.2da~ ~override~ ~lufm0.2da~ ~override~ ~lumt0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEWI965~ min_lev=~32~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEWI965~

COPY_EXISTING ~lufmc.2da~ ~override~ ~lufmt.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEWI965~ min_lev=~32~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	IF ~GA_SPWI921~
	UNLESS ~GA_MEWI965~

COPY_EXISTING ~kitlist.2da~ ~override~
	COUNT_2DA_COLS numcolumns
	COUNT_2DA_ROWS numcolumns numrows
	FOR (i = 1; i < numrows; ++i) BEGIN
		READ_2DA_ENTRY i 8 numcolumns theclass
		PATCH_IF (~%theclass%~ STRING_EQUAL_CASE ~1~) OR (~%theclass%~ STRING_EQUAL_CASE ~19~) BEGIN
			READ_2DA_ENTRY i 1 numcolumns theclassname
			INNER_ACTION BEGIN
				COPY_EXISTING ~luabbr.2da~ ~override~
					LPF GET_2DA_ROW INT_VAR found_it=1 STR_VAR match= EVAL ~%theclassname%~ RET numcolumns2=numcols row=matched END
					PATCH_IF row > ~-1~ BEGIN
						READ_2DA_ENTRY row 1 numcolumns2 thehlatable
						INNER_ACTION BEGIN
							COPY_EXISTING ~lu%thehlatable%.2da~ ~override~
								LPF ADD_HLA STR_VAR ability=~GA_MEWI965~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
								IF_EXISTS
								UNLESS ~GA_MEWI965~
						END
					END
					BUT_ONLY_IF_IT_CHANGES
			END
		END
	END
	BUT_ONLY_IF_IT_CHANGES

ACTION_IF (me_power_spells = 1) BEGIN

//LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI966~ scroll=~MEWI966X~ class_include=~{204, 207, 208, 209, 21}~ END
COPY_EXISTING ~mewi966.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=displayportraiticon parameter2=icon_index_mewi966 END
	SAY NAME1 @33966
	SAY UNIDENTIFIED_DESC @34966

LAF ADD_CLASS_SPELL STR_VAR resref=~MEWI966~ scroll=~MEWI966X~ scroll=~MEWI966X~ class_include=~{1, 5, 7, 10, 13, 14, 17, 19}~ END

COPY_EXISTING ~mewi966x.itm~ ~override~
	SAY NAME2 @33966
	SAY IDENTIFIED_DESC @34966
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

ACTION_IF (GAME_IS ~bg2ee eet~) BEGIN

COPY_EXISTING ~ar6110.are~ ~override~ //Sendai's Enclave, lich's lair
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=3 STR_VAR item_to_add=~mewi966x~ END

COPY_EXISTING ~ohbmhsm.sto~ ~override~ //Black Pits 2 scroll store
	ADD_STORE_ITEM ~mewi966x~ AFTER ~scrl9u~ #1 #0 #0 ~IDENTIFIED~ #6
	IF_EXISTS

END
ACTION_IF (GAME_IS ~iwdee~) BEGIN

COPY_EXISTING ~ar9712.are~ ~override~
	LPF ADD_AREA_ITEM INT_VAR container_to_add_to=6 STR_VAR item_to_add=~mewi966x~ END

END
END

ACTION_IF MOD_IS_INSTALLED ~EEex.tp2~ ~0~ BEGIN

COPY_EXISTING ~mewi967.spl~ ~override~
	PATCH_IF innate_hla = 1 BEGIN
		WRITE_SHORT spelltype 4
		WRITE_LONG spelllevel 1
		LPF ALTER_SPELL_HEADER INT_VAR location=4 END
	END
	LPF ALTER_EFFECT INT_VAR check_headers=1 check_globals=0 match_opcode=displaystring parameter1=RESOLVE_STR_REF(@30101) END
	SAY NAME1 @33967
	SAY UNIDENTIFIED_DESC @34967
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT END

COPY_EXISTING ~mecullth.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR check_headers=1 check_globals=0 match_opcode=eeexinvokelua special=RESOLVE_STR_REF(@30102) STR_VAR match_resource=~MECULLPR~ END
	SAY NAME1 @33967
	SAY UNIDENTIFIED_DESC @30103

COPY_EXISTING ~luma0.2da~ ~override~ ~luso0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEWI967~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEWI967~

COPY_EXISTING ~lucm0.2da~ ~override~ ~lufm0.2da~ ~override~ ~lumt0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEWI967~ min_lev=~32~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEWI967~

COPY_EXISTING ~lufmc.2da~ ~override~ ~lufmt.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEWI967~ min_lev=~32~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	IF ~GA_SPWI921~
	UNLESS ~GA_MEWI967~

COPY_EXISTING ~kitlist.2da~ ~override~
	COUNT_2DA_COLS numcolumns
	COUNT_2DA_ROWS numcolumns numrows
	FOR (i = 1; i < numrows; ++i) BEGIN
		READ_2DA_ENTRY i 8 numcolumns theclass
		PATCH_IF (~%theclass%~ STRING_EQUAL_CASE ~1~) OR (~%theclass%~ STRING_EQUAL_CASE ~19~) BEGIN
			READ_2DA_ENTRY i 1 numcolumns theclassname
			INNER_ACTION BEGIN
				COPY_EXISTING ~luabbr.2da~ ~override~
					LPF GET_2DA_ROW INT_VAR found_it=1 STR_VAR match= EVAL ~%theclassname%~ RET numcolumns2=numcols row=matched END
					PATCH_IF row > ~-1~ BEGIN
						READ_2DA_ENTRY row 1 numcolumns2 thehlatable
						INNER_ACTION BEGIN
							COPY_EXISTING ~lu%thehlatable%.2da~ ~override~
								LPF ADD_HLA STR_VAR ability=~GA_MEWI967~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
								IF_EXISTS
								UNLESS ~GA_MEWI967~
						END
					END
					BUT_ONLY_IF_IT_CHANGES
			END
		END
	END
	BUT_ONLY_IF_IT_CHANGES

END

ACTION_IF (me_power_spells = 1) BEGIN

COPY_EXISTING ~mewi968.spl~ ~override~
	PATCH_IF innate_hla = 1 BEGIN
		WRITE_SHORT spelltype 4
		WRITE_LONG spelllevel 1
		LPF ALTER_SPELL_HEADER INT_VAR location=4 END
	END
	READ_SHORT 0x68 numheaders
	FOR (i = numheaders; i < 50; ++i) BEGIN
		LPF ADD_SPELL_HEADER INT_VAR copy_header=i insert_point=i END
		LPF ALTER_SPELL_HEADER INT_VAR header=(i + 1) min_level=(i + 1) END
		numheaders = numheaders + 1
	END
	FOR (i = 1; i <= numheaders; ++i) BEGIN
		LPF ALTER_SPELL_EFFECT INT_VAR header=i duration_high=(i * 3) END
	END
	SAY NAME1 @33968
	SAY UNIDENTIFIED_DESC @34968
	LPF MATCH_SPELL_REVISIONS_DESCRIPTION_FORMAT STR_VAR new_savingthrow= EVAL ~%stringsavingthrowbreathnegates%~ END

COPY_EXISTING ~mesannih.cre~ ~override~
	WRITE_LONG animation slotsphereofannihilationdecimal
	SAY NAME1 @33968
	SAY NAME2 @33968

COPY_EXISTING ~mesannih.spl~ ~override~
	LPF ALTER_SPELL_HEADER INT_VAR projectile=mesannih END

COPY_EXISTING ~luma0.2da~ ~override~ ~luso0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEWI968~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEWI968~

COPY_EXISTING ~lucm0.2da~ ~override~ ~lufm0.2da~ ~override~ ~lumt0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEWI968~ min_lev=~32~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~GA_MEWI968~

COPY_EXISTING ~lufmc.2da~ ~override~ ~lufmt.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEWI968~ min_lev=~32~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	IF ~GA_SPWI921~
	UNLESS ~GA_MEWI968~

COPY_EXISTING ~kitlist.2da~ ~override~
	COUNT_2DA_COLS numcolumns
	COUNT_2DA_ROWS numcolumns numrows
	FOR (i = 1; i < numrows; ++i) BEGIN
		READ_2DA_ENTRY i 8 numcolumns theclass
		PATCH_IF (~%theclass%~ STRING_EQUAL_CASE ~1~) OR (~%theclass%~ STRING_EQUAL_CASE ~19~) BEGIN
			READ_2DA_ENTRY i 1 numcolumns theclassname
			INNER_ACTION BEGIN
				COPY_EXISTING ~luabbr.2da~ ~override~
					LPF GET_2DA_ROW INT_VAR found_it=1 STR_VAR match= EVAL ~%theclassname%~ RET numcolumns2=numcols row=matched END
					PATCH_IF row > ~-1~ BEGIN
						READ_2DA_ENTRY row 1 numcolumns2 thehlatable
						INNER_ACTION BEGIN
							COPY_EXISTING ~lu%thehlatable%.2da~ ~override~
								LPF ADD_HLA STR_VAR ability=~GA_MEWI968~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
								IF_EXISTS
								UNLESS ~GA_MEWI968~
						END
					END
					BUT_ONLY_IF_IT_CHANGES
			END
		END
	END
	BUT_ONLY_IF_IT_CHANGES

END

COPY_EXISTING ~meha150.spl~ ~override~
	SAY NAME1 @30045
	SAY UNIDENTIFIED_DESC @30046

COPY_EXISTING ~lupa0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~GA_MEHA150~ min_lev=~1~ max_lev=~99~ num_allowed=~20~ END
	IF_EXISTS
	UNLESS ~GA_MEHA150~

COPY_EXISTING ~kitlist.2da~ ~override~
	COUNT_2DA_COLS numcolumns
	COUNT_2DA_ROWS numcolumns numrows
	FOR (i = 1; i < numrows; ++i) BEGIN
		READ_2DA_ENTRY i 8 numcolumns theclass
		PATCH_IF (~%theclass%~ STRING_EQUAL_CASE ~6~) BEGIN
			READ_2DA_ENTRY i 1 numcolumns theclassname
			INNER_ACTION BEGIN
				COPY_EXISTING ~luabbr.2da~ ~override~
					LPF GET_2DA_ROW INT_VAR found_it=1 STR_VAR match= EVAL ~%theclassname%~ RET numcolumns2=numcols row=matched END
					PATCH_IF row > ~-1~ BEGIN
						READ_2DA_ENTRY row 1 numcolumns2 thehlatable
						INNER_ACTION BEGIN
							COPY_EXISTING ~lu%thehlatable%.2da~ ~override~
								LPF ADD_HLA STR_VAR ability=~GA_MEHA150~ min_lev=~1~ max_lev=~99~ num_allowed=~20~ END
								IF_EXISTS
								UNLESS ~GA_MEHA150~
						END
					END
					BUT_ONLY_IF_IT_CHANGES
			END
		END
	END
	BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING ~mehl043.spl~ ~override~
	SAY NAME1 @30047
	SAY UNIDENTIFIED_DESC @30048

COPY_EXISTING ~luba0.2da~ ~override~ ~luct0.2da~ ~override~ ~lufmt.2da~ ~override~ ~luft0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~AP_MEHL043~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~AP_MEHL043~

COPY_EXISTING ~kitlist.2da~ ~override~
	COUNT_2DA_COLS numcolumns
	COUNT_2DA_ROWS numcolumns numrows
	FOR (i = 1; i < numrows; ++i) BEGIN
		READ_2DA_ENTRY i 8 numcolumns theclass
		PATCH_IF (~%theclass%~ STRING_EQUAL_CASE ~5~) OR (~%theclass%~ STRING_EQUAL_CASE ~9~) OR (~%theclass%~ STRING_EQUAL_CASE ~10~) OR (~%theclass%~ STRING_EQUAL_CASE ~15~) BEGIN
			READ_2DA_ENTRY i 1 numcolumns theclassname
			INNER_ACTION BEGIN
				COPY_EXISTING ~luabbr.2da~ ~override~
					LPF GET_2DA_ROW INT_VAR found_it=1 STR_VAR match= EVAL ~%theclassname%~ RET numcolumns2=numcols row=matched END
					PATCH_IF row > ~-1~ BEGIN
						READ_2DA_ENTRY row 1 numcolumns2 thehlatable
						INNER_ACTION BEGIN
							COPY_EXISTING ~lu%thehlatable%.2da~ ~override~
								LPF ADD_HLA STR_VAR ability=~AP_MEHL043~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
								IF_EXISTS
								UNLESS ~AP_MEHL043~
						END
					END
					BUT_ONLY_IF_IT_CHANGES
			END
		END
	END
	BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING ~mehl044.spl~ ~override~
	SAY NAME1 @30049
	SAY UNIDENTIFIED_DESC @30050

COPY_EXISTING ~luba0.2da~ ~override~ ~lucm0.2da~ ~override~ ~lufm0.2da~ ~override~ ~lufmc.2da~ ~override~ ~lufmt.2da~ ~override~ ~lumt0.2da~ ~override~
	LPF ADD_HLA STR_VAR ability=~AP_MEHL044~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
	IF_EXISTS
	UNLESS ~AP_MEHL044~

COPY_EXISTING ~kitlist.2da~ ~override~
	COUNT_2DA_COLS numcolumns
	COUNT_2DA_ROWS numcolumns numrows
	FOR (i = 1; i < numrows; ++i) BEGIN
		READ_2DA_ENTRY i 8 numcolumns theclass
		PATCH_IF (~%theclass%~ STRING_EQUAL_CASE ~5~) OR (~%theclass%~ STRING_EQUAL_CASE ~7~) OR (~%theclass%~ STRING_EQUAL_CASE ~10~) OR (~%theclass%~ STRING_EQUAL_CASE ~13~) OR (~%theclass%~ STRING_EQUAL_CASE ~14~) OR (~%theclass%~ STRING_EQUAL_CASE ~17~) BEGIN
			READ_2DA_ENTRY i 1 numcolumns theclassname
			INNER_ACTION BEGIN
				COPY_EXISTING ~luabbr.2da~ ~override~
					LPF GET_2DA_ROW INT_VAR found_it=1 STR_VAR match= EVAL ~%theclassname%~ RET numcolumns2=numcols row=matched END
					PATCH_IF row > ~-1~ BEGIN
						READ_2DA_ENTRY row 1 numcolumns2 thehlatable
						INNER_ACTION BEGIN
							COPY_EXISTING ~lu%thehlatable%.2da~ ~override~
								LPF ADD_HLA STR_VAR ability=~AP_MEHL044~ min_lev=~1~ max_lev=~99~ num_allowed=~1~ END
								IF_EXISTS
								UNLESS ~AP_MEHL044~
						END
					END
					BUT_ONLY_IF_IT_CHANGES
			END
		END
	END
	BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING ~mehl001.spl~ ~override~
	SAY NAME1 @30083
	SAY UNIDENTIFIED_DESC @30084

COPY_EXISTING ~mehl002.spl~ ~override~
	SAY NAME1 @30085
	SAY UNIDENTIFIED_DESC @30086

COPY_EXISTING ~mehl003.spl~ ~override~
	SAY NAME1 @30087
	SAY UNIDENTIFIED_DESC @30088

COPY_EXISTING ~mehl004.spl~ ~override~
	SAY NAME1 @30089
	SAY UNIDENTIFIED_DESC @30090

COPY_EXISTING ~mehl005.spl~ ~override~
	SAY NAME1 @30091
	SAY UNIDENTIFIED_DESC @30092

COPY_EXISTING ~mehl006.spl~ ~override~
	SAY NAME1 @30093
	SAY UNIDENTIFIED_DESC @30094

COPY_EXISTING ~luabbr.2da~ ~override~
	COUNT_2DA_ROWS 2 numrows
	FOR (i = 1; i < numrows; ++i) BEGIN
		READ_2DA_ENTRY i 1 2 thehlatable
		INNER_ACTION BEGIN
			COPY_EXISTING ~lu%thehlatable%.2da~ ~override~
				LPF ADD_HLA STR_VAR ability=~AP_MEHL001~ min_lev=~1~ max_lev=~99~ num_allowed=~20~ END
				LPF ADD_HLA STR_VAR ability=~AP_MEHL002~ min_lev=~1~ max_lev=~99~ num_allowed=~20~ END
				LPF ADD_HLA STR_VAR ability=~AP_MEHL003~ min_lev=~1~ max_lev=~99~ num_allowed=~20~ END
				LPF ADD_HLA STR_VAR ability=~AP_MEHL004~ min_lev=~1~ max_lev=~99~ num_allowed=~20~ END
				LPF ADD_HLA STR_VAR ability=~AP_MEHL005~ min_lev=~1~ max_lev=~99~ num_allowed=~20~ END
				LPF ADD_HLA STR_VAR ability=~AP_MEHL006~ min_lev=~1~ max_lev=~99~ num_allowed=~20~ END
				IF_EXISTS
				UNLESS ~AP_MEHL001~
		END
	END
	BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING_REGEXP ~.*\.are~ ~override~
	READ_SHORT 0x48 theareatype
	PATCH_IF ((theareatype BAND 0b00000001) = 0b00000001) AND (~%SOURCE_RES%~ STRING_MATCHES_REGEXP ~ARS[0-9a-zA-Z]+~) = 1 BEGIN
		LPF fj_are_structure INT_VAR fj_loc_x=0 fj_loc_y=0 STR_VAR fj_structure_type=~actor~ fj_name=~ME_Fix_Wing_Buffet~ fj_cre_resref=~MEFIXWBU~ END
	END
	BUT_ONLY_IF_IT_CHANGES


// Creatures with the Doom Guard animation are often stationary creatures or objects, so they should be immune to effects that could move them.

COPY_EXISTING_REGEXP ~.*\.cre~ ~override~
	READ_LONG animation ulgiash
	PATCH_IF (ulgiash = 25605) OR (ulgiash = 25606) BEGIN
		LPF ADD_CRE_EFFECT INT_VAR opcode=protectionfromopcode target=1 timing=9 parameter2=wingbuffet END
		LPF ADD_CRE_EFFECT INT_VAR opcode=protectionfromopcode target=1 timing=9 parameter2=teleport END
	END
	BUT_ONLY_IF_IT_CHANGES

// Turning regeneration into a repeated heal effect so that a regeneration effect can be temporarily turned off.
/*
COPY_EXISTING_REGEXP ~.*\.cre~ ~override~ ~.*\.itm~ ~override~
	LPF ALTER_EFFECT INT_VAR silent=1 multi_match=60 match_opcode=regeneration opcode=applyrepeatingeff STR_VAR resource=~meregen1~ END
	IF ~b~
	BUT_ONLY_IF_IT_CHANGES


COPY_EXISTING_REGEXP ~.*\.spl~ ~override~
	PATCH_IF !(~%SOURCE_RES%~ STRING_EQUAL_CASE ~SPWI202~) BEGIN
		LPF ALTER_SPELL_EFFECT INT_VAR match_opcode=regeneration new_opcode=applyrepeatingeff STR_VAR resource=~meregen1~ END
	END
	IF ~b~
	BUT_ONLY_IF_IT_CHANGES
*/
/*
COPY_EXISTING_REGEXP ~.*\.eff~ ~override~
	READ_LONG effopcode theopcode
	PATCH_IF theopcode = regeneration BEGIN
		WRITE_LONG effopcode applyrepeatingeff
		WRITE_ASCII effresource ~meregen1~ #8
	END
	BUT_ONLY_IF_IT_CHANGES
*/
// Patching for Far Sequencer
/*
COPY_EXISTING_REGEXP ~.*\.spl~ ~override~
	READ_SHORT 0x68 numheaders
	PATCH_IF numheaders > 0 BEGIN
		READ_SHORT 0x80 therange
		PATCH_IF therange > 14 BEGIN
			LPF ALTER_SPELL_HEADER INT_VAR range=10000 END
		END
	END
	BUT_ONLY_IF_IT_CHANGES
*/
ACTION_IF MOD_IS_INSTALLED ~MESpells.tp2~ ~25031~ BEGIN

COPY_EXISTING ~spwi503.spl~ ~override~
	READ_SHORT 0x68 numheaders
	maxlength = 8
	FOR (i = 1; i <= numheaders; ++i) BEGIN
		LPF ALTER_SPELL_HEADER INT_VAR header=i range=maxlength END
		maxlength += 2
	END

END

ACTION_IF !(MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN
/*
COPY_EXISTING_REGEXP ~.*\.spl~ ~override~
	LPF DELETE_EFFECT INT_VAR silent=1 check_headers=0 check_globals=1 match_opcode=402 STR_VAR match_resource=~MEINHOST~ END
	IF ~MEINHOST~
	BUT_ONLY_IF_IT_CHANGES
*/
COPY_EXISTING_REGEXP ~.*\.spl~ ~override~
	LPF DELETE_EFFECT INT_VAR silent=1 check_headers=1 check_globals=1 match_opcode=402 END
	BUT_ONLY_IF_IT_CHANGES
END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) BEGIN

COPY_EXISTING ~mislead.spl~ ~override~
//	LPF ADD_SPELL_EFFECT INT_VAR insert_point=0 opcode=castspell target=1 timing=1 STR_VAR resource=~MEIMGID1~ END
	LPF ADD_SPELL_EFFECT INT_VAR insert_point=0 opcode=eeexinvokelua target=1 timing=0 special=1 STR_VAR resource=~MEIMGSCR~ END

COPY_EXISTING ~projimag.spl~ ~override~
//	LPF ADD_SPELL_EFFECT INT_VAR insert_point=0 opcode=castspell target=1 timing=1 STR_VAR resource=~MEIMGID2~ END
	LPF ADD_SPELL_EFFECT INT_VAR insert_point=0 opcode=eeexinvokelua target=1 timing=0 special=2 STR_VAR resource=~MEIMGSCR~ END

COPY_EXISTING ~simulacr.spl~ ~override~
//	LPF ADD_SPELL_EFFECT INT_VAR insert_point=0 opcode=castspell target=1 timing=1 STR_VAR resource=~MEIMGID3~ END
	LPF ADD_SPELL_EFFECT INT_VAR insert_point=0 opcode=eeexinvokelua target=1 timing=0 special=3 STR_VAR resource=~MEIMGSCR~ END

COPY_EXISTING_REGEXP ~.*\.itm~ ~override~
	READ_SHORT 0x68 thenumheaders
	READ_SHORT 0x70 thenumglobaleffects
	PATCH_IF thenumheaders > 0 AND thenumglobaleffects = 0 BEGIN
		READ_BYTE 0x72 thefirstheadertype
		PATCH_IF thefirstheadertype = 1 OR thefirstheadertype = 2 OR thefirstheadertype = 4 BEGIN
			LPF ADD_ITEM_EQEFFECT INT_VAR opcode=modifyallsaves target=1 timing=2 END
		END
	END
	BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING_REGEXP ~.*\.itm~ ~override~
	READ_LONG 0x6A effectoffset
	READ_SHORT 0x70 numeffects
	offset = effectoffset
	protectionfound = 0
	FOR (i = 0; i < numeffects; ++i) BEGIN
		READ_SHORT offset theopcode
		PATCH_IF theopcode = 102 BEGIN
			protectionfound = 1
			i = numeffects
		END
		offset = offset + 0x30
	END
	PATCH_IF protectionfound = 1 BEGIN
		LPF DELETE_EFFECT INT_VAR silent=1 check_headers=0 check_globals=1 match_opcode=protectionfromspell END
	END
	BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING_REGEXP ~.*\.spl~ ~override~
	READ_LONG 0x64 headeroffset
	READ_SHORT 0x68 numheaders
	READ_LONG 0x6A effectoffset
	READ_SHORT 0x90 firstheadernumeffects ELSE 0
	READ_SHORT 0x92 firstheaderfirsteffectindex ELSE 0
	numeffects = firstheadernumeffects + firstheaderfirsteffectindex
	offset = effectoffset
	protectionfound = 0
	FOR (i = 0; i < numeffects; ++i) BEGIN
		READ_SHORT offset theopcode
		PATCH_IF theopcode = 102 BEGIN
			protectionfound = 1
			i = numeffects
		END
		offset = offset + 0x30
	END
	PATCH_IF protectionfound = 1 BEGIN
		LPF DELETE_EFFECT INT_VAR silent=1 check_headers=1 check_globals=0 match_opcode=protectionfromspell END
	END
	BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING ~mepr454.spl~ ~override~ ~mewi451.spl~ ~override~
	READ_LONG 0x34 thespelllevel
	LPF ADD_SPELL_EFFECT INT_VAR insert_point=0 opcode=402 target=2 timing=0 parameter2=thespelllevel savingthrow=0x100000 special=(0 - 1) STR_VAR resource=~MEPRTSLV~ END
	IF_EXISTS
	UNLESS ~MEPRTSLV~

COPY_EXISTING ~sppr105.spl~ ~override~ ~sppr211.spl~ ~override~ ~sppr250.spl~ ~override~ ~sppr302.spl~ ~override~ ~sppr304.spl~ ~override~ ~sppr313.spl~ ~override~ ~sppr314.spl~ ~override~ ~sppr450.spl~ ~override~ ~sppr603d.spl~ ~override~ ~sppr705.spl~ ~override~ ~sppr706.spl~ ~override~ ~sppr718.spl~ ~override~ ~sppr719.spl~ ~override~ ~sppr720.spl~ ~override~ ~spwi101.spl~ ~override~ ~spwi213.spl~ ~override~ ~spwi215.spl~ ~override~ ~spdr201.spl~ ~override~ ~spwi304.spl~ ~override~ ~spwi308.spl~ ~override~ ~spdr301.spl~ ~override~ ~spwi313.spl~ ~override~ ~mewi354.spl~ ~override~ ~spwi404.spl~ ~override~ ~spwi502.spl~ ~override~ ~spwi503.spl~ ~override~ ~mewi560d.spl~ ~override~ ~mewi565d.spl~ ~override~ ~spwi614.spl~ ~override~ ~mewi653.spl~ ~override~ ~mewi657.spl~ ~override~ ~mewi754.spl~ ~override~ ~spwi712.spl~ ~override~ ~spwi810.spl~ ~override~ ~spwi811.spl~ ~override~ ~spwi816.spl~ ~override~ ~spwi817.spl~ ~override~
	READ_LONG 0x34 thespelllevel
	LPF ADD_SPELL_EFFECT INT_VAR insert_point=0 opcode=402 target=2 timing=0 parameter2=thespelllevel savingthrow=0x100000 special=RESOLVE_STR_REF(@30037) STR_VAR resource=~MEPRTSLV~ END
	IF_EXISTS
	UNLESS ~MEPRTSLV~

ACTION_IF MOD_IS_INSTALLED ~MESpells.tp2~ ~29111~ BEGIN

COPY_EXISTING ~memsward.spl~ ~override~
	READ_LONG 0x34 thespelllevel
	LPF ADD_SPELL_EFFECT INT_VAR insert_point=0 opcode=402 target=2 timing=0 parameter2=thespelllevel savingthrow=0x100000 special=RESOLVE_STR_REF(@30037) STR_VAR resource=~MEPRTSLV~ END
	IF_EXISTS
	UNLESS ~MEPRTSLV~

END ELSE BEGIN

COPY_EXISTING ~spwi911.spl~ ~override~
	READ_LONG 0x34 thespelllevel
	LPF ADD_SPELL_EFFECT INT_VAR insert_point=0 opcode=402 target=2 timing=0 parameter2=thespelllevel savingthrow=0x100000 special=RESOLVE_STR_REF(@30037) STR_VAR resource=~MEPRTSLV~ END
	IF_EXISTS
	UNLESS ~MEPRTSLV~

END

ACTION_IF GAME_IS ~iwdee~ BEGIN

	COPY_EXISTING ~sppr323d.spl~ ~override~ ~sppr324.spl~ ~override~ ~sppr326.spl~ ~override~ ~sppr326b.spl~ ~override~ ~sppr423.spl~ ~override~ ~sppr517.spl~ ~override~ ~sppr519.spl~ ~override~ ~sppr617.spl~ ~override~ ~spwi204.spl~ ~override~ ~spwi430b.spl~ ~override~ ~spwi432y.spl~ ~override~ ~spwi524b.spl~ ~override~ ~spwi615.spl~ ~override~ ~spwi631.spl~ ~override~ ~spwi726.spl~ ~override~ ~spwi812.spl~ ~override~
		READ_LONG 0x34 thespelllevel
		LPF ADD_SPELL_EFFECT INT_VAR insert_point=0 opcode=402 target=2 timing=0 parameter2=thespelllevel savingthrow=0x100000 special=RESOLVE_STR_REF(@30037) STR_VAR resource=~MEPRTSLV~ END
		IF_EXISTS
		UNLESS ~MEPRTSLV~

END

END

ACTION_IF (MOD_IS_INSTALLED ~EEex.tp2~ ~0~) AND !(FILE_EXISTS_IN_GAME ~M_MEFLYA.lua~) BEGIN
	COPY ~MESpells/lua/M_MEFLYA.lua~ ~override~

	COPY_EXISTING ~sppr105.spl~ ~override~ ~spdr201.spl~ ~override~ ~spwi215.spl~ ~override~
		LPF ADD_SPELL_EFFECT INT_VAR insert_point=0 opcode=eeexinvokelua target=2 parameter2=(0 - 30) STR_VAR resource=~MEPRTAIR~ END
		IF_EXISTS
		UNLESS ~MEPRTAIR~

	COPY_EXISTING ~sppr720.spl~ ~override~ ~spwi101.spl~ ~override~
		LPF ADD_SPELL_EFFECT INT_VAR insert_point=0 opcode=eeexinvokelua target=2 STR_VAR resource=~MEPRTAIR~ END
		IF_EXISTS
		UNLESS ~MEPRTAIR~

	OUTER_SPRINT stringspikegrowth @4018
	OUTER_SPRINT stringspikestones @4019
	COPY_EXISTING_REGEXP ~.*\.spl~ ~override~
		READ_LONG NAME1 thenameref
		GET_STRREF thenameref thename
		READ_SHORT 0x98 theprojectile ELSE 0
		PATCH_IF (theprojectile = 64) OR (theprojectile = 101) OR (theprojectile = 243) OR (~%thename%~ STRING_EQUAL_CASE ~%stringspikegrowth%~) OR (~%thename%~ STRING_EQUAL_CASE ~%stringspikestones%~) BEGIN
			LPF ADD_SPELL_EFFECT INT_VAR insert_point=0 opcode=eeexinvokelua target=2 parameter2=(0 - 30) STR_VAR resource=~MEPRTAIR~ END
		END
		UNLESS ~MEPRTAIR~
		BUT_ONLY_IF_IT_CHANGES

END

ACTION_IF MOD_IS_INSTALLED ~BetterHOF.TP2~ ~1024~ BEGIN

	COPY_EXISTING_REGEXP ~.......\.spl~ ~override~
		READ_SHORT spelltype thespelltype
		READ_LONG spelllevel thelevel
		LPF ADD_SPELL_CFEFFECT INT_VAR opcode=removeeffectsbyresource target=1 timing=1 insert_point=0 STR_VAR resource=~MEQUICSP~ END
		PATCH_IF (thespelltype = 1 OR thespelltype = 2) AND (thelevel >= 1 AND thelevel <= 5) BEGIN
			LPF ADD_SPELL_CFEFFECT INT_VAR opcode=applyeffectslist target=1 timing=1 parameter1=238 parameter2=110 insert_point=1 dicenumber=62 dicesize=(thelevel * 10) STR_VAR resource=~MEQUICSP~ END
		END
		IF_EXISTS
		UNLESS ~MEQUICSP~
		BUT_ONLY_IF_IT_CHANGES
END
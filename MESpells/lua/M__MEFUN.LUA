me_attacksperround = {"0", "1", "2", "3", "4", "5", "1/2", "3/2", "5/2", "7/2", "9/2"}
me_attacksperround_haste = {"0", "2", "4", "6", "8", "10", "1", "3", "5", "7", "9"}
me_classids = {"Mage", "Fighter", "Cleric", "Thief", "Bard", "Paladin", "Fighter/Mage", "Fighter/Cleric", "Fighter/Thief", "Fighter/Mage/Thief", "Druid", "Ranger", "Mage/Thief", "Cleric/Mage", "Cleric/Thief", "Fighter/Druid", "Fighter/Mage/Cleric", "Cleric/Ranger", "Sorcerer", "Monk", "Shaman"}
me_monsterclassids = {"Ankheg", "Basilisk", "Greater Basilisk", "Black Bear", "Brown Bear", "Cave Bear", "Polar Bear", "Carrion Crawler", "Wild Dog", "War Dog", "Doppelganger", "Greater Doppelganger", "Drizzt", "Elminster", "Ettercap", "Ghoul", "Revenant", "Ghast", "Gibberling", "Gnoll", "Hobgoblin", "Kobold", "Tasloi", "Xvart", "Ogre", "Ogre Mage", "Half-ogre", "Ogrillion", "Sarevok", "Sirine", "Dryad", "Nereid", "Nymph", "Skeleton", "Skeleton Warrior", "Skeleton Boneguard", "Giant Spider", "Huge Spider", "Phase Spider", "Sword Spider", "Wraith Spider", "Volo", "Wolf", "Worg", "Dire Wolf", "Winter Wolf", "Vampiric Wolf", "Dread Wolf", "Wyvern", "Olive Slime", "Mustard Jelly", "Ochre Jelly", "Gray Ooze", "Green Slime", "Innocent", "Flaming Fist", "Werewolf", "Wolfwere", "Death Knight", "Demon", "Beholder", "Mind Flayer", "Vampire", "Vampyre", "Otyugh", "Rakshasa", "Troll", "Umber Hulk", "Sahuagin", "Shadow", "Spectre", "Wraith", "Kuo-toa", "Mist Creature", "Cat", "Duergar", "Mephit", "Mimic", "Devil", "Giant", "Orc", "Iron Golem", "Flesh Golem", "Stone Golem", "Clay Golem", "Air Elemental", "Fire Elemental", "Earth Elemental", "Fat Spider Woman", "Red Dragon", "Shadow Dragon", "Silver Dragon", "Djinni", "Dao", "Efreeti", "Noble Djinni", "Noble Efreeti", "Zombie", "Prey", "Predator", "Long Sword", "Mage", "Fighter", "Cleric", "Thief", "Bard", "Paladin", "Druid", "Ranger", "Wizard Eye", "Watcher", "Amnian Soldier", "Town Guard", "creature of unknown class", "creature of unknown class", "creature of unknown", "creature of unknown class", "creature of unknown class", "Water Elemental", "Green Dragon", "Neothelid", "Spectral Troll", "Wight", "creature of unknown class", "creature of unknown class"}
me_kitids = {[64] = "Abjurer", [128] = "Conjurer", [256] = "Diviner", [512] = "Enchanter", [1024] = "Illusionist", [2048] = "Invoker", [4096] = "Necromancer", [8192] = "Transmuter", [16385] = "Berserker", [16386] = "Wizard Slayer", [16387] = "Kensai", [16388] = "Cavalier", [16389] = "Inquisitor", [16390] = "Undead Hunter", [16391] = "Archer", [16392] = "Stalker", [16393] = "Beastmaster", [16394] = "Assassin", [16395] = "Bounty Hunter", [16396] = "Swashbuckler", [16397] = "Blade", [16398] = "Jester", [16399] = "Skald", [16400] = "Totemic Druid", [16401] = "Shapeshifter", [16402] = "Avenger", [16403] = "Priest of Talos", [16404] = "Priest of Helm", [16405] = "Priest of Lathander", [16416] = "Blackguard", [16417] = "Shadowdancer", [16418] = "Dwarven Defender", [16419] = "Dragon Disciple", [16420] = "Dark Moon Monk", [16421] = "Sun Soul Monk", [16424] = "Priest of Tyr", [16425] = "Priest of Tempus", [1073741824] = "Barbarian"}
me_spellidstype = {[1] = "SPPR", [2] = "SPWI", [3] = "SPIN", [4] = "SPCL"}
me_proficiency = {[0x1] = 89, [0x2] = 90, [0x4] = 91, [0x8] = 92, [0x10] = 93, [0x20] = 94, [0x40] = 95, [0x80] = 96, [0x100] = 97, [0x200] = 98, [0x400] = 99, [0x800] = 100, [0x1000] = 101, [0x2000] = 102, [0x4000] = 103, [0x8000] = 104, [0x10000] = 105, [0x20000] = 106, [0x40000] = 107, [0x80000] = 108, [0x100000] = 111, [0x200000] = 112, [0x400000] = 113, [0x800000] = 114, [0x1000000] = 115}
me_multiclass_classes = {
[7] = {2, 1},
[8] = {2, 3},
[9] = {2, 4},
[10] = {2, 1, 4},
[13] = {1, 4},
[14] = {3, 1},
[15] = {3, 4},
[16] = {2, 11},
[17] = {2, 1, 3},
[18] = {3, 12}
}
me_multiclass_dual = {
[7] = {8, 16},
[8] = {8, 32},
[9] = {8, 64},
[10] = {8, 16, 64},
[13] = {16, 64},
[14] = {32, 16},
[15] = {32, 64},
[16] = {8, 128},
[17] = {8, 16, 32},
[18] = {32, 256}
}
me_resistance_opcode = {
[14] = {30, 0x46D},
[15] = {28, 0x46E},
[16] = {29, 0x46F},
[17] = {27, 0x470},
[19] = {84, 0x472},
[20] = {85, 0x473},
[21] = {86, 0x474},
[22] = {87, 0x475},
[23] = {88, 0x476},
[24] = {89, 0x477},
[73] = {31, 0},
[74] = {173, 0}
}
me_damage_resistance = {
[0] = {22, 87, 32431},
[1] = {17, 27, 32436},
[2] = {15, 28, 32434},
[4] = {16, 29, 32433},
[8] = {14, 30, 32428},
[16] = {23, 88, 32429},
[32] = {74, 173, 32437},
[64] = {73, 31, 32435},
[128] = {24, 89, 32432},
[256] = {21, 86, 32430},
[512] = {19, 84, 32438},
[1024] = {20, 85, 32439},
[2048] = {22, 87, 32440}
}

me_damage_resistance_base = {
[0] = 0x475,
[1] = 0x470,
[2] = 0x46E,
[4] = 0x46F,
[8] = 0x46D,
[16] = 0x476,
[128] = 0x477,
[256] = 0x474,
[512] = 0x472,
[1024] = 0x473,
[2048] = 0x475
}

function MESTATPR(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)

	me_class = EEex_GetActorClass(targetID)
	me_level1 = EEex_GetActorStat(targetID, 34)
	if (me_class >= 7 and me_class <= 10) or (me_class >= 13 and me_class <= 18) then
		me_level2 = "/" .. EEex_GetActorStat(targetID, 68)
	else
		me_level2 = ""
	end
	if me_class == 10 or me_class == 17 then
		me_level3 = "/" .. EEex_GetActorStat(targetID, 69)
	else
		me_level3 = ""
	end
	me_kit_string = ""
	me_kit_string_found = false
	for key,value in pairs(me_kitids) do
		if key == EEex_GetActorKit(targetID) then
			me_kit_string = value
			me_kit_string_found = true
		end
	end
	if EEex_GetActorKit(targetID) == -2147483648 then
		me_kit_string = "Wild Mage"
		me_kit_string_found = true
	end
	if me_kit_string_found == true then
		Infinity_DisplayString("Level " .. me_level1 .. me_level2 .. me_level3 .. " " .. me_kit_string)
	else
		if me_class >= 1 and me_class <= 21 then
			Infinity_DisplayString("Level " .. me_level1 .. me_level2 .. me_level3 .. " " .. me_classids[me_class])
		elseif me_class >= 101 and me_class <= 223 then
			Infinity_DisplayString("Level " .. me_level1 .. " " .. me_monsterclassids[me_class - 100])
		else
			Infinity_DisplayString("Level " .. me_level1 .. " creature of unknown class")
		end
	end
	
	Infinity_DisplayString("Hit Points: " .. EEex_ReadWord(creatureData + 0x438, 0x0) .. "/" .. EEex_GetActorStat(targetID, 1))
	Infinity_DisplayString("AC vs. slashing: " .. EEex_GetActorStat(targetID, 2) + EEex_GetActorStat(targetID, 6) .. "  AC vs. piercing: " .. EEex_GetActorStat(targetID, 2) + EEex_GetActorStat(targetID, 5) .. "  AC vs. crushing: " .. EEex_GetActorStat(targetID, 2) + EEex_GetActorStat(targetID, 3) .. "  AC vs. missiles: " .. EEex_GetActorStat(targetID, 2) + EEex_GetActorStat(targetID, 4))
	Infinity_DisplayString("Base THAC0: " .. EEex_GetActorStat(targetID, 7))
--	Infinity_DisplayString("Gold: " .. characters[id].gold)
--	Infinity_DisplayString("Base THAC0: " .. EEex_ReadByte(creatureData + 0x466, 0x0))
	if bit32.band(EEex_ReadDword(creatureData + 0x434), 0x8000) == 0x8000 or bit32.band(EEex_ReadDword(creatureData + 0xB30), 0x8000) == 0x8000 or EEex_GetActorStat(targetID, 155) > 0 then
		Infinity_DisplayString("Attacks per round: " .. me_attacksperround_haste[EEex_GetActorStat(targetID, 8) + 1])
	else
		Infinity_DisplayString("Attacks per round: " .. me_attacksperround[EEex_GetActorStat(targetID, 8) + 1])
	end
	Infinity_DisplayString("Attributes: ")
	if EEex_GetActorStat(targetID, 37) == 0 then
		me_strextra = ""
	elseif EEex_GetActorStat(targetID, 37) >= 100 then
		me_strextra = "/00"
	else
		me_strextra = "/" .. EEex_GetActorStat(targetID, 37)
	end
	Infinity_DisplayString("Strength: " .. EEex_GetActorStat(targetID, 36) .. me_strextra .. "  Dexterity: " .. EEex_GetActorStat(targetID, 40) .. "  Constitution: " .. EEex_GetActorStat(targetID, 41) .. "  Intelligence: " .. EEex_GetActorStat(targetID, 38) .. "  Wisdom: " .. EEex_GetActorStat(targetID, 39) .. "  Charisma: " .. EEex_GetActorStat(targetID, 42))
	Infinity_DisplayString(MEGetStat(targetID, "Slashing Resistance: ", 21, "%\n") .. MEGetStat(targetID, "Piercing Resistance: ", 23, "%\n") .. MEGetStat(targetID, "Crushing Resistance: ", 22, "%\n") .. MEGetStat(targetID, "Missile Resistance: ", 24, "%\n") .. MEGetStat(targetID, "Fire Resistance: ", 14, "%\n") .. MEGetStat(targetID, "Magical Fire Resistance: ", 19, "%\n") .. MEGetStat(targetID, "Cold Resistance: ", 15, "%\n") .. MEGetStat(targetID, "Magical Cold Resistance: ", 20, "%\n") .. MEGetStat(targetID, "Electricity Resistance: ", 16, "%\n") .. MEGetStat(targetID, "Acid Resistance: ", 17, "%\n") .. MEGetStat(targetID, "Poison Resistance: ", 74, "%\n") .. MEGetStat(targetID, "Magic Damage Resistance: ", 73, "%\n") .. MEGetStat(targetID, "Magic Resistance: ", 18, "%\n"))
	Infinity_DisplayString("Saving Throws: ")
	Infinity_DisplayString("Spell: " .. EEex_GetActorStat(targetID, 13) .. "  Death: " .. EEex_GetActorStat(targetID, 9) .. "  Breath: " .. EEex_GetActorStat(targetID, 12) .. "  Wands: " .. EEex_GetActorStat(targetID, 10) .. "  Polymorph: " .. EEex_GetActorStat(targetID, 11))
	Infinity_DisplayString(MEGetStat(targetID, "Backstab multiplier: ", 56, "x\n") .. MEGetStat(targetID, "Stoneskins remaining: ", 88, "\n") .. MEGetStat(targetID, "Casting time reduced by ", 77, "\n"))
	if EEex_GetActorStat(targetID, 79) > 0 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " casts wizard spells as if " .. EEex_GetActorStat(targetID, 79) .. " levels higher")
	end	
	if EEex_GetActorStat(targetID, 53) ~= 100 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " casts wizard spells with " .. EEex_GetActorStat(targetID, 53) .. "% the normal duration")
	end	
	if EEex_GetActorStat(targetID, 80) > 0 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " casts priest spells as if " .. EEex_GetActorStat(targetID, 80) .. " levels higher")
	end	
	if EEex_GetActorStat(targetID, 54) ~= 100 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " casts priest spells with " .. EEex_GetActorStat(targetID, 54) .. "% the normal duration")
	end	
	if EEex_GetActorStat(targetID, 76) ~= 0 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " can cast more than one spell per round")
	end
	if EEex_GetActorStat(targetID, 81) ~= 0 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " can see invisible creatures")
	end
	if EEex_GetActorStat(targetID, 191) ~= 0 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " can use any item")
	end
	if EEex_GetActorStat(targetID, 197) ~= 0 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " is immune to time stop")
	end
	if EEex_GetActorStat(targetID, 175) ~= 0 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " cannot be backstabbed")
	end
	if EEex_GetActorStat(targetID, 187) ~= 0 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " cannot be turned")
	end
	if EEex_GetActorStat(targetID, 83) ~= 0 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " cannot be reduced below " .. EEex_GetActorStat(targetID, 83) .. " HP")
	end
	if EEex_GetActorStat(targetID, 192) ~= 0 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " will backstab on each hit")
	end
	if EEex_GetActorStat(targetID, 181) == 1 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " is under the effect of Protection from Normal Weapons")
	end
	if EEex_GetActorStat(targetID, 128) == 1 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " is under the effect of Mantle")
	elseif EEex_GetActorStat(targetID, 128) == 2 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " is under the effect of Improved Mantle")
	elseif EEex_GetActorStat(targetID, 128) == 3 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " is under the effect of Absolute Immunity")
	elseif EEex_GetActorStat(targetID, 128) == 4 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " is under the effect of Protection from Magical Weapons")
	end
	if EEex_GetActorStat(targetID, 122) ~= 0 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " will reflect missile attacks")
	end
	if EEex_GetActorStat(targetID, 145) > 19 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " will deal maximum damage with each hit")
	end
	if EEex_GetActorStat(targetID, 146) > 0 then
		if EEex_GetActorStat(targetID, 146) > 19 then
			Infinity_DisplayString(EEex_GetActorName(targetID) .. " will critically hit on every attack")
		else
			Infinity_DisplayString(EEex_GetActorName(targetID) .. " will critically hit on a roll between " .. 20 - EEex_GetActorStat(targetID, 146) .. " and 20")
		end
	end
	if EEex_GetActorStat(targetID, 200) > 0 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " has been drained " .. EEex_GetActorStat(targetID, 200) .. " levels")
	end	

end

function MEGetStat(targetID, pre, stat, post)
	if EEex_GetActorStat(targetID, stat) == 0 then
		return ""
	else
		return pre .. EEex_GetActorStat(targetID, stat) .. post
	end
end

me_ghost_walk_dest_x = {}
me_ghost_walk_dest_y = {}
me_ghost_walk_area = {}

function MEGHOWS2(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local target = EEex_ReadDword(creatureData + 0x318)
	local targetx = EEex_ReadDword(creatureData + 0x34C)
	local targety = EEex_ReadDword(creatureData + 0x350)
	local destx = EEex_ReadDword(creatureData + 0x3404)
	local desty = EEex_ReadDword(creatureData + 0x3408)
	local destx2 = EEex_ReadDword(creatureData + 0x3568)
	local desty2 = EEex_ReadDword(creatureData + 0x356C)
--	Infinity_DisplayString("Target: " .. target)
--	Infinity_DisplayString("Targeting: [" .. targetx .. "." .. targety .. "]")
--	Infinity_DisplayString("Maybe going to: [" .. destx .. "." .. desty .. "]")
	if destx > 0 or desty > 0 then
--		EEex_LuaObject = targetID
		me_ghost_walk_dest_x["" .. targetID] = destx
		me_ghost_walk_dest_y["" .. targetID] = desty
		me_ghost_walk_area["" .. targetID] = EEex_GetActorAreaRes(targetID)
--		local currentAction = EEex_ReadWord(creatureData + 0x2F8, 0x0)
--		if currentAction == 23 then
--			EEex_WriteWord(creatureData + 0x2F8, 84)
--			EEex_WriteWord(creatureData + 0x338, EEex_GetActorRequiredDirection(targetID, destx, desty))
--			EEex_WriteWord(creatureData + 0x31FE, EEex_GetActorRequiredDirection(targetID, destx, desty))
--		end
--		EEex_WriteWord(creatureData + 0x31FE, EEex_GetActorRequiredDirection(targetID, destx, desty))
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 148,
["target"] = 1,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 1,
["duration"] = 100,
["resource"] = "MEGHOWLK",
["source_x"] = x,
["source_y"] = y,
["target_x"] = destx,
["target_y"] = desty,
["source_target"] = targetID,
["source_id"] = targetID
})
	elseif destx2 > 0 or desty2 > 0 then
--		EEex_LuaObject = targetID
		me_ghost_walk_dest_x["" .. targetID] = destx2
		me_ghost_walk_dest_y["" .. targetID] = desty2
		me_ghost_walk_area["" .. targetID] = EEex_GetActorAreaRes(targetID)
--		local currentAction = EEex_ReadWord(creatureData + 0x2F8, 0x0)
--		if currentAction == 23 then
--			EEex_WriteWord(creatureData + 0x2F8, 84)
--			EEex_WriteWord(creatureData + 0x338, EEex_GetActorRequiredDirection(targetID, destx, desty))
--			EEex_WriteWord(creatureData + 0x31FE, EEex_GetActorRequiredDirection(targetID, destx, desty))
--		end
--		EEex_WriteWord(creatureData + 0x31FE, EEex_GetActorRequiredDirection(targetID, destx, desty))
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 148,
["target"] = 1,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 1,
["duration"] = 100,
["resource"] = "MEGHOWLK",
["source_x"] = x,
["source_y"] = y,
["target_x"] = destx2,
["target_y"] = desty2,
["source_target"] = targetID,
["source_id"] = targetID
})
	end
end

function MEFIXWBU(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if EEex_GetActorStat(targetID, 640) == 0 and EEex_GetActorStat(EEex_GetActorIDPortrait(0), 640) == 0 then return end
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 235,
["target"] = 2,
["timing"] = 10,
["duration"] = 5,
["parameter1"] = 10000,
["parameter2"] = 3,
["source_x"] = EEex_ReadDword(creatureData + 0x8),
["source_y"] = EEex_ReadDword(creatureData + 0xC),
["target_x"] = EEex_ReadDword(creatureData + 0x8),
["target_y"] = EEex_ReadDword(creatureData + 0xC),
["source_target"] = targetID,
["source_id"] = targetID
})
end

function MEGHOWLK(effectData, creatureData)
--	if true then return end
	local sourceID = EEex_ReadDword(creatureData + 0x34)
	if not EEex_IsSprite(sourceID, false) then return end
	local sourceX = EEex_ReadDword(creatureData + 0x8)
	local sourceY = EEex_ReadDword(creatureData + 0xC)
	local destx = EEex_ReadDword(creatureData + 0x3404)
	local desty = EEex_ReadDword(creatureData + 0x3408)
	local destx2 = EEex_ReadDword(creatureData + 0x3568)
	local desty2 = EEex_ReadDword(creatureData + 0x356C)
	local destx3 = EEex_ReadDword(creatureData + 0x34C)
	local desty3 = EEex_ReadDword(creatureData + 0x350)
	local targetX = 0
	local targetY = 0
	local storedx = me_ghost_walk_dest_x["" .. sourceID]
	local storedy = me_ghost_walk_dest_y["" .. sourceID]
	if storedx == nil then 
		storedx = targetX
	end
	if storedy == nil then
		storedy = targetY
	end
	local storedarea = me_ghost_walk_area["" .. sourceID]
	local targetID = EEex_ReadDword(creatureData + 0x318)
	local action = EEex_GetActorCurrentAction(sourceID)
	local actionRange = 1
	local moveType = 3
	if action == 29 or action == 184 or action == 354 or action == 355 then
		moveType = 1
	end
	if storedarea ~= nil and EEex_GetActorAreaRes(sourceID) ~= storedarea then
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 321,
["target"] = 1,
["timing"] = 1,
["duration"] = 100,
["resource"] = "MEFLYISP",
["source_target"] = sourceID,
["source_id"] = sourceID
})	
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 321,
["target"] = 1,
["timing"] = 1,
["duration"] = 100,
["resource"] = "MEETHRSP",
["source_target"] = sourceID,
["source_id"] = sourceID
})	
	elseif (EEex_IsSprite(targetID) and (action == 31 or action == 113 or action == 191 or action == 318)) or action == 95 or action == 114 or action == 192 or action == 319 then
		if action == 31 or action == 113 or action == 191 or action == 318 then
			targetX = EEex_ReadDword(EEex_GetActorShare(targetID) + 0x8)
			targetY = EEex_ReadDword(EEex_GetActorShare(targetID) + 0xC)
		else
			targetX = destx3
			targetY = desty3
		end
		local spellData = EEex_DemandResData(EEex_GetActorSpellRES(sourceID), "SPL")
		if spellData > 1000 then
			actionRange = EEex_ReadWord(spellData + 0x80, 0x0)
		end
		if actionRange > EEex_GetActorStat(sourceID, 147) * 2 then
			actionRange = EEex_GetActorStat(sourceID, 147) * 2
		end
		if actionRange >= 6 and ((targetX - sourceX) / 16) ^ 2 + ((targetY - sourceY) / 12) ^ 2 <= actionRange ^ 2 then
			targetX = sourceX
			targetY = sourceY
		elseif targetID ~= sourceID and EEex_GetDistance(targetX, targetY, storedx, storedy) < 20 then
			targetX = 0
			targetY = 0
		end
	elseif ((EEex_IsSprite(targetID) and targetID ~= sourceID) or (action == 3 or action == 134)) then
		if EEex_IsSprite(targetID) then
			targetX = EEex_ReadDword(EEex_GetActorShare(targetID) + 0x8)
			targetY = EEex_ReadDword(EEex_GetActorShare(targetID) + 0xC)
		else
			targetX = destx
			targetY = desty
		end
		if (action == 3 or action == 134) then
			local weaponFound = false
			EEex_IterateActorEffects(sourceID, function(eData)
				local the_sourceslot = EEex_ReadDword(eData + 0xA4)
				if (the_sourceslot == 10 or (the_sourceslot >= 35 and the_sourceslot <= 38)) and not weaponFound then
					weaponFound = true
					local the_parent_resource = EEex_ReadLString(eData + 0x94, 8)
					local itemData = EEex_DemandResData(the_parent_resource, "ITM")
					if itemData > 1000 then
						actionRange = EEex_ReadWord(itemData + 0x80, 0x0)
					end
					if actionRange > EEex_GetActorStat(sourceID, 147) * 2 then
						actionRange = EEex_GetActorStat(sourceID, 147) * 2
					end
				end
			end)
		end
		if actionRange >= 6 and ((targetX - sourceX) / 16) ^ 2 + ((targetY - sourceY) / 12) ^ 2 <= actionRange ^ 2 then
			targetX = sourceX
			targetY = sourceY
		elseif EEex_GetDistance(targetX, targetY, storedx, storedy) < 20 then
			targetX = 0
			targetY = 0
		end
	elseif destx > 0 and desty > 0 and (destx ~= storedx or desty ~= storedy) then
		targetX = destx
		targetY = desty
	elseif destx2 > 0 and desty2 > 0 and (destx2 ~= storedx or desty2 ~= storedy) and action ~= 0 then
		targetX = destx2
		targetY = desty2
	end
	me_ghost_walk_area["" .. sourceID] = EEex_GetActorAreaRes(sourceID)
	if targetX > 0 and targetY > 0 then
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 321,
["target"] = 1,
["timing"] = 1,
["duration"] = 100,
["resource"] = "MEFLYISP",
["source_target"] = sourceID,
["source_id"] = sourceID
})	
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 321,
["target"] = 1,
["timing"] = 1,
["duration"] = 100,
["resource"] = "MEETHRSP",
["source_target"] = sourceID,
["source_id"] = sourceID
})	
		local theareatype = 0
		if EEex_ReadDword(EEex_GetActorShare(sourceID) + 0x14) > 0 then
			theareatype = EEex_ReadWord(EEex_ReadDword(EEex_GetActorShare(sourceID) + 0x14) + 0x40, 0x0)
		end
		local isEthereal = EEex_GetActorStat(sourceID, 639)
		if bit32.band(theareatype, 0x800) == 0 and (bit32.band(theareatype, 0x1) > 0 or isEthereal == 1) then
			EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 184,
["target"] = 1,
["timing"] = 0,
["duration"] = 60,
["parameter2"] = 1,
["source_target"] = sourceID,
["source_id"] = sourceID,
["parent_resource"] = "MEFLYISP"
})	
		end
		me_ghost_walk_dest_x["" .. sourceID] = targetX
		me_ghost_walk_dest_y["" .. sourceID] = targetY
		local speed = EEex_GetActorStat(sourceID, 640)

		if ((EEex_IsSprite(targetID) and targetID ~= sourceID) or action == 3 or action == 134) then
			local targetLocX = targetX
			local targetLocY = targetY
			if targetLocX > sourceX then
				targetX = targetLocX - 20
			elseif targetLocX > sourceX then
				targetX = targetLocX + 20
			end
			if targetLocY > sourceY then
				targetY = targetLocY - 20
			elseif targetLocY > sourceY then
				targetY = targetLocY + 20
			end
			local coordinateString = targetX .. "." .. targetY
			local otherCoordinateString = "0.0"
			if me_ghost_walk_positions[coordinateString] == nil or coordinateString == me_ghost_walk_actors["" .. sourceID] then
				if me_ghost_walk_actors["" .. sourceID] ~= nil then
					me_ghost_walk_positions[me_ghost_walk_actors["" .. sourceID]] = nil
				end
				me_ghost_walk_actors["" .. sourceID] = coordinateString
				me_ghost_walk_positions[coordinateString] = sourceID
			else
				local emptySlotFound = false
				if me_ghost_walk_actors["" .. sourceID] ~= nil then
					me_ghost_walk_positions[me_ghost_walk_actors["" .. sourceID]] = nil
				end
				for key,value in pairs(me_ghost_walk_offsets) do
					if not emptySlotFound then
						otherCoordinateString = (targetLocX + value[1]) .. "." .. (targetLocY + value[2])
						if otherCoordinateString == me_ghost_walk_actors["" .. sourceID] then
							emptySlotFound = true
							if me_ghost_walk_actors["" .. sourceID] ~= nil then
								me_ghost_walk_positions[me_ghost_walk_actors["" .. sourceID]] = nil
							end
							me_ghost_walk_actors["" .. sourceID] = otherCoordinateString
							me_ghost_walk_positions[otherCoordinateString] = sourceID
							targetX = targetLocX + value[1]
							targetY = targetLocY + value[2]
						end
					end
				end
				for key,value in pairs(me_ghost_walk_offsets) do
					if not emptySlotFound then
						otherCoordinateString = (targetLocX + value[1]) .. "." .. (targetLocY + value[2])
						if me_ghost_walk_positions[otherCoordinateString] == nil then
							emptySlotFound = true
							if me_ghost_walk_actors["" .. sourceID] ~= nil then
								me_ghost_walk_positions[me_ghost_walk_actors["" .. sourceID]] = nil
							end
							me_ghost_walk_actors["" .. sourceID] = otherCoordinateString
							me_ghost_walk_positions[otherCoordinateString] = sourceID
							targetX = targetLocX + value[1]
							targetY = targetLocY + value[2]
						end
					end
				end
				if not emptySlotFound then
					if me_ghost_walk_actors["" .. sourceID] ~= nil then
						me_ghost_walk_positions[me_ghost_walk_actors["" .. sourceID]] = nil
					end
					me_ghost_walk_actors["" .. sourceID] = coordinateString
					me_ghost_walk_positions[coordinateString] = sourceID
				end
			end

			if actionRange >= 6 and ((targetX - sourceX) / 16) ^ 2 + ((targetY - sourceY) / 12) ^ 2 <= actionRange ^ 2 then
				targetX = sourceX
				targetY = sourceY
			end
		end
		if bit32.band(theareatype, 0x800) == 0 and speed > 0 and (bit32.band(theareatype, 0x1) > 0 or isEthereal == 1) then
			if isEthereal == 1 then
				EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 235,
["target"] = 1,
["parameter1"] = speed - 1,
["parameter2"] = moveType,
["timing"] = 1,
["duration"] = 60,
["source_x"] = sourceX,
["source_y"] = sourceY,
["target_x"] = targetX,
["target_y"] = targetY,
["source_target"] = sourceID,
["source_id"] = sourceID,
["parent_resource"] = "MEETHRSP"
})	
			else

				EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 406,
["target"] = 1,
["timing"] = 0,
["duration"] = 60,
["source_target"] = sourceID,
["source_id"] = sourceID,
["parent_resource"] = "MEFLYISP"
})	
				EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 235,
["target"] = 1,
["parameter1"] = speed - 1,
["parameter2"] = moveType,
["timing"] = 1,
["duration"] = 60,
["source_x"] = sourceX,
["source_y"] = sourceY,
["target_x"] = targetX,
["target_y"] = targetY,
["source_target"] = sourceID,
["source_id"] = sourceID,
["parent_resource"] = "MEFLYISP"
})	
			end
		end
	end
--	if EEex_GetActorStat(sourceID, 640) > 0 then
    EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["resource"] = "MEGHOWST",
["parent_resource"] = "MEGHOWST",
["source_target"] = sourceID,
["source_id"] = sourceID
})

end

function MEGHOWL2(effectData, creatureData)
	EEex_WriteDword(effectData + 0x110, 0x1)
	local sourceID = EEex_ReadDword(creatureData + 0x34)
	if not EEex_IsSprite(sourceID) then return end
	local sourceX = EEex_ReadDword(creatureData + 0x8)
	local sourceY = EEex_ReadDword(creatureData + 0xC)
	local destx = EEex_ReadDword(creatureData + 0x3404)
	local desty = EEex_ReadDword(creatureData + 0x3408)
	local destx2 = EEex_ReadDword(creatureData + 0x3568)
	local desty2 = EEex_ReadDword(creatureData + 0x356C)
	local targetX = 0
	local targetY = 0
	local storedx = me_ghost_walk_dest_x["" .. sourceID]
	local storedy = me_ghost_walk_dest_y["" .. sourceID]
	local storedarea = me_ghost_walk_area["" .. sourceID]
	if storedarea ~= nil and EEex_GetActorAreaRes(sourceID) ~= storedarea then
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 321,
["target"] = 1,
["timing"] = 1,
["duration"] = 100,
["resource"] = "MEFLYISP",
["source_target"] = sourceID,
["source_id"] = sourceID
})	
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 321,
["target"] = 1,
["timing"] = 1,
["duration"] = 100,
["resource"] = "MEETHRSP",
["source_target"] = sourceID,
["source_id"] = sourceID
})	
	elseif destx > 0 and desty > 0 then
--	elseif destx > 0 and desty > 0 and (destx ~= storedx or desty ~= storedy) then
		targetX = destx
		targetY = desty
	elseif destx2 > 0 and desty2 > 0 then
--	elseif destx2 > 0 and desty2 > 0 and (destx2 ~= storedx or desty2 ~= storedy) then
		targetX = destx2
		targetY = desty2
	else
		targetX = storedx
		targetY = storedy
	end
	me_ghost_walk_area["" .. sourceID] = EEex_GetActorAreaRes(sourceID)
	if targetX > 0 and targetY > 0 then
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 321,
["target"] = 1,
["timing"] = 1,
["duration"] = 100,
["resource"] = "MEFLYISP",
["source_target"] = sourceID,
["source_id"] = sourceID
})	
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 321,
["target"] = 1,
["timing"] = 1,
["duration"] = 100,
["resource"] = "MEETHRSP",
["source_target"] = sourceID,
["source_id"] = sourceID
})	
		local theareatype = 0
		if EEex_ReadDword(EEex_GetActorShare(sourceID) + 0x14) > 0 then
			theareatype = EEex_ReadWord(EEex_ReadDword(EEex_GetActorShare(sourceID) + 0x14) + 0x40, 0x0)
		end
		local isEthereal = EEex_GetActorStat(sourceID, 639)
		if bit32.band(theareatype, 0x800) == 0 and (bit32.band(theareatype, 0x1) > 0 or isEthereal == 1) then
			EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 184,
["target"] = 1,
["timing"] = 0,
["duration"] = 60,
["parameter2"] = 1,
["source_target"] = sourceID,
["source_id"] = sourceID,
["parent_resource"] = "MEFLYISP"
})	
		end
		me_ghost_walk_dest_x["" .. sourceID] = targetX
		me_ghost_walk_dest_y["" .. sourceID] = targetY
--[[
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 148,
["target"] = 1,	
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 1,
["duration"] = 100,
["resource"] = "MEGHOWLK",
["source_x"] = sourceX,
["source_y"] = sourceY,
["target_x"] = targetX,
["target_y"] = targetY,
["source_target"] = sourceID,
["source_id"] = sourceID
})
--]]
		local speed = EEex_GetActorStat(sourceID, 640)
		local targetID = EEex_ReadDword(creatureData + 0x318)
		local action = EEex_GetActorCurrentAction(sourceID)
	--	Infinity_DisplayString(action)
	--	Infinity_DisplayString(targetID)
		if ((EEex_IsSprite(targetID) and targetID ~= sourceID) or action == 3 or action == 134) then
	--		Infinity_DisplayString(action)
	--		local targetLocX, targetLocY = EEex_GetActorLocation(targetID)
			local targetLocX = targetX
			local targetLocY = targetY
	--		Infinity_DisplayString("ugu")
			if targetLocX > sourceX then
				targetX = targetLocX - 20
			elseif targetLocX > sourceX then
				targetX = targetLocX + 20
			end
			if targetLocY > sourceY then
				targetY = targetLocY - 20
			elseif targetLocY > sourceY then
				targetY = targetLocY + 20
			end
			local coordinateString = targetX .. "." .. targetY
			local otherCoordinateString = "0.0"
	--		Infinity_DisplayString(coordinateString)
			if me_ghost_walk_positions[coordinateString] == nil or coordinateString == me_ghost_walk_actors["" .. sourceID] then
				if me_ghost_walk_actors["" .. sourceID] ~= nil then
					me_ghost_walk_positions[me_ghost_walk_actors["" .. sourceID]] = nil
				end
				me_ghost_walk_actors["" .. sourceID] = coordinateString
				me_ghost_walk_positions[coordinateString] = sourceID
			else
				local emptySlotFound = false
				if me_ghost_walk_actors["" .. sourceID] ~= nil then
					me_ghost_walk_positions[me_ghost_walk_actors["" .. sourceID]] = nil
				end
				for key,value in pairs(me_ghost_walk_offsets) do
					if not emptySlotFound then
						otherCoordinateString = (targetLocX + value[1]) .. "." .. (targetLocY + value[2])
						if otherCoordinateString == me_ghost_walk_actors["" .. sourceID] then
							emptySlotFound = true
							if me_ghost_walk_actors["" .. sourceID] ~= nil then
								me_ghost_walk_positions[me_ghost_walk_actors["" .. sourceID]] = nil
							end
							me_ghost_walk_actors["" .. sourceID] = otherCoordinateString
							me_ghost_walk_positions[otherCoordinateString] = sourceID
							targetX = targetLocX + value[1]
							targetY = targetLocY + value[2]
						end
					end
				end
				for key,value in pairs(me_ghost_walk_offsets) do
					if not emptySlotFound then
						otherCoordinateString = (targetLocX + value[1]) .. "." .. (targetLocY + value[2])
						if me_ghost_walk_positions[otherCoordinateString] == nil then
							emptySlotFound = true
							if me_ghost_walk_actors["" .. sourceID] ~= nil then
								me_ghost_walk_positions[me_ghost_walk_actors["" .. sourceID]] = nil
							end
							me_ghost_walk_actors["" .. sourceID] = otherCoordinateString
							me_ghost_walk_positions[otherCoordinateString] = sourceID
							targetX = targetLocX + value[1]
							targetY = targetLocY + value[2]
						end
					end
				end
				if not emptySlotFound then
					if me_ghost_walk_actors["" .. sourceID] ~= nil then
						me_ghost_walk_positions[me_ghost_walk_actors["" .. sourceID]] = nil
					end
					me_ghost_walk_actors["" .. sourceID] = coordinateString
					me_ghost_walk_positions[coordinateString] = sourceID
				end
			end
		end
		if bit32.band(theareatype, 0x800) == 0 and speed > 0 and (bit32.band(theareatype, 0x1) > 0 or isEthereal == 1) then
			local distX = targetX - sourceX
			local distY = targetY - sourceY
			local dist = math.floor((distX ^ 2 + distY ^ 2) ^ .5)
			local deltaX = 0
			local deltaY = 0
			if dist ~= 0 then
				deltaX = math.floor(speed * distX / dist)
				deltaY = math.floor(speed * distY / dist)
			end
			if math.abs(deltaX) > math.abs(distX) then
				deltaX = distX
			end
			if math.abs(deltaY) > math.abs(distY) then
				deltaY = distY
			end
			if isEthereal == 1 then
				EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 124,
["target"] = 1,
["timing"] = 1,
["source_x"] = sourceX,
["source_y"] = sourceY,
["target_x"] = sourceX + deltaX,
["target_y"] = sourceY + deltaY,
["parent_resource"] = "MEETHRSP",
["source_id"] = sourceID
})
			else

				EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 406,
["target"] = 1,
["timing"] = 0,
["duration"] = 60,
["source_target"] = sourceID,
["source_id"] = sourceID,
["parent_resource"] = "MEFLYISP"
})	
				EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 124,
["target"] = 1,
["timing"] = 1,
["source_x"] = sourceX,
["source_y"] = sourceY,
["target_x"] = sourceX + deltaX,
["target_y"] = sourceY + deltaY,
["parent_resource"] = "MEFLYISP",
["source_id"] = sourceID
})
			end
--		local currentAction = EEex_ReadWord(creatureData + 0x2F8, 0x0)
--		if currentAction == 23 then
--			C:Eval("ActionOverride(\"" .. EEex_GetActorScriptName(sourceID) .. "\", Face(" .. EEex_GetActorRequiredDirection(sourceID, targetX, targetY) .."))")
--			EEex_WriteWord(creatureData + 0x2F8, 84)
--			EEex_WriteWord(creatureData + 0x338, EEex_GetActorRequiredDirection(sourceID, targetX, targetY))
--		EEex_Call(EEex_Label("CGameSprite::Face"), {EEex_GetActorRequiredDirection(sourceID, targetX, targetY)}, creatureData, 0x0)
--			EEex_WriteWord(creatureData + 0x31FE, EEex_GetActorRequiredDirection(sourceID, targetX, targetY))
--		end
		end
	end
	if EEex_GetActorStat(sourceID, 640) > 0 then
--		Infinity_DisplayString("Game reloaded?")
--[[
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 321,
["target"] = 1,
["timing"] = 1,
["duration"] = 100,
["resource"] = "MEGHOWST",
["source_target"] = sourceID,
["source_id"] = sourceID
})	
--]]
--		EEex_WriteDword(effectData + 0x110, 0x1)
    	EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["resource"] = "MEGHOWST",
["parent_resource"] = "MEGHOWST",
["source_target"] = sourceID,
["source_id"] = sourceID
})
	end
--[[
	if EEex_GetActorStat(sourceID, 637) == 0 then
--		Infinity_DisplayString("Game reloaded?")

--		EEex_WriteDword(effectData + 0x110, 0x1)
    	EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 9,
--["duration"] = EEex_GetGameTick() + 3,
["resource"] = "MEGHOWST",
["parent_resource"] = "MEGHOWSA",
["source_target"] = sourceID,
["source_id"] = sourceID
})
    	EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 206,
["target"] = 2,
["parameter1"] = 0,
["parameter2"] = 0,
["timing"] = 0,
["duration"] = 3,
["resource"] = "MEGHOWSA",
["source_target"] = sourceID,
["source_id"] = sourceID
})

	end
--]]
end
me_ghost_walk_offsets = {{-20, -20}, {0, -20}, {20, -20}, {20, 0}, {20, 20}, {0, 20}, {-20, 20}, {-20, 0}, {-10, -30}, {10, -30}, {30, -10}, {30, 10}, {10, 30}, {-10, 30}, {-30, 10}, {-30, -10}}
me_ghost_walk_positions = {}
me_ghost_walk_actors = {}
me_object_target_actions = {
[3] = 1, [8] = 1, [22] = 1, [25] = 1, [31] = 1, [87] = 1, [98] = 1, [105] = 1, [134] = 1, [139] = 1, [180] = 1, [191] = 1, [208] = 1
}
function MEGHOWSP(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local sourceID = EEex_ReadDword(creatureData + 0x34)
	if not EEex_IsSprite(sourceID) then return end
	local isEthereal = EEex_GetActorStat(sourceID, 639)
	local speed = EEex_GetActorStat(sourceID, 640)
--	Infinity_DisplayString("isEthereal: " .. isEthereal .. "; speed: " .. speed)
	local sourceX = EEex_ReadDword(effectData + 0x7C)
	local sourceY = EEex_ReadDword(effectData + 0x80)
	local targetX = EEex_ReadDword(effectData + 0x84)
	local targetY = EEex_ReadDword(effectData + 0x88)
	local targetID = EEex_ReadDword(creatureData + 0x318)
	local action = EEex_GetActorCurrentAction(sourceID)
--	Infinity_DisplayString(action)
--	Infinity_DisplayString(targetID)
	if ((EEex_IsSprite(targetID) and targetID ~= sourceID) or action == 3 or action == 134) then
--		Infinity_DisplayString(action)
--		local targetLocX, targetLocY = EEex_GetActorLocation(targetID)
		local targetLocX = targetX
		local targetLocY = targetY
--		Infinity_DisplayString("ugu")
		if targetLocX > sourceX then
			targetX = targetLocX - 20
		elseif targetLocX > sourceX then
			targetX = targetLocX + 20
		end
		if targetLocY > sourceY then
			targetY = targetLocY - 20
		elseif targetLocY > sourceY then
			targetY = targetLocY + 20
		end
		local coordinateString = targetX .. "." .. targetY
		local otherCoordinateString = "0.0"
--		Infinity_DisplayString(coordinateString)
		if me_ghost_walk_positions[coordinateString] == nil or coordinateString == me_ghost_walk_actors["" .. sourceID] then
			if me_ghost_walk_actors["" .. sourceID] ~= nil then
				me_ghost_walk_positions[me_ghost_walk_actors["" .. sourceID]] = nil
			end
			me_ghost_walk_actors["" .. sourceID] = coordinateString
			me_ghost_walk_positions[coordinateString] = sourceID
		else
			local emptySlotFound = false
			if me_ghost_walk_actors["" .. sourceID] ~= nil then
				me_ghost_walk_positions[me_ghost_walk_actors["" .. sourceID]] = nil
			end
			for key,value in pairs(me_ghost_walk_offsets) do
				if not emptySlotFound then
					otherCoordinateString = (targetLocX + value[1]) .. "." .. (targetLocY + value[2])
					if otherCoordinateString == me_ghost_walk_actors["" .. sourceID] then
						emptySlotFound = true
						if me_ghost_walk_actors["" .. sourceID] ~= nil then
							me_ghost_walk_positions[me_ghost_walk_actors["" .. sourceID]] = nil
						end
						me_ghost_walk_actors["" .. sourceID] = otherCoordinateString
						me_ghost_walk_positions[otherCoordinateString] = sourceID
						targetX = targetLocX + value[1]
						targetY = targetLocY + value[2]
					end
				end
			end
			for key,value in pairs(me_ghost_walk_offsets) do
				if not emptySlotFound then
					otherCoordinateString = (targetLocX + value[1]) .. "." .. (targetLocY + value[2])
					if me_ghost_walk_positions[otherCoordinateString] == nil then
						emptySlotFound = true
						if me_ghost_walk_actors["" .. sourceID] ~= nil then
							me_ghost_walk_positions[me_ghost_walk_actors["" .. sourceID]] = nil
						end
						me_ghost_walk_actors["" .. sourceID] = otherCoordinateString
						me_ghost_walk_positions[otherCoordinateString] = sourceID
						targetX = targetLocX + value[1]
						targetY = targetLocY + value[2]
					end
				end
			end
			if not emptySlotFound then
				if me_ghost_walk_actors["" .. sourceID] ~= nil then
					me_ghost_walk_positions[me_ghost_walk_actors["" .. sourceID]] = nil
				end
				me_ghost_walk_actors["" .. sourceID] = coordinateString
				me_ghost_walk_positions[coordinateString] = sourceID
			end
		end
	end
	if speed > 0 then
		if isEthereal == 1 then
			EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 235,
["target"] = 1,
["parameter1"] = speed,
["parameter2"] = 3,
["timing"] = 1,
["duration"] = 6,
["source_x"] = sourceX,
["source_y"] = sourceY,
["target_x"] = targetX,
["target_y"] = targetY,
["source_target"] = sourceID,
["source_id"] = sourceID,
["parent_resource"] = "MEETHRSP"
})	
		else
			EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 235,
["target"] = 1,
["parameter1"] = speed,
["parameter2"] = 3,
["timing"] = 1,
["duration"] = 6,
["source_x"] = sourceX,
["source_y"] = sourceY,
["target_x"] = targetX,
["target_y"] = targetY,
["source_target"] = sourceID,
["source_id"] = sourceID,
["parent_resource"] = "MEFLYISP"
})	
		end
--		local currentAction = EEex_ReadWord(creatureData + 0x2F8, 0x0)
--		if currentAction == 23 then
--			EEex_WriteWord(creatureData + 0x2F8, 84)
--			EEex_WriteWord(creatureData + 0x338, EEex_GetActorRequiredDirection(targetID, EEex_ReadDword(effectData + 0x84), EEex_ReadDword(effectData + 0x88)))
--		EEex_Call(EEex_Label("CGameSprite::Face"), {EEex_GetActorRequiredDirection(targetID, EEex_ReadDword(effectData + 0x84), EEex_ReadDword(effectData + 0x88))}, creatureData, 0x0)
--		EEex_WriteWord(creatureData + 0x31FE, EEex_GetActorRequiredDirection(targetID, EEex_ReadDword(effectData + 0x84), EEex_ReadDword(effectData + 0x88)))
--		end
	end
end

function MEBIRDFS(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local destx = EEex_ReadDword(creatureData + 0x3404)
	local desty = EEex_ReadDword(creatureData + 0x3408)
--	Infinity_DisplayString("Going to: [" .. destx .. "." .. desty .. "]")
	if destx > 0 or desty > 0 then
		me_ghost_walk_dest_x["" .. targetID] = destx
		me_ghost_walk_dest_y["" .. targetID] = desty
		C:Eval("ActionOverride(\"MEBIRD" .. me_bird_id .. "\", FlyToPoint([" .. destx .. "." .. desty .. "], 15))")
--		C:Eval("ActionOverride(\"MEBIRD" .. me_bird_id .. "\", ReallyForceSpellPointRES(\"MEBIRDF2\", [" .. destx .. "." .. desty .. "]))")
	end
end

function MEBIRDFL(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local x = EEex_ReadDword(creatureData + 0x8)
	local y = EEex_ReadDword(creatureData + 0xc)
	local destx = EEex_ReadDword(creatureData + 0x3404)
	local desty = EEex_ReadDword(creatureData + 0x3408)
	local me_bird_id = EEex_GetActorLocal(targetID, "ME_Bird_ID")
	local storedx = me_ghost_walk_dest_x["" .. targetID]
	local storedy = me_ghost_walk_dest_y["" .. targetID]
--	Infinity_DisplayString("Location: [" .. x .. "." .. y .. "]")
--	Infinity_DisplayString("Destination: [" .. storedx .. "." .. storedy .. "]")
	if destx > 0 and desty > 0 and (destx ~= storedx or desty ~= storedy) then
		me_ghost_walk_dest_x["" .. targetID] = destx
		me_ghost_walk_dest_y["" .. targetID] = desty
		C:Eval("ActionOverride(\"MEBIRD" .. me_bird_id .. "\", FlyToPoint([" .. destx .. "." .. desty .. "], 15))")
--		C:Eval("ActionOverride(\"MEBIRD" .. me_bird_id .. "\", ReallyForceSpellPointRES(\"MEBIRDF2\", [" .. destx .. "." .. desty .. "]))")
--	elseif math.abs(x - storedx) < 10 and math.abs(y - storedy) < 10 then
--		EEex_LuaObject = targetID
--		C:Eval("ApplySpellRES(\"MEGHOWEN\", EEex_LuaObject)")
	end
end

function MECREFLG(effectData, creatureData)
	local me_modifier = EEex_ReadDword(effectData + 0x18)
	local me_operand = EEex_ReadDword(effectData + 0x1c)
	local me_cre_flags = EEex_ReadDword(creatureData + 0x424)
	if me_operand == 0 then
		me_cre_flags = me_modifier
	elseif me_operand == 1 then
		me_cre_flags = bit32.band(me_cre_flags, me_modifier)
	elseif me_operand == 2 then
		me_cre_flags = bit32.bor(me_cre_flags, me_modifier)
	elseif me_operand == 3 then
		me_cre_flags = bit32.bxor(me_cre_flags, me_modifier)
	elseif me_operand == 4 then
		me_cre_flags = bit32.band(me_cre_flags, bit32.bnot(me_modifier))
	end
	EEex_WriteDword(creatureData + 0x424, me_cre_flags)
end

function ME_Set_Creature_Flags(actorID, me_modifier, me_operand)
	local me_creatureData = EEex_GetActorShare(actorID)
	local me_cre_flags = EEex_ReadDword(me_creatureData + 0x424)
	if me_operand == 0 then
		me_cre_flags = me_modifier
	elseif me_operand == 1 then
		me_cre_flags = bit32.band(me_cre_flags, me_modifier)
	elseif me_operand == 2 then
		me_cre_flags = bit32.bor(me_cre_flags, me_modifier)
	elseif me_operand == 3 then
		me_cre_flags = bit32.bxor(me_cre_flags, me_modifier)
	elseif me_operand == 4 then
		me_cre_flags = bit32.band(me_cre_flags, bit32.bnot(me_modifier))
	end
	EEex_WriteDword(me_creatureData + 0x424, me_cre_flags)
end

function MEINKILL(effectData, creatureData)
		EEex_LuaObject = EEex_ReadDword(creatureData + 0x34)
		C:Eval("ApplySpellRES(\"MEINKILL\", EEex_LuaObject)")
end

function MESEARCH(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local is_string = EEex_ReadDword(effectData + 0x40)
	local search_end = EEex_ReadDword(effectData + 0x44)
	if is_string > 0 then
		local search_target = EEex_ReadLString(effectData + 0x18, 0x8)
		for i = 0, search_end, 1 do
			if EEex_ReadLString(creatureData + i, 0x8) == search_target then
				Infinity_DisplayString("Match found for " .. search_target .. " at offset " .. i)
			end
		end
	else
		local search_byte = EEex_ReadByte(effectData + 0x18, 0x0)
		local search_word = EEex_ReadWord(effectData + 0x18, 0x0)
		local search_dword = EEex_ReadDword(effectData + 0x18)
		for i = 0, search_end, 1 do
			if EEex_ReadDword(creatureData + i) == search_dword then
				Infinity_DisplayString("Match found for " .. search_dword .. " at offset " .. i .. " (4 bytes)")
			elseif search_dword < 65536 and EEex_ReadWord(creatureData + i, 0x0) == search_word then
				Infinity_DisplayString("Match found for " .. search_word .. " at offset " .. i .. " (2 bytes)")
			elseif search_dword < 256 and EEex_ReadByte(creatureData + i, 0x0) == search_byte then
				Infinity_DisplayString("Match found for " .. search_byte .. " at offset " .. i .. " (1 byte)")
			end
		end
	end
end

function ME_Search_General(search_target, search_offset, search_length, is_string)
	if is_string then
		for i = 0, search_length, 1 do
			if EEex_ReadLString(search_offset + i, 0x8) == search_target then
				Infinity_DisplayString("Match found for " .. search_target .. " at offset " .. i)
			end
		end
	else
		for i = 0, search_length, 1 do
			if EEex_ReadDword(search_offset + i) == search_target then
				Infinity_DisplayString("Match found for " .. search_target .. " at offset " .. i .. " (4 bytes)")
			elseif EEex_ReadWord(search_offset + i, 0x0) == search_target then
				Infinity_DisplayString("Match found for " .. search_target .. " at offset " .. i .. " (2 bytes)")
			elseif EEex_ReadByte(search_offset + i, 0x0) == search_target then
				Infinity_DisplayString("Match found for " .. search_target .. " at offset " .. i .. " (1 byte)")
			end
		end
	end
end

function MEPRINTO(effectData, creatureData)
	local offset = EEex_ReadDword(effectData + 0x1c)
	local read_size = EEex_ReadDword(effectData + 0x40)
	if read_size == 1 then
		Infinity_DisplayString("Byte at offset " .. offset .. " is " .. EEex_ReadByte(creatureData + offset, 0x0))
	elseif read_size == 2 then
		Infinity_DisplayString("Word at offset " .. offset .. " is " .. EEex_ReadWord(creatureData + offset, 0x0))
	elseif read_size == 4 or read_size == 0 then
		Infinity_DisplayString("Dword at offset " .. offset .. " is " .. EEex_ReadDword(creatureData + offset))
	else
		Infinity_DisplayString("String at offset " .. offset .. " is " .. EEex_ReadLString(creatureData + offset, 0x8))
	end
end

function MEPRINTS(effectData, creatureData)
	local starting = EEex_ReadDword(effectData + 0x1C)
	local ending = EEex_ReadDword(effectData + 0x44)
	for i = starting, ending, 1 do
		Infinity_DisplayString(EEex_ToHex(i, 0, true) .. ": " .. EEex_ReadByte(creatureData + i, 0x0) .. ", " .. EEex_ReadWord(creatureData + i, 0x0) .. ", " .. EEex_ReadDword(creatureData + i) .. ", \"" .. EEex_ReadLString(creatureData + i, 8) .. "\"")
	end 
end
--[[
function MECORMOV(effectData, creatureData)
	local destx = EEex_ReadDword(creatureData + 0x34C)
	local desty = EEex_ReadDword(creatureData + 0x350)
	local destx2 = EEex_ReadDword(creatureData + 0x3404)
	local desty2 = EEex_ReadDword(creatureData + 0x3408)
	local destx3 = EEex_ReadDword(creatureData + 0x3568)
	local desty3 = EEex_ReadDword(creatureData + 0x356C)
--	Infinity_DisplayString("Going to: [" .. destx .. "." .. desty .. "]")
--	Infinity_DisplayString("Maybe going to: [" .. destx2 .. "." .. desty2 .. "]")
--	Infinity_DisplayString("Perhaps going to: [" .. destx3 .. "." .. desty3 .. "]")
	if destx > 0 and desty > 0 then
		EEex_LuaObject = EEex_ReadDword(creatureData + 0x34)
		if destx < 6000 and desty < 6000 then
			C:Eval("ActionOverride(EEex_LuaObject,ReallyForceSpellPointRES(\"MECORMOT\",[" .. destx .. "." .. desty .. "]))")
--		else
--			C:Eval("ActionOverride(EEex_LuaObject,ReallyForceSpellPointRES(\"MECORMOT\",[" .. destx2 .. "." .. desty2 .. "]))")
		end
	end
end
--]]

function MECORMOV(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local savingthrow = EEex_ReadDword(effectData + 0x3C)
	if bit32.band(savingthrow, 0x100000) > 0 and EEex_GetActorStat(targetID, 652) == 0 then return end
	local parent_resource = EEex_ReadLString(effectData + 0x90, 8)
	local x = EEex_ReadDword(creatureData + 0x8)
	local y = EEex_ReadDword(creatureData + 0xC)
--	local destx = EEex_ReadDword(creatureData + 0x34C)
--	local desty = EEex_ReadDword(creatureData + 0x350)
--	local prevx = EEex_ReadDword(creatureData + 0x410)
--	local prevy = EEex_ReadDword(creatureData + 0x414)
	local destx2 = EEex_ReadDword(creatureData + 0x3404)
	local desty2 = EEex_ReadDword(creatureData + 0x3408)
--	local destx3 = EEex_ReadDword(creatureData + 0x3568)
--	local desty3 = EEex_ReadDword(creatureData + 0x356C)
	local theareatype = 0
	if EEex_ReadDword(EEex_GetActorShare(targetID) + 0x14) > 0 then
		theareatype = EEex_ReadWord(EEex_ReadDword(EEex_GetActorShare(targetID) + 0x14) + 0x40, 0x0)
	end
	if bit32.band(theareatype, 0x800) == 0 and destx2 > 0 then
--		Infinity_DisplayString("Going to: [" .. destx .. "." .. desty .. "]")
--		Infinity_DisplayString("Maybe going to: [" .. destx2 .. "." .. desty2 .. "]")
--		Infinity_DisplayString("Perhaps going to: [" .. destx3 .. "." .. desty3 .. "]")
    	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 124,
["target"] = 1,
["timing"] = 1,
["source_id"] = targetID,
["source_target"] = targetID,
["source_x"] = x,
["source_y"] = y,
["target_x"] = destx2,
["target_y"] = desty2
})
	end
    EEex_ApplyEffectToActor(targetID, {
["opcode"] = 337,
["target"] = 2,
["parameter1"] = 652,
["parameter2"] = 366,
["timing"] = 1,
["parent_resource"] = parent_resource,
["source_target"] = targetID,
["source_id"] = targetID
})
    EEex_ApplyEffectToActor(targetID, {
["opcode"] = 366,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 652,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["resource"] = parent_resource,
["parent_resource"] = parent_resource,
["internal_flags"] = 0x400000,
["source_target"] = targetID,
["source_id"] = targetID
})
end

function EEex_GetDistance(x1, y1, x2, y2)
	return math.floor((((x1 - x2) ^ 2) + ((y1 - y2) ^ 2)) ^ .5) 
end

function MEPSPMOV(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local x = EEex_ReadDword(creatureData + 0x8)
	local y = EEex_ReadDword(creatureData + 0xC)
	local destx = EEex_ReadDword(creatureData + 0x3404)
	local desty = EEex_ReadDword(creatureData + 0x3408)
	local theareatype = 0
	if EEex_ReadDword(EEex_GetActorShare(targetID) + 0x14) > 0 then
		theareatype = EEex_ReadWord(EEex_ReadDword(EEex_GetActorShare(targetID) + 0x14) + 0x40, 0x0)
	end
	if bit32.band(theareatype, 0x800) == 0 and destx > 0 and EEex_GetDistance(x, y, destx, desty) > 100 then
    	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 215,
["target"] = 1,
["timing"] = 1,
["resource"] = "DDOORH",
["parent_resource"] = "METELEPH",
["source_id"] = targetID,
["source_target"] = targetID,
["source_x"] = x,
["source_y"] = y,
["target_x"] = destx,
["target_y"] = desty
})
    	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 124,
["target"] = 1,
["timing"] = 1,
["parent_resource"] = "METELEPH",
["source_id"] = targetID,
["source_target"] = targetID,
["source_x"] = x,
["source_y"] = y,
["target_x"] = destx,
["target_y"] = desty
})
    	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 215,
["target"] = 1,
["timing"] = 1,
["resource"] = "DDOORH",
["parent_resource"] = "METELEPH",
["source_id"] = targetID,
["source_target"] = targetID,
["source_x"] = x,
["source_y"] = y,
["target_x"] = destx,
["target_y"] = desty
})
--[[
    	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 148,
["target"] = 1,
["timing"] = 1,
["parameter1"] = 1,
["parameter2"] = 2,
["resource"] = "METELEPH",
["source_id"] = targetID,
["source_target"] = targetID,
["source_x"] = x,
["source_y"] = y,
["target_x"] = destx,
["target_y"] = desty
})
--]]
	end

end


me_balance_current_hp = {}
me_balance_max_hp = {}

function MEBALCST(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	me_balance_current_hp["" .. targetID] = EEex_ReadWord(creatureData + 0x438, 0x0)
	EEex_WriteWord(creatureData + 0x438, EEex_ReadWord(effectData + 0x18, 0x0))
end

function MEBALCEN(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	EEex_WriteWord(creatureData + 0x438, me_balance_current_hp["" .. targetID])
	Infinity_DisplayString(me_balance_current_hp["" .. targetID])
	Infinity_DisplayString(EEex_ReadWord(creatureData + 0x438, 0x0))
end

function MEBALMST(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	me_balance_max_hp["" .. targetID] = EEex_ReadWord(creatureData + 0x43A, 0x0)
	EEex_WriteWord(creatureData + 0x43A, EEex_ReadWord(effectData + 0x18, 0x0))
end

function MEBALMEN(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	EEex_WriteWord(creatureData + 0x43A, me_balance_max_hp["" .. targetID])
end

function MEGOLDAB(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID == 0x0 then return end
	local g_pBaldurChitin = EEex_ReadDword(EEex_Label("g_pBaldurChitin"))
	local m_pObjectGame = EEex_ReadDword(g_pBaldurChitin + EEex_Label("CBaldurChitin::m_pObjectGame"))
	local me_gold_ability_count = math.floor((EEex_ReadDword(m_pObjectGame + 0x47E8) / EEex_ReadDword(effectData + 0x18)) + 1)
    EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 1,
["parameter1"] = me_gold_ability_count,
["parameter2"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["resource"] = "MECO326",
["source_target"] = targetID,
["source_id"] = targetID
})
end

function MEGAZE(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if targetID == 0x0 or sourceID == 0x0 then return end
	local sourceData = EEex_GetActorShare(sourceID)
	local sourcex = EEex_ReadDword(sourceData + 0x8)
	local sourcey = EEex_ReadDword(sourceData + 0xC)
--	Infinity_DisplayString(targetID)
--	Infinity_DisplayString(sourcex)
--	Infinity_DisplayString(sourcey)
	local eyeContactDirection = EEex_GetActorRequiredDirection(targetID, sourcex, sourcey)
--	Infinity_DisplayString("ugu")
	local range = EEex_ReadDword(effectData + 0x1c)
	local check_if_facing = EEex_ReadDword(effectData + 0x44)
	local sourceDirection = EEex_GetActorDirection(sourceID)
	local targetDirection = EEex_GetActorDirection(targetID)
	if check_if_facing == 1 then
		if EEex_WithinCyclicRange(eyeContactDirection, targetDirection, range, 0, 15) and (not EEex_WithinCyclicRange(sourceDirection, targetDirection, 9 - range, 0, 15)) then
--			Infinity_DisplayString("ogo")
			local res_number = EEex_ReadDword(effectData + 0x18)
    		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["resource"] = "MEGAZ" .. res_number,
["source_target"] = targetID,
["source_id"] = sourceID
})
		end
	else
		if (not EEex_WithinCyclicRange(eyeContactDirection, targetDirection, range, 0, 15)) or EEex_WithinCyclicRange(sourceDirection, targetDirection, 9 - range, 0, 15) then
			local res_number = EEex_ReadDword(effectData + 0x18)
    		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["resource"] = "MEGAZ" .. res_number,
["source_target"] = targetID,
["source_id"] = sourceID
})
		end
	end
end
--[[
function MEGAZE(effectData, creatureData)
	local range = EEex_ReadDword(effectData + 0x1c)
	local check_if_facing = EEex_ReadDword(effectData + 0x44)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID == 0x0 then return end
	local sourceDirection = EEex_GetActorDirection(sourceID)
	local targetDirection = EEex_GetActorDirection(targetID)
	if check_if_facing == 1 then
		if not (EEex_WithinCyclicRange(sourceDirection, targetDirection, range, 0, 15)) then
			local res_number = EEex_ReadDword(effectData + 0x18)
    		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 1,
["duration"] = 100,
["resource"] = "MEGAZ" .. res_number,
["source_target"] = targetID,
["source_id"] = sourceID
})
		end
	else
		if EEex_WithinCyclicRange(sourceDirection, targetDirection, range, 0, 15) then
			local res_number = EEex_ReadDword(effectData + 0x18)
    		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 1,
["duration"] = 100,
["resource"] = "MEGAZ" .. res_number,
["source_target"] = targetID,
["source_id"] = sourceID
})
		end
	end
end
--]]
function ME_FMC_ActionbarListener(config)
	local actorID = EEex_GetActorIDSelected()
	if actorID ~= 0x0 then
--		Infinity_DisplayString(config)
--		Infinity_DisplayString(EEex_GetActorClass(actorID))
	    if config == 16 and EEex_GetActorClass(actorID) == 17 then
	        EEex_SetActionbarButton(0x3, EEex_ACTIONBAR_TYPE.FIND_TRAPS)
	        EEex_SetActionbarButton(0x4, EEex_ACTIONBAR_TYPE.THIEVING)
	        EEex_SetActionbarButton(0x5, EEex_ACTIONBAR_TYPE.STEALTH)
	    end
	end
end
--EEex_AddActionbarListener(ME_FMC_ActionbarListener)

function MESETQSP(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID == 0x0 then return end
	local first_four = EEex_ReadDword(effectData + 0x18)
	local second_four = EEex_ReadDword(effectData + 0x1c)
	local slot_number = EEex_ReadDword(effectData + 0x44)
	EEex_WriteDword(creatureData + 0x275E + (0x34 * slot_number), first_four)
	EEex_WriteDword(creatureData + 0x2762 + (0x34 * slot_number), second_four)
end

function MESpellToPoint(actorID)
	EEex_AddActionHook(function(actionData)
		local spellActions = {
			[31]  = 95 , -- Spell => SpellPoint
			[113] = 114, -- ForceSpell => ForceSpellPoint
			[181] = 337, -- ReallyForceSpell => ReallyForceSpellPoint
			[191] = 192, -- SpellNoDec => SpellPointNoDec
		}
		local newActionID = spellActions[EEex_GetActionID(actionData)]
		if newActionID then
			EEex_SetActionID(actionData, newActionID)
			local targetID = EEex_GetActionTarget(actionData)
			local targetX, targetY = EEex_GetActorLocation(targetID)
			EEex_SetActionPointX(actionData, targetX)
			EEex_SetActionPointY(actionData, targetY)
		end
	end)
end

function MEACHOOK()
--	Infinity_DisplayString(actorID)
	EEex_AddActionHook(function(actionData)	
		ME_Search_General("PFIRE2", actionData, 0x1000, 1)
--		ME_Search_General(234, actionData, 0x1000, 0)
--		for i = 100, 199, 1 do
--			Infinity_DisplayString(EEex_ToHex(i, 0, true) .. ": " .. EEex_ReadByte(actionData + i, 0x0) .. ", " .. EEex_ReadWord(actionData + i, 0x0) .. ", " .. EEex_ReadDword(actionData + i) .. ", \"" .. EEex_ReadLString(actionData + i, 8) .. "\"")
--		end 
	end)
end

function MESPIN(effectData, creatureData)
	me_initial_direction = EEex_ReadWord(creatureData + 0x31FE, 0x0)
--	for i = 0, 15, 1 do
--		EEex_Call(EEex_Label("CGameSprite::Face"), {(me_initial_direction + 1) % 16}, creatureData, 0x0)
		EEex_WriteWord(creatureData + 0x31FE, (me_initial_direction + 1) % 16)
--	for j = 0, 100, 1 do
--		end
--	end
end

function MEPERMCN(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID == 0x0 then return end
	local contingencyRes = EEex_ReadLString(effectData + 0x18, 8)
	EEex_AlterActorEffect(targetID,{{"opcode",232},{"parent_resource",contingencyRes}}, {{"parameter3",0}},1)
end

me_swap_id = {}

function MESWAP(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if me_swap_id["" .. sourceID] == nil then
		me_swap_id["" .. sourceID] = targetID
	else
		local otherID = me_swap_id["" .. sourceID]
		local otherData = EEex_GetActorShare(otherID)
		EEex_ApplyEffectToActor(otherID, {
["opcode"] = 124,
["target"] = 2,
["timing"] = 1,
["parameter2"] = 3,
["source_id"] = targetID,
["source_target"] = otherID,
["source_x"] = EEex_ReadDword(creatureData + 0x8),
["source_y"] = EEex_ReadDword(creatureData + 0xC),
["target_x"] = EEex_ReadDword(otherData + 0x8),
["target_y"] = EEex_ReadDword(otherData + 0xC)
})
		me_swap_id["" .. sourceID] = nil
	end
end

function MEINHOST(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local targetID = EEex_ReadDword(creatureData + 0x318)
	if not EEex_IsSprite(sourceID) then return end
	local area = EEex_ReadDword(effectData + 0x44)
	local hostileTrigger = "MEINHOST"
	if area == 15 then
		hostileTrigger = "MEINHO15"
	elseif area == 30 then
		hostileTrigger = "MEINHO30"
	end
	if EEex_IsSprite(targetID) then
		if area == 0 and EEex_GetActorAllegiance(targetID) ~= 128 then return end
		if area > 0 and EEex_GetActorAllegiance(targetID) >= 200 then return end
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["resource"] = hostileTrigger,
["source_id"] = sourceID,
["source_target"] = targetID
})

	else
		local targetX = EEex_ReadDword(creatureData + 0x34C)
		local targetY = EEex_ReadDword(creatureData + 0x350)
		if targetX > 0 and targetY > 0 and targetX < 10000 and targetY < 10000 then
			EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 148,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["resource"] = hostileTrigger,
["source_id"] = sourceID,
["source_target"] = sourceID,
["source_x"] = EEex_ReadDword(creatureData + 0x8),
["source_y"] = EEex_ReadDword(creatureData + 0xC),
["target_x"] = targetX,
["target_y"] = targetY
})
		end
	end
end

function MEORACLE(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local string_to_display = EEex_ReadDword(effectData + 0x18)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID > 0 and EEex_GetActorStat(targetID, 642) == 1 then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 330,
["target"] = 2,
["parameter1"] = string_to_display,
["timing"] = 1,
["source_target"] = targetID
})
	end
end

me_oracle_spell_ref = {}

function MEORACL2(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local actionID = EEex_ReadDword(creatureData + 0x2F8)
	local spellRES = EEex_ReadLString(creatureData + 0x3596, 8)
	local spellIDS = EEex_ReadWord(creatureData + 0x338, 0x0)
	if actionID == 31 or actionID == 113 or actionID == 191 or actionID == 318 or actionID == 95 or actionID == 114 or actionID == 192 or actionID == 319 then
		if spellRES == "" then
			spellRES = me_spellidstype[math.floor(spellIDS / 1000)] .. spellIDS % 1000
		end
		local spellNameStrref = EEex_ReadDword(EEex_GetSpellData(spellRES) + 0x8)
		if (me_oracle_spell_ref["" .. targetID] == nil or me_oracle_spell_ref["" .. targetID] ~= spellRES) and spellNameStrref > 0 then

			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 330,
["target"] = 2,
["parameter1"] = spellNameStrref,
["timing"] = 1,
["source_target"] = targetID
})
			me_oracle_spell_ref["" .. targetID] = spellRES
		end
	else
		me_oracle_spell_ref["" .. targetID] = nil
	end
end

function MECCTSEQ(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID == 0x0 then return end
	local newSeqRes = EEex_ReadLString(effectData + 0x6C, 8)
	local baseSeqRes = EEex_ReadLString(effectData + 0x74, 8)
	EEex_AlterActorEffect(targetID,{{"opcode",256},{"parent_resource",newSeqRes}}, {{"parent_resource",baseSeqRes}},1)
end

function MEMMCDIA(effectData, creatureData)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID > 0 and sourceID > 0 then
		local sourceData = EEex_GetActorShare(sourceID)
		local targetDialogue = EEex_ReadLString(creatureData + 0x35A8, 8)
		EEex_WriteLString(sourceData + 0x35A8, targetDialogue, 8)
	end
end

function MEMMCSPL(effectData, creatureData)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID > 0 and sourceID > 0 then
		local sourceData = EEex_GetActorShare(sourceID)
		local actionID = EEex_ReadDword(creatureData + 0x2F8)
		local spellRES = EEex_ReadLString(creatureData + 0x3596, 8)
		local spellIDS = EEex_ReadWord(creatureData + 0x338, 0x0)
--		Infinity_DisplayString("actionID: " .. actionID)
--		Infinity_DisplayString("spellRES: " .. spellRES)
--		Infinity_DisplayString("spellIDS: " .. spellIDS)
		if actionID == 31 or actionID == 113 or actionID == 191 or actionID == 318 then
			local spellTargetID = EEex_ReadDword(creatureData + 0x318)
			if EEex_GetActorAllegiance(targetID) >= 200 then
				if EEex_GetActorAllegiance(spellTargetID) >= 200 then
					if spellRES == "" then
						C:Eval("ForceSpell(Myself, " .. spellIDS .. ")",sourceID)
					else
						C:Eval("ForceSpellRES(\"" .. spellRES .. "\", Myself)",sourceID)
					end
				else
					EEex_LuaObject = targetID
					if spellRES == "" then
						C:Eval("ForceSpell(" .. "EEex_LuaObject" .. ", " .. spellIDS .. ")",sourceID)
					else
						C:Eval("ForceSpellRES(\"" .. spellRES .. "\", " .. "EEex_LuaObject" .. ")",sourceID)
					end
				end
			else
				if EEex_GetActorAllegiance(spellTargetID) >= 200 then
					EEex_LuaObject = spellTargetID
					if spellRES == "" then
						C:Eval("ForceSpell(" .. "EEex_LuaObject" .. ", " .. spellIDS .. ")",sourceID)
					else
						C:Eval("ForceSpellRES(\"" .. spellRES .. "\", " .. "EEex_LuaObject" .. ")",sourceID)
					end
				elseif targetID == spellTargetID then
					if spellRES == "" then
						C:Eval("ForceSpell(Myself, " .. spellIDS .. ")",sourceID)
					else
						C:Eval("ForceSpellRES(\"" .. spellRES .. "\", Myself)",sourceID)
					end
				else
					EEex_LuaObject = targetID
					if spellRES == "" then
						C:Eval("ForceSpell(" .. "EEex_LuaObject" .. ", " .. spellIDS .. ")",sourceID)
					else
						C:Eval("ForceSpellRES(\"" .. spellRES .. "\", " .. "EEex_LuaObject" .. ")",sourceID)
					end
				end
			end
		elseif actionID == 95 or actionID == 114 or actionID == 192 or actionID == 319 then
			local spellTargetX = EEex_ReadDword(creatureData + 0x34C)
			local spellTargetY = EEex_ReadDword(creatureData + 0x350)
			if spellRES == "" then
				C:Eval("ForceSpellPoint([" .. spellTargetX .. "." .. spellTargetY .. "], " .. spellIDS .. ")",sourceID)
			else
				C:Eval("ForceSpellPointRES(\"" .. spellRES .. "\", [" .. spellTargetX .. "." .. spellTargetY .. "])",sourceID)
			end

		end
	end
end

me_copy_spell_id = {}
me_copy_spell_caster_id = {}
me_copy_spell_ref = {}

function MECOPSPL(effectData, creatureData)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local actionID = EEex_ReadDword(creatureData + 0x2F8)
	local spellRES = EEex_GetActorSpellRES(targetID)
	local spellIDS = EEex_ReadWord(creatureData + 0x338, 0x0)
	if me_copy_spell_id["" .. sourceID] ~= nil then
		if me_copy_spell_ref["" .. sourceID] == nil then
			EEex_LuaObject = me_copy_spell_id["" .. sourceID]
		else
			EEex_LuaObject = targetID
		end
	end
	if (actionID == 31 or actionID == 113 or actionID == 191 or actionID == 318 or actionID == 95 or actionID == 114 or actionID == 192 or actionID == 319) and me_copy_spell_ref["" .. sourceID] == nil then
		me_copy_spell_ref["" .. sourceID] = "" .. spellRES

	end
	if me_copy_spell_id["" .. sourceID] == nil then
		me_copy_spell_id["" .. sourceID] = targetID
	else
		if me_copy_spell_ref["" .. sourceID] ~= nil then
			local castInstantly = EEex_ReadDword(effectData + 0x44)
			if castInstantly == 0 then
				C:Eval("ForceSpellRES(\"" .. me_copy_spell_ref["" .. sourceID] .. "\", " .. "EEex_LuaObject" .. ")",sourceID)
			else
				C:Eval("ReallyForceSpellRES(\"" .. me_copy_spell_ref["" .. sourceID] .. "\", " .. "EEex_LuaObject" .. ")",sourceID)
			end
		end
		me_copy_spell_id["" .. sourceID] = nil
		me_copy_spell_ref["" .. sourceID] = nil
	end


end

function MEALTSPL(effectData, creatureData)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local actionID = EEex_ReadDword(creatureData + 0x2F8)
	local spellRES = EEex_GetActorSpellRES(targetID)
	local spellIDS = EEex_ReadWord(creatureData + 0x338, 0x0)
	local casterID = 0
	if me_copy_spell_id["" .. sourceID] ~= nil then
		if me_copy_spell_ref["" .. sourceID] == nil then
			EEex_LuaObject = me_copy_spell_id["" .. sourceID]
			casterID = targetID
		else
			EEex_LuaObject = targetID
			casterID = me_copy_spell_id["" .. sourceID]
		end
	end
	if (actionID == 31 or actionID == 113 or actionID == 191 or actionID == 318 or actionID == 95 or actionID == 114 or actionID == 192 or actionID == 319) and me_copy_spell_ref["" .. sourceID] == nil then
		me_copy_spell_ref["" .. sourceID] = "" .. spellRES
--		Infinity_DisplayString("ugu")
	end
--	Infinity_DisplayString(spellRES)
--		Infinity_DisplayString("igi")
	if me_copy_spell_id["" .. sourceID] == nil then
		me_copy_spell_id["" .. sourceID] = targetID
--		Infinity_DisplayString("aga")
	else
		if me_copy_spell_ref["" .. sourceID] ~= nil then
--			C:Eval("ActionOverride(\"" .. EEex_GetActorScriptName(casterID) .. "\", ReallyForceSpellRES(\"" .. me_copy_spell_ref["" .. sourceID] .. "\", EEex_LuaObject))")
--				Infinity_DisplayString(EEex_GetActorScriptName(casterID) .. " -> " .. EEex_GetActorScriptName(EEex_LuaObject))
				EEex_ApplyEffectToActor(casterID, {
["opcode"] = 145,
["target"] = 2,
["parameter2"] = 3,
["special"] = 1,
["timing"] = 0,
["duration"] = 4,
["source_id"] = casterID,
["source_target"] = casterID
})
				EEex_ApplyEffectToActor(EEex_LuaObject, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = EEex_GetActorStat(casterID, 34),
["parameter2"] = 2,
["timing"] = 1,
["resource"] = me_copy_spell_ref["" .. sourceID],
["source_id"] = casterID,
["source_target"] = EEex_LuaObject
})

		end
		me_copy_spell_id["" .. sourceID] = nil
		me_copy_spell_ref["" .. sourceID] = nil
	end


end

function MEEXHEAL(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local healingMultiplier = EEex_GetActorStat(sourceID, 620)
	if targetID > 0 and sourceID > 0 then
		if healingMultiplier > 0 then
			local healAmount = math.floor(EEex_ReadDword(effectData + 0x18) * healingMultiplier / 100)
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 17,
["target"] = 2,
["parameter1"] = healAmount,
["timing"] = 1,
["source_id"] = sourceID,
["source_target"] = targetID
})
		end
	end
end

function ME_IsDualClassed(actorID)
	return (bit32.band(EEex_ReadDword(EEex_GetActorShare(actorID) + 0x424), 504) > 0)
end

function ME_IsMultiClassed(actorID)
	local me_class = EEex_GetActorClass(actorID)
	return (((me_class >= 7 and me_class <= 9) or (me_class >= 13 and me_class <= 16) or (me_class == 18)) and (bit32.band(EEex_ReadDword(EEex_GetActorShare(actorID) + 0x424), 504) == 0))
end

function MEDETCRE(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID ~= 0 then
		local name = EEex_ReadDword(creatureData + 0x41C)
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 330,
["target"] = 2,
["parameter1"] = name,
["timing"] = 1,
["source_target"] = targetID
})
	end
end

function MEKILLCN(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID == 0x0 then return end
	local contingencyRes = EEex_ReadLString(effectData + 0x18, 8)
	EEex_IterateActorEffects(targetID, function(iData)
		local the_opcode = EEex_ReadDword(iData + 0x10)
		local the_parent_resource = EEex_ReadLString(iData + 0x94, 8)
		if the_opcode == 256 and the_parent_resource == contingencyRes then
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 232,
["target"] = 1,
["parameter1"] = 0,
["parameter2"] = 12,
["timing"] = 1,
["resource"] = EEex_ReadLString(iData + 0x30, 8),
["source_target"] = targetID,
["source_id"] = targetID,
["parent_resource"] = contingencyRes
})
		end
	end)

end

me_death_trigger = {}

function MEDEATCS(effectData, creatureData)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID == 0x0 or sourceID == 0x0 then return end
	local contingencyRes = EEex_ReadLString(effectData + 0x18, 8)
	EEex_IterateActorEffects(sourceID, function(eData)
		local the_opcode = EEex_ReadDword(eData + 0x10)
		local the_parent_resource = EEex_ReadLString(eData + 0x94, 8)
		if the_opcode == 232 and the_parent_resource == contingencyRes then
			me_death_trigger["" .. sourceID] = {EEex_ReadDword(eData + 0x1C), EEex_ReadLString(eData + 0x30, 8)}
		end
	end)


end

function MEDEATCN(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID == 0x0 or sourceID == 0x0 then return end
	local sourceData = EEex_GetActorShare(sourceID)
	local contingencyRes = EEex_ReadLString(effectData + 0x18, 8)
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 232,
["target"] = 1,
["parameter1"] = me_death_trigger["" .. sourceID][1],
["parameter2"] = 16,
["timing"] = 9,
["resource"] = me_death_trigger["" .. sourceID][2],
["source_target"] = targetID,
["source_id"] = sourceID,
["parent_resource"] = contingencyRes
})

end

function MEDESTSP(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local destinationSpell = EEex_ReadLString(effectData + 0x18, 8)
	local destx2 = EEex_ReadDword(creatureData + 0x3404)
	local desty2 = EEex_ReadDword(creatureData + 0x3408)
	if destx2 > 0 then
    	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 148,
["target"] = 1,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["resource"] = destinationSpell,
["source_id"] = targetID,
["source_target"] = targetID,
["source_x"] = EEex_ReadDword(creatureData + 0x8),
["source_y"] = EEex_ReadDword(creatureData + 0xC),
["target_x"] = destx2,
["target_y"] = desty2
})
	end

end

me_spell_immunity = {}
me_spell_immunity_reset = {}

function MESPLIMS(effectData, creatureData)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if sourceID == 0x0 then return end
	if me_spell_immunity_reset["" .. sourceID] == nil then
		me_spell_immunity_reset["" .. sourceID] = true
		me_spell_immunity["" .. sourceID] = {"", "", ""}
	end
	EEex_IterateActorEffects(sourceID, function(eData)
		local the_opcode = EEex_ReadDword(eData + 0x10)
		local the_special = EEex_ReadDword(eData + 0x48)
		local the_parent_resource = EEex_ReadLString(eData + 0x94, 8)
		if the_opcode == 256 then
			if the_parent_resource == "MESPLIM1" then
				me_spell_immunity["" .. sourceID][1] = EEex_ReadLString(eData + 0x30, 8)
			elseif the_parent_resource == "MESPLIM2" then
				me_spell_immunity["" .. sourceID][2] = EEex_ReadLString(eData + 0x30, 8)
			elseif the_parent_resource == "MESPLIM3" then
				me_spell_immunity["" .. sourceID][3] = EEex_ReadLString(eData + 0x30, 8)
			end
		end
	end)

end

function MESPLIM1(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID == 0x0 or sourceID == 0x0 then return end
	me_spell_immunity_reset["" .. sourceID] = nil
	local sourceData = EEex_GetActorShare(sourceID)
	local contingencyRes = EEex_ReadLString(effectData + 0x18, 8)
	if me_spell_immunity["" .. sourceID][1] ~= nil then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 206,
["target"] = 2,
["parameter1"] = ex_spell_ineffective_strref,
["parameter2"] = 16,
["timing"] = 0,
["duration"] = 2400,
["resource"] = me_spell_immunity["" .. sourceID][1],
["source_target"] = targetID,
["source_id"] = sourceID,
["parent_resource"] = contingencyRes
})
	end
	if me_spell_immunity["" .. sourceID][2] ~= nil then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 206,
["target"] = 2,
["parameter1"] = 24534,
["parameter2"] = 16,
["timing"] = 0,
["duration"] = 2400,
["resource"] = me_spell_immunity["" .. sourceID][2],
["source_target"] = targetID,
["source_id"] = sourceID,
["parent_resource"] = contingencyRes
})
	end
	if me_spell_immunity["" .. sourceID][3] ~= nil then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 206,
["target"] = 2,
["parameter1"] = 24534,
["parameter2"] = 16,
["timing"] = 0,
["duration"] = 2400,
["resource"] = me_spell_immunity["" .. sourceID][3],
["source_target"] = targetID,
["source_id"] = sourceID,
["parent_resource"] = contingencyRes
})
	end
end


-- Modifies the duration of all effects on the actor where the condition is true.
-- The condition is determined by the Special parameter:
-- 0: True always
-- 1: True if the effect is flagged as hostile
-- 2: True if the effect is not flagged as hostile
-- The duration is modified in a way determined by Parameter2:
-- 0: Add Parameter1 (in ticks) to the duration
-- 1: Set the duration to Parameter1 (in ticks)
-- 2: Multiply the duration by Parameter1 (as a percentage)

function MEMODDUR(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID == 0x0 then return end
	local parameter1 = EEex_ReadDword(effectData + 0x18)
	local parameter2 = EEex_ReadDword(effectData + 0x1C)
	local condition = EEex_ReadDword(effectData + 0x44)
	EEex_IterateActorEffects(targetID, function(eData)
		local the_internal_flags = EEex_ReadDword(eData + 0xCC)
		if bit32.band(the_internal_flags, 0x400000) == 0 then
			local conditionMet = false
			if condition == 0 then
				conditionMet = true
			elseif condition == 1 then
				if bit32.band(EEex_ReadDword(eData + 0x9C), 0x400) ~= 0 then
					conditionMet = true
				end
			elseif condition == 2 then
				if bit32.band(EEex_ReadDword(eData + 0x9C), 0x400) == 0 then
					conditionMet = true
				end
			end
			if conditionMet then
				EEex_WriteDword(eData + 0xCC, bit32.bor(the_internal_flags, 0x400000))
				local the_end_time = EEex_ReadDword(eData + 0x28)
				local the_start_time = EEex_ReadDword(eData + 0x6C)
				if parameter2 == 0 then
					EEex_WriteDword(eData + 0x28, the_end_time + parameter1)
				elseif parameter2 == 1 then
					EEex_WriteDword(eData + 0x28, the_start_time + parameter1)
				elseif parameter2 == 2 then
					EEex_WriteDword(eData + 0x28, the_start_time + math.floor((the_end_time - the_start_time) * parameter1 / 100))
				end
			end
		end
	end)
end

ex_transferScripts = false
function MEIMGSCR(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local masterID = EEex_ReadDword(creatureData + 0x39F4)
	if targetID == 0 or masterID <= 0 then return end
	local special = EEex_ReadDword(effectData + 0x44)
	local doNotDisableButton = false
	local doNotDisableSpellcasting = false
	EEex_IterateActorEffects(targetID, function(eData)
		local the_opcode = EEex_ReadDword(eData + 0x10)
		local the_parameter2 = EEex_ReadDword(eData + 0x20)
		local the_savingthrow = EEex_ReadDword(eData + 0x40)
		if (the_opcode == 101 or the_opcode == 198) and bit32.band(the_savingthrow, 0x40000) > 0 then
			if the_parameter2 == 144 then
				doNotDisableButton = true
			elseif the_parameter2 == 145 then
				doNotDisableSpellcasting = true
			end
		end
	end)
	if doNotDisableButton then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 337,
["target"] = 2,
["parameter1"] = -1,
["parameter2"] = 144,
["timing"] = 9,
["parent_resource"] = "MEIMGREM",
["source_target"] = targetID,
["source_id"] = targetID
})
	end
	if doNotDisableSpellcasting then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 337,
["target"] = 2,
["parameter1"] = -1,
["parameter2"] = 145,
["timing"] = 9,
["parent_resource"] = "MEIMGREM",
["source_target"] = targetID,
["source_id"] = targetID
})
	end
	local transferScripts = ex_transferScripts
	local latestImageTime = 0
	local latestImageFlags = 0
	EEex_IterateActorEffects(masterID, function(eData)
		local the_opcode = EEex_ReadDword(eData + 0x10)
		local the_parameter2 = EEex_ReadDword(eData + 0x20)
		local the_time_applied = EEex_ReadDword(eData + 0x6C)
		if the_opcode == 236 and the_parameter2 == special and the_time_applied > latestImageTime then
			latestImageTime = the_time_applied
			latestImageFlags = EEex_ReadDword(eData + 0x40)
		end
	end)
	if bit32.band(latestImageFlags, 0x40000) > 0 then
		transferScripts = true
	end
	if EEex_GetActorStat(targetID, 663) > 0 then
		EEex_IterateActorEffects(targetID, function(eData)
			local the_opcode = EEex_ReadDword(eData + 0x10)
			local the_parameter1 = EEex_ReadDword(eData + 0x1C)
			local the_special = EEex_ReadDword(eData + 0x48)
			if the_opcode == 401 and the_special == 663 and (the_parameter1 == special or the_parameter1 == 4) then
				local the_resource = EEex_ReadLString(eData + 0x30, 8)
				if bit32.band(EEex_ReadDword(eData + 0x40), 0x40000) > 0 then
					transferScripts = true
				end
				if bit32.band(EEex_ReadDword(eData + 0x40), 0x80000) > 0 then
					transferScripts = false
				end
				if bit32.band(EEex_ReadDword(eData + 0x40), 0x100000) > 0 then
					EEex_ApplyEffectToActor(masterID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 9,
["resource"] = the_resource,
["parent_resource"] = "MEIMGSPL",
["source_target"] = masterID,
["source_id"] = targetID
})
				else
					EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 9,
["resource"] = the_resource,
["parent_resource"] = "MEIMGSPL",
["source_target"] = targetID,
["source_id"] = masterID
})
				end
			end
		end)
	end
	if not transferScripts then return end
	local masterData = EEex_GetActorShare(masterID)
	local overrideScript = EEex_ReadLString(masterData + 0x65C, 8)
	local classScript = EEex_ReadLString(masterData + 0x664, 8)
	local raceScript = EEex_ReadLString(masterData + 0x66C, 8)
	local generalScript = EEex_ReadLString(masterData + 0x674, 8)
	local defaultScript = EEex_ReadLString(masterData + 0x67C, 8)
	local specificsScript = EEex_ReadLString(masterData + 0x2A24, 8)
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 82,
["target"] = 2,
["parameter2"] = 0,
["timing"] = 9,
["resource"] = overrideScript,
["parent_resource"] = "MEIMGSCR",
["source_target"] = targetID,
["source_id"] = targetID
})
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 82,
["target"] = 2,
["parameter2"] = 2,
["timing"] = 9,
["resource"] = specificsScript,
["parent_resource"] = "MEIMGSCR",
["source_target"] = targetID,
["source_id"] = targetID
})
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 82,
["target"] = 2,
["parameter2"] = 4,
["timing"] = 9,
["resource"] = classScript,
["parent_resource"] = "MEIMGSCR",
["source_target"] = targetID,
["source_id"] = targetID
})
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 82,
["target"] = 2,
["parameter2"] = 5,
["timing"] = 9,
["resource"] = raceScript,
["parent_resource"] = "MEIMGSCR",
["source_target"] = targetID,
["source_id"] = targetID
})
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 82,
["target"] = 2,
["parameter2"] = 6,
["timing"] = 9,
["resource"] = generalScript,
["parent_resource"] = "MEIMGSCR",
["source_target"] = targetID,
["source_id"] = targetID
})
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 82,
["target"] = 2,
["parameter2"] = 7,
["timing"] = 9,
["resource"] = defaultScript,
["parent_resource"] = "MEIMGSCR",
["source_target"] = targetID,
["source_id"] = targetID
})
--	if EEex_GetActorAllegiance(targetID) <= 7 then
--		C:Eval("MakeGlobal()",targetID)
--		C:Eval("ChangeEnemyAlly(Myself,FAMILIAR)",targetID)
--		C:Eval("AddFamiliar()",targetID)
--	end
end

function MEFOOLSM(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if targetID == 0 or sourceID == 0 then return end
	local targetInt = EEex_GetActorStat(targetID, 38)
	local sourceInt = EEex_GetActorStat(sourceID, 38)
	if sourceInt > targetInt then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 12,
["target"] = 2,
["parameter1"] = (sourceInt - targetInt),
["timing"] = 9,
["source_target"] = targetID,
["source_id"] = sourceID
})
	elseif targetInt > sourceInt then
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 12,
["target"] = 2,
["parameter1"] = (targetInt - sourceInt),
["timing"] = 9,
["source_target"] = sourceID,
["source_id"] = sourceID
})
	end
end

function MEMODPRF(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID == 0 then return end
	local increment = EEex_ReadDword(effectData + 0x18)
	local proficiencies = EEex_ReadDword(effectData + 0x1C)
	local maximum = EEex_ReadDword(effectData + 0x44)
	local profBit = 1
	local profChanges = {}
	while profBit <= 0x1000000 do
--		Infinity_DisplayString(profBit .. " -> " .. bit32.band(proficiencies, profBit))
		if bit32.band(proficiencies, profBit) > 0 then
			local profCurrent = EEex_GetActorStat(targetID, me_proficiency[profBit])
--			Infinity_DisplayString(me_proficiency[profBit] .. ": " .. profCurrent)
			if profCurrent == 0 then
				EEex_ApplyEffectToActor(targetID, {
["opcode"] = 233,
["target"] = 2,
["parameter1"] = increment,
["parameter2"] = me_proficiency[profBit],
["timing"] = 9,
["source_target"] = targetID,
["source_id"] = targetID
})
			else
				if (profCurrent + increment) < maximum then
					profChanges[me_proficiency[profBit]] = profCurrent + increment
				else
					profChanges[me_proficiency[profBit]] = maximum
				end
			end
		end
		profBit = profBit * 2
	end
	EEex_IterateActorEffects(targetID, function(eData)
		local the_opcode = EEex_ReadDword(eData + 0x10)
		local the_parameter2 = EEex_ReadDword(eData + 0x20)
		if the_opcode == 233 and profChanges[the_parameter2] ~= nil then
			EEex_WriteDword(eData + 0x1C, profChanges[the_parameter2])
		end
	end)
end

function MECRTSEQ(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID == 0 then return end
	local contingencyRes = EEex_ReadLString(effectData + 0x18, 8)
	EEex_IterateActorEffects(targetID, function(eData)
		local the_opcode = EEex_ReadDword(eData + 0x10)
		local the_parent_resource = EEex_ReadLString(eData + 0x94, 8)
		if the_opcode == 256 and the_parent_resource == contingencyRes then
			local the_resource = EEex_ReadLString(eData + 0x30, 8)
			EEex_AlterActorEffect(targetID,{{"opcode",341},{"resource","MECRTSEQ"}}, {{"resource",the_resource}},1)
		end
	end)
end

function MECRTSPL(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local newTargetID = targetID
	if not EEex_IsSprite(sourceID, false) then return end
	local contingencyRes = EEex_ReadLString(effectData + 0x18, 8)
	EEex_IterateActorEffects(sourceID, function(eData)
		local the_opcode = EEex_ReadDword(eData + 0x10)
		local the_special = EEex_ReadDword(eData + 0x48)
		local the_parent_resource = EEex_ReadLString(eData + 0x94, 8)
		if the_opcode == 401 and the_special == 666 and the_parent_resource == contingencyRes then
			local the_parameter3 = EEex_ReadDword(eData + 0x60)
			if the_parameter3 == 0 then
				newTargetID = sourceID
			end
			local the_casterlvl = EEex_ReadDword(eData + 0xC8)
			local the_resource = EEex_ReadLString(eData + 0x30, 8)
			local the_resource2 = EEex_ReadLString(eData + 0x70, 8)
			local the_resource3 = EEex_ReadLString(eData + 0x78, 8)
			if the_resource ~= "" then
				EEex_ApplyEffectToActor(newTargetID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = the_casterlvl,
["parameter2"] = 1,
["casterlvl"] = the_casterlvl,
["resource"] = the_resource,
["timing"] = 9,
["source_target"] = newTargetID,
["source_id"] = sourceID
})
			end
			if the_resource2 ~= "" then
				EEex_ApplyEffectToActor(newTargetID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = the_casterlvl,
["parameter2"] = 1,
["casterlvl"] = the_casterlvl,
["resource"] = the_resource2,
["timing"] = 9,
["source_target"] = newTargetID,
["source_id"] = sourceID
})
			end
			if the_resource3 ~= "" then
				EEex_ApplyEffectToActor(newTargetID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = the_casterlvl,
["parameter2"] = 1,
["casterlvl"] = the_casterlvl,
["resource"] = the_resource3,
["timing"] = 9,
["source_target"] = newTargetID,
["source_id"] = sourceID
})
			end
		end
	end)
end

function MEPRTOPC(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if targetID == 0x0 or sourceID == 0x0 then return end
	local opcode = EEex_ReadDword(effectData + 0x1C)
	if EEex_IsImmuneToOpcode(targetID, opcode) then
		local spellRes = EEex_ReadLString(effectData + 0x90, 8)
		local immunityString = EEex_ReadDword(effectData + 0x44)
		local immunityOpcode = 318
		if immunityString ~= -1 then
			immunityOpcode = 324
		end
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = immunityOpcode,
["target"] = 2,
["timing"] = 0,
["duration"] = 0,
["resource"] = spellRes,
["special"] = immunityString,
["parent_resource"] = spellRes,
["source_target"] = targetID,
["source_id"] = sourceID
})
	end
end

function MEPRTOFF(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if targetID == 0x0 or sourceID == 0x0 then return end
	local check_value = EEex_ReadDword(effectData + 0x18)
	local offset = EEex_ReadWord(effectData + 0x1C, 0x0)
	local readSize = EEex_ReadByte(effectData + 0x1E, 0x0)
	local check_relation = EEex_ReadByte(effectData + 0x1F, 0x0)
	local check_stat = 0
	if readSize == 1 then
		check_stat = EEex_ReadByte(creatureData + offset, 0x0)
	elseif readSize == 2 then
		check_stat = EEex_ReadSignedWord(creatureData + offset, 0x0)
	else
		check_stat = EEex_ReadDword(creatureData + offset)
	end
--	Infinity_DisplayString("check_value: " .. check_value .. ", offset: " .. offset .. ", readSize: " .. readSize .. ", check_relation: " .. check_relation .. ", check_stat: " .. check_stat)
	local hasProtection = false
	if check_relation == 0 and check_stat <= check_value then
		hasProtection = true
	elseif check_relation == 1 and check_stat == check_value then
		hasProtection = true
	elseif check_relation == 2 and check_stat < check_value then
		hasProtection = true
	elseif check_relation == 3 and check_stat > check_value then
		hasProtection = true
	elseif check_relation == 4 and check_stat >= check_value then
		hasProtection = true
	elseif check_relation == 5 and check_stat ~= check_value then
		hasProtection = true
	elseif check_relation == 6 and bit32.bor(check_stat, check_value) == check_value then
		hasProtection = true
	elseif check_relation == 7 and bit32.band(check_stat, check_value) >= check_value then
		hasProtection = true
	elseif check_relation == 8 and bit32.band(check_stat, check_value) > 0 then
		hasProtection = true
	elseif check_relation == 9 and bit32.band(check_stat, check_value) == 0 then
		hasProtection = true
	elseif check_relation == 10 and bit32.bor(check_stat, check_value) > check_value then
		hasProtection = true
	elseif check_relation == 11 and bit32.band(check_stat, check_value) < check_value then
		hasProtection = true
	end
	if hasProtection then
		local spellRes = EEex_ReadLString(effectData + 0x90, 8)
		local immunityString = EEex_ReadDword(effectData + 0x44)
		local immunityOpcode = 318
		if immunityString ~= -1 then
			immunityOpcode = 324
		end
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = immunityOpcode,
["target"] = 2,
["timing"] = 0,
["duration"] = 0,
["resource"] = spellRes,
["special"] = immunityString,
["parent_resource"] = spellRes,
["source_target"] = targetID,
["source_id"] = sourceID
})
	end
end

function MEPRTSLV(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if targetID <= 0x0 or sourceID <= 0x0 then return end
	if targetID ~= sourceID and bit32.band(EEex_ReadDword(effectData + 0x3C), 0x100000) > 0 then return end
	local level = EEex_ReadDword(effectData + 0x1C)
	if EEex_GetActorStat(sourceID, 654) ~= 0 and level >= 1 then
		level = level + EEex_GetActorStat(sourceID, 654)
		if level < 1 then
			level = 1
		end
	end
	if EEex_IsImmuneToSpellLevel(targetID, level, false) then
		local spellRes = EEex_ReadLString(effectData + 0x90, 8)
		local immunityString = EEex_ReadDword(effectData + 0x44)
		local immunityOpcode = 318
		if immunityString ~= -1 then
			immunityOpcode = 324
		end
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = immunityOpcode,
["target"] = 2,
["timing"] = 0,
["duration"] = 0,
["resource"] = spellRes,
["special"] = immunityString,
["parent_resource"] = spellRes,
["source_target"] = targetID,
["source_id"] = sourceID
})
	end
end

function MEPRTACT(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if not EEex_IsSprite(targetID, false) then return end
	local actionID = EEex_ReadWord(creatureData + 0x2F8, 0x0)
	if actionID == 3 or actionID == 105 or actionID == 134 or actionID == 31 or actionID == 95 or actionID == 113 or actionID == 114 or actionID == 191 or actionID == 192 then
		local spellRes = EEex_ReadLString(effectData + 0x90, 8)
		local immunityString = EEex_ReadDword(effectData + 0x44)
		local immunityOpcode = 318
		if immunityString ~= -1 then
			immunityOpcode = 324
		end
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = immunityOpcode,
["target"] = 2,
["timing"] = 0,
["duration"] = 0,
["resource"] = spellRes,
["special"] = immunityString,
["parent_resource"] = spellRes,
["source_target"] = targetID,
["source_id"] = sourceID
})
	end
end

function MEPRTAIR(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local heightThreshold = EEex_ReadDword(effectData + 0x1C)
	if not EEex_IsSprite(targetID) then return end
	if EEex_IsInAir(targetID, heightThreshold) then
		local spellRes = EEex_ReadLString(effectData + 0x90, 8)
		local immunityString = EEex_ReadDword(effectData + 0x44)
		local immunityOpcode = 318
		if immunityString ~= -1 then
			immunityOpcode = 324
		end
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = immunityOpcode,
["target"] = 2,
["timing"] = 0,
["duration"] = 0,
["resource"] = spellRes,
["special"] = immunityString,
["parent_resource"] = spellRes,
["source_target"] = targetID,
["source_id"] = sourceID
})
	end
end

function MEPRTFLY(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if not EEex_IsSprite(targetID) then return end
	if EEex_IsFlying(targetID) then
		local spellRes = EEex_ReadLString(effectData + 0x90, 8)
		local immunityString = EEex_ReadDword(effectData + 0x44)
		local immunityOpcode = 318
		if immunityString ~= -1 then
			immunityOpcode = 324
		end
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = immunityOpcode,
["target"] = 2,
["timing"] = 0,
["duration"] = 0,
["resource"] = spellRes,
["special"] = immunityString,
["parent_resource"] = spellRes,
["source_target"] = targetID,
["source_id"] = sourceID
})
	end
end

function EEex_IsInAir(actorID, heightThreshold)
	local animation = EEex_GetActorAnimation(actorID)
	return (me_flying_sprite['' .. animation] ~= nil or EEex_GetActorStat(actorID, 640) > 0 or EEex_ReadDword(EEex_GetActorShare(actorID) + 0x10) < heightThreshold)
end

function EEex_IsFlying(actorID)
	local animation = EEex_GetActorAnimation(actorID)
	return (me_flying_sprite['' .. animation] ~= nil or EEex_GetActorStat(actorID, 640) > 0)
end

function EEex_IsEthereal(actorID)
	local animation = EEex_GetActorAnimation(actorID)
	return (me_ethereal_sprite['' .. animation] ~= nil or EEex_GetActorStat(actorID, 639) > 0)
end

function MEREMOPC(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local match_opcode = EEex_ReadSignedWord(effectData + 0x18, 0x0)
	local match_opcode2 = EEex_ReadSignedWord(effectData + 0x1A, 0x0)
	local match_parameter2 = EEex_ReadDword(effectData + 0x1C)
	local match_special = EEex_ReadDword(effectData + 0x44)
	local parent_resource = EEex_ReadLString(effectData + 0x90, 8)
	if targetID == 0x0 then return end
	EEex_IterateActorEffects(targetID, function(eData)
		local the_opcode = EEex_ReadDword(eData + 0x10)
		local the_parameter2 = EEex_ReadDword(eData + 0x20)
		local the_special = EEex_ReadDword(eData + 0x48)
		if (match_opcode == -1 or match_opcode == the_opcode or (match_opcode2 > 0 and match_opcode2 == the_opcode)) and (match_parameter2 == -1 or match_parameter2 == the_parameter2) and (match_special == -1 or match_special == the_special) then
			EEex_WriteDword(eData + 0x28, EEex_ReadDword(eData + 0x6C))
		end
	end)
end

function MEPSTACK(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local parent_resource = EEex_ReadLString(effectData + 0x90, 8)
	if targetID == 0x0 or sourceID == 0x0 then return end
	EEex_IterateActorEffects(targetID, function(eData)
		local the_sourceID = EEex_ReadDword(eData + 0x110)
		local the_parent_resource = EEex_ReadLString(eData + 0x94, 8)
		if the_sourceID == sourceID and the_parent_resource == parent_resource then
			EEex_WriteDword(eData + 0x28, EEex_ReadDword(eData + 0x6C))
		end
	end)
end

function MEPSTAC2(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local parameter5 = EEex_ReadDword(effectData + 0x64)
	local parent_resource = EEex_ReadLString(effectData + 0x90, 8)
	if targetID == 0x0 or parameter5 == 0 then return end
	EEex_IterateActorEffects(targetID, function(eData)
		local the_parameter5 = EEex_ReadDword(eData + 0x68)
		local the_parent_resource = EEex_ReadLString(eData + 0x94, 8)
		if the_parameter5 == parameter5 and the_parent_resource == parent_resource then
			EEex_WriteDword(eData + 0x28, EEex_ReadDword(eData + 0x6C))
		end
	end)
end

function MECIDSET(originatingEffectData, effectData, creatureData)
	local parameter5 = EEex_ReadDword(effectData + 0x64)
	if parameter5 == 0 then
		local sourceID = EEex_ReadDword(effectData + 0x10C)
		if EEex_IsSprite(sourceID) then
			EEex_WriteDword(effectData + 0x64, EEex_GetActorStat(sourceID, 645))
		end
	end
end

function MESPLMOD(originatingEffectData, effectData, creatureData)
	if true then return false end
end

EEex_AddScreenEffectsGlobal("MESPLMOD", function(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if not EEex_IsSprite(targetID) then return false end
	local internal_flags = EEex_ReadDword(effectData + 0xC8)
	if bit32.band(internal_flags, 0x2000000) > 0 then return end
	local opcode = EEex_ReadDword(effectData + 0xC)
	local parent_resource = EEex_ReadLString(effectData + 0x90, 8)
	local parameter1 = EEex_ReadDword(effectData + 0x18)
	local parameter2 = EEex_ReadDword(effectData + 0x1C)
	local dicenumber = EEex_ReadDword(effectData + 0x34)
	local dicesize = EEex_ReadDword(effectData + 0x38)
	local restype = EEex_ReadDword(effectData + 0x8C)
	if opcode == 337 and parameter2 == 5 then
		EEex_IterateActorEffects(targetID, function(eData)
			local the_parameter3 = EEex_ReadDword(eData + 0x60)
			if the_parameter3 == 14432 then
				EEex_WriteDword(eData + 0x28, EEex_ReadDword(eData + 0x6C))
			end
		end)
	elseif (opcode == 5 or opcode == 241) and (parameter1 == 0 or parameter1 == EEex_GetActorGeneral(targetID)) and EEex_GetActorAllegiance(targetID) == 2 and (not EEex_IsSprite(sourceID, true) or EEex_GetActorAllegiance(sourceID) >= 200) and not EEex_IsImmuneToOpcode(targetID, opcode) then
		local portraitIcon = 0
		local modParameter2 = parameter2 % 10
		if modParameter2 == 2 or modParameter2 == 3 then
			portraitIcon = 1
		elseif modParameter2 == 4 then
			portraitIcon = 43
		end
		local charmStrref = 0
		if parameter2 == 0 or parameter2 == 1 then
			charmStrref = 14672
		elseif parameter2 == 2 or parameter2 == 3 then
			charmStrref = 14780
		elseif parameter2 == 4 then
			charmStrref = 26206
		end
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 72,
["target"] = EEex_ReadDword(effectData + 0x10),
["power"] = EEex_ReadDword(effectData + 0x14),
["parameter1"] = 255,
["parameter2"] = 0,
["timing"] = EEex_ReadDword(effectData + 0x20),
["duration"] = EEex_ReadDword(effectData + 0x24),
["resource"] = EEex_ReadLString(effectData + 0x2C, 8),
["dicenumber"] = EEex_ReadDword(effectData + 0x34),
["dicesize"] = EEex_ReadDword(effectData + 0x38),
["savingthrow"] = EEex_ReadDword(effectData + 0x3C),
["savebonus"] = EEex_ReadDword(effectData + 0x40),
["school"] = EEex_ReadDword(effectData + 0x48),
["resist_dispel"] = EEex_ReadDword(effectData + 0x58),
["parameter3"] = 14432,
["parameter4"] = EEex_ReadDword(effectData + 0x60),
["parameter5"] = EEex_ReadDword(effectData + 0x64),
["vvcresource"] = EEex_ReadLString(effectData + 0x6C, 8),
["resource2"] = EEex_ReadLString(effectData + 0x74, 8),
["source_x"] = EEex_ReadDword(effectData + 0x7C),
["source_y"] = EEex_ReadDword(effectData + 0x80),
["target_x"] = EEex_ReadDword(effectData + 0x84),
["target_y"] = EEex_ReadDword(effectData + 0x88),
["restype"] = EEex_ReadDword(effectData + 0x8C),
["parent_resource"] = EEex_ReadLString(effectData + 0x90, 8),
["resource_flags"] = EEex_ReadDword(effectData + 0x98),
["impact_projectile"] = EEex_ReadDword(effectData + 0x9C),
["sourceslot"] = EEex_ReadDword(effectData + 0xA0),
["effvar"] = EEex_ReadLString(effectData + 0xA4, 32),
["casterlvl"] = EEex_ReadDword(effectData + 0xC4),
["internal_flags"] = bit32.bor(internal_flags, 0x2000000),
["sectype"] = EEex_ReadDword(effectData + 0xCC),
["source_target"] = targetID,
["source_id"] = sourceID
})
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 142,
["target"] = EEex_ReadDword(effectData + 0x10),
["power"] = EEex_ReadDword(effectData + 0x14),
["parameter1"] = 0,
["parameter2"] = portraitIcon,
["timing"] = EEex_ReadDword(effectData + 0x20),
["duration"] = EEex_ReadDword(effectData + 0x24),
["resource"] = EEex_ReadLString(effectData + 0x2C, 8),
["dicenumber"] = EEex_ReadDword(effectData + 0x34),
["dicesize"] = EEex_ReadDword(effectData + 0x38),
["savingthrow"] = EEex_ReadDword(effectData + 0x3C),
["savebonus"] = EEex_ReadDword(effectData + 0x40),
["school"] = EEex_ReadDword(effectData + 0x48),
["resist_dispel"] = EEex_ReadDword(effectData + 0x58),
["parameter3"] = 14432,
["parameter4"] = EEex_ReadDword(effectData + 0x60),
["parameter5"] = EEex_ReadDword(effectData + 0x64),
["vvcresource"] = EEex_ReadLString(effectData + 0x6C, 8),
["resource2"] = EEex_ReadLString(effectData + 0x74, 8),
["source_x"] = EEex_ReadDword(effectData + 0x7C),
["source_y"] = EEex_ReadDword(effectData + 0x80),
["target_x"] = EEex_ReadDword(effectData + 0x84),
["target_y"] = EEex_ReadDword(effectData + 0x88),
["restype"] = EEex_ReadDword(effectData + 0x8C),
["parent_resource"] = EEex_ReadLString(effectData + 0x90, 8),
["resource_flags"] = EEex_ReadDword(effectData + 0x98),
["impact_projectile"] = EEex_ReadDword(effectData + 0x9C),
["sourceslot"] = EEex_ReadDword(effectData + 0xA0),
["effvar"] = EEex_ReadLString(effectData + 0xA4, 32),
["casterlvl"] = EEex_ReadDword(effectData + 0xC4),
["internal_flags"] = bit32.bor(internal_flags, 0x2000000),
["sectype"] = EEex_ReadDword(effectData + 0xCC),
["source_target"] = targetID,
["source_id"] = sourceID
})
		if charmStrref > 0 then
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 139,
["target"] = EEex_ReadDword(effectData + 0x10),
["power"] = EEex_ReadDword(effectData + 0x14),
["parameter1"] = charmStrref,
["parameter2"] = 0,
["timing"] = EEex_ReadDword(effectData + 0x20),
["duration"] = EEex_ReadDword(effectData + 0x24),
["resource"] = EEex_ReadLString(effectData + 0x2C, 8),
["dicenumber"] = EEex_ReadDword(effectData + 0x34),
["dicesize"] = EEex_ReadDword(effectData + 0x38),
["savingthrow"] = EEex_ReadDword(effectData + 0x3C),
["savebonus"] = EEex_ReadDword(effectData + 0x40),
["school"] = EEex_ReadDword(effectData + 0x48),
["resist_dispel"] = EEex_ReadDword(effectData + 0x58),
["parameter3"] = 14432,
["parameter4"] = EEex_ReadDword(effectData + 0x60),
["parameter5"] = EEex_ReadDword(effectData + 0x64),
["vvcresource"] = EEex_ReadLString(effectData + 0x6C, 8),
["resource2"] = EEex_ReadLString(effectData + 0x74, 8),
["source_x"] = EEex_ReadDword(effectData + 0x7C),
["source_y"] = EEex_ReadDword(effectData + 0x80),
["target_x"] = EEex_ReadDword(effectData + 0x84),
["target_y"] = EEex_ReadDword(effectData + 0x88),
["restype"] = EEex_ReadDword(effectData + 0x8C),
["parent_resource"] = EEex_ReadLString(effectData + 0x90, 8),
["resource_flags"] = EEex_ReadDword(effectData + 0x98),
["impact_projectile"] = EEex_ReadDword(effectData + 0x9C),
["sourceslot"] = EEex_ReadDword(effectData + 0xA0),
["effvar"] = EEex_ReadLString(effectData + 0xA4, 32),
["casterlvl"] = EEex_ReadDword(effectData + 0xC4),
["internal_flags"] = bit32.bor(internal_flags, 0x2000000),
["sectype"] = EEex_ReadDword(effectData + 0xCC),
["source_target"] = targetID,
["source_id"] = sourceID
})
		end
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 400,
["target"] = EEex_ReadDword(effectData + 0x10),
["power"] = EEex_ReadDword(effectData + 0x14),
["parameter1"] = 0,
["parameter2"] = 0,
["timing"] = EEex_ReadDword(effectData + 0x20),
["duration"] = EEex_ReadDword(effectData + 0x24),
["resource"] = "MECLONEE",
["dicenumber"] = EEex_ReadDword(effectData + 0x34),
["dicesize"] = EEex_ReadDword(effectData + 0x38),
["savingthrow"] = EEex_ReadDword(effectData + 0x3C),
["savebonus"] = EEex_ReadDword(effectData + 0x40),
["school"] = EEex_ReadDword(effectData + 0x48),
["resist_dispel"] = EEex_ReadDword(effectData + 0x58),
["parameter3"] = 14432,
["parameter4"] = EEex_ReadDword(effectData + 0x60),
["parameter5"] = EEex_ReadDword(effectData + 0x64),
["vvcresource"] = EEex_ReadLString(effectData + 0x6C, 8),
["resource2"] = EEex_ReadLString(effectData + 0x74, 8),
["source_x"] = EEex_ReadDword(effectData + 0x7C),
["source_y"] = EEex_ReadDword(effectData + 0x80),
["target_x"] = EEex_ReadDword(effectData + 0x84),
["target_y"] = EEex_ReadDword(effectData + 0x88),
["restype"] = EEex_ReadDword(effectData + 0x8C),
["parent_resource"] = EEex_ReadLString(effectData + 0x90, 8),
["resource_flags"] = EEex_ReadDword(effectData + 0x98),
["impact_projectile"] = EEex_ReadDword(effectData + 0x9C),
["sourceslot"] = EEex_ReadDword(effectData + 0xA0),
["effvar"] = EEex_ReadLString(effectData + 0xA4, 32),
["casterlvl"] = EEex_ReadDword(effectData + 0xC4),
["internal_flags"] = bit32.bor(internal_flags, 0x2000000),
["sectype"] = EEex_ReadDword(effectData + 0xCC),
["source_target"] = targetID,
["source_id"] = sourceID
})
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 101,
["target"] = EEex_ReadDword(effectData + 0x10),
["power"] = EEex_ReadDword(effectData + 0x14),
["parameter1"] = 0,
["parameter2"] = 400,
["timing"] = EEex_ReadDword(effectData + 0x20),
["duration"] = EEex_ReadDword(effectData + 0x24),
["resource"] = EEex_ReadLString(effectData + 0x2C, 8),
["dicenumber"] = EEex_ReadDword(effectData + 0x34),
["dicesize"] = EEex_ReadDword(effectData + 0x38),
["savingthrow"] = EEex_ReadDword(effectData + 0x3C),
["savebonus"] = EEex_ReadDword(effectData + 0x40),
["school"] = EEex_ReadDword(effectData + 0x48),
["resist_dispel"] = EEex_ReadDword(effectData + 0x58),
["parameter3"] = 14432,
["parameter4"] = EEex_ReadDword(effectData + 0x60),
["parameter5"] = EEex_ReadDword(effectData + 0x64),
["vvcresource"] = EEex_ReadLString(effectData + 0x6C, 8),
["resource2"] = EEex_ReadLString(effectData + 0x74, 8),
["source_x"] = EEex_ReadDword(effectData + 0x7C),
["source_y"] = EEex_ReadDword(effectData + 0x80),
["target_x"] = EEex_ReadDword(effectData + 0x84),
["target_y"] = EEex_ReadDword(effectData + 0x88),
["restype"] = EEex_ReadDword(effectData + 0x8C),
["parent_resource"] = EEex_ReadLString(effectData + 0x90, 8),
["resource_flags"] = EEex_ReadDword(effectData + 0x98),
["impact_projectile"] = EEex_ReadDword(effectData + 0x9C),
["sourceslot"] = EEex_ReadDword(effectData + 0xA0),
["effvar"] = EEex_ReadLString(effectData + 0xA4, 32),
["casterlvl"] = EEex_ReadDword(effectData + 0xC4),
["internal_flags"] = bit32.bor(internal_flags, 0x2000000),
["sectype"] = EEex_ReadDword(effectData + 0xCC),
["source_target"] = targetID,
["source_id"] = sourceID
})
		return true
	end
	return false
end)

function MEPRINTE(originatingEffectData, effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local opcode = EEex_ReadDword(effectData + 0xC)
	Infinity_DisplayString("Opcode " .. opcode .. " on " .. EEex_GetActorName(targetID))
	if opcode == 20 then
		Infinity_DisplayString("power: " .. EEex_ReadDword(effectData + 0x14))
		Infinity_DisplayString("target: " .. EEex_ReadDword(effectData + 0x10))
		Infinity_DisplayString("parameter1: " .. EEex_ReadDword(effectData + 0x18))
		Infinity_DisplayString("parameter2: " .. EEex_ReadDword(effectData + 0x1C))
		Infinity_DisplayString("parameter3: " .. EEex_ReadDword(effectData + 0x5C))
		Infinity_DisplayString("parameter4: " .. EEex_ReadDword(effectData + 0x60))
		Infinity_DisplayString("timing: " .. EEex_ReadDword(effectData + 0x20))
		Infinity_DisplayString("duration: " .. EEex_ReadDword(effectData + 0x24))
		Infinity_DisplayString("time_applied: " .. EEex_ReadDword(effectData + 0x68))
		Infinity_DisplayString("probability1: " .. EEex_ReadWord(effectData + 0x28, 0x0))
		Infinity_DisplayString("probability2: " .. EEex_ReadWord(effectData + 0x2A, 0x0))
		Infinity_DisplayString("savingthrow: " .. EEex_ReadDword(effectData + 0x3C))
		Infinity_DisplayString("special: " .. EEex_ReadDword(effectData + 0x44))
		Infinity_DisplayString("school: " .. EEex_ReadDword(effectData + 0x48))
		Infinity_DisplayString("resist_dispel: " .. EEex_ReadDword(effectData + 0x58))
		Infinity_DisplayString("used_internally: " .. EEex_ReadDword(effectData + 0x4C))
		Infinity_DisplayString("resource: " .. EEex_ReadLString(effectData + 0x2C, 8))
		Infinity_DisplayString("resource2: " .. EEex_ReadLString(effectData + 0x6C, 8))
		Infinity_DisplayString("resource3: " .. EEex_ReadLString(effectData + 0x74, 8))
		Infinity_DisplayString("restype: " .. EEex_ReadDword(effectData + 0x8C))
		Infinity_DisplayString("parent_resource: " .. EEex_ReadLString(effectData + 0x90, 8))
		Infinity_DisplayString("resource_flags: " .. EEex_ReadDword(effectData + 0x98))
		Infinity_DisplayString("sourceslot: " .. EEex_ReadDword(effectData + 0xA0))
		Infinity_DisplayString("internal_flags: " .. EEex_ReadDword(effectData + 0xC8))
		Infinity_DisplayString("sectype: " .. EEex_ReadDword(effectData + 0xCC))
		Infinity_DisplayString("casterlvl: " .. EEex_ReadDword(effectData + 0xC4))
--		EEex_WriteDword(effectData + 0x1C, 131072)
	end
end

me_const_id_sync = 0

me_actor_id_const = {}
function MECNSTID(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if EEex_GetActorStat(targetID, 645) == 0 then
		if me_const_id_sync == 0 then
			me_const_id_sync = 1

			local thisID = -2
			for i = 0, 5, 1 do
				if EEex_GetActorIDPortrait(i) > 0 then
					local actorShare = EEex_GetActorShare(EEex_GetActorIDPortrait(i))
					local possibleCount = EEex_ReadDword(actorShare + 0x614) + 2
					EEex_WriteDword(actorShare + 0x614, possibleCount)
					if possibleCount > thisID then
						thisID = possibleCount
					end
				end
			end

--[[
			local thisID = EEex_GetGlobal("MECNSTID") + 1
			EEex_SetGlobal("MECNSTID", thisID)
--]]
			me_const_id_sync = 0
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 401,
["target"] = 2,
["timing"] = 9,
["parameter1"] = thisID,
["parameter2"] = 1,
["special"] = 645,
["source_target"] = targetID,
["source_id"] = targetID
})
--			if thisID > 0 then
--				me_actor_id_const[thisID] = targetID
--			end
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 403,
["target"] = 2,
["timing"] = 9,
["resource"] = "MECIDSET",
["source_target"] = targetID,
["source_id"] = targetID
})

			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 402,
["target"] = 2,
["timing"] = 9,
["resource"] = "MECIDTAB",
["source_target"] = targetID,
["source_id"] = 0
})

		else
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 402,
["target"] = 2,
["timing"] = 3,
["resource"] = "MECNSTID",
["source_target"] = targetID,
["source_id"] = targetID
})

		end
--	else
--		me_actor_id_const[EEex_GetActorStat(targetID, 645)] = targetID
	end
end

function MECIDTAB(effectData, creatureData)

	local sourceID = EEex_ReadDword(effectData + 0x10C)

	if (sourceID == 0 or sourceID == -1) then
		local targetID = EEex_ReadDword(creatureData + 0x34)
		if EEex_GetActorIDPortrait(0) == targetID or EEex_GetActorIDPortrait(0) == -1 then
--			Infinity_DisplayString("reset")
			me_actor_id_const = {}
		end
		EEex_AlterActorEffect(targetID,{{"opcode",402},{"resource","MECIDTAB"}}, {{"source_id",targetID}},1)
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["resource"] = "MECIDTA2",
["source_target"] = targetID,
["source_id"] = targetID
})
--[[
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 402,
["target"] = 2,
["timing"] = 0,
["duration"] = 0,
["resource"] = "MECIDTA2",
["source_target"] = targetID,
["source_id"] = targetID
})
--]]
	end

end

function MECIDTA2(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local constantID = EEex_GetActorStat(targetID, 645)
--	Infinity_DisplayString(constantID)
	if constantID ~= 0 then
		me_actor_id_const[constantID] = targetID

		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["resource"] = "MECIDTA3",
["source_target"] = targetID,
["source_id"] = targetID
})
	end
end

function MECIDTA3(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
--	Infinity_DisplayString(targetID)
	if not EEex_IsSprite(targetID) then return end
	EEex_IterateActorEffects(targetID, function(eData)

		local the_parameter5 = EEex_ReadDword(eData + 0x68)

		if me_actor_id_const[the_parameter5] ~= nil then
--			if EEex_IsSprite(me_actor_id_const[the_parameter5]) then
			EEex_WriteDword(eData + 0x110, me_actor_id_const[the_parameter5])
--			end
		end

	end)

end

function MEACTSPL(effectData, creatureData)

	local sourceID = EEex_ReadDword(creatureData + 0x34)
	local action = EEex_ReadWord(effectData + 0x44, 0x0)
	if action ~= EEex_ReadWord(creatureData + 0x2F8, 0x0) then return end
	local targetID = EEex_ReadDword(creatureData + 0x318)
	local spellRes = EEex_ReadLString(effectData + 0x18, 8)
	local casterlvl = EEex_ReadDword(effectData + 0xC4)
	if casterlvl < 1 then
		casterlvl = EEex_GetActorStat(sourceID, 34)
	end
	local sourceX = EEex_ReadDword(creatureData + 0x8)
	local sourceY = EEex_ReadDword(creatureData + 0xC)
	local range = bit32.band(EEex_ReadWord(effectData + 0x46, 0x0), 0x7FFF)
	local invertRangeCheck = (bit32.band(EEex_ReadWord(effectData + 0x46, 0x0), 0x8000) == 0)
	if targetID > 0 then
		local targetX = EEex_ReadDword(EEex_GetActorShare(targetID) + 0x8)
		local targetY = EEex_ReadDword(EEex_GetActorShare(targetID) + 0xC)
		if invertRangeCheck then
			if EEex_GetDistance(sourceX, sourceY, targetX, targetY) < range then return end
		else
			if EEex_GetDistance(sourceX, sourceY, targetX, targetY) >= range then return end
		end
--		EEex_WriteDword(effectData + 0x110, 0x1)
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["parameter1"] = casterlvl,
["parameter2"] = 2,
["resource"] = spellRes,
["source_target"] = targetID,
["source_id"] = sourceID,
["source_x"] = sourceX,
["source_y"] = sourceY,
["target_x"] = targetX,
["target_y"] = targetY
})
--		EEex_WriteDword(effectData + 0x110, 0x0)
	else
		local targetX = EEex_ReadDword(creatureData + 0x34C)
		local targetY = EEex_ReadDword(creatureData + 0x350)
		if invertRangeCheck then
			if EEex_GetDistance(sourceX, sourceY, targetX, targetY) < range then return end
		else
			if EEex_GetDistance(sourceX, sourceY, targetX, targetY) >= range then return end
		end
--		EEex_WriteDword(effectData + 0x110, 0x1)
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 148,
["target"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["parameter1"] = casterlvl,
["parameter2"] = 2,
["resource"] = spellRes,
["source_target"] = sourceID,
["source_id"] = sourceID,
["source_x"] = sourceX,
["source_y"] = sourceY,
["target_x"] = targetX,
["target_y"] = targetY
})
--		EEex_WriteDword(effectData + 0x110, 0x0)
	end

end

function MEEXCHSP(effectData, creatureData)
	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if not EEex_IsSprite(targetID) or not EEex_IsSprite(sourceID) then return false end
	local spellRes = EEex_ReadLString(effectData + 0x18, 8)
	local flags = EEex_ReadByte(effectData + 0x47, 0x0)
	if bit32.band(flags, 0x1) == 1 then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 1,
["parameter1"] = 1,
["parameter2"] = 2,
["resource"] = spellRes,
["internal_flags"] = 0x4000001,
["source_target"] = targetID,
["source_id"] = sourceID
})
	end
	if bit32.band(flags, 0x2) == 2 then
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 1,
["parameter1"] = 1,
["parameter2"] = 2,
["resource"] = spellRes,
["internal_flags"] = 0x4000001,
["source_target"] = sourceID,
["source_id"] = targetID
})
	end
end

function MELINKST(effectData, creatureData)
	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if not EEex_IsSprite(targetID) or not EEex_IsSprite(sourceID) then return false end
	local spellRes = EEex_ReadLString(effectData + 0x18, 8)
	local duration = EEex_ReadWord(effectData + 0x44, 0x0)
	local timing = 0
	if duration == 0 then
		timing = 9
	end
	local flags = EEex_ReadByte(effectData + 0x47, 0x0)
	if bit32.band(flags, 0x1) == 1 then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 1,
["resource"] = spellRes,
["internal_flags"] = 0x4000001,
["source_target"] = targetID,
["source_id"] = sourceID
})
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 403,
["target"] = 2,
["timing"] = timing,
["duration"] = duration,
["resource"] = spellRes,
["internal_flags"] = 0x4000001,
["parent_resource"] = spellRes,
["source_target"] = targetID,
["source_id"] = sourceID
})
	end
	if bit32.band(flags, 0x2) == 2 then
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 1,
["resource"] = spellRes,
["internal_flags"] = 0x4000001,
["source_target"] = sourceID,
["source_id"] = targetID
})
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 403,
["target"] = 2,
["timing"] = timing,
["duration"] = duration,
["resource"] = spellRes,
["internal_flags"] = 0x4000001,
["parent_resource"] = spellRes,
["source_target"] = sourceID,
["source_id"] = targetID
})
	end
end

function MELINKSO(effectData, creatureData)
	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if not EEex_IsSprite(targetID) or not EEex_IsSprite(sourceID) then return false end
	local spellRes = EEex_ReadLString(effectData + 0x18, 8)
	local parent_resource = EEex_ReadLString(effectData + 0x90, 8)
	local duration = EEex_ReadDword(effectData + 0x44)
	local timing = 0
	if duration == 0 then
		timing = 9
	end
	local constantID = math.random(0x7FFFFFFF)
--[[
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 1,
["resource"] = spellRes,
["internal_flags"] = 0x4000001,
["source_target"] = targetID,
["source_id"] = sourceID
})
--]]
	EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 401,
["target"] = 2,
["timing"] = timing,
["duration"] = duration,
["parameter1"] = constantID,
["parameter2"] = 1,
["resource"] = spellRes,
["internal_flags"] = 0x4000001,
["special"] = 660,
["parent_resource"] = parent_resource,
["source_target"] = sourceID,
["source_id"] = sourceID
})
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 402,
["target"] = 2,
["timing"] = timing,
["duration"] = duration,
["resource"] = "MELINKS2",
["resource2"] = spellRes,
["internal_flags"] = 0x4000001,
["special"] = constantID,
["parent_resource"] = parent_resource,
["source_target"] = targetID,
["source_id"] = sourceID
})
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 403,
["target"] = 2,
["timing"] = timing,
["duration"] = duration,
["resource"] = spellRes,
["internal_flags"] = 0x4000001,
["special"] = constantID,
["parent_resource"] = parent_resource,
["source_target"] = targetID,
["source_id"] = sourceID
})
end

function MELINKS2(effectData, creatureData)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if (sourceID == 0 or sourceID == -1) then
		local targetID = EEex_ReadDword(creatureData + 0x34)
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["resource"] = "MELINKS3",
["internal_flags"] = 0x4000001,
["source_target"] = targetID,
["source_id"] = targetID
})
	end
end

function MELINKS3(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if EEex_GetActorStat(targetID, 660) == 0 then return end
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	EEex_IterateActorEffects(targetID, function(eData)
		local the_opcode = EEex_ReadDword(eData + 0x10)
		local the_parameter1 = EEex_ReadDword(eData + 0x1C)
		local the_special = EEex_ReadDword(eData + 0x48)
		local the_parent_resource = EEex_ReadLString(eData + 0x94, 8)
		if the_opcode == 401 and the_special == 660 then
			EEex_IterateActorEffects(sourceID, function(eDataA)
				local the_opcodeA = EEex_ReadDword(eDataA + 0x10)
				local the_specialA = EEex_ReadDword(eDataA + 0x48)
				local the_sourceIDA = EEex_ReadDword(eDataA + 0x110)
				if the_opcodeA == 403 and the_specialA == the_parameter1 and the_sourceIDA <= 0 then
					EEex_WriteDword(eDataA + 0x110, targetID)
				end
			end)
		end
	end)
end

me_permanent_linkable_opcodes = {
[2] = 1, [3] = 1, [4] = 1, [7] = 1, [8] = 1, [9] = 1, [11] = 1, [12] = 1, [13] = 1, [14] = 1, [17] = 1, [18] = 1, [20] = 1, [23] = 1, [24] = 1, [25] = 1, [26] = 1, [32] = 1,
[41] = 1, [43] = 1, [46] = 1, [47] = 1, [48] = 1, [50] = 1, [51] = 1, [52] = 1, [55] = 1, [58] = 1, [61] = 1, [64] = 1,
[66] = 1, [70] = 1, [72] = 1, [75] = 1, [77] = 1, [79] = 1, [81] = 1, [82] = 1, [93] = 1, [94] = 1, [112] = 1, [115] = 1, [116] = 1, [117] = 1, [119] = 1, [124] = 1, [125] = 1,
[134] = 1, [135] = 1, [136] = 1, [138] = 1, [139] = 1, [141] = 1, [146] = 1, [148] = 1, [150] = 1, [151] = 1, [159] = 1, [160] = 1, [161] = 1, [162] = 1, [163] = 1, [164] = 1, [165] = 1,
[170] = 1, [174] = 1, [177] = 1, [209] = 1, [210] = 1, [211] = 1, [212] = 1, [213] = 1, [215] = 1, [216] = 1, [217] = 1, [218] = 1, [220] = 1, [221] = 1, [222] = 1, [224] = 1, [225] = 1, [229] = 1,
[236] = 1, [237] = 1, [238] = 1, [239] = 1, [240] = 1, [242] = 1, [243] = 1, [244] = 1, [255] = 1, [261] = 1, [264] = 1, [266] = 1, [269] = 1, [270] = 1, [271] = 1, [273] = 1, [274] = 1, [279] = 1,
[283] = 1, [304] = 1, [307] = 1, [311] = 1, [316] = 1, [321] = 1, [326] = 1, [327] = 1, [329] = 1, [330] = 1, [334] = 1, [337] = 1, [343] = 1
}
me_unlinkable_opcodes = {
[67] = 1, [68] = 1, [96] = 1, [103] = 1, [104] = 1, [107] = 1, [108] = 1, [127] = 1, [140] = 1, [147] = 1, [152] = 1, [168] = 1, [171] = 1, [172] = 1, [187] = 1, [192] = 1, [195] = 1, [196] = 1,
[214] = 1, [231] = 1, [234] = 1, [251] = 1, [252] = 1, [253] = 1, [254] = 1, [257] = 1, [265] = 1, [290] = 1, [298] = 1, [309] = 1, [313] = 1, [314] = 1, [315] = 1, [319] = 1, [320] = 1, [331] = 1,
[338] = 1, [339] = 1
}
function MELINKEF(originatingEffectData, effectData, creatureData)
	local internal_flags = EEex_ReadDword(effectData + 0xC8)
	if bit32.band(internal_flags, 0x4000000) == 0 then
		local targetID = EEex_ReadDword(creatureData + 0x34)
		local sourceID = EEex_ReadDword(effectData + 0x10C)
		local linkID = -1
		EEex_IterateActorEffects(targetID, function(eData)
			local the_opcode = EEex_ReadDword(eData + 0x10)
			local the_resource = EEex_ReadLString(eData + 0x30, 8)
			if the_opcode == 403 and the_resource == "MELINKEF" then
				linkID = EEex_ReadDword(eData + 0x110)
			end
		end)
		if not EEex_IsSprite(targetID) or not EEex_IsSprite(sourceID) or not EEex_IsSprite(linkID) then return false end
		local opcode = EEex_ReadDword(effectData + 0xC)
		local timing = EEex_ReadDword(effectData + 0x20)
		local resist_dispel = EEex_ReadDword(effectData + 0x58)
		if resist_dispel ~= 1 and resist_dispel ~= 3 then return false end
		if timing == 2 or timing == 5 or timing == 8 then return false end
		if me_unlinkable_opcodes[opcode] ~= nil then return false end
--		if (timing == 1 or timing == 4 or timing == 7 or timing == 9) and me_permanent_linkable_opcodes[opcode] == nil then return false end
		EEex_ApplyEffectToActor(linkID, {
["opcode"] = EEex_ReadDword(effectData + 0xC),
["target"] = EEex_ReadDword(effectData + 0x10),
["power"] = EEex_ReadDword(effectData + 0x14),
["parameter1"] = EEex_ReadDword(effectData + 0x18),
["parameter2"] = EEex_ReadDword(effectData + 0x1C),
["timing"] = EEex_ReadDword(effectData + 0x20),
["duration"] = EEex_ReadDword(effectData + 0x24),
["resource"] = EEex_ReadLString(effectData + 0x2C, 8),
["dicenumber"] = EEex_ReadDword(effectData + 0x34),
["dicesize"] = EEex_ReadDword(effectData + 0x38),
["savingthrow"] = EEex_ReadDword(effectData + 0x3C),
["savebonus"] = EEex_ReadDword(effectData + 0x40),
["special"] = EEex_ReadDword(effectData + 0x44),
["school"] = EEex_ReadDword(effectData + 0x48),
["resist_dispel"] = EEex_ReadDword(effectData + 0x58),
["parameter3"] = EEex_ReadDword(effectData + 0x5C),
["parameter4"] = EEex_ReadDword(effectData + 0x60),
["parameter5"] = EEex_ReadDword(effectData + 0x64),
["vvcresource"] = EEex_ReadLString(effectData + 0x6C, 8),
["resource2"] = EEex_ReadLString(effectData + 0x74, 8),
["source_x"] = EEex_ReadDword(effectData + 0x7C),
["source_y"] = EEex_ReadDword(effectData + 0x80),
["target_x"] = EEex_ReadDword(EEex_GetActorShare(linkID) + 0x8),
["target_y"] = EEex_ReadDword(EEex_GetActorShare(linkID) + 0xC),
["restype"] = EEex_ReadDword(effectData + 0x8C),
["parent_resource"] = EEex_ReadLString(effectData + 0x90, 8),
["resource_flags"] = EEex_ReadDword(effectData + 0x98),
["impact_projectile"] = EEex_ReadDword(effectData + 0x9C),
["sourceslot"] = EEex_ReadDword(effectData + 0xA0),
["effvar"] = EEex_ReadLString(effectData + 0xA4, 32),
["casterlvl"] = EEex_ReadDword(effectData + 0xC4),
["internal_flags"] = bit32.bor(internal_flags, 0x4000000),
["sectype"] = EEex_ReadDword(effectData + 0xCC),
["source_target"] = linkID,
["source_id"] = sourceID
})

		return false
	end
end

function MELINKVO(originatingEffectData, effectData, creatureData)
	local internal_flags = EEex_ReadDword(effectData + 0xC8)
	if bit32.band(internal_flags, 0x4000000) == 0 then
		local targetID = EEex_ReadDword(creatureData + 0x34)
		local sourceID = EEex_ReadDword(effectData + 0x10C)
		local linkID = -1
		EEex_IterateActorEffects(targetID, function(eData)
			local the_opcode = EEex_ReadDword(eData + 0x10)
			local the_resource = EEex_ReadLString(eData + 0x30, 8)
			if the_opcode == 403 and the_resource == "MELINKVO" then
				linkID = EEex_ReadDword(eData + 0x110)
			end
		end)
		if not EEex_IsSprite(targetID) or not EEex_IsSprite(linkID) then return false end
		local opcode = EEex_ReadDword(effectData + 0xC)
		local timing = EEex_ReadDword(effectData + 0x20)
		local resist_dispel = EEex_ReadDword(effectData + 0x58)
		local damage = EEex_ReadDword(effectData + 0x18)
		local damage_method = EEex_ReadWord(effectData + 0x1C, 0x0)
		local dicenumber = EEex_ReadDword(effectData + 0x34)
		local dicesize = EEex_ReadDword(effectData + 0x38)
		if (opcode == 12 or opcode == 17) and damage_method == 0 then
			for i = 1, dicenumber, 1 do
				damage = damage + math.random(dicesize)
			end
			dicenumber = 0
			dicesize = 0
		end
		if sourceID <= 0 and opcode ~= 12 then return false end
		if timing == 2 or timing == 5 or timing == 8 then return false end
		if me_unlinkable_opcodes[opcode] ~= nil then return false end
--		if (timing == 1 or timing == 4 or timing == 7 or timing == 9) and me_permanent_linkable_opcodes[opcode] == nil then return false end
		EEex_ApplyEffectToActor(linkID, {
["opcode"] = EEex_ReadDword(effectData + 0xC),
["target"] = EEex_ReadDword(effectData + 0x10),
["power"] = EEex_ReadDword(effectData + 0x14),
["parameter1"] = damage,
["parameter2"] = EEex_ReadDword(effectData + 0x1C),
["timing"] = EEex_ReadDword(effectData + 0x20),
["duration"] = EEex_ReadDword(effectData + 0x24),
["resource"] = EEex_ReadLString(effectData + 0x2C, 8),
["dicenumber"] = dicenumber,
["dicesize"] = dicesize,
["savingthrow"] = EEex_ReadDword(effectData + 0x3C),
["savebonus"] = EEex_ReadDword(effectData + 0x40),
["special"] = EEex_ReadDword(effectData + 0x44),
["school"] = EEex_ReadDword(effectData + 0x48),
["resist_dispel"] = EEex_ReadDword(effectData + 0x58),
["parameter3"] = EEex_ReadDword(effectData + 0x5C),
["parameter4"] = EEex_ReadDword(effectData + 0x60),
["parameter5"] = EEex_ReadDword(effectData + 0x64),
["vvcresource"] = EEex_ReadLString(effectData + 0x6C, 8),
["resource2"] = EEex_ReadLString(effectData + 0x74, 8),
["source_x"] = EEex_ReadDword(effectData + 0x7C),
["source_y"] = EEex_ReadDword(effectData + 0x80),
["target_x"] = EEex_ReadDword(EEex_GetActorShare(linkID) + 0x8),
["target_y"] = EEex_ReadDword(EEex_GetActorShare(linkID) + 0xC),
["restype"] = EEex_ReadDword(effectData + 0x8C),
["parent_resource"] = EEex_ReadLString(effectData + 0x90, 8),
["resource_flags"] = EEex_ReadDword(effectData + 0x98),
["impact_projectile"] = EEex_ReadDword(effectData + 0x9C),
["sourceslot"] = EEex_ReadDword(effectData + 0xA0),
["effvar"] = EEex_ReadLString(effectData + 0xA4, 32),
["casterlvl"] = EEex_ReadDword(effectData + 0xC4),
["internal_flags"] = bit32.bor(internal_flags, 0x4000000),
["sectype"] = EEex_ReadDword(effectData + 0xCC),
["source_target"] = linkID,
["source_id"] = sourceID
})

		return false
	end
end

function MEVOODRE(effectData, creatureData)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local isMyCopy = false
	if EEex_IsSprite(targetID, false) then
		EEex_IterateActorEffects(targetID, function(eData)
			local the_opcode = EEex_ReadDword(eData + 0x10)
			local the_resource = EEex_ReadLString(eData + 0x30, 8)
			local the_sourceID = EEex_ReadDword(eData + 0x110)
			if the_opcode == 403 and the_resource == "MELINKVO" and the_sourceID == sourceID then
				isMyCopy = true
			end
		end)
	end
	if isMyCopy then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 168,
["target"] = 2,
["timing"] = 9,
["internal_flags"] = 0x4000000,
["source_target"] = targetID,
["source_id"] = targetID
})
	end
end

function MELINKVA(originatingEffectData, effectData, creatureData)
	local opcode = EEex_ReadDword(effectData + 0xC)
	if opcode ~= 12 then return false end
	local internal_flags = EEex_ReadDword(effectData + 0xC8)
	if bit32.band(internal_flags, 0x4000000) == 0 then
		local targetID = EEex_ReadDword(creatureData + 0x34)
		local sourceID = EEex_ReadDword(effectData + 0x10C)
		local linkConstantID = -1
		local linkID = -1
		EEex_IterateActorEffects(targetID, function(eData)
			local the_opcode = EEex_ReadDword(eData + 0x10)
			local the_resource = EEex_ReadLString(eData + 0x30, 8)
			if the_opcode == 403 and the_resource == "MELINKVA" then
				linkConstantID = EEex_ReadDword(eData + 0x64)
				linkID = EEex_ReadDword(eData + 0x110)
			end
		end)
		if not EEex_IsSprite(targetID) or not EEex_IsSprite(sourceID) or not EEex_IsSprite(linkID) then return false end
		local targetCurrentHP = EEex_ReadWord(creatureData + 0x438, 0x0)
		local targetMaxHP = EEex_GetActorStat(targetID, 1)
		local damage = EEex_ReadDword(effectData + 0x18)
		local healing = damage
		local damage_method = EEex_ReadWord(effectData + 0x1C, 0x0)
		local damage_type = EEex_ReadWord(effectData + 0x1E, 0x0)
		local dicenumber = EEex_ReadDword(effectData + 0x34)
		local dicesize = EEex_ReadDword(effectData + 0x38)
		if damage_method == 0 then
			for i = 1, dicenumber, 1 do
				healing = healing + math.random(dicesize)
			end
			EEex_WriteDword(effectData + 0x18, healing)
			EEex_WriteDword(effectData + 0x34, 0)
			EEex_WriteDword(effectData + 0x38, 0)
--			local resistance = EEex_GetActorFullResistance(targetID, me_damage_resistance[damage_type][1])
			local resistance = EEex_GetActorStat(targetID, me_damage_resistance[damage_type][1])
			healing = healing - math.floor(healing * resistance / 100)
		end
		if damage_method == 1 then
			healing = targetCurrentHP - damage
		elseif damage_method == 2 then
			healing = targetCurrentHP - math.floor(targetMaxHP * damage / 100)
		elseif damage_method == 3 then
			healing = math.floor(targetMaxHP * damage / 100)
		end
		if healing <= 0 then return false end
--		if (timing == 1 or timing == 4 or timing == 7 or timing == 9) and me_permanent_linkable_opcodes[opcode] == nil then return false end
		EEex_ApplyEffectToActor(linkID, {
["opcode"] = 17,
["target"] = EEex_ReadDword(effectData + 0x10),
["power"] = EEex_ReadDword(effectData + 0x14),
["parameter1"] = healing,
["timing"] = EEex_ReadDword(effectData + 0x20),
["duration"] = EEex_ReadDword(effectData + 0x24),
["resource"] = EEex_ReadLString(effectData + 0x2C, 8),
["dicenumber"] = EEex_ReadDword(effectData + 0x34),
["dicesize"] = EEex_ReadDword(effectData + 0x38),
["savingthrow"] = EEex_ReadDword(effectData + 0x3C),
["savebonus"] = EEex_ReadDword(effectData + 0x40),
["special"] = EEex_ReadDword(effectData + 0x44),
["school"] = 7,
["parameter3"] = EEex_ReadDword(effectData + 0x5C),
["parameter4"] = EEex_ReadDword(effectData + 0x60),
["parameter5"] = linkConstantID,
["vvcresource"] = EEex_ReadLString(effectData + 0x6C, 8),
["resource2"] = EEex_ReadLString(effectData + 0x74, 8),
["source_x"] = EEex_ReadDword(effectData + 0x7C),
["source_y"] = EEex_ReadDword(effectData + 0x80),
["target_x"] = EEex_ReadDword(EEex_GetActorShare(linkID) + 0x8),
["target_y"] = EEex_ReadDword(EEex_GetActorShare(linkID) + 0xC),
["restype"] = EEex_ReadDword(effectData + 0x8C),
["parent_resource"] = EEex_ReadLString(effectData + 0x90, 8),
["resource_flags"] = bit32.band(EEex_ReadDword(effectData + 0x98), 0xFFFFF9FF),
["impact_projectile"] = EEex_ReadDword(effectData + 0x9C),
["sourceslot"] = EEex_ReadDword(effectData + 0xA0),
["effvar"] = EEex_ReadLString(effectData + 0xA4, 32),
["casterlvl"] = EEex_ReadDword(effectData + 0xC4),
["internal_flags"] = bit32.bor(internal_flags, 0x4000000),
["sectype"] = 13,
["source_target"] = linkID,
["source_id"] = targetID
})

		return false
	end
end

function MESELFSP(effectData, creatureData)
	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if not EEex_IsSprite(targetID) then return end
	local special = EEex_ReadDword(effectData + 0x44)
	if special <= 0 then
		special = 1
	end	
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = special,
["parameter2"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["resource"] = EEex_ReadLString(effectData + 0x18, 8),
["source_x"] = EEex_ReadDword(creatureData + 0x8),
["source_y"] = EEex_ReadDword(creatureData + 0xC),
["target_x"] = EEex_ReadDword(creatureData + 0x8),
["target_y"] = EEex_ReadDword(creatureData + 0xC),
["source_target"] = targetID,
["source_id"] = targetID
})
end

function MEREVRSP(effectData, creatureData)
	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if not EEex_IsSprite(targetID) or not EEex_IsSprite(sourceID) then return end
	local special = EEex_ReadDword(effectData + 0x44)
	if special <= 0 then
		special = 1
	end	
--	Infinity_DisplayString(EEex_GetActorScriptName(sourceID) .. " is being pulled to " .. EEex_GetActorScriptName(targetID))
	EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = special,
["parameter2"] = 2,
["timing"] = 9,
["resource"] = EEex_ReadLString(effectData + 0x18, 8),
["source_x"] = EEex_ReadDword(creatureData + 0x8),
["source_y"] = EEex_ReadDword(creatureData + 0xC),
["target_x"] = EEex_ReadDword(EEex_GetActorShare(sourceID) + 0x8),
["target_y"] = EEex_ReadDword(EEex_GetActorShare(sourceID) + 0xC),
["source_target"] = sourceID,
["source_id"] = targetID
})
end

function MEKNOCKB(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if not EEex_IsSprite(targetID) or not EEex_IsSprite(sourceID) then return end
	local sourceX = EEex_ReadDword(EEex_GetActorShare(sourceID) + 0x8)
	local sourceY = EEex_ReadDword(EEex_GetActorShare(sourceID) + 0xC)
	local targetX = EEex_ReadDword(creatureData + 0x8)
	local targetY = EEex_ReadDword(creatureData + 0xC)
	local parameter2 = EEex_ReadDword(effectData + 0x1C)
	local timing = EEex_ReadWord(effectData + 0x44, 0x0)
	local duration = EEex_ReadWord(effectData + 0x46, 0x0)
	local resist_dispel = EEex_ReadDword(effectData + 0x58)
	if resist_dispel == 1 then
		resist_dispel = 3
	end
	if parameter2 == 1 or parameter2 == 3 then
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 235,
["target"] = EEex_ReadDword(effectData + 0x10),
["power"] = EEex_ReadDword(effectData + 0x14),
["parameter1"] = EEex_ReadDword(effectData + 0x18),
["parameter2"] = parameter2 + 1,
["timing"] = timing,
["duration"] = duration,
["resource"] = EEex_ReadLString(effectData + 0x2C, 8),
["school"] = EEex_ReadDword(effectData + 0x48),
["resist_dispel"] = resist_dispel,
["parameter3"] = EEex_ReadDword(effectData + 0x5C),
["parameter4"] = EEex_ReadDword(effectData + 0x60),
["parameter5"] = EEex_ReadDword(effectData + 0x64),
["vvcresource"] = EEex_ReadLString(effectData + 0x6C, 8),
["resource2"] = EEex_ReadLString(effectData + 0x74, 8),
["source_x"] = targetX,
["source_y"] = targetY,
["target_x"] = sourceX,
["target_y"] = sourceY,
["restype"] = EEex_ReadDword(effectData + 0x8C),
["parent_resource"] = EEex_ReadLString(effectData + 0x90, 8),
["resource_flags"] = EEex_ReadDword(effectData + 0x98),
["impact_projectile"] = EEex_ReadDword(effectData + 0x9C),
["sourceslot"] = EEex_ReadDword(effectData + 0xA0),
["effvar"] = EEex_ReadLString(effectData + 0xA4, 32),
["casterlvl"] = EEex_ReadDword(effectData + 0xC4),
["internal_flags"] = EEex_ReadDword(effectData + 0xC8),
["sectype"] = EEex_ReadDword(effectData + 0xCC),
["source_target"] = sourceID,
["source_id"] = targetID
})
	elseif parameter2 == 2 or parameter2 == 4 then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 235,
["target"] = EEex_ReadDword(effectData + 0x10),
["power"] = EEex_ReadDword(effectData + 0x14),
["parameter1"] = EEex_ReadDword(effectData + 0x18),
["parameter2"] = parameter2 - 1,
["timing"] = timing,
["duration"] = duration,
["resource"] = EEex_ReadLString(effectData + 0x2C, 8),
["school"] = EEex_ReadDword(effectData + 0x48),
["resist_dispel"] = resist_dispel,
["parameter3"] = EEex_ReadDword(effectData + 0x5C),
["parameter4"] = EEex_ReadDword(effectData + 0x60),
["parameter5"] = EEex_ReadDword(effectData + 0x64),
["vvcresource"] = EEex_ReadLString(effectData + 0x6C, 8),
["resource2"] = EEex_ReadLString(effectData + 0x74, 8),
["source_x"] = targetX,
["source_y"] = targetY,
["target_x"] = sourceX,
["target_y"] = sourceY,
["restype"] = EEex_ReadDword(effectData + 0x8C),
["parent_resource"] = EEex_ReadLString(effectData + 0x90, 8),
["resource_flags"] = EEex_ReadDword(effectData + 0x98),
["impact_projectile"] = EEex_ReadDword(effectData + 0x9C),
["sourceslot"] = EEex_ReadDword(effectData + 0xA0),
["effvar"] = EEex_ReadLString(effectData + 0xA4, 32),
["casterlvl"] = EEex_ReadDword(effectData + 0xC4),
["internal_flags"] = EEex_ReadDword(effectData + 0xC8),
["sectype"] = EEex_ReadDword(effectData + 0xCC),
["source_target"] = targetID,
["source_id"] = sourceID
})
	end
end




function MEONCREA(effectData, creatureData)
	if true then return end
--[[
	local theEFF = EEex_DemandResData("ME314L02", "EFF")
	if theEFF > 0x100 then
		for i = 0, 0x100, 1 do
			Infinity_DisplayString(EEex_ToHex(i, 0, true) .. ": " .. EEex_ReadByte(theEFF + i, 0x0) .. ", " .. EEex_ReadWord(theEFF + i, 0x0) .. ", " .. EEex_ReadDword(theEFF + i) .. ", \"" .. EEex_ReadLString(theEFF + i, 8) .. "\"")
		end 
	end
--]]
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if (sourceID == 0 or sourceID == -1) then
		local targetID = EEex_ReadDword(creatureData + 0x34)
		me_ghost_walk_positions = {}
		me_ghost_walk_actors = {}
		EEex_AlterActorEffect(targetID,{{"opcode",402},{"resource","MEONCREA"}}, {{"source_id",targetID}},1)
--		Infinity_DisplayString("ugu")
	end
end

function MEOFFSCR(effectData, creatureData)

	local targetID = EEex_ReadDword(creatureData + 0x34)

	local x, y = EEex_GetActorLocation(targetID)
	if EEex_ReadDword(creatureData + 0x14) <= 0 then return end
	local areaX, areaY = EEex_GetActorAreaSize(targetID)
--	local creFlags = EEex_ReadDword(creatureData + 0x424)
	if x <= 33 or y <= 25 or (areaX - x) <= 33 or (areaY - y) <= 12 then
--		EEex_WriteDword(creatureData + 0x424, bit32.bor(creFlags, 0x800000))

--		EEex_WriteDword(effectData + 0x110, 0x1)
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 287,
["target"] = 2,
["timing"] = 10,
["duration"] = 17,
["parent_resource"] = "MEOFFSCR",
["source_target"] = targetID,
["source_id"] = targetID
})
--[[
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["resource"] = "MEOFFSCR",
["source_target"] = targetID,
["source_id"] = targetID
})
--]]
--		EEex_WriteDword(effectData + 0x110, 0x0)

	else
--		EEex_WriteDword(creatureData + 0x424, bit32.band(creFlags, bit32.bnot(0x800000)))
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 9,
["resource"] = "MEOFFSCR",
["source_target"] = targetID,
["source_id"] = targetID
})
	end

end

me_bird_linkable_opcodes = {
[2] = 1, [3] = 1, [4] = 1, [5] = 1, [7] = 1, [8] = 1, [9] = 1, [11] = 1, [13] = 1, [14] = 1, [16] = 1,
[20] = 1, [22] = 1, [26] = 1, [32] = 1, [39] = 1,[40] = 1, [43] = 1, [45] = 1, [46] = 1, [47] = 1, [48] = 1, [50] = 1, [51] = 1, [52] = 1, [53] = 1,
[55] = 1, [58] = 1, [61] = 1, [63] = 1, [64] = 1, [65] = 1, [66] = 1, [68] = 1, [69] = 1, [70] = 1, [74] = 1, [75] = 1, [76] = 1, [77] = 1, [78] = 1,
[79] = 1, [80] = 1, [81] = 1, [101] = 1, [102] = 1, [109] = 1, [112] = 1, [115] = 1, [116] = 1, [119] = 1, [124] = 1, [125] = 1, [126] = 1, [134] = 1,
[135] = 1, [136] = 1, [138] = 1, [159] = 1, [160] = 1, [161] = 1, [162] = 1, [163] = 1, [164] = 1, [165] = 1, [168] = 1,
[170] = 1, [175] = 1, [176] = 1, [177] = 1, [183] = 1, [185] = 1, [186] = 1, [209] = 1, [210] = 1, [211] = 1, [212] = 1, [213] = 1,
[216] = 1, [217] = 1, [218] = 1, [220] = 1, [221] = 1, [222] = 1, [224] = 1, [225] = 1, [229] = 1, [230] = 1, [231] = 1,
[236] = 1, [237] = 1, [238] = 1, [241] = 1, [242] = 1, [243] = 1, [244] = 1, [245] = 1, [246] = 1, [247] = 1, [261] = 1, [262] = 1, [266] = 1,
[270] = 1, [271] = 1, [273] = 1, [274] = 1, [279] = 1,
[283] = 1, [291] = 1, [293] = 1, [294] = 1, [295] = 1, [297] = 1, [310] = 1, [314] = 1, [315] = 1, [316] = 1, [317] = 1, [321] = 1, [334] = 1, [337] = 1, [342] = 1, [365] = 1
}

function MELINKBI(originatingEffectData, effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local linkID = -1
	EEex_IterateActorEffects(targetID, function(eData)
		local the_opcode = EEex_ReadDword(eData + 0x10)
		local the_resource = EEex_ReadLString(eData + 0x30, 8)
		if the_opcode == 403 and the_resource == "MELINKBI" then
			linkID = EEex_ReadDword(eData + 0x110)
		end
	end)
	if not EEex_IsSprite(targetID) or not EEex_IsSprite(sourceID) or not EEex_IsSprite(linkID) or sourceID == linkID then return false end
	local opcode = EEex_ReadDword(effectData + 0xC)
	local timing = EEex_ReadDword(effectData + 0x20)
	
	if timing == 2 or timing == 5 or timing == 8 then return false end
	if me_bird_linkable_opcodes[opcode] == nil then return false end
	local internal_flags = EEex_ReadDword(effectData + 0xC8)
	if bit32.band(internal_flags, 0x4000000) ~= 0 then return end
	local new_opcode = opcode
	local new_parameter1 = EEex_ReadDword(effectData + 0x18)
	local new_parameter2 = EEex_ReadDword(effectData + 0x1C)
	local old_animation = EEex_GetActorAnimation(linkID)
	if new_opcode == 13 and me_birdtodead["" .. old_animation] ~= nil then
		new_parameter1 = 1
		new_parameter2 = 512
				EEex_ApplyEffectToActor(linkID, {
["opcode"] = 53,
["target"] = 2,
["parameter1"] = me_birdtodead["" .. old_animation],
["parameter2"] = 2,
["timing"] = 9,
["source_target"] = linkID,
["source_id"] = linkID
})
		EEex_ApplyEffectToActor(linkID, {
["opcode"] = 53,
["target"] = 2,
["parameter1"] = EEex_GetActorAnimation(targetID),
["parameter2"] = 0,
["timing"] = 0,
["source_target"] = linkID,
["source_id"] = linkID
})
	end
	EEex_ApplyEffectToActor(linkID, {
["opcode"] = new_opcode,
["target"] = EEex_ReadDword(effectData + 0x10),
["power"] = EEex_ReadDword(effectData + 0x14),
["parameter1"] = new_parameter1,
["parameter2"] = new_parameter2,
["timing"] = EEex_ReadDword(effectData + 0x20),
["duration"] = EEex_ReadDword(effectData + 0x24),
["resource"] = EEex_ReadLString(effectData + 0x2C, 8),
["dicenumber"] = EEex_ReadDword(effectData + 0x34),
["dicesize"] = EEex_ReadDword(effectData + 0x38),
["savingthrow"] = EEex_ReadDword(effectData + 0x3C),
["savebonus"] = EEex_ReadDword(effectData + 0x40),
["special"] = EEex_ReadDword(effectData + 0x44),
["school"] = EEex_ReadDword(effectData + 0x48),
["resist_dispel"] = EEex_ReadDword(effectData + 0x58),
["parameter3"] = EEex_ReadDword(effectData + 0x5C),
["parameter4"] = EEex_ReadDword(effectData + 0x60),
["parameter5"] = EEex_ReadDword(effectData + 0x64),
["vvcresource"] = EEex_ReadLString(effectData + 0x6C, 8),
["resource2"] = EEex_ReadLString(effectData + 0x74, 8),
["source_x"] = EEex_ReadDword(effectData + 0x7C),
["source_y"] = EEex_ReadDword(effectData + 0x80),
["target_x"] = EEex_ReadDword(EEex_GetActorShare(linkID) + 0x8),
["target_y"] = EEex_ReadDword(EEex_GetActorShare(linkID) + 0xC),
["restype"] = EEex_ReadDword(effectData + 0x8C),
["parent_resource"] = EEex_ReadLString(effectData + 0x90, 8),
["resource_flags"] = EEex_ReadDword(effectData + 0x98),
["impact_projectile"] = EEex_ReadDword(effectData + 0x9C),
["sourceslot"] = EEex_ReadDword(effectData + 0xA0),
["effvar"] = EEex_ReadLString(effectData + 0xA4, 32),
["casterlvl"] = EEex_ReadDword(effectData + 0xC4),
["internal_flags"] = bit32.bor(internal_flags, 0x4000000),
["sectype"] = EEex_ReadDword(effectData + 0xCC),
["source_target"] = linkID,
["source_id"] = sourceID
})
	return false
end

function MEBIRDPU(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local birdName = EEex_GetActorScriptName(sourceID)
--	Infinity_DisplayString(birdName)
	if birdName == nil or birdName == "None" then return end
	local area = EEex_ReadDword(creatureData + 0x14)
	
	if area <= 0 then return end
--	Infinity_DisplayString(area)
--	Infinity_DisplayString(EEex_ReadLString(area, 8))

	EEex_IterateActorIDs(area, function(actorID)

		local the_actorName = EEex_GetActorScriptName(actorID)
--		Infinity_DisplayString(the_actorName)
		if the_actorName == birdName .. "CRE" then
			EEex_ApplyEffectToActor(actorID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 9,
["resource"] = "MEBIRDPU",
["source_x"] = EEex_ReadDword(EEex_GetActorShare(sourceID) + 0x8),
["source_y"] = EEex_ReadDword(EEex_GetActorShare(sourceID) + 0xC),
["target_x"] = EEex_ReadDword(EEex_GetActorShare(actorID) + 0x8),
["target_y"] = EEex_ReadDword(EEex_GetActorShare(actorID) + 0xC),
["source_target"] = actorID,
["source_id"] = sourceID
})

		end

	end)

--	EEex_EvalActionsStringAsActorResume("ApplySpellRES(\"MEBIRDPU\",\"" .. birdName .. "CRE\")", sourceID)
end

--[[
function MEBIRDPU(effectData, creatureData)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if (sourceID == 0 or sourceID == -1) then
		local targetID = EEex_ReadDword(creatureData + 0x34)
--		EEex_AlterActorEffect(targetID,{{"opcode",402},{"resource","MEBIRDPU"}}, {{"source_id",targetID}},1)
		local birdName = EEex_GetActorScriptName(targetID)
		Infinity_DisplayString(birdName)
		if birdName == nil or birdName == "None" then return end
		EEex_EvalActionsStringAsActorResume("ApplySpellRES(\"MEBIRDPU\",\"" .. birdName .. "CRE\")", targetID)
	end

end
--]]
--[[
function MEBIRDPU(effectData, creatureData)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if (sourceID == 0 or sourceID == -1) then
		local targetID = EEex_ReadDword(creatureData + 0x34)
--		EEex_AlterActorEffect(targetID,{{"opcode",402},{"resource","MEBIRDPU"}}, {{"source_id",targetID}},1)
		local birdCreatureName = EEex_GetActorScriptName(targetID)
		Infinity_DisplayString(birdCreatureName)
		if birdCreatureName == nil or birdCreatureName == "None" then return end
		Infinity_DisplayString(string.sub(birdCreatureName, 1, #birdCreatureName - 3))
		EEex_EvalActionsStringAsActorResume("ApplySpellRES(\"MEBIRDP2\",\"" .. string.sub(birdCreatureName, 1, #birdCreatureName - 3) .. "\")", targetID)
	end

end
--]]

function MESHATTE(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	EEex_Call(EEex_Label("CGameSprite::Shatter"), {0x0}, creatureData, 0x0)
end

function MEHOP(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	EEex_Call(EEex_Label("CGameSprite::Shatter"), {0x4}, creatureData, 0x0)
--[[
	EEex_IterateActorEffects(targetID, function(eData)
		local the_opcode = EEex_ReadDword(eData + 0x10)
		local the_timing = EEex_ReadDword(eData + 0x24)
		if the_opcode == 7 and the_timing == 2 then
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 7,
["target"] = 2,
["parameter1"] = EEex_ReadDword(eData + 0x1C),
["parameter2"] = EEex_ReadDword(eData + 0x20),
["timing"] = 0,
["duration"] = 0,
["parent_resource"] = "MECLRFIX",
["sourceslot"] = EEex_ReadDword(eData + 0xA4),
["source_target"] = targetID,
["source_id"] = targetID
})
		end
	end)
--]]
end


function MEHGTST(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local animation = EEex_GetActorAnimation(targetID)
	local parameter1 = EEex_ReadDword(effectData + 0x18)
	local parameter2 = EEex_ReadDword(effectData + 0x1C)
	local special = EEex_ReadDword(effectData + 0x44)
	if special == 0 then
		local height = EEex_ReadSignedWord(creatureData + 0x618, 0x0)
--		Infinity_DisplayString(height)
		if parameter2 == 0 then
			EEex_WriteWord(creatureData + 0x618, height + parameter1)
		elseif parameter2 == 1 then
			EEex_WriteWord(creatureData + 0x618, parameter1)
		elseif parameter2 == 2 then
			EEex_WriteWord(creatureData + 0x618, math.floor(height * (parameter1 / 100)))
		end
	elseif special == 1 then
		local speed = EEex_ReadSignedWord(creatureData + 0x61A, 0x0)
--		Infinity_DisplayString(speed)
		if parameter2 == 0 then
			EEex_WriteWord(creatureData + 0x61A, speed + parameter1)
		elseif parameter2 == 1 then
			EEex_WriteWord(creatureData + 0x61A, parameter1)
		elseif parameter2 == 2 then
			EEex_WriteWord(creatureData + 0x61A, math.floor(speed * (parameter1 / 100)))
		end
	elseif special == 2 then
		local accel = EEex_ReadSignedWord(creatureData + 0x61C, 0x0)
--		Infinity_DisplayString(accel)
		if parameter2 == 0 then
			EEex_WriteWord(creatureData + 0x61C, accel + parameter1)
		elseif parameter2 == 1 then
			EEex_WriteWord(creatureData + 0x61C, parameter1)
		elseif parameter2 == 2 then
			EEex_WriteWord(creatureData + 0x61C, math.floor(accel * (parameter1 / 100)))
		end
	elseif special == 3 then
		local minHeight = EEex_ReadSignedWord(creatureData + 0x61E, 0x0)
--		Infinity_DisplayString(minHeight)
		if parameter2 == 0 then
			EEex_WriteWord(creatureData + 0x61E, minHeight + parameter1)
		elseif parameter2 == 1 then
			EEex_WriteWord(creatureData + 0x61E, parameter1)
		elseif parameter2 == 2 then
			EEex_WriteWord(creatureData + 0x61E, math.floor(minHeight * (parameter1 / 100)))
		end
	elseif special == 4 then
		local maxHeight = EEex_ReadSignedWord(creatureData + 0x620, 0x0)
--		Infinity_DisplayString(maxHeight)
		if parameter2 == 0 then
			EEex_WriteWord(creatureData + 0x620, maxHeight + parameter1)
		elseif parameter2 == 1 then
			EEex_WriteWord(creatureData + 0x620, parameter1)
		elseif parameter2 == 2 then
			EEex_WriteWord(creatureData + 0x620, math.floor(maxHeight * (parameter1 / 100)))
		end
	end
end
-- Bits for special:
--[[
0x1: Treat the minimum height as the ground (so reaching the minimum height counts as landing)
0x2: Remove source effects on landing
0x8: Cast spell on landing
--]]
function MEHGTMOD(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
--	if not EEex_IsSprite(sourceID) then return end
	local parameter1 = EEex_ReadDword(effectData + 0x18)
	local parameter2 = EEex_ReadDword(effectData + 0x1C)
	local parameter3 = EEex_ReadDword(effectData + 0x5C)
	local parameter4 = EEex_ReadDword(effectData + 0x60)
	local special = EEex_ReadDword(effectData + 0x44)
	local parent_resource = EEex_ReadLString(effectData + 0x90, 8)
	local spellRes = EEex_ReadLString(effectData + 0x18, 8)
	local casterlvl = EEex_ReadDword(effectData + 0xC4)
	local duration = EEex_ReadDword(effectData + 0x24)
	local time_applied = EEex_ReadDword(effectData + 0x68)
	local firstIteration = false
	local roofHeight = 32767
	local targetHeight = 70
	local areaRes = EEex_GetActorAreaRes(targetID)
	if me_ceiling_height[areaRes] ~= nil then
		roofHeight = me_ceiling_height[areaRes] * 2
	end
	if bit32.band(parameter4, 0x1) == 0 then
		parameter4 = bit32.bor(parameter4, 0x1)
		firstIteration = true
	end

	local animation = EEex_GetActorAnimation(targetID)
	local height = EEex_ReadSignedWord(creatureData + 0x618, 0x0) + EEex_GetActorStat(targetID, 641)
	local speed = EEex_ReadSignedWord(creatureData + 0x61A, 0x0) + EEex_GetActorStat(targetID, 642)
	local accel = EEex_ReadSignedWord(creatureData + 0x61C, 0x0) + EEex_GetActorStat(targetID, 643)
	local minHeight = EEex_GetActorStat(targetID, 647)
	local maxHeight = EEex_GetActorStat(targetID, 648)
	local centerHeight = EEex_GetActorStat(targetID, 649)
	local minSpeed = EEex_GetActorStat(targetID, 650)
	local previousHeight = height
	if minSpeed == 0 then
		minSpeed = -32768
	end
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 9,
["resource"] = "MEGOOVER",
["source_target"] = targetID,
["source_id"] = sourceID
})
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 9,
["resource"] = "MEOVERDS",
["source_target"] = targetID,
["source_id"] = sourceID
})
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 9,
["resource"] = "MEOVERAC",
["source_target"] = targetID,
["source_id"] = sourceID
})
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 9,
["resource"] = "MEOVERTH",
["source_target"] = targetID,
["source_id"] = sourceID
})
	if bit32.band(special, 0x20) == 0x0 then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 9,
["resource"] = "MEOVERVI",
["source_target"] = targetID,
["source_id"] = targetID
})
	end
	local theareatype = 0
	if EEex_ReadDword(EEex_GetActorShare(targetID) + 0x14) > 0 then
		theareatype = EEex_ReadWord(EEex_ReadDword(EEex_GetActorShare(targetID) + 0x14) + 0x40, 0x0)
	end
	if height >= 50 then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 406,
["target"] = 2,
["timing"] = 10,
["duration"] = 15,
["parent_resource"] = "MEOVERDS",
["source_target"] = targetID,
["source_id"] = targetID
})
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 284,
["target"] = 2,
["timing"] = 10,
["duration"] = 15,
["parameter1"] = -10,
["parent_resource"] = "MEOVERTH",
["source_target"] = targetID,
["source_id"] = targetID
})
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 0,
["target"] = 2,
["timing"] = 10,
["duration"] = 15,
["parameter1"] = 20,
["parameter2"] = 0x1,
["parent_resource"] = "MEOVERAC",
["source_target"] = targetID,
["source_id"] = targetID
})
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 0,
["target"] = 2,
["timing"] = 10,
["duration"] = 15,
["parameter1"] = 20,
["parameter2"] = 0x4,
["parent_resource"] = "MEOVERAC",
["source_target"] = targetID,
["source_id"] = targetID
})
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 0,
["target"] = 2,
["timing"] = 10,
["duration"] = 15,
["parameter1"] = 20,
["parameter2"] = 0x8,
["parent_resource"] = "MEOVERAC",
["source_target"] = targetID,
["source_id"] = targetID
})
		if bit32.band(special, 0x20) == 0x0 and height >= 100 then
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 262,
["target"] = 2,
["timing"] = 1,
["duration"] = 15,
["parameter1"] = math.floor(height / 100),
["parent_resource"] = "MEOVERVI",
["source_target"] = targetID,
["source_id"] = targetID
})
		end
		if bit32.band(theareatype, 0x1) == 1 and bit32.band(theareatype, 0x800) == 0 then
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 184,
["target"] = 2,
["timing"] = 10,
["duration"] = 15,
["parameter2"] = 1,
["parent_resource"] = "MEGOOVER",
["source_target"] = targetID,
["source_id"] = targetID
})
		end
	end
	if (minHeight <= 0 or bit32.band(special, 0x1) == 0x1) and (height <= minHeight and speed <= 0 and accel <= 0) then 
		EEex_WriteWord(creatureData + 0x618, 0)
		EEex_WriteWord(creatureData + 0x61A, 0)
		EEex_WriteWord(creatureData + 0x61C, -1)
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 9,
["resource"] = "MEOVERVI",
["source_target"] = targetID,
["source_id"] = targetID
})
		if bit32.band(special, 0x2) == 0x2 then
			EEex_WriteDword(effectData + 0x110, 0x1)
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 9,
["resource"] = parent_resource,
["parent_resource"] = parent_resource,
["source_target"] = targetID,
["source_id"] = sourceID
})
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 407,
["target"] = 2,
["parameter1"] = casterlvl,
["parameter2"] = 2,
["timing"] = 10,
["duration"] = 1,
["resource"] = "MEUNSTUC",
["casterlvl"] = casterlvl,
["parent_resource"] = "MEUNSTUC",
["source_target"] = targetID,
["source_id"] = sourceID
})
		end
		if bit32.band(special, 0x8) == 0x8 then
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 9,
["resource"] = parent_resource .. "E",
["source_target"] = targetID,
["source_id"] = sourceID
})
			EEex_WriteDword(creatureData + 0x10, 0)
		end
		if bit32.band(special, 0x2) == 0x2 or bit32.band(special, 0x8) == 0x8 then
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 325,
["target"] = 2,
["timing"] = 3,
["duration"] = 0,
["source_target"] = targetID,
["source_id"] = sourceID
})
			return 
		end
	end
	if minHeight < 0 then
		minHeight = 0
	end
	if maxHeight <= 0 or maxHeight > 10000 then
		maxHeight = 10000
	end
	if maxHeight > (roofHeight - targetHeight) and not EEex_IsEthereal(targetID) then
		if targetHeight >= roofHeight then
			maxHeight = 1
		else
			maxHeight = (roofHeight - targetHeight)
		end
	end
	if minHeight >= maxHeight then
		minHeight = maxHeight - 1
	end

	if height <= minHeight then
		height = minHeight
		if speed < 0 then
			speed = 0
		end
	elseif height >= maxHeight then
		height = maxHeight - 1
		if speed > 0 then
			if speed >= 25 and bit32.band(special, 0x40) == 0x40 and maxHeight < 10000 then
				EEex_ApplyEffectToActor(targetID, {
["opcode"] = 295,
["target"] = 2,
["timing"] = 10,
["duration"] = 3,
["parameter2"] = 1,
["parent_resource"] = "MEFALDMG",
["source_target"] = targetID,
["source_id"] = sourceID
})
				EEex_ApplyEffectToActor(targetID, {
["opcode"] = 12,
["target"] = 2,
["timing"] = 9,
["dicenumber"] = math.floor((speed - 30) / 3),
["dicesize"] = 6,
["savingthrow"] = 0x1000000,
["parent_resource"] = "MEFALDMG",
["source_target"] = targetID,
["source_id"] = sourceID
})
				EEex_ApplyEffectToActor(targetID, {
["opcode"] = 206,
["target"] = 2,
["timing"] = 10,
["duration"] = 3,
["resource"] = "MEFALDMG",
["source_target"] = targetID,
["source_id"] = sourceID
})
			end
			speed = 0
		end
	end

	height = height + speed
	if height - speed < centerHeight then
		speed = speed - accel
	elseif height - speed > centerHeight then
		speed = speed + accel
	end
	if speed <= minSpeed then
		speed = minSpeed + 1
	end

	if height <= minHeight then
		height = minHeight
		
		if speed < 0 then
			if speed <= -33 and bit32.band(special, 0x40) == 0x40 and (minHeight <= 0 or bit32.band(special, 0x1) == 0x1) then
				EEex_ApplyEffectToActor(targetID, {
["opcode"] = 12,
["target"] = 2,
["timing"] = 9,
["dicenumber"] = math.floor(math.abs(speed + 30) / 3),
["dicesize"] = 6,
["savingthrow"] = 0x1000000,
["parent_resource"] = "MEFALDMG",
["source_target"] = targetID,
["source_id"] = sourceID
})
				EEex_ApplyEffectToActor(targetID, {
["opcode"] = 206,
["target"] = 2,
["timing"] = 10,
["duration"] = 3,
["resource"] = "MEFALDMG",
["source_target"] = targetID,
["source_id"] = sourceID
})
			end
			speed = 0
		end
	elseif height >= maxHeight then
		height = maxHeight - 1
		if speed > 0 then
			if speed >= 33 and bit32.band(special, 0x40) == 0x40 and maxHeight < 10000 then
				EEex_ApplyEffectToActor(targetID, {
["opcode"] = 295,
["target"] = 2,
["timing"] = 10,
["duration"] = 3,
["parameter2"] = 1,
["parent_resource"] = "MEFALDMG",
["source_target"] = targetID,
["source_id"] = sourceID
})
				EEex_ApplyEffectToActor(targetID, {
["opcode"] = 12,
["target"] = 2,
["timing"] = 9,
["dicenumber"] = math.floor((speed - 30) / 3),
["dicesize"] = 6,
["savingthrow"] = 0x1000000,
["parent_resource"] = "MEFALDMG",
["source_target"] = targetID,
["source_id"] = sourceID
})
				EEex_ApplyEffectToActor(targetID, {
["opcode"] = 206,
["target"] = 2,
["timing"] = 10,
["duration"] = 3,
["resource"] = "MEFALDMG",
["source_target"] = targetID,
["source_id"] = sourceID
})
			end
			speed = 0
		end
	end
	if bit32.band(EEex_ReadDword(creatureData + 0x434), 0x2000) > 0 then return end
	if bit32.band(special, 0x20) == 0x20 and math.floor(previousHeight / 100) ~= math.floor(height / 100) then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 9,
["resource"] = "MEOVERVI",
["source_target"] = targetID,
["source_id"] = targetID
})
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 262,
["target"] = 2,
["timing"] = 1,
["duration"] = 15,
["parameter1"] = math.floor(height / 100),
["parent_resource"] = "MEOVERVI",
["source_target"] = targetID,
["source_id"] = targetID
})
	end
	if ((minHeight > 0 and bit32.band(special, 0x1) == 0x0) or (height > minHeight)) and not (EEex_IsFlying(targetID)) then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 176,
["target"] = 2,
["timing"] = 3,
["parameter2"] = 1,
["duration"] = 0,
["parent_resource"] = parent_resource,
["source_target"] = targetID,
["source_id"] = sourceID
})
	end

	EEex_WriteWord(creatureData + 0x618, height)
	EEex_WriteWord(creatureData + 0x61A, speed)

	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 325,
["target"] = 2,
["timing"] = 3,
["duration"] = 0,
["source_target"] = targetID,
["source_id"] = sourceID
})
	local visualHeight = -math.ceil(height / 2)
	if visualHeight > 0 or visualHeight == -0 then
		visualHeight = 0
	end

	EEex_WriteDword(creatureData + 0x10, visualHeight)
	EEex_WriteDword(creatureData + 0x2D00, 0)
	EEex_WriteDword(effectData + 0x110, 0x1)
	if bit32.band(special, 0x10) == 0x10 then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 337,
["target"] = 2,
["timing"] = 1,
["parameter1"] = parameter2,
["parameter2"] = 402,
["parameter3"] = parameter3,
["parameter4"] = parameter4,
["resource"] = "MEHGTMOD",
["special"] = special,
["casterlvl"] = casterlvl,
["parent_resource"] = "MEHGTREM",
["source_target"] = targetID,
["source_id"] = sourceID
})
	end
	if duration == time_applied and not firstIteration then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 402,
["target"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["parameter1"] = parameter1,
["parameter2"] = parameter2,
["parameter3"] = parameter3,
["parameter4"] = parameter4,
["resource"] = "MEHGTMOD",
["special"] = special,
["casterlvl"] = casterlvl,
["parent_resource"] = parent_resource,
["source_target"] = targetID,
["source_id"] = sourceID
})
	else
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 402,
["target"] = 2,
["timing"] = 3,
["parameter1"] = parameter1,
["parameter2"] = parameter2,
["parameter3"] = parameter3,
["parameter4"] = parameter4,
["resource"] = "MEHGTMOD",
["special"] = special,
["casterlvl"] = casterlvl,
["parent_resource"] = parent_resource,
["source_target"] = targetID,
["source_id"] = sourceID
})
	end
end

function METEST(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	EEex_WriteDword(effectData + 0x110, 0x1)

	local currentTick = EEex_GetGameTick()
	local targetTick = currentTick + 1

	Infinity_DisplayString("Tick: "..currentTick)
	EEex_WriteDword(creatureData + 0x10, -500)
--[[
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 402,
["target"] = 2,
["timing"] = 6,
["duration"] = targetTick,
["resource"] = "METEST",
["parent_resource"] = "METEST",
["source_target"] = targetID,
["source_id"] = targetID
})
--]]
end


function MEGRVGLB(effectData, creatureData)
	EEex_WriteDword(effectData + 0x110, 0x1)
	local me_grvglb_radius = 500
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local casterlvl = EEex_ReadDword(effectData + 0xC4)
	local targetX = EEex_ReadDword(creatureData + 0x8)
	local targetY = EEex_ReadDword(creatureData + 0xC)
	local centerX = EEex_ReadDword(effectData + 0x84)
	local centerY = EEex_ReadDword(effectData + 0x88)
	local horizontalDistance = math.floor((((targetX - centerX) ^ 2) + (((targetY - centerY) * 1.5) ^ 2)) ^ .5)
	if horizontalDistance > me_grvglb_radius then
		horizontalDistance = me_grvglb_radius
	end
--	Infinity_DisplayString(EEex_GetActorName(targetID) .. ": " .. horizontalDistance)
	local globeYRadius = math.floor(((me_grvglb_radius ^ 2) - (horizontalDistance ^ 2)) ^ .5)
	local globeHeight = globeYRadius + me_grvglb_radius * .8
	local globeBottom = me_grvglb_radius * .8 - globeYRadius

	local height = EEex_ReadSignedWord(creatureData + 0x618, 0x0) + EEex_GetActorStat(targetID, 641)
--	Infinity_DisplayString(EEex_GetActorName(targetID) .. "-> globeHeight: " .. globeHeight .. "; globeBottom: " .. globeBottom .. "; fullHeight: " .. fullHeight)
	if height >= globeBottom and (height <= globeHeight or horizontalDistance <= me_grvglb_radius * .6) then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 401,
["target"] = 2,
["timing"] = 10,
["duration"] = 12,
["parameter1"] = 1,
["parameter2"] = 1,
["special"] = 647,
["parent_resource"] = "MEGRVGLA",
["source_target"] = targetID,
["source_id"] = sourceID
})
	else
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 9,
["resource"] = "MEGRVGLA",
["parent_resource"] = parent_resource,
["source_target"] = targetID,
["source_id"] = sourceID
})
	end
	if height <= globeHeight and height >= globeBottom then

		if EEex_IsFlying(targetID) then return end

		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 401,
["target"] = 2,
["timing"] = 10,
["duration"] = 12,
["parameter1"] = globeHeight,
["parameter2"] = 1,
["special"] = 649,
["parent_resource"] = "MEGRVGLB",
["source_target"] = targetID,
["source_id"] = sourceID
})
--[[
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 401,
["target"] = 2,
["timing"] = 10,
["duration"] = 16,
["parameter1"] = 1,
["parameter2"] = 1,
["special"] = 647,
["parent_resource"] = "MEGRVGLB",
["source_target"] = targetID,
["source_id"] = sourceID
})
--]]
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 401,
["target"] = 2,
["timing"] = 10,
["duration"] = 12,
["parameter1"] = 30000,
["parameter2"] = 1,
["special"] = 648,
["parent_resource"] = "MEGRVGLB",
["source_target"] = targetID,
["source_id"] = sourceID
})
		if EEex_GetActorStat(targetID, 636) == 0 then
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 401,
["target"] = 2,
["timing"] = 1,
["duration"] = 12,
["parameter1"] = 1,
["parameter2"] = 1,
["special"] = 636,
["parent_resource"] = "MEGRVGLC",
["source_target"] = targetID,
["source_id"] = sourceID
})
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 235,
["target"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["parameter1"] = EEex_GetActorMovementRate(targetID, false),
["parameter2"] = 1,
["parent_resource"] = "MEGRVGLC",
["target_x"] = EEex_ReadDword(EEex_GetActorShare(targetID) + 0x8),
["target_y"] = EEex_ReadDword(EEex_GetActorShare(targetID) + 0xC),
["source_target"] = targetID,
["source_id"] = sourceID
})

			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 402,
["target"] = 2,
["timing"] = 3,
["parameter1"] = -3,
["parameter2"] = 1,
["special"] = 2,
["resource"] = "MEHGTST",
["parent_resource"] = "MEGRVGLC",
["source_target"] = targetID,
["source_id"] = sourceID
})

			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 402,
["target"] = 2,
["timing"] = 3,
--["duration"] = EEex_GetGameTick() + 1,
["parameter1"] = globeHeight,
["parameter2"] = 1,
["special"] = 0x42,
["resource"] = "MEHGTMOD",
["parent_resource"] = "MEGRVGLC",
["source_target"] = targetID,
["source_id"] = sourceID
})
		end
--[[
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 4,
["duration"] = 1,
["resource"] = "MEGRVGLB",
["parent_resource"] = "MEGRVGLB",
["source_target"] = targetID,
["source_id"] = targetID
})
--]]
	else
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 9,
["resource"] = "MEGRVGLB",
["parent_resource"] = parent_resource,
["source_target"] = targetID,
["source_id"] = sourceID
})
	end
end

function MELOOPST(effectData, creatureData)
--	Infinity_DisplayString("ugu")
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if (sourceID == 0 or sourceID == -1) then
		
		local parameter1 = EEex_ReadDword(effectData + 0x18)
		local parameter2 = EEex_ReadDword(effectData + 0x1C)
		local parameter3 = EEex_ReadDword(effectData + 0x5C)
		local parameter4 = EEex_ReadDword(effectData + 0x60)
		local special = EEex_ReadDword(effectData + 0x44)
		local vvcresource = EEex_ReadLString(effectData + 0x6C, 8)
		local parent_resource = EEex_ReadLString(effectData + 0x90, 8)
		local casterlvl = EEex_ReadDword(effectData + 0xC4)
		local targetID = EEex_ReadDword(creatureData + 0x34)
		EEex_AlterActorEffect(targetID,{{"opcode",402}, {"resource","LOOPST"}, {"parameter1",parameter1}, {"parameter2",parameter2}, {"parameter3",parameter3}, {"parameter4",parameter4}, {"special",special}}, {{"source_id",targetID}},1)
		local height = EEex_ReadSignedWord(creatureData + 0x618, 0x0)
		local speed = EEex_ReadSignedWord(creatureData + 0x61A, 0x0)
		local accel = EEex_ReadSignedWord(creatureData + 0x61C, 0x0)
		local minHeight = EEex_ReadSignedWord(creatureData + 0x61E, 0x0)
		local maxHeight = EEex_ReadSignedWord(creatureData + 0x620, 0x0)
		if minHeight < 0 then
			minHeight = 0
		end
		if maxHeight == -1 or maxHeight >= me_highestheightnumber then
			maxHeight = me_highestheightnumber - 1
		end
--		Infinity_DisplayString("height: " .. height)
--		Infinity_DisplayString("speed: " .. speed)
--		Infinity_DisplayString("accel: " .. accel)
		height = height + speed
		speed = speed + accel
		EEex_WriteWord(creatureData + 0x618, height)
		EEex_WriteWord(creatureData + 0x61A, speed)
		if height <= minHeight then
			height = minHeight
			EEex_WriteWord(creatureData + 0x618, minHeight)
			if speed <= 0 then
				speed = 0
				EEex_WriteWord(creatureData + 0x61A, 0)
			end
		elseif height > maxHeight then
			height = maxHeight
			if maxHeight <= me_highestheightnumber then
				EEex_WriteWord(creatureData + 0x618, maxHeight)
			end
		end
		local animation = EEex_GetActorAnimation(targetID)
	--	Infinity_DisplayString(me_heighttoanimation[height])
--	EEex_WriteDword(effectData + 0x110, 0x1)
		if me_heighttoanimation[height] == nil then return end
		EEex_ApplyEffectToActor(targetID, {
	["opcode"] = 53,
	["target"] = 2,
	["parameter1"] = me_heighttoanimation[height],
	["timing"] = 0,
	["parent_resource"] = parent_resource,
	["source_target"] = targetID,
	["source_id"] = sourceID
	})
		EEex_Call(EEex_Label("CGameSprite::Shatter"), {0x2}, creatureData, 0x0)
		EEex_ApplyEffectToActor(targetID, {
	["opcode"] = 53,
	["target"] = 2,
	["parameter1"] = animation,
	["timing"] = 0,
	["parent_resource"] = parent_resource,
	["source_target"] = targetID,
	["source_id"] = sourceID
	})
--	Infinity_DisplayString("ogo")

		EEex_IterateActorEffects(targetID, function(eData)
			local the_opcode = EEex_ReadDword(eData + 0x10)
			local the_timing = EEex_ReadDword(eData + 0x24)
			if the_opcode == 7 and the_timing == 2 then
				EEex_ApplyEffectToActor(targetID, {
	["opcode"] = 7,
	["target"] = 2,
	["parameter1"] = EEex_ReadDword(eData + 0x1C),
	["parameter2"] = EEex_ReadDword(eData + 0x20),
	["timing"] = 0,
	["duration"] = 0,
	["parent_resource"] = "MECLRFIX",
	["sourceslot"] = EEex_ReadDword(eData + 0xA4),
	["source_target"] = targetID,
	["source_id"] = targetID
	})
			end
		end)
--[[
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 407,
["target"] = 2,
["timing"] = 10,
["duration"] = 1,
["parameter1"] = casterlvl,
["parameter2"] = 2,
["resource"] = parent_resource,
["casterlvl"] = casterlvl,
["source_target"] = targetID,
["source_id"] = targetID
})
--]]
--[[
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 402,
["target"] = 2,
["timing"] = 3,
["duration"] = 0,
["parameter1"] = parameter1,
["parameter2"] = parameter2,
["parameter3"] = parameter3,
["parameter4"] = parameter4,
["resource"] = vvcresource,
["special"] = special,
["casterlvl"] = casterlvl,
["parent_resource"] = parent_resource,
["source_target"] = targetID,
["source_id"] = targetID
})
--]]
	end
end
--[[
To use the MESTONES function, create an opcode 403 effect, set the resource to MESTONES (all capitals), and choose parameters.

It serves like the Stoneskin opcode, except more versitile.

By default, when the last skin is removed, it will automatically remove all effects of the spell or ability that had
 included the opcode 403 effect. This way, you can include other effects that will last as long as there are skins remaining.

parameter1 - Determines how many skins there are (how many instances of damage will be blocked). If parameter1 is
 set to 65535, then the effect will block an infinite number of damage instances.

parameter2 - Determines which damage types are blocked. The number for each damage type is the same as in DAMAGES.IDS,
 with one exception: crushing damage is 0x4000. If you want to block multiple damage types, add the numbers for each
 damage type. For example, if you want the skins to block slashing, piercing, crushing, missile, and nonlethal damage,
 set parameter2 to 0x4990 (0x100 + 0x10 + 0x4000 + 0x80 + 0x800)

special - Bit flags for the effect.
Bit 0: If set, when the last skin is removed, it will not automatically remove all effects of the source spell.
Bit 1: If set, when the last skin is removed, it will cast a spell on the creature. The spell resref is specified
 by resource2 (in an EFF file). If you aren't using this from an EFF file, then the spell resref is set to the
 resref of the source spell, with an E added at the end.
Bit 2: If set, whenever a skin is removed, it will cast a spell on the source of the damage. The spell resref is specified
 by resource3 (in an EFF file). If you aren't using this from an EFF file, then the spell resref is set to the
 resref of the source spell, with an F added at the end.

If you want to make a specific damage effect bypass the MESTONES effect without removing a skin, set bit 20 of the
 special field in the damage effect. This can't be done with base weapon damage, unfortunately.
--]]
function MESTONES(originatingEffectData, effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local opcode = EEex_ReadDword(effectData + 0xC)
	if opcode ~= 12 then return false end
	local special = EEex_ReadDword(effectData + 0x44)
	if bit32.band(special, 0x100000) > 0 then return false end
	local skins_left = EEex_ReadDword(originatingEffectData + 0x18)
	if skins_left <= 0 then return false end
	local types_blocked = EEex_ReadDword(originatingEffectData + 0x1C)
	local flags = EEex_ReadDword(originatingEffectData + 0x44)
	local parent_resource = EEex_ReadLString(originatingEffectData + 0x90, 8)
	local damage_type = EEex_ReadWord(effectData + 0x1E, 0x0)
	local casterlvl = EEex_ReadDword(originatingEffectData + 0xC4)
	if (damage_type == 0 and bit32.band(types_blocked, 0x4000) > 0) or (damage_type ~= 0 and bit32.band(types_blocked, damage_type) > 0) then
		if bit32.band(flags, 0x4) > 0 then
			local hit_spell = EEex_ReadLString(originatingEffectData + 0x74, 8)
			if hit_spell == "" then
				hit_spell = parent_resource .. "F"
			end
			local damagerID = EEex_ReadDword(effectData + 0x10C)
			if EEex_IsSprite(damagerID) then
				EEex_ApplyEffectToActor(damagerID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 9,
["parameter1"] = casterlvl,
["parameter2"] = 2,
["resource"] = hit_spell,
["source_target"] = damagerID,
["source_id"] = targetID
})
			end
		end
		if skins_left ~= 65535 then
			skins_left = skins_left - 1
		end
		EEex_WriteDword(originatingEffectData + 0x18, skins_left)
		if skins_left <= 0 then
			EEex_WriteDword(originatingEffectData + 0x110, 0x1)
			if bit32.band(flags, 0x1) == 0 then
				EEex_ApplyEffectToActor(targetID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 9,
["resource"] = parent_resource,
["source_target"] = targetID,
["source_id"] = targetID
})
			end
			if bit32.band(flags, 0x2) > 0 then
				local end_spell = EEex_ReadLString(originatingEffectData + 0x6C, 8)
				if end_spell == "" then
					end_spell = parent_resource .. "E"
				end
				EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 9,
["parameter1"] = casterlvl,
["parameter2"] = 2,
["resource"] = end_spell,
["source_target"] = targetID,
["source_id"] = targetID
})
			end
		end
		return true
	end
	return false
end

function MEMODDTP(originatingEffectData, effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local opcode = EEex_ReadDword(effectData + 0xC)
	if opcode ~= 12 then return false end
	local special = EEex_ReadDword(effectData + 0x44)
	if bit32.band(special, 0x100000) > 0 then return false end
	local damage_type = EEex_ReadWord(effectData + 0x1E, 0x0)
	local types_checked = EEex_ReadWord(originatingEffectData + 0x1C, 0x0)
	local new_damage_type = EEex_ReadWord(originatingEffectData + 0x1E, 0x0)
	if (damage_type == 0 and bit32.band(types_checked, 0x4000) > 0) or (damage_type ~= 0 and bit32.band(types_checked, damage_type) > 0) then
		EEex_WriteWord(effectData + 0x1E, new_damage_type)
	end
	return false
end

function MERANDSP(effectData, creatureData)
	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local spellRES = EEex_ReadLString(effectData + 0x18, 8)
	local casterlvl = EEex_ReadDword(effectData + 0xC4)
	local maxradius = EEex_ReadDword(effectData + 0x44)
	local targetX = EEex_ReadDword(creatureData + 0x8)
	local targetY = EEex_ReadDword(creatureData + 0xC)
	local sourceX = EEex_ReadDword(effectData + 0x84)
	local sourceY = EEex_ReadDword(effectData + 0x88)
	local deltaX = math.random(maxradius * 2 + 1) - maxradius - 1
	local deltaY = math.random(maxradius * 2 + 1) - maxradius - 1
	while math.floor((deltaX ^ 2 + deltaY ^ 2) ^ .5) > maxradius do
		deltaX = math.random(maxradius * 2 + 1) - maxradius - 1
		deltaY = math.random(maxradius * 2 + 1) - maxradius - 1
	end
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 148,
["target"] = 2,
["timing"] = 9,
["parameter1"] = casterlvl,
["parameter2"] = 2,
["resource"] = spellRES,
["casterlvl"] = casterlvl,
["source_target"] = targetID,
["source_id"] = sourceID,
["source_x"] = sourceX,
["source_y"] = sourceY,
["target_x"] = targetX + deltaX,
["target_y"] = targetY + deltaY
})

end
key_angles = {-90, -67.5, -45, -22.5, 0, 22.5, 45, 67.5, 90}
function MEWOFORC(effectData, creatureData)
	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local creatureRES = EEex_ReadLString(effectData + 0x18, 8)
	local casterlvl = EEex_ReadDword(effectData + 0xC4)
	local numCreatures = EEex_ReadWord(effectData + 0x44, 0x0)
	if numCreatures == 0 then return end
	local savingthrow = EEex_ReadDword(effectData + 0x3C)
	local wallAnimation = ""
	local wallDeltaBase = EEex_ReadWord(effectData + 0x46, 0x0)
	if wallDeltaBase == 0 then
		wallDeltaBase = 30
	end
	local duration = EEex_ReadDword(effectData + 0x5C)
	local timing = 0
	if duration == 0 then
		timing = 9
		duration = 60
	end

	local vvcresource = EEex_ReadLString(effectData + 0x6C, 8)
	if vvcresource == "" then
		vvcresource = "SNONE"
	end
	local targetX = EEex_ReadDword(effectData + 0x84)
	local targetY = EEex_ReadDword(effectData + 0x88)
	local sourceX = EEex_ReadDword(creatureData + 0x8)
	local sourceY = EEex_ReadDword(creatureData + 0xC)
	local deltaX = targetX - sourceX
	local deltaY = targetY - sourceY
	local angle = 90
	if deltaX ~= 0 then
		angle = math.deg(math.atan(deltaY / deltaX))
		local angleRounded = false
		for i = 1, 9, 1 do
			if angleRounded == false and ((angle >= key_angles[i] and angle - 11.25 <= key_angles[i]) or (angle <= key_angles[i] and angle + 11.25 >= key_angles[i])) then
				angleRounded = true
				angle = key_angles[i]
				if bit32.band(savingthrow, 0x100000) > 0 then
					wallAnimation = "MEWOFOR" .. i
				end
			end
		end
	else
		if bit32.band(savingthrow, 0x100000) > 0 then
			wallAnimation = "MEWOFOR9"
		end
	end
	
	local wallDeltaX = math.floor(math.sin(math.rad(angle)) * wallDeltaBase * -1)
	local wallDeltaY = math.floor(math.cos(math.rad(angle)) * wallDeltaBase)
	if wallAnimation ~= "" then
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 215,
["target"] = 2,
["timing"] = 0,
["duration"] = duration,
["parameter2"] = 2,
["resource"] = wallAnimation,
["source_target"] = sourceID,
["source_id"] = sourceID,
["source_x"] = sourceX,
["source_y"] = sourceY,
["target_x"] = targetX,
["target_y"] = targetY
})
	end
	if numCreatures % 2 == 1 then
		C:Eval('CreateCreatureImpassableAllowOverlap(\"' .. creatureRES .. '\", [' .. targetX .. '.' .. targetY + 7 .. '], ' .. 0, sourceID)
--[[
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 67,
["target"] = 2,
["timing"] = timing,
["duration"] = duration,
["parameter2"] = 2,
["resource"] = creatureRES,
["vvcresource"] = vvcresource,
["casterlvl"] = casterlvl,
["source_target"] = sourceID,
["source_id"] = sourceID,
["source_x"] = sourceX,
["source_y"] = sourceY,
["target_x"] = targetX,
["target_y"] = targetY
})
--]]
		numCreatures = math.floor((numCreatures - 1) / 2)
		for i = 1, numCreatures, 1 do
			C:Eval('CreateCreatureImpassableAllowOverlap(\"' .. creatureRES .. '\", [' .. targetX + (wallDeltaX * i) .. '.' .. targetY + (wallDeltaY * i) + 7 .. '], ' .. 0, sourceID)
--[[
			EEex_ApplyEffectToActor(sourceID, {
	["opcode"] = 67,
	["target"] = 2,
	["timing"] = timing,
	["duration"] = duration,
	["parameter2"] = 2,
	["resource"] = creatureRES,
	["vvcresource"] = vvcresource,
	["casterlvl"] = casterlvl,
	["source_target"] = sourceID,
	["source_id"] = sourceID,
	["source_x"] = sourceX,
	["source_y"] = sourceY,
	["target_x"] = targetX + (wallDeltaX * i),
	["target_y"] = targetY + (wallDeltaY * i)
	})
--]]
			C:Eval('CreateCreatureImpassableAllowOverlap(\"' .. creatureRES .. '\", [' .. targetX - (wallDeltaX * i) .. '.' .. targetY - (wallDeltaY * i) + 7 .. '], ' .. 0, sourceID)
--[[
			EEex_ApplyEffectToActor(sourceID, {
	["opcode"] = 67,
	["target"] = 2,
	["timing"] = timing,
	["duration"] = duration,
	["parameter2"] = 2,
	["resource"] = creatureRES,
	["vvcresource"] = vvcresource,
	["casterlvl"] = casterlvl,
	["source_target"] = sourceID,
	["source_id"] = sourceID,
	["source_x"] = sourceX,
	["source_y"] = sourceY,
	["target_x"] = targetX - (wallDeltaX * i),
	["target_y"] = targetY - (wallDeltaY * i)
	})
--]]
		end
	else
		for i = 1, numCreatures, 1 do
			C:Eval('CreateCreatureImpassableAllowOverlap(\"' .. creatureRES .. '\", [' .. targetX + math.floor(wallDeltaX / 2) + (wallDeltaX * i) .. '.' .. targetY + math.floor(wallDeltaY / 2) + (wallDeltaY * i) + 7 .. '], ' .. 0, sourceID)
--[[
			EEex_ApplyEffectToActor(sourceID, {
	["opcode"] = 67,
	["target"] = 2,
	["timing"] = timing,
	["duration"] = duration,
	["parameter2"] = 2,
	["resource"] = creatureRES,
	["vvcresource"] = vvcresource,
	["casterlvl"] = casterlvl,
	["source_target"] = sourceID,
	["source_id"] = sourceID,
	["source_x"] = sourceX,
	["source_y"] = sourceY,
	["target_x"] = targetX + math.floor(wallDeltaX / 2) + (wallDeltaX * i),
	["target_y"] = targetY + math.floor(wallDeltaY / 2) + (wallDeltaY * i)
	})
--]]
			C:Eval('CreateCreatureImpassableAllowOverlap(\"' .. creatureRES .. '\", [' .. targetX - math.floor(wallDeltaX / 2) - (wallDeltaX * i) .. '.' .. targetY - math.floor(wallDeltaY / 2) - (wallDeltaY * i) + 7 .. '], ' .. 0, sourceID)
--[[
			EEex_ApplyEffectToActor(sourceID, {
	["opcode"] = 67,
	["target"] = 2,
	["timing"] = timing,
	["duration"] = duration,
	["parameter2"] = 2,
	["resource"] = creatureRES,
	["vvcresource"] = vvcresource,
	["casterlvl"] = casterlvl,
	["source_target"] = sourceID,
	["source_id"] = sourceID,
	["source_x"] = sourceX,
	["source_y"] = sourceY,
	["target_x"] = targetX - math.floor(wallDeltaX / 2) - (wallDeltaX * i),
	["target_y"] = targetY - math.floor(wallDeltaY / 2) - (wallDeltaY * i)
	})
--]]
		end
	end
end

function MEUNSTUC(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local targetX = EEex_ReadDword(creatureData + 0x8)
	local targetY = EEex_ReadDword(creatureData + 0xC)
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 222,
["target"] = 2,
["timing"] = 1,
["duration"] = duration,
["source_target"] = targetID,
["source_id"] = targetID,
["source_x"] = targetX,
["source_y"] = targetY,
["target_x"] = targetX,
["target_y"] = targetY
})
end

function EEex_GetGameData()
	return EEex_ReadDword(EEex_ReadDword(EEex_Label("g_pBaldurChitin")) + EEex_Label("CBaldurChitin::m_pObjectGame"))
end

function EEex_GetActorIDCharacter(slot)
	if slot >= 0 and slot <= 5 then
		local m_pObjectGame = EEex_GetGameData()
		return EEex_ReadDword(m_pObjectGame + 0x3DD8 + slot * 0x4)
	else
		return 0x0
	end
end

function MEFAMSPL(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if EEex_GetActorAllegiance(targetID) ~= 3 then return end
	if EEex_GetActorIDCharacter(EEex_ReadDword(EEex_GetGameData() + 0x47CC)) ~= sourceID then
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 139,
["target"] = 2,
["timing"] = 1,
["parameter1"] = ex_no_familiar_strref_1,
["parent_resource"] = "MEFAMNST",
["source_target"] = sourceID,
["source_id"] = sourceID
})
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 206,
["target"] = 2,
["timing"] = 0,
["duration"] = 1,
["resource"] = "MEFAMNST",
["parent_resource"] = "MEFAMNST",
["source_target"] = sourceID,
["source_id"] = sourceID
})
		return 
	end
	local isCorrectFamiliar = false
	local spellRES = EEex_ReadLString(effectData + 0x18, 8)
	local casterlvl = EEex_ReadDword(effectData + 0xC4)
	EEex_IterateActorEffects(targetID, function(eData)
		local the_opcode = EEex_ReadDword(eData + 0x10)
		local the_parameter3 = EEex_ReadDword(eData + 0x60)
		if the_opcode == 196 and EEex_GetActorIDCharacter(the_parameter3) == sourceID then
			isCorrectFamiliar = true
		end
	end)
	if isCorrectFamiliar then
		if EEex_GetActorStat(sourceID, 661) > 0 then
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 1,
["resource"] = "MEFAMSE2",
["source_target"] = targetID,
["source_id"] = sourceID
})
			local found_it = false
			EEex_IterateActorEffects(sourceID, function(eData)
				local the_opcode = EEex_ReadDword(eData + 0x10)
				local the_special = EEex_ReadDword(eData + 0x48)
				if the_opcode == 401 and the_special == 661 and found_it == false then
					found_it = true
					EEex_ApplyEffectToActor(targetID, {
["opcode"] = 401,
["target"] = 2,
["timing"] = 0,
["duration"] = 3600000,
["parameter1"] = EEex_ReadDword(eData + 0x1C),
["parameter2"] = 1,
["parameter3"] = EEex_ReadDword(eData + 0x60),
["parameter4"] = EEex_ReadDword(eData + 0x64),
["resource"] = EEex_ReadLString(eData + 0x30, 8),
["parent_resource"] = "MEFAMSE2",
["special"] = 661,
["casterlvl"] = EEex_ReadDword(eData + 0xC8),
["source_target"] = targetID,
["source_id"] = sourceID
})
					Infinity_SetToken("ME_FAMSES", EEex_GetSpellName(eData + 0x30))
					EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 139,
["target"] = 2,
["timing"] = 1,
["parameter1"] = ex_familiar_spell_strref_1,
["source_target"] = sourceID,
["source_id"] = sourceID
})
				end

			end)
			EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 1,
["resource"] = "MEFAMSEQ",
["source_target"] = sourceID,
["source_id"] = sourceID
})
		end
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 1,
["parameter1"] = casterlvl,
["parameter2"] = 2,
["resource"] = spellRES,
["casterlvl"] = casterlvl,
["source_target"] = targetID,
["source_id"] = sourceID
})
	end
end

function MEFAMSEQ(originatingEffectData, effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local opcode = EEex_ReadDword(effectData + 0xC)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local parent_resource = EEex_ReadLString(originatingEffectData + 0x90, 8)
	if (opcode ~= 232 and opcode ~= 256) or parent_resource ~= EEex_ReadLString(effectData + 0x90, 8) then return false end
	local spellRES = EEex_ReadLString(originatingEffectData + 0x18, 8)
	local parameter1 = EEex_ReadDword(effectData + 0x18)
	local parameter2 = EEex_ReadDword(effectData + 0x1C)
	local special = EEex_ReadDword(effectData + 0x44)
	local sequencerType = 1
	if opcode == 232 then
		if special == 1 then
			sequencerType = 2
		else
			sequencerType = 3
		end
	end
	EEex_WriteDword(effectData + 0xC, 256)
	local resource = EEex_ReadLString(effectData + 0x2C, 8)
	local casterlvl = EEex_ReadDword(originatingEffectData + 0xC4)
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 401,
["target"] = 2,
["timing"] = 0,
["duration"] = 3600000,
["parameter1"] = sequencerType,
["parameter2"] = 1,
["parameter3"] = parameter1,
["parameter4"] = parameter2,
["resource"] = resource,
["parent_resource"] = "MEFAMSEQ",
["special"] = 661,
["casterlvl"] = casterlvl,
["source_target"] = targetID,
["source_id"] = targetID
})
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 9,
["parameter1"] = casterlvl,
["parameter2"] = 2,
["casterlvl"] = casterlvl,
["resource"] = spellRES,
["source_target"] = targetID,
["source_id"] = targetID
})
	return true
end

function MEFAMSE2(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local newTargetID = targetID
	local newTargetX = EEex_ReadDword(creatureData + 0x8)
	local newTargetY = EEex_ReadDword(creatureData + 0xC)
	local sourceData = EEex_GetActorShare(sourceID)
	if EEex_GetActorStat(sourceID, 661) > 0 then
		EEex_IterateActorEffects(sourceID, function(eData)
			local the_opcode = EEex_ReadDword(eData + 0x10)
			local the_special = EEex_ReadDword(eData + 0x48)
			if the_opcode == 401 and the_special == 661 then
				local the_parameter3 = EEex_ReadDword(eData + 0x60)
				if the_parameter3 == 0 then
					newTargetID = sourceID
					newTargetX = EEex_ReadDword(sourceData + 0x8)
					newTargetY = EEex_ReadDword(sourceData + 0xC)
				end
				local the_casterlvl = EEex_ReadDword(eData + 0xC8)
				local the_resource = EEex_ReadLString(eData + 0x30, 8)
				local the_resource2 = EEex_ReadLString(eData + 0x70, 8)
				local the_resource3 = EEex_ReadLString(eData + 0x78, 8)
				if the_resource ~= "" then
					EEex_ApplyEffectToActor(newTargetID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 9,
["parameter1"] = the_casterlvl,
["parameter2"] = 1,
["casterlvl"] = the_casterlvl,
["resource"] = the_resource,
["target_x"] = newTargetX,
["target_y"] = newTargetY,
["source_target"] = newTargetID,
["source_id"] = sourceID
})
				end
				if the_resource2 ~= "" then
					EEex_ApplyEffectToActor(newTargetID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 9,
["parameter1"] = the_casterlvl,
["parameter2"] = 1,
["casterlvl"] = the_casterlvl,
["resource"] = the_resource2,
["target_x"] = newTargetX,
["target_y"] = newTargetY,
["source_target"] = newTargetID,
["source_id"] = sourceID
})
				end
				if the_resource3 ~= "" then
					EEex_ApplyEffectToActor(newTargetID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 9,
["parameter1"] = the_casterlvl,
["parameter2"] = 1,
["casterlvl"] = the_casterlvl,
["resource"] = the_resource3,
["target_x"] = newTargetX,
["target_y"] = newTargetY,
["source_target"] = newTargetID,
["source_id"] = sourceID
})
				end
			end
		end)
	end

	return true
end

function MECHAINL(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if not EEex_IsSprite(sourceID) then return end
	local spellRES = EEex_ReadLString(effectData + 0x18, 8)
	local savingthrow = EEex_ReadDword(effectData + 0x3C)
	local special = EEex_ReadDword(effectData + 0x44)
	local casterlvl = EEex_ReadDword(effectData + 0xC4)
	local parent_resource = EEex_ReadLString(effectData + 0x90, 8)
	local chainSourceID = sourceID

	if EEex_GetActorStat(sourceID, 662) > 0 and bit32.band(savingthrow, 0x100000) == 0 then
		EEex_IterateActorEffects(sourceID, function(eData)
			local the_opcode = EEex_ReadDword(eData + 0x10)
			local the_special = EEex_ReadDword(eData + 0x48)
			local the_parent_resource = EEex_ReadLString(eData + 0x94, 8)
			if the_opcode == 401 and the_special == 662 and the_parent_resource == "MECHAI" .. special then
				chainSourceID = EEex_ReadDword(eData + 0x1C)
			end
		end)
	end
	local chainSourceData = EEex_GetActorShare(chainSourceID)
	EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 1,
["resource"] = "MECHAI" .. special,
["source_target"] = sourceID,
["source_id"] = sourceID
})
	EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 401,
["target"] = 2,
["timing"] = 0,
["duration"] = 1,
["parameter1"] = targetID,
["parameter2"] = 1,
["resource"] = parent_resource,
["parent_resource"] = "MECHAI" .. special,
["special"] = 662,
["source_target"] = sourceID,
["source_id"] = sourceID
})
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 9,
["parameter1"] = casterlvl,
["parameter2"] = 2,
["resource"] = spellRES,
["source_x"] = EEex_ReadDword(chainSourceData + 0x8),
["source_y"] = EEex_ReadDword(chainSourceData + 0xC),
["target_x"] = EEex_ReadDword(creatureData + 0x8),
["target_y"] = EEex_ReadDword(creatureData + 0xC),
["source_target"] = targetID,
["source_id"] = chainSourceID
})

end

function MESUMMOD(originatingEffectData, effectData, creatureData)
	local opcode = EEex_ReadDword(effectData + 0xC)
	local power = EEex_ReadDword(effectData + 0x10)
	local parameter1 = EEex_ReadDword(effectData + 0x18)
	local parameter2 = EEex_ReadDword(effectData + 0x1C)
	local special = EEex_ReadDword(effectData + 0x44)
	local school = EEex_ReadDword(effectData + 0x48)
	local resource = EEex_ReadLString(effectData + 0x2C, 8)
	local vvcresource = EEex_ReadLString(effectData + 0x6C, 8)
	local parent_resource = EEex_ReadLString(effectData + 0x90, 8)
--[[
	if opcode == 177 then
		local effResData = EEex_DemandResData(resource, "EFF") + 0x4
		opcode = EEex_ReadDword(effResData + 0xC)
		parameter1 = EEex_ReadDword(effResData + 0x18)
		parameter2 = EEex_ReadDword(effResData + 0x1C)
		special = EEex_ReadDword(effResData + 0x44)
		resource = EEex_ReadLString(effResData + 0x2C, 8)
		vvcresource = EEex_ReadLString(effResData + 0x6C, 8)
	end
--]]
	if opcode ~= 67 and opcode ~= 127 and opcode ~= 331 and resource ~= "MEWI299D" then return false end
	local internal_flags = EEex_ReadDword(effectData + 0xC8)
	if bit32.band(internal_flags, 0x4000000) == 0 then
		local targetID = EEex_ReadDword(creatureData + 0x34)
		local sourceID = EEex_ReadDword(effectData + 0x10C)
		if targetID ~= sourceID or not EEex_IsSprite(targetID) or not EEex_IsSprite(sourceID) then return false end
		local o_spellRES = EEex_ReadLString(originatingEffectData + 0x18, 8)
		local o_spellRES2 = EEex_ReadLString(originatingEffectData + 0x6C, 8)
		local o_spellRES3 = EEex_ReadLString(originatingEffectData + 0x74, 8)
		local o_savingthrow = EEex_ReadDword(originatingEffectData + 0x3C)
		if bit32.band(o_savingthrow, 0x100000) > 0 and parent_resource ~= o_spellRES and parent_resource ~= o_spellRES2 and parent_resource ~= o_spellRES3 then return false end
		if bit32.band(o_savingthrow, 0x200000) > 0 and power > EEex_ReadDword(originatingEffectData + 0x18) then return false end
		if bit32.band(o_savingthrow, 0x400000) > 0 and school ~= EEex_ReadDword(originatingEffectData + 0x1C) then return false end
		local o_special = EEex_ReadDword(originatingEffectData + 0x44)
		if o_special <= 0 then return true end
		local timing = EEex_ReadDword(effectData + 0x20)
		local duration = EEex_ReadDword(effectData + 0x24)
		for i = 2, o_special, 1 do
			if resource == "MEWI299D" then
				timing = 4
				duration = i - 1
			end
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = opcode,
["target"] = EEex_ReadDword(effectData + 0x10),
["power"] = power,
["parameter1"] = parameter1,
["parameter2"] = parameter2,
["timing"] = timing,
["duration"] = duration,
["resource"] = resource,
["dicenumber"] = EEex_ReadDword(effectData + 0x34),
["dicesize"] = EEex_ReadDword(effectData + 0x38),
["savingthrow"] = EEex_ReadDword(effectData + 0x3C),
["savebonus"] = EEex_ReadDword(effectData + 0x40),
["special"] = special,
["school"] = school,
["parameter3"] = EEex_ReadDword(effectData + 0x5C),
["parameter4"] = EEex_ReadDword(effectData + 0x60),
["parameter5"] = EEex_ReadDword(effectData + 0x64),
["vvcresource"] = vvcresource,
["resource2"] = EEex_ReadLString(effectData + 0x74, 8),
["source_x"] = EEex_ReadDword(effectData + 0x7C),
["source_y"] = EEex_ReadDword(effectData + 0x80),
["target_x"] = EEex_ReadDword(effectData + 0x84),
["target_y"] = EEex_ReadDword(effectData + 0x88),
["restype"] = EEex_ReadDword(effectData + 0x8C),
["parent_resource"] = parent_resource,
["resource_flags"] = bit32.band(EEex_ReadDword(effectData + 0x98), 0xFFFFF9FF),
["impact_projectile"] = EEex_ReadDword(effectData + 0x9C),
["sourceslot"] = EEex_ReadDword(effectData + 0xA0),
["effvar"] = EEex_ReadLString(effectData + 0xA4, 32),
["casterlvl"] = EEex_ReadDword(effectData + 0xC4),
["internal_flags"] = bit32.bor(internal_flags, 0x4000000),
["sectype"] = EEex_ReadDword(effectData + 0xCC),
["source_target"] = targetID,
["source_id"] = sourceID
})
		end
	end
	return false
end

function MESTOSEQ(originatingEffectData, effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local opcode = EEex_ReadDword(effectData + 0xC)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local parent_resource = EEex_ReadLString(originatingEffectData + 0x90, 8)
	if (opcode ~= 232 and opcode ~= 256) or parent_resource ~= EEex_ReadLString(effectData + 0x90, 8) then return false end
--	local spellRES = EEex_ReadLString(originatingEffectData + 0x18, 8)
	local parameter1 = EEex_ReadDword(effectData + 0x18)
	local parameter2 = EEex_ReadDword(effectData + 0x1C)
	local special = EEex_ReadDword(effectData + 0x44)
	local sequencerType = 1
	if opcode == 232 then
		if special == 1 then
			sequencerType = 2
		else
			sequencerType = 3
		end
	end
	local resource = EEex_ReadLString(effectData + 0x2C, 8)
	local resource2 = EEex_ReadLString(effectData + 0x6C, 8)
	local resource3 = EEex_ReadLString(effectData + 0x74, 8)
	local casterlvl = EEex_ReadDword(originatingEffectData + 0xC4)
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 401,
["target"] = 2,
["timing"] = 0,
["duration"] = 3600000,
["parameter1"] = sequencerType,
["parameter2"] = 1,
["parameter3"] = parameter1,
["parameter4"] = parameter2,
["resource"] = resource,
["vvcresource"] = resource2,
["resource2"] = resource3,
["casterlvl"] = casterlvl,
["parent_resource"] = parent_resource,
["special"] = 666,
["source_target"] = targetID,
["source_id"] = targetID
})
--[[
	if spellRES ~= "" then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 9,
["parameter1"] = casterlvl,
["parameter2"] = 2,
["resource"] = spellRES,
["source_target"] = targetID,
["source_id"] = targetID
})
	end
--]]
	if opcode == 232 then
		return true
	else
		return false
	end
end

function MECURSCN(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID == 0x0 or sourceID == 0x0 then return end
	local contingencyRES = EEex_ReadLString(effectData + 0x18, 8)
	local duration = EEex_ReadDword(effectData + 0x44)
	local parent_resource = EEex_ReadLString(effectData + 0x90, 8)
	if parent_resource ~= "" then
		local spellType = EEex_ReadWord(EEex_GetSpellData(parent_resource) + 0x1C, 0x0)
		if spellType == 1 then
			duration = math.floor(duration * EEex_GetActorStat(sourceID, 53) / 100)
		elseif spellType == 2 then
			duration = math.floor(duration * EEex_GetActorStat(sourceID, 54) / 100)
		end
	end
	local resources = {"","",""}
	local resourcesIndex = 1
	local target = 0
	local condition = 0
	local found_it = false
	EEex_IterateActorEffects(sourceID, function(eData)
		local the_opcode = EEex_ReadDword(eData + 0x10)
		local the_special = EEex_ReadDword(eData + 0x48)
		local the_parent_resource = EEex_ReadLString(eData + 0x94, 8)
		if the_opcode == 401 and the_special == 666 and the_parent_resource == contingencyRES and found_it == false then
			found_it = true
			target = EEex_ReadDword(eData + 0x60)
			condition = EEex_ReadDword(eData + 0x64)
			local the_resource = EEex_ReadLString(eData + 0x30, 8)
			local the_resource2 = EEex_ReadLString(eData + 0x70, 8)
			local the_resource3 = EEex_ReadLString(eData + 0x78, 8)
			if resourcesIndex <= 3 and the_resource ~= "" then
				resources[resourcesIndex] = the_resource
				resourcesIndex = resourcesIndex + 1
			end
			if resourcesIndex <= 3 and the_resource2 ~= "" then
				resources[resourcesIndex] = the_resource2
				resourcesIndex = resourcesIndex + 1
			end
			if resourcesIndex <= 3 and the_resource3 ~= "" then
				resources[resourcesIndex] = the_resource3
				resourcesIndex = resourcesIndex + 1
			end
			EEex_WriteDword(eData + 0x28, EEex_ReadDword(eData + 0x6C))
		end
	end)	
--	if target == 2 then
--		target = 3
--	end
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 1,
["resource"] = "MECURSCN",
["source_target"] = targetID,
["source_id"] = sourceID
})
	if resources[1] ~= "" then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 232,
["target"] = 2,
["parameter1"] = target,
["parameter2"] = condition,
["timing"] = 0,
["duration"] = duration,
["resource"] = resources[1],
["vvcresource"] = resources[2],
["resource2"] = resources[3],
["parent_resource"] = "MECURSCN",
["source_target"] = targetID,
["source_id"] = sourceID
})
	end
--[[
	EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 1,
["duration"] = 1,
["resource"] = contingencyRES,
["source_target"] = sourceID,
["source_id"] = sourceID
})
--]]
end

-- Returns the actor's current area resref as a string.
-- If the game was just loaded, sometimes the actor doesn't know what
--  area they're in yet, so it'll return "" in that case.
function EEex_GetActorAreaRes(actorID)
	local share = EEex_GetActorShare(actorID)
	if share > 0 and EEex_ReadDword(EEex_GetActorShare(actorID) + 0x14) > 0 then
		return EEex_ReadLString(EEex_ReadDword(EEex_GetActorShare(actorID) + 0x14), 0x8)
	else
		return ""
	end
end

-- Returns true if the actor is a creature.
-- Returns false if the actor is BALDUR.BCS, an area script, a door, a container, or a region.
-- For example, if you get the sourceID of an effect of a fireball from a trap, and you
--  do EEex_IsSprite(sourceID), it will return false.
-- If the source had been a mage casting a fireball, it would've returned true.
function EEex_IsSprite(actorID, allowDead)
	-- EEex uses 0x0 as an "invalid" actorID return value, but it actually
	-- points to a valid object - (not a sprite, though, so return false).
	if actorID ~= 0x0 and actorID ~= -0x1 then
		local share = EEex_GetActorShare(actorID)
		if share > 0x0 and EEex_ReadByte(share + 0x4, 0) == 0x31 then
			return allowDead or bit32.band(EEex_ReadDword(share + 0x434), 0xFC0) == 0x0
		end
	end
	return false
end

dead_id_list = {}
function MEDEADID(effectData, creatureData)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if sourceID ~= 1 and bit32.band(EEex_ReadDword(creatureData + 0x424), 0x2) == 0 then
		EEex_IterateActorEffects(targetID, function(eData)
			local the_opcode = EEex_ReadDword(eData + 0x10)
			local the_resource = EEex_ReadLString(eData + 0x30, 8)
			if the_opcode == 402 and the_resource == "MEDEADID" then
				EEex_WriteDword(eData + 0x110, 1)
			end
		end)
		dead_id_list["" .. targetID] = targetID
	end
end
nonliving_race = {["108"] = 1, ["115"] = 1, ["121"] = 1, ["125"] = 1, ["126"] = 1, ["128"] = 1, ["132"] = 1, ["133"] = 1, ["134"] = 1, ["136"] = 1, ["139"] = 1, ["141"] = 1, ["144"] = 1, ["145"] = 1, ["147"] = 1, ["148"] = 1, ["149"] = 1, ["150"] = 1, ["155"] = 1, ["156"] = 1, ["157"] = 1, ["158"] = 1, ["159"] = 1, ["173"] = 1, ["175"] = 1, ["180"] = 1, ["181"] = 1, ["201"] = 1, ["202"] = 1, ["203"] = 1, ["204"] = 1, ["205"] = 1, ["206"] = 1, ["207"] = 1, ["208"] = 1, ["209"] = 1, ["210"] = 1, ["211"] = 1, ["212"] = 1, ["213"] = 1, ["214"] = 1, ["215"] = 1, ["255"] = 1}
function MEREANIM(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if not EEex_IsSprite(sourceID, false) then return end
--	local duration = EEex_ReadDword(effectData + 0x44)
	local parent_resource = EEex_ReadLString(effectData + 0x90, 8)
--[[
	if parent_resource ~= "" then
		local spellType = EEex_ReadWord(EEex_GetSpellData(parent_resource) + 0x1C, 0x0)
		if spellType == 1 then
			duration = math.floor(duration * EEex_GetActorStat(sourceID, 53) / 100)
		elseif spellType == 2 then
			duration = math.floor(duration * EEex_GetActorStat(sourceID, 54) / 100)
		end
	end
--]]
	local spellRES = EEex_ReadLString(effectData + 0x18, 8)
	local savingthrow = EEex_ReadDword(effectData + 0x3C)
	local getHighestLevel = (bit32.band(savingthrow, 0x100000) > 0)
	local ignoreHigherLevel = (bit32.band(savingthrow, 0x200000) > 0)
	local includeNonliving = (bit32.band(savingthrow, 0x800000) > 0)
	local maxDistance = EEex_ReadDword(effectData + 0x44)
	local casterlvl = EEex_ReadDword(effectData + 0xC4)
	local targetX = EEex_ReadDword(effectData + 0x84)
	local targetY = EEex_ReadDword(effectData + 0x88)
	local areaActorIDList = dead_id_list
	local actorX = 0
	local actorY = 0
	local currentShare = 0
	local currentStates = 0
	local currentDistance = 0
	local shortestDistance = 32767
	local currentLevel = 0
	local highestLevel = 0
	local chosenID = 0
	for k, v in pairs(areaActorIDList) do
		if EEex_IsSprite(v, true) then
			currentShare = EEex_GetActorShare(v)
			actorX = EEex_ReadDword(currentShare + 0x8)
			actorY = EEex_ReadDword(currentShare + 0xC)
			currentStates = EEex_ReadDword(currentShare + 0x434)
			if bit32.band(currentStates, 0xE00) > 0 and bit32.band(currentStates, 0xC0) == 0 and (bit32.band(currentStates, 0x100) == 0 or EEex_ReadDword(currentShare + 0x43C) > 1000) and (includeNonliving or (EEex_GetActorGeneral(v) ~= 4 and nonliving_race["" .. EEex_GetActorRace(v)] == nil)) then
				currentDistance = EEex_GetDistance(targetX, targetY, actorX, actorY)
				currentLevel = EEex_ReadByte(currentShare + 0x648, 0x0)
				if EEex_GetActorAreaRes(sourceID) == EEex_GetActorAreaRes(v) and (maxDistance <= 0 or currentDistance <= maxDistance) and (currentDistance < shortestDistance or (getHighestLevel and currentLevel > highestLevel)) and (ignoreHigherLevel == false or currentLevel <= casterlvl) and (getHighestLevel == false or highestLevel <= currentLevel) then
					shortestDistance = currentDistance
					highestLevel = currentLevel
					chosenID = v
				end
			end
		end
	end
	if chosenID > 0 then
		currentShare = EEex_GetActorShare(chosenID)
		currentStates = EEex_ReadDword(currentShare + 0x434)
		EEex_WriteDword(currentShare + 0x434, bit32.band(currentStates, 0xFFFFFEFF)) 
		EEex_WriteDword(currentShare + 0xB30, bit32.band(EEex_ReadDword(currentShare + 0xB30), 0xFFFFFEFF)) 
		EEex_WriteWord(currentShare + 0x438, 0)
		EEex_ApplyEffectToActor(chosenID, {
["opcode"] = 32,
["target"] = 2,
["parameter2"] = 0,
["timing"] = 1,
["parent_resource"] = parent_resource,
["source_target"] = chosenID,
["source_id"] = sourceID
})
		EEex_ApplyEffectToActor(chosenID, {
["opcode"] = 17,
["target"] = 2,
["parameter1"] = 100,
["parameter2"] = 2,
["timing"] = 1,
["parent_resource"] = parent_resource,
["source_target"] = chosenID,
["source_id"] = sourceID
})
		EEex_ApplyEffectToActor(chosenID, {
["opcode"] = 72,
["target"] = 2,
["parameter1"] = 4,
["parameter2"] = 1,
["timing"] = 1,
["parent_resource"] = parent_resource,
["source_target"] = chosenID,
["source_id"] = sourceID
})
		EEex_ApplyEffectToActor(chosenID, {
["opcode"] = 72,
["target"] = 2,
["parameter1"] = 4,
["parameter2"] = 1,
["timing"] = 1,
["parent_resource"] = parent_resource,
["source_target"] = chosenID,
["source_id"] = sourceID
})
		EEex_ApplyEffectToActor(chosenID, {
["opcode"] = 82,
["target"] = 2,
["parameter2"] = 0,
["timing"] = 1,
["resource"] = "MENOBCS",
["parent_resource"] = parent_resource,
["source_target"] = chosenID,
["source_id"] = sourceID
})
		EEex_ApplyEffectToActor(chosenID, {
["opcode"] = 82,
["target"] = 2,
["parameter2"] = 1,
["timing"] = 1,
["resource"] = "MENOBCS",
["parent_resource"] = parent_resource,
["source_target"] = chosenID,
["source_id"] = sourceID
})
		EEex_ApplyEffectToActor(chosenID, {
["opcode"] = 82,
["target"] = 2,
["parameter2"] = 2,
["timing"] = 1,
["resource"] = "MENOBCS",
["parent_resource"] = parent_resource,
["source_target"] = chosenID,
["source_id"] = sourceID
})
		EEex_ApplyEffectToActor(chosenID, {
["opcode"] = 82,
["target"] = 2,
["parameter2"] = 4,
["timing"] = 1,
["resource"] = "MENOBCS",
["parent_resource"] = parent_resource,
["source_target"] = chosenID,
["source_id"] = sourceID
})
		EEex_ApplyEffectToActor(chosenID, {
["opcode"] = 82,
["target"] = 2,
["parameter2"] = 5,
["timing"] = 1,
["resource"] = "MENOBCS",
["parent_resource"] = parent_resource,
["source_target"] = chosenID,
["source_id"] = sourceID
})
		EEex_ApplyEffectToActor(chosenID, {
["opcode"] = 82,
["target"] = 2,
["parameter2"] = 6,
["timing"] = 1,
["resource"] = "MENOBCS",
["parent_resource"] = parent_resource,
["source_target"] = chosenID,
["source_id"] = sourceID
})
		EEex_ApplyEffectToActor(chosenID, {
["opcode"] = 82,
["target"] = 2,
["parameter2"] = 7,
["timing"] = 1,
["resource"] = "MENOBCS",
["parent_resource"] = parent_resource,
["source_target"] = chosenID,
["source_id"] = sourceID
})
		EEex_ApplyEffectToActor(chosenID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 9,
["resource"] = "MEREANEA",
["source_target"] = chosenID,
["source_id"] = sourceID
})
		local reanimatedEA = 5
		local sourceEA = EEex_GetActorAllegiance(sourceID)
		if sourceEA >= 28 then
			reanimatedEA = sourceEA
		end
		EEex_ApplyEffectToActor(chosenID, {
["opcode"] = 72,
["target"] = 2,
["parameter1"] = reanimatedEA,
["parameter2"] = 0,
["timing"] = 9,
["parent_resource"] = "MEREANEA",
["source_target"] = chosenID,
["source_id"] = sourceID
})
		if spellRES ~= "" then
			EEex_ApplyEffectToActor(chosenID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 9,
["parameter1"] = casterlvl,
["parameter2"] = 2,
["resource"] = spellRES,
["source_target"] = chosenID,
["source_id"] = sourceID
})
		end
	end
end

function METURNSG(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if EEex_GetActorModalState(targetID) ~= 4 then return end
	local turnUndeadLevel = 0
	local class = EEex_GetActorClass(targetID)
	if class == 3 or class == 14 or class == 15 or class == 18 then
		turnUndeadLevel = EEex_GetActorStat(targetID, 34)
	elseif class == 8 then
		turnUndeadLevel = EEex_GetActorStat(targetID, 68)
	elseif class == 17 then
		turnUndeadLevel = EEex_GetActorStat(targetID, 69)
	elseif class == 6 then
		turnUndeadLevel = EEex_GetActorStat(targetID, 34) - 2
	end
	if turnUndeadLevel >= 2 then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 9,
["parameter1"] = math.floor(turnUndeadLevel / 2),
["parameter2"] = 2,
["resource"] = "METURNSG",
["source_target"] = targetID,
["source_id"] = targetID
})
	end

end

function MERECALL(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local sourceData = EEex_GetActorShare(sourceID)
	local areaRES = EEex_GetActorAreaRes(sourceID)
	if areaRES == "" then return end
	local theareatype = 0
	if EEex_ReadDword(EEex_GetActorShare(sourceID) + 0x14) > 0 then
		theareatype = EEex_ReadWord(EEex_ReadDword(EEex_GetActorShare(sourceID) + 0x14) + 0x40, 0x0)
	end
	if bit32.band(theareatype, 0x800) > 0 then return end
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 215,
["target"] = 2,
["timing"] = 1,
["parameter1"] = 0,
["parameter2"] = 0,
["resource"] = "DDOORH",
["source_x"] = EEex_ReadDword(sourceData + 0x8),
["source_y"] = EEex_ReadDword(sourceData + 0xC),
["target_x"] = EEex_ReadDword(creatureData + 0x8),
["target_y"] = EEex_ReadDword(creatureData + 0xC),
["source_target"] = targetID,
["source_id"] = sourceID
})
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 186,
["target"] = 2,
["timing"] = 0,
["parameter1"] = EEex_ReadDword(effectData + 0x44),
["parameter2"] = 0,
["resource"] = areaRES,
["source_x"] = EEex_ReadDword(sourceData + 0x8),
["source_y"] = EEex_ReadDword(sourceData + 0xC),
["target_x"] = EEex_ReadDword(sourceData + 0x8),
["target_y"] = EEex_ReadDword(sourceData + 0xC),
["source_target"] = targetID,
["source_id"] = sourceID
})
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 222,
["target"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["parameter1"] = 0,
["parameter2"] = 0,
["source_x"] = EEex_ReadDword(sourceData + 0x8),
["source_y"] = EEex_ReadDword(sourceData + 0xC),
["target_x"] = EEex_ReadDword(sourceData + 0x8),
["target_y"] = EEex_ReadDword(sourceData + 0xC),
["source_target"] = targetID,
["source_id"] = sourceID
})
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 215,
["target"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["parameter1"] = 0,
["parameter2"] = 0,
["resource"] = "DDOORH",
["source_x"] = EEex_ReadDword(sourceData + 0x8),
["source_y"] = EEex_ReadDword(sourceData + 0xC),
["target_x"] = EEex_ReadDword(creatureData + 0x8),
["target_y"] = EEex_ReadDword(creatureData + 0xC),
["source_target"] = targetID,
["source_id"] = sourceID
})
end
me_past_seconds = {}
me_past_seconds_count = 60
me_past_effects = {}
function METIMELG(effectData, creatureData)
	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local time_applied = EEex_ReadDword(effectData + 0x24)
	local me_current_effects = {}
	EEex_IterateActorEffects(targetID, function(eData)
		local the_opcode = EEex_ReadDword(eData + 0x10)
		local the_timing = EEex_ReadDword(eData + 0x24)
		local the_duration = EEex_ReadDword(eData + 0x28)
		local the_internal_flags = EEex_ReadDword(eData + 0xCC)
--[[
		if EEex_ReadLString(eData + 0x94, 8) == "SPPR406" then
			Infinity_DisplayString("the_duration: " .. the_duration .. ", time_applied: " .. time_applied)
		end
--]]
		if the_timing ~= 1 and the_timing ~= 2 and the_timing ~= 9 and the_opcode ~= 124 and the_opcode ~= 402 and ((the_duration - time_applied < 15 and bit32.band(the_internal_flags, 0x200000) == 0) or the_opcode == 159 or the_opcode == 218 or the_opcode == 366) then
			EEex_WriteDword(eData + 0xCC, bit32.bor(the_internal_flags, 0x200000))
			table.insert(me_current_effects, {
["opcode"] = EEex_ReadDword(eData + 0x10),
["target"] = EEex_ReadDword(eData + 0x14),
["power"] = EEex_ReadDword(eData + 0x18),
["parameter1"] = EEex_ReadDword(eData + 0x1C),
["parameter2"] = EEex_ReadDword(eData + 0x20),
["timing"] = EEex_ReadDword(eData + 0x24),
["duration"] = EEex_ReadDword(eData + 0x28),
["resource"] = EEex_ReadLString(eData + 0x30, 8),
["dicenumber"] = EEex_ReadDword(eData + 0x38),
["dicesize"] = EEex_ReadDword(eData + 0x3C),
["savingthrow"] = EEex_ReadDword(eData + 0x40),
["savebonus"] = EEex_ReadDword(eData + 0x44),
["special"] = EEex_ReadDword(eData + 0x48),
["school"] = EEex_ReadDword(eData + 0x4C),
["parameter3"] = EEex_ReadDword(eData + 0x60),
["parameter4"] = EEex_ReadDword(eData + 0x64),
["parameter5"] = EEex_ReadDword(eData + 0x68),
["time_applied"] = EEex_ReadDword(eData + 0x6C),
["vvcresource"] = EEex_ReadLString(eData + 0x70, 8),
["resource2"] = EEex_ReadLString(eData + 0x78, 8),
["source_x"] = EEex_ReadDword(eData + 0x80),
["source_y"] = EEex_ReadDword(eData + 0x84),
["target_x"] = EEex_ReadDword(eData + 0x88),
["target_y"] = EEex_ReadDword(eData + 0x8C),
["restype"] = EEex_ReadDword(eData + 0x90),
["parent_resource"] = EEex_ReadLString(eData + 0x94, 8),
["resource_flags"] = bit32.band(EEex_ReadDword(eData + 0x9C), 0xFFFFF9FF),
["impact_projectile"] = EEex_ReadDword(eData + 0xA0),
["sourceslot"] = EEex_ReadDword(eData + 0xA4),
["effvar"] = EEex_ReadLString(eData + 0xA8, 32),
["casterlvl"] = EEex_ReadDword(eData + 0xC8),
["internal_flags"] = the_internal_flags,
["sectype"] = EEex_ReadDword(eData + 0xD0),
["source_id"] = EEex_ReadDword(eData + 0x110),
})
		end
	end)
	if me_past_seconds["" .. targetID] == nil or (me_past_seconds["" .. targetID][1][6] ~= nil and me_past_seconds["" .. targetID][1][6] > time_applied) then
		me_past_seconds["" .. targetID] = {{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{}}
		
	end
	for i = me_past_seconds_count, 2, -1 do
		me_past_seconds["" .. targetID][i] = me_past_seconds["" .. targetID][i - 1]
	end
--[[
	Infinity_DisplayString(#me_current_effects)
	if #me_current_effects > 0 then
		Infinity_DisplayString(me_current_effects[1]["parent_resource"])
	end
--]]
	me_past_seconds["" .. targetID][1] = {EEex_ReadSignedWord(creatureData + 0x438, 0x0), EEex_ReadDword(creatureData + 0x8), EEex_ReadDword(creatureData + 0xC), EEex_GetActorAreaRes(targetID), me_current_effects, time_applied}
end

function METIMETR(effectData, creatureData)
	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local parameter1 = EEex_ReadDword(effectData + 0x18)
	local time_applied = EEex_ReadDword(effectData + 0x24)
	local parent_resource = EEex_ReadLString(effectData + 0x90, 8)
	local previous_second = {}
	local game_tick = EEex_GetGameTick()
	if parameter1 <= 0 then return end
	if parameter1 > me_past_seconds_count then
		parameter1 = me_past_seconds_count
	end
--	local current_past_seconds = me_past_seconds
	if me_past_seconds["" .. targetID] == nil then
		me_past_seconds["" .. targetID] = {{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{}}
	end
--	me_past_effects["" .. targetID] = {}
	local theareares = EEex_GetActorAreaRes(targetID)
	local theareatype = 0x800
	if EEex_ReadDword(EEex_GetActorShare(targetID) + 0x14) > 0 then
		theareatype = EEex_ReadWord(EEex_ReadDword(EEex_GetActorShare(targetID) + 0x14) + 0x40, 0x0)
	end
	local currentHP = EEex_ReadSignedWord(creatureData + 0x434, 0x0)
	local currentX = EEex_ReadDword(creatureData + 0x8)
	local currentY = EEex_ReadDword(creatureData + 0xC)
	local seconds_ago = 0
	local the_effect = {}
	local effect_opcode = 0
	local effect_duration = 0
	local effect_timing = 0
	for i = 1, parameter1, 1 do
		if #me_past_seconds["" .. targetID][i] > 0 then
			seconds_ago = seconds_ago + 1
		end
	end
	for i = 1, parameter1, 1 do
		previous_second = me_past_seconds["" .. targetID][1]
		for j = 1, me_past_seconds_count - 1, 1 do
			me_past_seconds["" .. targetID][j] = me_past_seconds["" .. targetID][j + 1]
		end
		me_past_seconds["" .. targetID][me_past_seconds_count] = {}
--		me_past_effects["" .. targetID]["" .. i] = previous_second[5]
		if #previous_second > 0 then
--			Infinity_DisplayString(i .. " second(s) before: " .. previous_second[1] .. " HP, [" .. previous_second[2] .. "." .. previous_second[3] .. "], " .. previous_second[4]) 
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 17,
["target"] = 2,
["timing"] = 6,
["duration"] = game_tick + i,
["parameter1"] = previous_second[1],
["parameter2"] = 1,
["parent_resource"] = parent_resource,
["internal_flags"] = 0x600000,
["source_target"] = targetID,
["source_id"] = targetID
})
			currentHP = previous_second[1]
			if bit32.band(theareatype, 0x800) == 0 and theareares ~= "" and theareares == previous_second[4] then
				EEex_ApplyEffectToActor(targetID, {
["opcode"] = 148,
["target"] = 2,
["timing"] = 6,
["duration"] = game_tick + i,
["parameter1"] = 1,
["parameter2"] = 2,
["resource"] = "MEINTELE",
["parent_resource"] = parent_resource,
["source_x"] = currentX,
["source_y"] = currentY,
["target_x"] = previous_second[2],
["target_y"] = previous_second[3],
["internal_flags"] = 0x600000,
["source_target"] = targetID,
["source_id"] = targetID
})
--				currentX = previous_second[2]
--				currentY = previous_second[3]
			end
			for j = 1, #previous_second[5], 1 do
				the_effect = previous_second[5][j]
				effect_opcode = the_effect["opcode"]
				effect_timing = the_effect["timing"]
				effect_duration = the_effect["duration"]
				if the_effect["time_applied"] + seconds_ago * 15 < time_applied and (effect_duration < time_applied or (effect_opcode == 218 and the_effect["parameter1"] > 0 and EEex_GetActorStat(targetID, 88) == 0) or (effect_opcode == 159 and the_effect["parameter1"] > 0 and bit32.band(EEex_ReadDword(creatureData + 0x434), 0x40000000) == 0 and bit32.band(EEex_ReadDword(creatureData + 0xB30), 0x40000000) == 0)) then
					
					if effect_timing == 4096 then
						effect_timing = 10
						effect_duration = the_effect["duration"] - time_applied + (seconds_ago * 15)
					else
						effect_duration = game_tick + the_effect["duration"] - time_applied + (seconds_ago * 15)
					end		
					EEex_ApplyEffectToActor(targetID, {
["opcode"] = the_effect["opcode"],
["target"] = the_effect["target"],
["power"] = the_effect["power"],
["parameter1"] = the_effect["parameter1"],
["parameter2"] = the_effect["parameter2"],
["timing"] = effect_timing,
["duration"] = effect_duration,
["resource"] = the_effect["resource"],
["dicenumber"] = the_effect["dicenumber"],
["dicesize"] = the_effect["dicesize"],
["savingthrow"] = the_effect["savingthrow"],
["savebonus"] = the_effect["savebonus"],
["special"] = the_effect["special"],
["school"] = the_effect["school"],
["parameter3"] = the_effect["parameter3"],
["parameter4"] = the_effect["parameter4"],
["parameter5"] = the_effect["parameter5"],
["vvcresource"] = the_effect["vvcresource"],
["resource2"] = the_effect["resource2"],
["source_x"] = the_effect["source_x"],
["source_y"] = the_effect["source_y"],
["target_x"] = the_effect["target_x"],
["target_y"] = the_effect["target_y"],
["restype"] = the_effect["restype"],
["parent_resource"] = the_effect["parent_resource"],
["resource_flags"] = the_effect["resource_flags"],
["impact_projectile"] = the_effect["impact_projectile"],
["sourceslot"] = the_effect["sourceslot"],
["effvar"] = the_effect["effvar"],
["casterlvl"] = the_effect["casterlvl"],
["internal_flags"] = bit32.bor(the_effect["internal_flags"], 0x600000),
["sectype"] = the_effect["sectype"],
["source_id"] = the_effect["source_id"],
})

				elseif (effect_opcode == 218 or effect_opcode == 159) and the_effect["parameter1"] > 0 then
					EEex_IterateActorEffects(targetID, function(eData)
						local the_opcode = EEex_ReadDword(eData + 0x10)
						if the_opcode == effect_opcode then
							EEex_WriteDword(eData + 0x1C, the_effect["parameter1"])
						end
					end)
				end

			end
--[[
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 402,
["target"] = 2,
["timing"] = 6,
["duration"] = game_tick + i,
["parameter1"] = i,
["parameter2"] = time_applied,
["special"] = game_tick,
["resource"] = "METIMEEF",
["parent_resource"] = parent_resource,
["source_target"] = targetID,
["source_id"] = targetID
})
--]]
		end
	end

	if seconds_ago > 0 then

		EEex_IterateActorEffects(targetID, function(eData)
			local the_opcode = EEex_ReadDword(eData + 0x10)
			local the_timing = EEex_ReadDword(eData + 0x24)
			local the_parent_resource = EEex_ReadLString(eData + 0x94, 8)
			local the_internal_flags = EEex_ReadDword(eData + 0xCC)
			local the_time_applied = EEex_ReadDword(eData + 0x6C)
			if the_time_applied < time_applied and the_timing ~= 1 and the_timing ~= 2 and the_timing ~= 9 and the_parent_resource ~= parent_resource and the_opcode ~= 402 and bit32.band(the_internal_flags, 0x400000) == 0 then
				local the_duration = EEex_ReadDword(eData + 0x28)
				the_duration = the_duration + (seconds_ago * 15)
				the_time_applied = the_time_applied + (seconds_ago * 15)
				EEex_WriteDword(eData + 0x28, the_duration)
				EEex_WriteDword(eData + 0x6C, the_time_applied)
				if the_time_applied >= time_applied then
					EEex_WriteDword(eData + 0x28, 0)
					EEex_WriteDword(eData + 0x114, 1)
				end
			end
		end)

	end
end

function MESTEALS(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local parameter1 = EEex_ReadDword(effectData + 0x18)
	if parameter1 > 0 then
		parameter1 = parameter1 + math.floor(EEex_GetActorStat(sourceID, 29) / 50)
	end
	local parameter2 = EEex_ReadDword(effectData + 0x1C)
	local savingthrow = EEex_ReadDword(effectData + 0x3C)
	local processWizardSpells = (bit32.band(savingthrow, 0x10000) == 0)
	local processPriestSpells = (bit32.band(savingthrow, 0x20000) == 0)
--	local lowestLevelFirst = (bit32.band(savingthrow, 0x40000) > 0)
	local subtractSpells = (bit32.band(savingthrow, 0x80000) > 0)
	local onePerSchool = (bit32.band(savingthrow, 0x100000) > 0)
	local matchSpecificSpell = (bit32.band(savingthrow, 0x200000) > 0)
	local ignoreSpecificSpell = (bit32.band(savingthrow, 0x400000) > 0)
	local printFeedback = (bit32.band(savingthrow, 0x800000) > 0)
	local targetClass = EEex_GetActorClass(targetID)
	local isSorcererClass = (targetClass == 19 or targetClass == 21)
	if ex_wizard_classes[targetClass] ~= 1 then
		processWizardSpells = false
	end
	if ex_priest_classes[targetClass] ~= 1 then
		processPriestSpells = false
	end
	local parent_resource = EEex_ReadLString(effectData + 0x90, 8)
	local matchSpell = EEex_ReadLString(effectData + 0x6C, 8)
	if matchSpell == "" then
		matchSpell = parent_resource
	end
	local ignoreSpell = EEex_ReadLString(effectData + 0x74, 8)
	if ignoreSpell == "" then
		ignoreSpell = parent_resource
	end
	local special = EEex_ReadDword(effectData + 0x44)
	local parameter3 = EEex_ReadDword(effectData + 0x5C)
	local schools_found = {false, false, false, false, false, false, false, false}
	if parameter3 > 0 then 
		for i = 1, 8, 1 do
			if bit32.band(parameter3, 2 ^ i) > 0 then
				schools_found[i] = true
			end
		end
	end
	local numFound = 0
	local numLeft = 0
	if parameter2 < 0 then
		parameter2 = 1
	elseif parameter2 > 9 then
		parameter2 = 9
	end
	if special < 0 then
		special = 1
	elseif special > parameter2 then
		special = parameter2
	end

	local increment = -1
--[[
	if lowestLevelFirst then
		local temp = parameter2
		parameter2 = special
		special = temp
		increment = 1
	end
--]]
	local levelsFound = {0, 0, 0, 0, 0, 0, 0, 0, 0}
	local sorcererSpellsFound = {}
	local sorcererSpellMax = 0
	for i = parameter2, special, increment do
		sorcererSpellsFound = {}
		numLeft = parameter1 - numFound
		sorcererSpellMax = 0
		if processWizardSpells then 
			EEex_ProcessWizardMemorization(targetID, function(level, resrefLocation)
				if level == i then
					local resref = EEex_ReadLString(resrefLocation, 8)
					if sorcererSpellsFound[resref] == nil then	
						sorcererSpellsFound[resref] = 1
					else
						sorcererSpellsFound[resref] = sorcererSpellsFound[resref] + 1
					end
					local flags = EEex_ReadWord(resrefLocation + 0x8, 0x0)
					local spellMemorized = (bit32.band(flags, 0x1) > 0)
					if parameter2 >= level and ((spellMemorized and subtractSpells) or (spellMemorized == false and subtractSpells == false)) and (matchSpecificSpell == false or matchSpell == resref or isSorcererClass) and (ignoreSpecificSpell == false or ignoreSpell ~= resref or isSorcererClass) then
						local spellData = EEex_GetSpellData(resref)
						if spellData ~= 0 then
							local spellSchool = EEex_ReadByte(spellData + 0x25, 0x0)
							if (parameter1 <= 0 or ((isSorcererClass == false or sorcererSpellsFound[resref] <= numLeft) and (isSorcererClass or numFound < parameter1))) and ((onePerSchool == false and parameter3 == 0) or (schools_found[spellSchool] ~= nil and schools_found[spellSchool] == false)) then
								if onePerSchool then 
									schools_found[spellSchool] = true
								end
								if subtractSpells then
									EEex_WriteWord(resrefLocation + 0x8, bit32.band(flags, 0xFFFE))
								else
									EEex_WriteWord(resrefLocation + 0x8, bit32.bor(flags, 0x1))
								end
								if isSorcererClass then
									if sorcererSpellsFound[resref] > sorcererSpellMax then
										sorcererSpellMax = sorcererSpellsFound[resref]
										levelsFound[i] = sorcererSpellsFound[resref]
									end
								else
									numFound = numFound + 1
									levelsFound[i] = levelsFound[i] + 1
								end
							end
						end
					end
				end
			end)
		end
		numFound = numFound + sorcererSpellMax
		sorcererSpellsFound = {}
		numLeft = parameter1 - numFound
		sorcererSpellMax = 0
		if i <= 7 and processPriestSpells then 
			EEex_ProcessClericMemorization(targetID, function(level, resrefLocation)
				if level == i then
					local resref = EEex_ReadLString(resrefLocation, 8)
					if sorcererSpellsFound[resref] == nil then	
						sorcererSpellsFound[resref] = 1
					else
						sorcererSpellsFound[resref] = sorcererSpellsFound[resref] + 1
					end
					local flags = EEex_ReadWord(resrefLocation + 0x8, 0x0)
					local spellMemorized = (bit32.band(flags, 0x1) > 0)
					if parameter2 >= level and ((spellMemorized and subtractSpells) or (spellMemorized == false and subtractSpells == false)) and (matchSpecificSpell == false or matchSpell == resref or isSorcererClass) and (ignoreSpecificSpell == false or ignoreSpell ~= resref or isSorcererClass) then
						local spellData = EEex_GetSpellData(resref)
						if spellData ~= 0 then
							local spellSchool = EEex_ReadByte(spellData + 0x25, 0x0)
							if (parameter1 <= 0 or ((isSorcererClass == false or sorcererSpellsFound[resref] <= numLeft) and (isSorcererClass or numFound < parameter1))) and ((onePerSchool == false and parameter3 == 0) or (schools_found[spellSchool] ~= nil and schools_found[spellSchool] == false)) then
								if onePerSchool then 
									schools_found[spellSchool] = true
								end
								if subtractSpells then
									EEex_WriteWord(resrefLocation + 0x8, bit32.band(flags, 0xFFFE))
								else
									EEex_WriteWord(resrefLocation + 0x8, bit32.bor(flags, 0x1))
								end
								if isSorcererClass then
									if sorcererSpellsFound[resref] > sorcererSpellMax then
										sorcererSpellMax = sorcererSpellsFound[resref]
										levelsFound[i] = sorcererSpellsFound[resref]
									end
								else
									numFound = numFound + 1
									levelsFound[i] = levelsFound[i] + 1
								end
							end
						end
					end
				end
			end)
		end
		numFound = numFound + sorcererSpellMax
	end
	EEex_WriteDword(effectData + 0x110, 1)
	for j = 1, 9, 1 do
		if levelsFound[j] > 0 then
			EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 402,
["target"] = 2,
["timing"] = 0,
["parameter1"] = levelsFound[j],
["parameter2"] = j,
["savingthrow"] = 0x400000,
["special"] = 1,
["resource"] = "EXMODMEM",
["parent_resource"] = parent_resource,
["source_target"] = sourceID,
["source_id"] = sourceID
})
		end
	end
--[[
	for i = parameter2, special, increment do
		sorcererSpellsFound = {}
		numFound = 0
		for j = 9, i, -1 do
		end
		numLeft = parameter1 - numFound
		sorcererSpellMax = 0
		if processWizardSpells then 
			EEex_ProcessWizardMemorization(sourceID, function(level, resrefLocation)
				if level == i then
					local resref = EEex_ReadLString(resrefLocation, 8)
					if sorcererSpellsFound[resref] == nil then	
						sorcererSpellsFound[resref] = 1
					else
						sorcererSpellsFound[resref] = sorcererSpellsFound[resref] + 1
					end
					local flags = EEex_ReadWord(resrefLocation + 0x8, 0x0)
					local spellMemorized = (bit32.band(flags, 0x1) > 0)
					if parameter2 >= level and ((spellMemorized and subtractSpells) or (spellMemorized == false and subtractSpells == false)) and (matchSpecificSpell == false or matchSpell == resref or isSorcererClass) and (ignoreSpecificSpell == false or ignoreSpell ~= resref or isSorcererClass) then
						local spellData = EEex_GetSpellData(resref)
						if spellData ~= 0 then
							local spellSchool = EEex_ReadByte(spellData + 0x25, 0x0)
							if (parameter1 <= 0 or ((isSorcererClass == false or sorcererSpellsFound[resref] <= numLeft) and (isSorcererClass or numFound < parameter1))) and ((onePerSchool == false and parameter3 == 0) or (schools_found[spellSchool] ~= nil and schools_found[spellSchool] == false)) then
								if onePerSchool then 
									schools_found[spellSchool] = true
								end
								if subtractSpells then
									EEex_WriteWord(resrefLocation + 0x8, bit32.band(flags, 0xFFFE))
								else
									EEex_WriteWord(resrefLocation + 0x8, bit32.bor(flags, 0x1))
								end
								if isSorcererClass then
									if sorcererSpellsFound[resref] > sorcererSpellMax then
										sorcererSpellMax = sorcererSpellsFound[resref]
										levelsFound[i] = sorcererSpellsFound[resref]
									end
								else
									numFound = numFound + 1
									levelsFound[i] = levelsFound[i] + 1
								end
							end
						end
					end
				end
			end)
		end
		numFound = numFound + sorcererSpellMax
		sorcererSpellsFound = {}
		numLeft = parameter1 - numFound
		sorcererSpellMax = 0
		if i <= 7 and processPriestSpells then 
			EEex_ProcessClericMemorization(sourceID, function(level, resrefLocation)
				if level == i then
					local resref = EEex_ReadLString(resrefLocation, 8)
					if sorcererSpellsFound[resref] == nil then	
						sorcererSpellsFound[resref] = 1
					else
						sorcererSpellsFound[resref] = sorcererSpellsFound[resref] + 1
					end
					local flags = EEex_ReadWord(resrefLocation + 0x8, 0x0)
					local spellMemorized = (bit32.band(flags, 0x1) > 0)
					if parameter2 >= level and ((spellMemorized and subtractSpells) or (spellMemorized == false and subtractSpells == false)) and (matchSpecificSpell == false or matchSpell == resref) and (ignoreSpecificSpell == false or ignoreSpell ~= resref) then
						local spellData = EEex_GetSpellData(resref)
						if spellData ~= 0 then
							local spellSchool = EEex_ReadByte(spellData + 0x25, 0x0)
							if (parameter1 <= 0 or ((isSorcererClass == false or sorcererSpellsFound[resref] <= numLeft) and (isSorcererClass or numFound < parameter1))) and ((onePerSchool == false and parameter3 == 0) or (schools_found[spellSchool] ~= nil and schools_found[spellSchool] == false)) then
								if onePerSchool then 
									schools_found[spellSchool] = true
								end
								if subtractSpells then
									EEex_WriteWord(resrefLocation + 0x8, bit32.band(flags, 0xFFFE))
								else
									EEex_WriteWord(resrefLocation + 0x8, bit32.bor(flags, 0x1))
								end
								if isSorcererClass then
									if sorcererSpellsFound[resref] > sorcererSpellMax then
										sorcererSpellMax = sorcererSpellsFound[resref]
										levelsFound[i] = sorcererSpellsFound[resref]
									end
								else
									numFound = numFound + 1
									levelsFound[i] = levelsFound[i] + 1
								end
							end
						end
					end
				end
			end)
		end
		numFound = numFound + sorcererSpellMax
	end
--]]
end

function EEex_CompareActorAllegiances(actorID1, actorID2)
	local ea1 = EEex_GetActorAllegiance(actorID1)
	local ea2 = EEex_GetActorAllegiance(actorID2)
	local eaGroup1 = 2
	local eaGroup2 = 2
	if ea1 >= 2 and ea1 <= 30 then
		eaGroup1 = 1
	elseif ea1 >= 200 then
		eaGroup1 = 3
	end
	if ea2 >= 2 and ea2 <= 30 then
		eaGroup2 = 1
	elseif ea1 >= 200 then
		eaGroup2 = 3
	end
	return math.abs(eaGroup1 - eaGroup2)
end

function EEex_GetActorCasterLevel(actorID, spellType)
	local casterLevel = 1
	local class = EEex_GetActorClass(actorID)
	local level1 = EEex_GetActorStat(actorID, 34)
	local level2 = EEex_GetActorStat(actorID, 68)
	local level3 = EEex_GetActorStat(actorID, 69)
	if spellType == 1 then
		if class == 1 or class == 5 or class == 13 or class == 19 or class > 21 then
			casterLevel = level1 + EEex_GetActorStat(actorID, 79)
		elseif class == 7 or class == 10 or class == 14 or class == 17 then
			casterLevel = level2 + EEex_GetActorStat(actorID, 79)
		end
	elseif spellType == 2 then
		if class == 3 or class == 6 or class == 11 or class == 12 or class == 14 or class == 15 or class == 18 or class == 21 or class > 21 then
			casterLevel = level1 + EEex_GetActorStat(actorID, 80)
		elseif class == 8 or class == 16 then
			casterLevel = level2 + EEex_GetActorStat(actorID, 80)
		elseif class == 17 then
			casterLevel = level3 + EEex_GetActorStat(actorID, 80)
		end
	else
		if level1 > casterLevel then
			casterLevel = level1
		end
		if level2 > casterLevel then
			casterLevel = level2
		end
		if level3 > casterLevel then
			casterLevel = level3
		end
	end
	return casterLevel
end

EEex_AddActionHookOpcode("MECONVIS", function(originatingEffectData, actionData, creatureData)
	local actionID = EEex_GetActionID(actionData)
	if actionID == 3 or actionID == 98 or actionID == 105 or actionID == 134 or actionID == 31 or actionID == 113 or actionID == 191 or actionID == 318 then
		local targetID = EEex_ReadDword(actionData + 0x20)
		if EEex_GetActorStat(targetID, 659) > 0 then
			EEex_SetActionID(actionData, 36)
		end
	end
end)

EEex_AddActionHookOpcode("MECAMOUE", function(originatingEffectData, actionData, creatureData)
	local actionID = EEex_GetActionID(actionData)
	local sourceID = EEex_ReadDword(creatureData + 0x34)
	if actionID == 3 or actionID == 98 or actionID == 105 or actionID == 134 or actionID == 31 or actionID == 95 or actionID == 191 or actionID == 192 then
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 4,
["duration"] = 1,
["parameter1"] = casterLevel,
["parameter2"] = 1,
["casterlvl"] = casterLevel,
["resource"] = "MEPR156H",
["source_target"] = sourceID,
["source_id"] = sourceID
})
	end
end)

EEex_AddActionHookOpcode("MEFORCSP", function(originatingEffectData, actionData, creatureData)
	local actionID = EEex_GetActionID(actionData)
	local sourceID = EEex_ReadDword(creatureData + 0x34)
	if actionID == 31 then
		local spellRES = EEex_GetActorSpellRES(sourceID)
		local targetID = EEex_ReadDword(actionData + 0x20)
		local targetX = EEex_ReadDword(EEex_GetActorShare(targetID) + 0x8)
		local targetY = EEex_ReadDword(EEex_GetActorShare(targetID) + 0xC)
		local casterLevel = EEex_GetActorCasterLevel(sourceID, EEex_ReadWord(EEex_GetSpellData(spellRES) + 0x1C, 0x0))
		EEex_SetActionID(actionData, 147)
		EEex_WriteDword(actionData + 0x20, EEex_ReadWord(actionData + 0x40, 0x0))
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 1,
["parameter1"] = casterLevel,
["parameter2"] = 0,
["casterlvl"] = casterLevel,
["resource"] = spellRES,
["source_x"] = EEex_ReadDword(creatureData + 0x8),
["source_y"] = EEex_ReadDword(creatureData + 0xC),
["target_x"] = targetX,
["target_y"] = targetY,
["source_target"] = targetID,
["source_id"] = sourceID
})
	elseif actionID == 95 then
		local spellRES = EEex_GetActorSpellRES(sourceID)
		local targetID = EEex_ReadDword(actionData + 0x20)
		local targetX = EEex_GetActionPointX(actionData)
		local targetY = EEex_GetActionPointY(actionData)
		local casterLevel = EEex_GetActorCasterLevel(sourceID, EEex_ReadWord(EEex_GetSpellData(spellRES) + 0x1C, 0x0))
		EEex_SetActionID(actionData, 147)
		EEex_WriteDword(actionData + 0x20, EEex_ReadWord(actionData + 0x40, 0x0))
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 148,
["target"] = 2,
["timing"] = 1,
["parameter1"] = casterLevel,
["parameter2"] = 0,
["casterlvl"] = casterLevel,
["resource"] = spellRES,
["source_x"] = EEex_ReadDword(creatureData + 0x8),
["source_y"] = EEex_ReadDword(creatureData + 0xC),
["target_x"] = targetX,
["target_y"] = targetY,
["source_target"] = sourceID,
["source_id"] = sourceID
})
	end
--[[
	if actionID == 31 or actionID == 95 then
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 342,
["target"] = 2,
["timing"] = 10,
["duration"] = 1,
["parameter1"] = 0,
["parameter2"] = 4,
["source_target"] = sourceID,
["source_id"] = sourceID
})
	end
--]]
end)

EEex_AddActionHookOpcode("MEAPPLSP", function(originatingEffectData, actionData, creatureData)
	local actionID = EEex_GetActionID(actionData)
	local sourceID = EEex_ReadDword(creatureData + 0x34)
	if actionID == 31 then
		local spellRES = EEex_GetActorSpellRES(sourceID)
		local spellData = EEex_GetSpellData(spellRES)
		if bit32.band(EEex_ReadDword(spellData + 0x18), 0x10000000) > 0 then
			local targetID = EEex_ReadDword(actionData + 0x20)
			local targetX = EEex_ReadDword(EEex_GetActorShare(targetID) + 0x8)
			local targetY = EEex_ReadDword(EEex_GetActorShare(targetID) + 0xC)
			local casterLevel = EEex_GetActorCasterLevel(sourceID, EEex_ReadWord(spellData + 0x1C, 0x0))
			EEex_SetActionID(actionData, 147)
			EEex_WriteDword(actionData + 0x20, EEex_ReadWord(actionData + 0x40, 0x0))
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 1,
["parameter1"] = casterLevel,
["parameter2"] = 1,
["casterlvl"] = casterLevel,
["resource"] = spellRES,
["source_x"] = EEex_ReadDword(creatureData + 0x8),
["source_y"] = EEex_ReadDword(creatureData + 0xC),
["target_x"] = targetX,
["target_y"] = targetY,
["source_target"] = targetID,
["source_id"] = sourceID
})
		end
	elseif actionID == 95 then
		local spellRES = EEex_GetActorSpellRES(sourceID)
		local spellData = EEex_GetSpellData(spellRES)
		if bit32.band(EEex_ReadDword(spellData + 0x18), 0x10000000) > 0 then
			local targetID = EEex_ReadDword(actionData + 0x20)
			local targetX = EEex_GetActionPointX(actionData)
			local targetY = EEex_GetActionPointY(actionData)
			local casterLevel = EEex_GetActorCasterLevel(sourceID, EEex_ReadWord(spellData + 0x1C, 0x0))
			EEex_SetActionID(actionData, 147)
			EEex_WriteDword(actionData + 0x20, EEex_ReadWord(actionData + 0x40, 0x0))
			EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 148,
["target"] = 2,
["timing"] = 1,
["parameter1"] = casterLevel,
["parameter2"] = 1,
["casterlvl"] = casterLevel,
["resource"] = spellRES,
["source_x"] = EEex_ReadDword(creatureData + 0x8),
["source_y"] = EEex_ReadDword(creatureData + 0xC),
["target_x"] = targetX,
["target_y"] = targetY,
["source_target"] = sourceID,
["source_id"] = sourceID
})
		end
	end
end)

EEex_AddActionHookOpcode("EXBERSER", function(originatingEffectData, actionData, creatureData)
	local actionID = EEex_GetActionID(actionData)
	local sourceID = EEex_ReadDword(creatureData + 0x34)
	local targetID = EEex_ReadDword(actionData + 0x20)
	if actionID == 3 and EEex_CompareActorAllegiances(sourceID, targetID) == 0 and (bit32.band(EEex_ReadDword(creatureData + 0x434), 0x2) > 0 or bit32.band(EEex_ReadDword(creatureData + 0xB30), 0x2) > 0) then
		local enemyID = EEex_EvalObjectStringAsActor("NearestEnemyOf(Myself)", sourceID)
		if enemyID > 0 then
			targetID = enemyID
			EEex_WriteDword(actionData + 0x20, targetID)
		else
			EEex_SetActionID(actionData, 0)
		end
	end
end)

EEex_AddActionHookOpcode("EXFEAR", function(originatingEffectData, actionData, creatureData)
	local actionID = EEex_GetActionID(actionData)
	local sourceID = EEex_ReadDword(creatureData + 0x34)
	local targetID = EEex_ReadDword(actionData + 0x20)
	if actionID == 200 and (bit32.band(EEex_ReadDword(creatureData + 0x434), 0x4) > 0 or bit32.band(EEex_ReadDword(creatureData + 0xB30), 0x4) > 0) then
		local enemyID = EEex_EvalObjectStringAsActor("NearestEnemyOf(Myself)", sourceID)
		if enemyID > 0 then
			targetID = enemyID
			EEex_SetActionID(actionData, 355)
			EEex_WriteDword(actionData + 0x20, targetID)
			EEex_WriteDword(actionData + 0x40, 100)
		end
	end
end)

EEex_AddActionHookOpcode("MEORACLE", function(originatingEffectData, actionData, creatureData)
	local actionID = EEex_GetActionID(actionData)
	local sourceID = EEex_ReadDword(creatureData + 0x34)
	local targetID = EEex_ReadDword(actionData + 0x20)
	if actionID == 31 or actionID == 113 or actionID == 191 or actionID == 318 or actionID == 95 or actionID == 114 or actionID == 192 or actionID == 319 then
		local spellRES = EEex_GetActorSpellRES(sourceID)
		local spellData = EEex_GetSpellData(spellRES)
		local spellNameStrref = ""
		if spellData > 0 then
			spellNameStrref = EEex_ReadDword(spellData + 0x8)
			local oracleString = ex_oracle_feedback_string_1 .. Infinity_FetchString(spellNameStrref)
			if sourceID ~= targetID and (actionID == 31 or actionID == 113 or actionID == 191 or actionID == 318) then
				oracleString = oracleString .. ex_oracle_feedback_string_2 .. EEex_GetActorName(targetID)
			end
			Infinity_SetToken("ME_ORACL", oracleString)
			EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 330,
["target"] = 2,
["parameter1"] = ex_oracle_feedback_strref,
["timing"] = 1,
["source_target"] = sourceID,
["source_id"] = sourceID
})
		end
	end
end)

EEex_AddActionHookOpcode("MEACTMOD", function(originatingEffectData, actionData, creatureData)
	local actionID = EEex_GetActionID(actionData)
	local sourceID = EEex_ReadDword(creatureData + 0x34)
	local targetID = EEex_ReadDword(actionData + 0x20)
	if actionID == 200 and (bit32.band(EEex_ReadDword(creatureData + 0x434), 0x4) > 0 or bit32.band(EEex_ReadDword(creatureData + 0xB30), 0x4) > 0) then
		local enemyID = EEex_EvalObjectStringAsActor("NearestEnemyOf(Myself)", sourceID)
		if enemyID > 0 then
			targetID = enemyID
			EEex_SetActionID(actionData, 355)
			EEex_WriteDword(actionData + 0x20, targetID)
			EEex_WriteDword(actionData + 0x40, 100)
		end
	elseif actionID == 31 or actionID == 191 then
		local spellRES = EEex_GetActorSpellRES(sourceID)
		local spellData = EEex_GetSpellData(spellRES)
		if bit32.band(EEex_ReadDword(spellData + 0x18), 0x10000000) > 0 then
			local targetX = EEex_ReadDword(EEex_GetActorShare(targetID) + 0x8)
			local targetY = EEex_ReadDword(EEex_GetActorShare(targetID) + 0xC)
			local casterLevel = EEex_GetActorCasterLevel(sourceID, EEex_ReadWord(spellData + 0x1C, 0x0))
			EEex_SetActionID(actionData, 147)
			EEex_WriteDword(actionData + 0x20, EEex_ReadWord(actionData + 0x40, 0x0))
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 1,
["parameter1"] = casterLevel,
["parameter2"] = 1,
["casterlvl"] = casterLevel,
["resource"] = spellRES,
["source_x"] = EEex_ReadDword(creatureData + 0x8),
["source_y"] = EEex_ReadDword(creatureData + 0xC),
["target_x"] = targetX,
["target_y"] = targetY,
["source_target"] = targetID,
["source_id"] = sourceID
})
		end
	elseif actionID == 95 or actionID == 192 then
		local spellRES = EEex_GetActorSpellRES(sourceID)
		local spellData = EEex_GetSpellData(spellRES)
		if bit32.band(EEex_ReadDword(spellData + 0x18), 0x10000000) > 0 then
			local targetID = EEex_ReadDword(actionData + 0x20)
			local targetX = EEex_GetActionPointX(actionData)
			local targetY = EEex_GetActionPointY(actionData)
			local casterLevel = EEex_GetActorCasterLevel(sourceID, EEex_ReadWord(spellData + 0x1C, 0x0))
			EEex_SetActionID(actionData, 147)
			EEex_WriteDword(actionData + 0x20, EEex_ReadWord(actionData + 0x40, 0x0))
			EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 148,
["target"] = 2,
["timing"] = 1,
["parameter1"] = casterLevel,
["parameter2"] = 1,
["casterlvl"] = casterLevel,
["resource"] = spellRES,
["source_x"] = EEex_ReadDword(creatureData + 0x8),
["source_y"] = EEex_ReadDword(creatureData + 0xC),
["target_x"] = targetX,
["target_y"] = targetY,
["source_target"] = sourceID,
["source_id"] = sourceID
})
		end
	end
--[[
	if actionID == 31 or actionID == 95 then
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 342,
["target"] = 2,
["timing"] = 10,
["duration"] = 1,
["parameter1"] = 0,
["parameter2"] = 4,
["source_target"] = sourceID,
["source_id"] = sourceID
})
	end
--]]
end)

EEex_AddActionHookOpcode("EXTAUNT", function(originatingEffectData, actionData, creatureData)
	local actionID = EEex_GetActionID(actionData)
	local sourceID = EEex_ReadDword(creatureData + 0x34)
	local targetID = EEex_ReadDword(actionData + 0x20)
	if actionID == 3 and EEex_CompareActorAllegiances(sourceID, targetID) == 0 and (bit32.band(EEex_ReadDword(creatureData + 0x434), 0x2) > 0 or bit32.band(EEex_ReadDword(creatureData + 0xB30), 0x2) > 0) then
		local enemyID = EEex_ReadDword(originatingEffectData + 0x10C)
		if enemyID > 0 then
			targetID = enemyID
			EEex_WriteDword(actionData + 0x20, targetID)
		end
	end
end)

--[[
To use the EXSPLDEF function, create an opcode 403 effect in a spell, set the resource to EXSPLDEF (all capitals), and choose parameters.

The EXSPLDEF function works like Spell Deflection, Spell Turning or Spell Trap, except it works against area of effect spells.

parameter1 - Determines the lowest spell level that can be deflected (0 - 9).

parameter2 - Determines the highest spell level that can be deflected (0 - 9).

special - Determines the number of spell levels that can be deflected. If set to -1, there is no limit.

savingthrow - This function uses several extra bits on this parameter:
Bit 17: If set, once the last spell level is deflected, another spell is cast on the creature whose spell
 was deflected. The spell resref is specified by resource2 (in an EFF file). If you aren't using this from an
 EFF file, then the spell resref is set to the resref of the source spell, with an E added at the end.
Bit 18: If set, whenever a spell is deflected, another spell is cast on the creature whose spell
 was deflected. The spell resref is specified by resource3 (in an EFF file). If you aren't using this from an
 EFF file, then the spell resref is set to the resref of the source spell, with an F added at the end.
Bit 19: If set, up to special spells (rather than spell levels) are deflected.
Bit 20: If NOT set, the function will remove all effects of the spell that called EXSPLDEF once the last spell level is deflected.
Bit 21: If set, only spells with the hostile flag, or that deal damage, will be deflected.
Bit 22: If set, the function will reflect rather than deflect the spell.
Bit 23: If set, the function will absorb the spell as with Spell Trap, restoring one of the character's previously-used spells.


--]]
previous_spells_turned = {}
function EXSPLDEF(originatingEffectData, effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local opcode = EEex_ReadDword(effectData + 0xC)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local parent_resource = EEex_ReadLString(originatingEffectData + 0x90, 8)
	local internal_flags = EEex_ReadDword(effectData + 0xC8)
	if bit32.band(internal_flags, 0x4000000) > 0 or targetID <= 0 or sourceID <= 0 or targetID == sourceID then return false end
	local savingthrow = EEex_ReadDword(originatingEffectData + 0x3C)
	local parameter1 = EEex_ReadDword(originatingEffectData + 0x18)
	local parameter2 = EEex_ReadDword(originatingEffectData + 0x1C)
	local match_spellRES = EEex_ReadLString(originatingEffectData + 0x18, 8)
	local spellRES = EEex_ReadLString(effectData + 0x90, 8)
	local theopcode = EEex_ReadDword(effectData + 0xC)
	local spellLevel = EEex_ReadDword(effectData + 0x14)
	local endSpellRES = EEex_ReadLString(effectData + 0x6C, 8)
	local repeatSpellRES = EEex_ReadLString(effectData + 0x74, 8)
	if endSpellRES == "" then
		endSpellRES = parent_resource .. "E"
	end
	if repeatSpellRES == "" then
		repeatSpellRES = parent_resource .. "F"
	end
--[[
	local spellData = 0

	if spellRES ~= "" and EEex_ReadDword(effectData + 0x8C) == 1 then
		spellData = EEex_GetSpellData(spellRES)
	end
	if spellData > 0 then
		spellLevel = EEex_ReadDword(spellData + 0x34)
		if EEex_ReadWord(spellData + 0x1C, 0x0) > 2 then
			spellLevel = 0
		end
	end
	if spellLevel == 0 and bit32.band(savingthrow, 0x10000) == 0 then return false end
--]]
	if spellLevel < parameter1 or spellLevel > parameter2 then return false end
	if bit32.band(savingthrow, 0x200000) > 0 and theopcode ~= 12 and theopcode ~= 25 and theopcode ~= 78 and bit32.band(EEex_ReadDword(effectData + 0x98), 0x400) == 0 then return false end
	local special = EEex_ReadDword(originatingEffectData + 0x44)
	local time_applied = EEex_ReadDword(effectData + 0x68)
	if previous_spells_turned["" .. targetID] == nil then
		previous_spells_turned["" .. targetID] = {}
	end
	if previous_spells_turned["" .. targetID][spellRES] == nil or math.abs(previous_spells_turned["" .. targetID][spellRES] - time_applied) > 1 then
		if special == 0 then
			return false
		elseif special ~= -1 then
			if bit32.band(savingthrow, 0x80000) == 0 and spellLevel > 0 then
				special = special - spellLevel
				if special < 0 then
					special = 0
				end
			else
				special = special - 1
			end
			EEex_WriteDword(originatingEffectData + 0x44, special)
		end
		if bit32.band(savingthrow, 0x400000) == 0 then
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 206,
["target"] = 2,
["timing"] = 10,
["duration"] = 1,
["resource"] = spellRES,
["internal_flags"] = 0x4000000,
["source_target"] = targetID,
["source_id"] = targetID
})		
		else
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 207,
["target"] = 2,
["timing"] = 10,
["duration"] = 1,
["resource"] = spellRES,
["internal_flags"] = 0x4000000,
["source_target"] = targetID,
["source_id"] = targetID
})
		end
		if bit32.band(savingthrow, 0x800000) > 0 then
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 261,
["target"] = 2,
["timing"] = 1,
["parameter1"] = spellLevel,
["parameter2"] = 0,
["internal_flags"] = 0x4000000,
["source_target"] = targetID,
["source_id"] = targetID
})		
		end
		if bit32.band(savingthrow, 0x40000) > 0 then
			EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 1,
["parameter1"] = EEex_ReadDword(originatingEffectData + 0xC4),
["parameter2"] = 2,
["resource"] = repeatSpellRES,
["internal_flags"] = 0x4000000,
["source_target"] = sourceID,
["source_id"] = targetID
})
		end
		if special == 0 then
			if bit32.band(savingthrow, 0x20000) > 0 then
				EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 1,
["parameter1"] = EEex_ReadDword(originatingEffectData + 0xC4),
["parameter2"] = 2,
["resource"] = endSpellRES,
["internal_flags"] = 0x4000000,
["source_target"] = sourceID,
["source_id"] = targetID
})
			end
			if bit32.band(savingthrow, 0x100000) == 0 then
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["resource"] = parent_resource,
["internal_flags"] = 0x4000000,
["source_target"] = targetID,
["source_id"] = targetID
})
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 2,
["parameter1"] = 1,
["parameter2"] = 2,
["resource"] = "MEBASEEF",
["internal_flags"] = 0x4000000,
["source_target"] = targetID,
["source_id"] = targetID
})
			end
		end
	end
	previous_spells_turned["" .. targetID][spellRES] = time_applied

--[[
	EEex_ApplyEffectToActor(sourceID, {
["opcode"] = EEex_ReadDword(effectData + 0xC),
["target"] = EEex_ReadDword(effectData + 0x10),
["power"] = EEex_ReadDword(effectData + 0x14),
["parameter1"] = EEex_ReadDword(effectData + 0x18),
["parameter2"] = EEex_ReadDword(effectData + 0x1C),
["timing"] = EEex_ReadDword(effectData + 0x20),
["duration"] = EEex_ReadDword(effectData + 0x24),
["resource"] = EEex_ReadLString(effectData + 0x2C, 8),
["dicenumber"] = EEex_ReadDword(effectData + 0x34),
["dicesize"] = EEex_ReadDword(effectData + 0x38),
["savingthrow"] = EEex_ReadDword(effectData + 0x3C),
["savebonus"] = EEex_ReadDword(effectData + 0x40),
["special"] = EEex_ReadDword(effectData + 0x44),
["school"] = EEex_ReadDword(effectData + 0x48),
["resist_dispel"] = EEex_ReadDword(effectData + 0x58),
["parameter3"] = EEex_ReadDword(effectData + 0x5C),
["parameter4"] = EEex_ReadDword(effectData + 0x60),
["parameter5"] = EEex_ReadDword(effectData + 0x64),
["vvcresource"] = EEex_ReadLString(effectData + 0x6C, 8),
["resource2"] = EEex_ReadLString(effectData + 0x74, 8),
["source_x"] = EEex_ReadDword(creatureData + 0x8),
["source_y"] = EEex_ReadDword(creatureData + 0xC),
["target_x"] = EEex_ReadDword(EEex_GetActorShare(sourceID) + 0x8),
["target_y"] = EEex_ReadDword(EEex_GetActorShare(sourceID) + 0xC),
["restype"] = EEex_ReadDword(effectData + 0x8C),
["parent_resource"] = EEex_ReadLString(effectData + 0x90, 8),
["resource_flags"] = EEex_ReadDword(effectData + 0x98),
["impact_projectile"] = EEex_ReadDword(effectData + 0x9C),
["sourceslot"] = EEex_ReadDword(effectData + 0xA0),
["effvar"] = EEex_ReadLString(effectData + 0xA4, 32),
["casterlvl"] = EEex_ReadDword(effectData + 0xC4),
["internal_flags"] = bit32.bor(internal_flags, 0x4000000),
["sectype"] = EEex_ReadDword(effectData + 0xCC),
["source_target"] = sourceID,
["source_id"] = targetID
})
	return true
--]]
	return false
end

function MEBRDSEQ(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local newSourceID = sourceID
	local spellTarget = 0
	local targetX = EEex_ReadDword(creatureData + 0x8)
	local targetY = EEex_ReadDword(creatureData + 0xC)
	local casterlvl = EEex_ReadDword(effectData + 0xC4)
	local contingencyRES = EEex_ReadLString(effectData + 0x18, 8)
--	if math.random(100) > casterlvl * 2 then return end
	if EEex_GetActorStat(sourceID, 666) > 0 and EEex_GetActorStat(sourceID, 668) > 0 then
		EEex_IterateActorEffects(sourceID, function(eData)
			local the_opcode = EEex_ReadDword(eData + 0x10)
			local the_special = EEex_ReadDword(eData + 0x48)
			local the_parent_resource = EEex_ReadLString(eData + 0x94, 8)
			if the_opcode == 401 and the_special == 666 and the_parent_resource == contingencyRES then
				local the_resource = EEex_ReadLString(eData + 0x30, 8)
				local the_resource2 = EEex_ReadLString(eData + 0x70, 8)
				local the_resource3 = EEex_ReadLString(eData + 0x78, 8)
				if the_resource ~= "" then
					spellTarget = EEex_ReadByte(EEex_GetSpellData(the_resource) + 0x7e, 0x0)
					if spellTarget == 5 or spellTarget == 7 then
						newSourceID = targetID
					else
						newSourceID = sourceID
					end
					EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 9,
["parameter1"] = casterlvl,
["parameter2"] = 1,
["casterlvl"] = casterlvl,
["resource"] = the_resource,
["target_x"] = targetX,
["target_y"] = targetY,
["source_target"] = targetID,
["source_id"] = newSourceID
})
				end
				if the_resource2 ~= "" then
					spellTarget = EEex_ReadByte(EEex_GetSpellData(the_resource2) + 0x7e, 0x0)
					if spellTarget == 5 or spellTarget == 7 then
						newSourceID = targetID
					else
						newSourceID = sourceID
					end
					EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 9,
["parameter1"] = casterlvl,
["parameter2"] = 1,
["casterlvl"] = casterlvl,
["resource"] = the_resource2,
["target_x"] = targetX,
["target_y"] = targetY,
["source_target"] = targetID,
["source_id"] = newSourceID
})
				end
				if the_resource3 ~= "" then
					spellTarget = EEex_ReadByte(EEex_GetSpellData(the_resource3) + 0x7e, 0x0)
					if spellTarget == 5 or spellTarget == 7 then
						newSourceID = targetID
					else
						newSourceID = sourceID
					end
					EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 9,
["parameter1"] = casterlvl,
["parameter2"] = 1,
["casterlvl"] = casterlvl,
["resource"] = the_resource3,
["target_x"] = targetX,
["target_y"] = targetY,
["source_target"] = targetID,
["source_id"] = newSourceID
})
				end
			end
		end)
	end
end

function MEMODBMP(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local range = EEex_ReadDword(effectData + 0x18)
	local newColor = EEex_ReadDword(effectData + 0x1C)
	local matchingColors = EEex_ReadWord(effectData + 0x3E, 0x0)
	local targetX = EEex_ReadDword(effectData + 0x84)
	local targetY = EEex_ReadDword(effectData + 0x88)
	local areaRes = EEex_GetActorAreaRes(targetID)
	if areaRes == "" then return end
	local areaX, areaY = EEex_GetActorAreaSize(targetID)
	local bitmapData = EEex_DemandResData(areaRes .. "SR", "BMP")
	local fileSize = EEex_ReadDword(bitmapData + 0x2)
	local dataOffset = EEex_ReadDword(bitmapData + 0xA)
	local bitmapX = EEex_ReadDword(bitmapData + 0x12)
	local bitmapY = EEex_ReadDword(bitmapData + 0x16)
	local pixelSizeX = 16
	local pixelSizeY = 12
	local current = 0
	local currentA = 0
	local currentB = 0
	local currentX = 0
	local currentY = 0
	if range == -1 then
		for i = dataOffset, fileSize - 1, 1 do
			current = EEex_ReadByte(bitmapData + i, 0)
			currentA = math.floor(current / 16)
			currentB = current % 16
			if bit32.band(matchingColors, 2 ^ currentA) > 0 then
				currentA = newColor
			end
			if bit32.band(matchingColors, 2 ^ currentB) > 0 then
				currentB = newColor
			end
			EEex_WriteByte(bitmapData + i, currentA * 16 + currentB)
		end
	else
		local i = dataOffset
		for y = bitmapY - 1, 0, -1 do
			for x = 0, bitmapX - 1, 2 do
				current = EEex_ReadByte(bitmapData + i, 0)
				currentX = math.floor((x + .5) * pixelSizeX)
				currentY = math.floor((y + .5) * pixelSizeY)
				currentA = math.floor(current / 16)
				if EEex_GetDistance(currentX, currentY, targetX, targetY) < range and bit32.band(matchingColors, 2 ^ currentA) > 0 then
					currentA = newColor
				end
				if x < bitmapX - 1 then
					currentX = math.floor((x + 1.5) * pixelSizeX)
					currentB = current % 16
					if EEex_GetDistance(currentX, currentY, targetX, targetY) < range and bit32.band(matchingColors, 2 ^ currentB) > 0 then
						currentB = newColor
					end
				end
				EEex_WriteByte(bitmapData + i, currentA * 16 + currentB)
				i = i + 1
			end
		end
	end
end

function MEDEFLEC(originatingEffectData, effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local opcode = EEex_ReadDword(effectData + 0xC)
	if opcode ~= 12 then return false end
	local savingthrow = EEex_ReadDword(originatingEffectData + 0x3C)
	local string = EEex_ReadDword(originatingEffectData + 0x18)
	local delay = EEex_ReadDword(originatingEffectData + 0x44)
	local types_blocked = EEex_ReadDword(originatingEffectData + 0x1C)
	local parent_resource = EEex_ReadLString(originatingEffectData + 0x90, 8)
	local damage_type = EEex_ReadWord(effectData + 0x1E, 0x0)
	local flags = EEex_ReadDword(effectData + 0x44)
	
	local doDeflect = true
	if (damage_type == 0 and bit32.band(types_blocked, 0x4000) > 0) or (damage_type ~= 0 and bit32.band(types_blocked, damage_type) > 0) then
		if bit32.band(savingthrow, 0x10000) == 0 and EEex_GetActorStat(targetID, 615) > 0 then
			EEex_IterateActorEffects(targetID, function(eData)
				local the_opcode = EEex_ReadDword(eData + 0x10)
				local the_parameter1 = EEex_ReadDword(eData + 0x1C)
				local the_special = EEex_ReadDword(eData + 0x48)
				local the_resource = EEex_ReadLString(eData + 0x30, 8)
				if the_opcode == 401 and the_parameter1 > 0 and the_special == 615 and the_resource == parent_resource then
					doDeflect = false
				end
			end)
		end
		if doDeflect then
			if delay ~= -1 then
				EEex_ApplyEffectToActor(targetID, {
["opcode"] = 401,
["target"] = 2,
["timing"] = 0,
["duration"] = delay,
["parameter1"] = 1,
["parameter2"] = 1,
["special"] = 615,
["resource"] = parent_resource,
["parent_resource"] = "MEDEFDEL",
["source_target"] = targetID,
["source_id"] = targetID,
})
			end
			if string ~= -1 then
				EEex_ApplyEffectToActor(targetID, {
["opcode"] = 139,
["target"] = 2,
["timing"] = 1,
["parameter1"] = string,
["resource"] = parent_resource,
["parent_resource"] = "MEDEFSTR",
["source_target"] = targetID,
["source_id"] = targetID,
})
			end
			return true
		end
	end
	return false
end

EEex_AddActionHookGlobal("EXAPPLS2", function(actionData, creatureData)
	local actionID = EEex_GetActionID(actionData)
	local sourceID = EEex_ReadDword(creatureData + 0x34)
	if actionID == 31 then
		local spellRES = EEex_GetActorSpellRES(sourceID)
		local spellData = EEex_GetSpellData(spellRES)
		if bit32.band(EEex_ReadDword(spellData + 0x18), 0x20000000) > 0 then
			local targetID = EEex_ReadDword(actionData + 0x20)
			local targetX = EEex_ReadDword(EEex_GetActorShare(targetID) + 0x8)
			local targetY = EEex_ReadDword(EEex_GetActorShare(targetID) + 0xC)
			local casterLevel = EEex_GetActorCasterLevel(sourceID, EEex_ReadWord(spellData + 0x1C, 0x0))
			EEex_SetActionID(actionData, 0)
			EEex_WriteDword(actionData + 0x20, EEex_ReadWord(actionData + 0x40, 0x0))
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 1,
["parameter1"] = casterLevel,
["parameter2"] = 1,
["casterlvl"] = casterLevel,
["resource"] = spellRES,
["source_x"] = EEex_ReadDword(creatureData + 0x8),
["source_y"] = EEex_ReadDword(creatureData + 0xC),
["target_x"] = targetX,
["target_y"] = targetY,
["source_target"] = targetID,
["source_id"] = sourceID
})
		end
	elseif actionID == 95 then
		local spellRES = EEex_GetActorSpellRES(sourceID)
		local spellData = EEex_GetSpellData(spellRES)
		if bit32.band(EEex_ReadDword(spellData + 0x18), 0x20000000) > 0 then
			local targetID = EEex_ReadDword(actionData + 0x20)
			local targetX = EEex_GetActionPointX(actionData)
			local targetY = EEex_GetActionPointY(actionData)
			local casterLevel = EEex_GetActorCasterLevel(sourceID, EEex_ReadWord(spellData + 0x1C, 0x0))
			EEex_SetActionID(actionData, 0)
			EEex_WriteDword(actionData + 0x20, EEex_ReadWord(actionData + 0x40, 0x0))
			EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 148,
["target"] = 2,
["timing"] = 1,
["parameter1"] = casterLevel,
["parameter2"] = 1,
["casterlvl"] = casterLevel,
["resource"] = spellRES,
["source_x"] = EEex_ReadDword(creatureData + 0x8),
["source_y"] = EEex_ReadDword(creatureData + 0xC),
["target_x"] = targetX,
["target_y"] = targetY,
["source_target"] = sourceID,
["source_id"] = sourceID
})
		end
	end
end)

EEex_ConstantID = {}
function EXCONID1(effectData, creatureData)
	if true then return end
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
--	Infinity_DisplayString(targetID)
	if not EEex_IsSprite(targetID, true) then return end
	if sourceID <= 0 then
		EEex_IterateActorEffects(targetID, function(eData)
			local the_opcode = EEex_ReadDword(eData + 0x10)
			local the_resource = EEex_ReadLString(eData + 0x30, 8)
			if the_opcode == 402 and the_resource == "EXCONID1" then
				EEex_WriteDword(eData + 0x110, targetID)
			end
		end)
		local constantID = EEex_ReadDword(creatureData + 0x610)
		EEex_ConstantID[constantID] = targetID
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 402,
["target"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["resource"] = "EXCONID2",
["source_target"] = targetID,
["source_id"] = targetID
})
	end


end

function EXCONID2(effectData, creatureData)
	if true then return end
	local targetID = EEex_ReadDword(creatureData + 0x34)
	EEex_IterateActorEffects(targetID, function(eData)

		local the_parameter5 = EEex_ReadDword(eData + 0x68)

		if EEex_ConstantID[the_parameter5] ~= nil and EEex_IsSprite(EEex_ConstantID[the_parameter5] ~= nil, true) then
			EEex_WriteDword(eData + 0x110, EEex_ConstantID[the_parameter5])
		end

	end)
end

ex_resistance_opcode = {
[14] = {30, 0x46D},
[15] = {28, 0x46E},
[16] = {29, 0x46F},
[17] = {27, 0x470},
[19] = {84, 0x472},
[20] = {85, 0x473},
[21] = {86, 0x474},
[22] = {87, 0x475},
[23] = {88, 0x476},
[24] = {89, 0x477},
[73] = {31, 0},
[74] = {173, 0}
}
ex_damage_types = {
[0] = {22, 87, ex_crushing_damage_strref},
[1] = {17, 27, ex_acid_damage_strref},
[2] = {15, 28, ex_cold_damage_strref},
[4] = {16, 29, ex_electricity_damage_strref},
[8] = {14, 30, ex_fire_damage_strref},
[16] = {23, 88, ex_piercing_damage_strref},
[32] = {74, 173, ex_poison_damage_strref},
[64] = {73, 31, ex_magic_damage_strref},
[128] = {24, 89, ex_missile_damage_strref},
[256] = {21, 86, ex_slashing_damage_strref},
[512] = {19, 84, ex_magicfire_damage_strref},
[1024] = {20, 85, ex_magiccold_damage_strref},
[2048] = {22, 87, ex_stunning_damage_strref}
}
ex_damage_resistance_base = {
[0] = 0x475,
[1] = 0x470,
[2] = 0x46E,
[4] = 0x46F,
[8] = 0x46D,
[16] = 0x476,
[128] = 0x477,
[256] = 0x474,
[512] = 0x472,
[1024] = 0x473,
[2048] = 0x475
}

function EEex_GetActorFullResistance(actorID, resistanceStat)
	if not EEex_IsSprite(actorID) or ex_resistance_opcode[resistanceStat] == nil then return 0 end
	local base_resistance = 0
	local timing_level = 0
	if ex_resistance_opcode[resistanceStat][2] ~= 0 then
		base_resistance = EEex_ReadByte(EEex_GetActorShare(actorID) + ex_resistance_opcode[resistanceStat][2], 0x0)
	end
	local extra_resistance = 0
	EEex_IterateActorEffects(actorID, function(eData)
		local the_opcode = EEex_ReadDword(eData + 0x10)
		if the_opcode == ex_resistance_opcode[resistanceStat][1] then
			local the_parameter1 = EEex_ReadDword(eData + 0x1C)
			local the_parameter2 = EEex_ReadDword(eData + 0x20)
			local the_timing = EEex_ReadDword(eData + 0x24)
			if the_parameter2 == 0 then
				extra_resistance = extra_resistance + the_parameter1
			elseif the_timing >= timing_level then
				timing_level = the_timing
				if the_parameter2 == 1 then
					base_resistance = the_parameter1
				elseif the_parameter2 == 2 then
					base_resistance = math.floor(base_resistance * the_parameter1 / 100)
				end
			end
		end
	end)
	return (base_resistance + extra_resistance)

end
--[[
EEex_AddScreenEffectsGlobal("EXEFFMOD", function(effectData, creatureData)
	local internal_flags = EEex_ReadDword(effectData + 0xC8)
	local opcode = EEex_ReadDword(effectData + 0xC)
	local timing = EEex_ReadDword(effectData + 0x20)
	if bit32.band(internal_flags, 0x2000000) > 0 or opcode == 187 or timing == 2 then return false end
	
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local sourceData = EEex_GetActorShare(sourceID)

	if not EEex_IsSprite(targetID) then return false end
	local parent_resource = EEex_ReadLString(effectData + 0x90, 8)
	local parameter1 = EEex_ReadDword(effectData + 0x18)
	local parameter2 = EEex_ReadDword(effectData + 0x1C)
	local dicenumber = EEex_ReadDword(effectData + 0x34)
	local dicesize = EEex_ReadDword(effectData + 0x38)
	local savingthrow = EEex_ReadDword(effectData + 0x3C)
	local restype = EEex_ReadDword(effectData + 0x8C)
	
	if EEex_IsSprite(sourceID) and opcode ~= 402 then
		local bypassMirrorImageStat = EEex_GetActorStat(sourceID, 613)
		if bypassMirrorImageStat == 1 or (bypassMirrorImageStat == 2 and (restype == 0 or restype == 2)) or (bypassMirrorImageStat == 3 and restype == 1) then
			savingthrow = bit32.bor(savingthrow, 0x1000000)
			EEex_WriteDword(effectData + 0x3C, savingthrow)
		end
	end
	if restype == 1 and EEex_IsSprite(sourceID) then
		if opcode == 17 then
			local healingMultiplier = EEex_GetActorStat(sourceID, 620)
			EEex_WriteDword(effectData + 0x18, parameter1 + math.floor(parameter1 * healingMultiplier / 100))
			EEex_WriteDword(effectData + 0x34, dicenumber + math.floor(dicenumber * healingMultiplier / 100))
		end
		local savebonus = EEex_ReadDword(effectData + 0x40)
		local school = EEex_ReadDword(effectData + 0x48)
		local schoolBonus = EEex_GetActorStat(sourceID, 622 + school) + EEex_GetActorStat(sourceID, 619)
		if schoolBonus ~= 0 then
			EEex_WriteDword(effectData + 0x40, savebonus - schoolBonus)
		end
	end
	
	if opcode == 12 then
		local damage = EEex_ReadDword(effectData + 0x18)
		local damage_method = EEex_ReadWord(effectData + 0x1C, 0x0)
		if damage_method ~= 0 then return false end
		local damage_type = EEex_ReadWord(effectData + 0x1E, 0x0)
	
		if EEex_IsSprite(sourceID) then
			local extradice = EEex_GetActorStat(sourceID, 616)
			if extradice ~= 0 then
				EEex_IterateActorEffects(sourceID, function(eData)
					if EEex_ReadDword(eData + 0x10) == 401 and EEex_ReadDword(eData + 0x48) == 616 then
						local the_extradice = EEex_ReadByte(eData + 0x1C, 0x0)
						local the_flags_a = EEex_ReadByte(eData + 0x1D, 0x0)
						local the_flags_b = EEex_ReadByte(eData + 0x1E, 0x0)
						local the_flags_c = EEex_ReadByte(eData + 0x1F, 0x0)
						local conditionsMet = true
						if bit32.band(the_flags_b, 0x40) ~= 0 and bit32.band(EEex_GetActorAlignment(targetID), the_flags_c) == 0 then
							conditionsMet = false
						end
						if bit32.band(the_flags_b, 0x1) ~= 0 and restype == 0 then
							conditionsMet = false
						elseif bit32.band(the_flags_b, 0x2) ~= 0 and restype == 1 then
							conditionsMet = false
						elseif bit32.band(the_flags_b, 0x4) ~= 0 and restype == 2 then
							conditionsMet = false
						end
						if damage_type ~= 0x1 and damage_type ~= 0x2 and damage_type ~= 0x4 and damage_type ~= 0x8 and damage_type ~= 0x20 and damage_type ~= 0x40 and damage_type ~= 0x200 and damage_type ~= 0x400 then
							if bit32.band(the_flags_b, 0x8) ~= 0 then
								conditionsMet = false
							end
						else
							if bit32.band(the_flags_b, 0x10) ~= 0 then
								conditionsMet = false
							end
						end
						if conditionsMet then
							if bit32.band(the_flags_a, 0x40) ~= 0 then
								damage = damage + the_extradice
								EEex_WriteDword(effectData + 0x18, damage)
							else
								dicenumber = dicenumber + the_extradice
								EEex_WriteDword(effectData + 0x34, dicenumber)
							end
						end
					end
				end)
			end
			local new_damage_type = EEex_GetActorStat(sourceID, 617)
			if new_damage_type ~= 0 and restype == 0 and parent_resource == "" then
				damage_type = new_damage_type - 1
				EEex_WriteWord(effectData + 0x1E, damage_type)
			end
			local minimumDamage = EEex_GetActorStat(sourceID, 621)
			if minimumDamage > 0 and dicesize > 0 and restype == 1 then
				if minimumDamage >= dicesize then
					minimumDamage = dicesize - 1
				end
				dicesize = dicesize - minimumDamage
				damage = damage + (dicenumber * minimumDamage)
				EEex_WriteDword(effectData + 0x18, damage)
				EEex_WriteDword(effectData + 0x38, dicesize)
			end
		end
	
		if EEex_Modules["ME_DAMAB"] then
			return EEex_DamageAbsorption(effectData, creatureData)
		else
			return false
		end
	end
	return false
end)
--]]
-- Like Infinity_DisplayString, but can print nil values, booleans, and entire tables.
function EEex_DS(string)
	Infinity_DisplayString(EEex_ToString(string))
end

function EEex_ToString(string)
	if string == nil then
		return "nil"
	else
		local stringType = type(string)
		if stringType == "boolean" then
			if string then
				return "true"
			else
				return "false"
			end
		elseif stringType == "function" then
			return "function()"
		elseif stringType == "table" then
			local tableString = "{"
			if string[1] == nil then
				for k, v in pairs(string) do
					tableString = tableString .. "[" .. EEex_ToString(k) .. "] = " .. EEex_ToString(v) .. ", "
				end
			else
				for k, v in ipairs(string) do
					tableString = tableString .. EEex_ToString(v) .. ", "
				end
			end
			tableString = tableString .. "}"
			return tableString
		elseif stringType == "string" then
			return "\"" .. string .. "\""
		else
			return string
		end
		
	end
end

-- Manually returns the total of the dice rolls from a damage or healing effect.
-- Values for luckMode:
-- 0: Luck won't affect die rolls.
-- 1: Weapon damage: Source's luck and minimum damage stat are added to each die roll.
-- 2: Spell damage: Target's luck is subtracted from each die roll.
-- 3: Healing: Target's luck is added to each die roll.
function EEex_RollEffectDice(targetID, sourceID, dicenumber, dicesize, luckMode)
	if dicenumber == 0 or dicesize == 0 then return 0 end
	local total = 0
	local sourceLuck = EEex_GetActorStat(sourceID, 32)
	local sourceWeaponLuck = EEex_GetActorStat(sourceID, 145)
	local sourceSpellMinimum = EEex_GetActorStat(sourceID, 621)
	local targetLuck = EEex_GetActorStat(targetID, 32)
	for i = 1, dicenumber, 1 do
		local roll = math.random(dicesize)
		if luckMode == 1 then
			roll = roll + sourceLuck + sourceWeaponLuck
		elseif luckMode == 2 then
			roll = roll - targetLuck
			if roll <= sourceSpellMinimum then
				roll = sourceSpellMinimum + 1
			end
		elseif luckMode == 3 then
			roll = roll + targetLuck
			if roll <= sourceSpellMinimum then
				roll = sourceSpellMinimum + 1
			end
		end
		if roll > dicesize then
			roll = dicesize
		elseif roll < 1 then
			roll = 1
		end
		total = total + roll
	end
	return total
end
-- Returns the actor's level. If the actor is multiclassed, it returns the highest level
--  among their class levels (e.g. if they're level 4/5, it returns 5).
function EEex_GetActorLevel(actorID)
	if not EEex_IsSprite(actorID) then return 0 end
	local highestLevel = EEex_GetActorStat(actorID, 34)
	local class = EEex_GetActorClass(actorID)
	if ((class >= 7 and class <= 10) or (class >= 13 and class <= 18)) and EEex_GetActorStat(actorID, 68) > highestLevel then
		highestLevel = EEex_GetActorStat(actorID, 68)
	end
	if (class == 10 or class == 17) and EEex_GetActorStat(actorID, 69) > highestLevel then
		highestLevel = EEex_GetActorStat(actorID, 69)
	end
	return highestLevel
end

function EEex_GetActorWizardLevel(actorID)
	if not EEex_IsSprite(actorID) then return 0 end
	local class = EEex_GetActorClass(actorID)
	if class == 1 or class == 5 or class == 13 or class == 19 then
		return EEex_GetActorStat(actorID, 34)
	elseif class == 7 or class == 10 or class == 14 or class == 17 then
		return EEex_GetActorStat(actorID, 68)
	else
		return EEex_GetActorLevel(actorID)
	end
end

function EEex_GetActorPriestLevel(actorID)
	if not EEex_IsSprite(actorID) then return 0 end
	local class = EEex_GetActorClass(actorID)
	if class == 3 or class == 6 or class == 11 or class == 12 or class == 14 or class == 15 or class == 18 or class == 21 then
		return EEex_GetActorStat(actorID, 34)
	elseif class == 8 or class == 16 then
		return EEex_GetActorStat(actorID, 68)
	elseif class == 17 then
		return EEex_GetActorStat(actorID, 69)
	else
		return EEex_GetActorLevel(actorID)
	end
end

function MELINESP(effectData, creatureData)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if not EEex_IsSprite(sourceID, false) then return end
	local parent_resource = EEex_ReadLString(effectData + 0x90, 8)
	local spellRES = EEex_ReadLString(effectData + 0x18, 8)
	local savingthrow = EEex_ReadDword(effectData + 0x3C)
	local maxDistance = EEex_ReadDword(effectData + 0x44)
	local casterlvl = EEex_ReadDword(effectData + 0xC4)
	local sourceX = EEex_ReadDword(creatureData + 0x8)
	local sourceY = EEex_ReadDword(creatureData + 0xC)
	local targetX = EEex_ReadDword(effectData + 0x84)
	local targetY = EEex_ReadDword(effectData + 0x88)
	local deltaX = targetX - sourceX
	local deltaY = targetY - sourceY
	local areaX, areaY = EEex_GetActorAreaSize(sourceID)
	if areaX <= 0 or areaY <= 0 then return end
	local newTargetX = targetX
	local newTargetY = targetY
	if deltaX > 0 then
		newTargetY = deltaY / deltaX * (areaX - sourceX) + sourceY
	elseif deltaX < 0 then
		newTargetY = deltaY / deltaX * -sourceX + sourceY
	end
	if deltaY > 0 then
		newTargetX = deltaX / deltaY * (areaY - sourceY) + sourceX
	elseif deltaY < 0 then
		newTargetX = deltaX / deltaY * -sourceY + sourceX
	end
--[[
	if deltaX > 0 and deltaY > 0 then
		newTargetX = deltaX / deltaY * (areaY - sourceY) + sourceX
		newTargetY = deltaY / deltaX * (areaX - sourceX) + sourceY
	elseif deltaX < 0 and deltaY > 0 then
		newTargetX = deltaX / deltaY * (areaY - sourceY) + sourceX
		newTargetY = deltaY / deltaX * -sourceX
	end
--]]
	if newTargetX < 0 then
		newTargetX = 0
	elseif newTargetX > areaX then
		newTargetX = areaX
	end
	if newTargetY < 0 then
		newTargetY = 0
	elseif newTargetY > areaY then
		newTargetY = areaY
	end

	local deltaH = math.floor((deltaX ^ 2 + deltaY ^ 2) ^ .5)
	if bit32.band(savingthrow, 0x100000) > 0 then
		local visionOffsets = {512, 768, 1024, 1280, 1536, 1792, 2048}
		local visionX = targetX
		local visionY = targetY
		for k, v in ipairs(visionOffsets) do
			visionX = deltaX / deltaH * v + sourceX
			visionY = deltaY / deltaH * v + sourceY
			if visionX > 0 and visionX < areaX and visionY > 0 and visionY < areaY and (maxDistance == 0 or v < maxDistance) then
				EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 67,
["target"] = 2,
["timing"] = 1,
["duration"] = 7,
["parameter2"] = 2,
["resource"] = "MELINEVI",
["vvcresource"] = "SNONE",
["source_x"] = visionX,
["source_y"] = visionY,
["target_x"] = visionX,
["target_y"] = visionY,
["source_target"] = sourceID,
["source_id"] = sourceID
})
			end
		end
	end
	if maxDistance > 0 then
		local maxX = deltaX / deltaH * maxDistance + sourceX
		local maxY = deltaY / deltaH * maxDistance + sourceY
		if maxX > 0 and maxX < areaX and maxY > 0 and maxY < areaY then
			newTargetX = maxX
			newTargetY = maxY
		end
	end
	EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 148,
["target"] = 2,
["timing"] = 1,
["parameter1"] = casterlvl,
["parameter2"] = 1,
["casterlvl"] = casterlvl,
["resource"] = spellRES,
["source_x"] = sourceX,
["source_y"] = sourceY,
["target_x"] = newTargetX,
["target_y"] = newTargetY,
["source_target"] = sourceID,
["source_id"] = sourceID
})
end

function MEBSSPEL(effectData, creatureData)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local spellRES = EEex_ReadLString(effectData + 0x18, 8)
	local savingthrow = EEex_ReadDword(effectData + 0x3C)
	local backstabMultiplier = EEex_GetActorStat(sourceID, 56) + EEex_ReadDword(effectData + 0x44)
	local casterlvl = EEex_ReadDword(effectData + 0xC4)
	local sourceX = EEex_ReadDword(creatureData + 0x8)
	local sourceY = EEex_ReadDword(creatureData + 0xC)
	local targetX = EEex_ReadDword(effectData + 0x84)
	local targetY = EEex_ReadDword(effectData + 0x88)
	for i = 1, backstabMultiplier, 1 do
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 1,
["parameter1"] = casterlvl,
["parameter2"] = 1,
["casterlvl"] = casterlvl,
["resource"] = spellRES,
["source_x"] = sourceX,
["source_y"] = sourceY,
["target_x"] = targetX,
["target_y"] = targetY,
["source_id"] = sourceID
})
	end
end
--[[

The EXSPLATK function performs a spell attack roll against the target. If the attack hits, it casts a spell on the target.

parameter1 - Modifies the attack roll; when parameter1 is higher, the attack is more accurate.

parameter2 - Specifies a stat that also modifies the attack roll (parameter2 should be equal to 0 (no stat), 36 (Strength),
 38 (Intelligence), 39 (Wisdom), 40 (Dexterity), 41 (Constitution), or 42 (Charisma)). If parameter2 is equal to 36, it uses
 STRMOD.2DA to determine the attack bonus; for any other stat, it uses DEXMOD.2DA.

savingthrow - This function uses several extra bits on this parameter:
 Bit 16: If set, the attack roll ignores the target's base armor class (treating it as if it were 10)
 Bit 17: If set, your bonus THAC0 with melee weapons is added to the roll.
 Bit 18: If set, your bonus THAC0 with missile weapons is added to the roll, and the target's
  AC vs. missiles is subtracted from it.
 Bit 19: If set, your bonus THAC0 with fist weapons is added to the roll.
 Bit 20: If set, you are treated as having the base THAC0 of a fighter the same level as your caster level.
 Bit 21: If set, on a critical hit, the spell will be cast twice on the target.
 Bit 22: If set, feedback will be given on the attack roll.

resource3 - Resref of spell to cast if the attack hits. If this effect is not being called from an EFF file, the resref
 is instead set to the resref of the spell that called this function with a "D" added at the end.
 
--]]
ex_dexterity_thac0 = {[0] = -20, [1] = -6, [2] = -4, [3] = -3, [4] = -2, [5] = -1, [6] = 0, [7] = 0, [8] = 0, [9] = 0, [10] = 0, [11] = 0, [12] = 0, [13] = 0, [14] = 0, [15] = 0, [16] = 1, [17] = 2, [18] = 2, [19] = 3, [20] = 3, [21] = 4, [22] = 4, [23] = 4, [24] = 5, [25] = 5}
ex_strength_thac0 = {[0] = -20, [1] = -5, [2] = -3, [3] = -3, [4] = -2, [5] = -2, [6] = -1, [7] = -1, [8] = 0, [9] = 0, [10] = 0, [11] = 0, [12] = 0, [13] = 0, [14] = 0, [15] = 0, [16] = 0, [17] = 1, [18] = 1, [19] = 3, [20] = 3, [21] = 4, [22] = 4, [23] = 5, [24] = 6, [25] = 7}
function MESPLATK(effectData, creatureData)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local savingthrow = EEex_ReadDword(effectData + 0x3C)
	local casterlvl = EEex_ReadDword(effectData + 0xC4)
	local parent_resource = EEex_ReadLString(effectData + 0x90, 8)
	local spellType = 4
	local spellData = EEex_DemandResData(parent_resource, "SPL")
	if spellData > 1000 then
		spellType = EEex_ReadWord(spellData + 0x1C, 0x0)
	end
	local roll = math.random(20)
	local baseTHAC0 = EEex_GetActorStat(sourceID, 7)
	local bonusTHAC0 = EEex_ReadDword(effectData + 0x18) + EEex_GetActorStat(sourceID, 32) + EEex_GetActorStat(sourceID, 610)
	if bit32.band(savingthrow, 0x20000) > 0 then
		bonusTHAC0 = bonusTHAC0 + EEex_GetActorStat(sourceID, 166)
	end
	if bit32.band(savingthrow, 0x40000) > 0 then
		bonusTHAC0 = bonusTHAC0 + EEex_GetActorStat(sourceID, 72)
	end
	if bit32.band(savingthrow, 0x80000) > 0 then
		bonusTHAC0 = bonusTHAC0 + EEex_GetActorStat(sourceID, 170)
	end
	if bit32.band(savingthrow, 0x100000) > 0 then
		baseTHAC0 = 21 - EEex_GetActorCasterLevel(sourceID, spellType)
	end
	local attackStat = EEex_ReadDword(effectData + 0x1C)
	if attackStat > 0 then
		local attackStatValue = EEex_GetActorStat(sourceID, attackStat)
		if attackStatValue < 0 then
			attackStatValue = 0
		elseif attackStatValue > 25 then
			attackStatValue = 25
		end
		if attackStat == 36 then
			bonusTHAC0 = bonusTHAC0 + ex_strength_thac0[attackStatValue]
			if attackStatValue == 18 then
				local exStrength = EEex_GetActorStat(sourceID, 37)
				if exStrength >= 51 then
					bonusTHAC0 = bonusTHAC0 + 1
				end
				if exStrength >= 100 then
					bonusTHAC0 = bonusTHAC0 + 1
				end
			end
		else
			bonusTHAC0 = bonusTHAC0 + ex_dexterity_thac0[attackStatValue]
		end
	end
	local criticalMissThreshold = 1
	local criticalHitThreshold = 20
	EEex_IterateActorEffects(sourceID, function(eData)
		local theopcode = EEex_ReadDword(eData + 0x10)
		local theparameter1 = EEex_ReadDword(eData + 0x1C)
		local theparameter2 = EEex_ReadDword(eData + 0x20)
		local thespecial = EEex_ReadDword(eData + 0x48)
		if theopcode == 54 and bit32.band(savingthrow, 0x100000) > 0 then
			if theparameter2 == 0 then
				baseTHAC0 = baseTHAC0 - theparameter1
			elseif theparameter2 == 1 then
				baseTHAC0 = theparameter1
			elseif theparameter2 == 2 then
				baseTHAC0 = math.floor(baseTHAC0 * theparameter1 / 100)
			end
		elseif theopcode == 278 and theparameter2 == 0 then
			bonusTHAC0 = bonusTHAC0 + theparameter1
		elseif theopcode == 301 and theparameter2 == 0 and (thespecial == 0 or thespecial == 3 or (thespecial == 1 and bit32.band(savingthrow, 0x20000) > 0) or (thespecial == 2 and bit32.band(savingthrow, 0x40000) > 0)) then
			criticalHitThreshold = criticalHitThreshold - theparameter1
		elseif theopcode == 362 and theparameter2 == 0 and (thespecial == 0 or thespecial == 3 or (thespecial == 1 and bit32.band(savingthrow, 0x20000) > 0) or (thespecial == 2 and bit32.band(savingthrow, 0x40000) > 0)) then
			criticalMissThreshold = criticalMissThreshold + theparameter1
		end
	end)
	local targetAC = EEex_GetActorStat(targetID, 2)
	if bit32.band(savingthrow, 0x10000) > 0 then
		local baseAC = EEex_ReadSignedWord(creatureData + 0x45C, 0x0)
		EEex_IterateActorEffects(sourceID, function(eData)
			local theopcode = EEex_ReadDword(eData + 0x10)
			local theparameter1 = EEex_ReadDword(eData + 0x1C)
			local theparameter2 = EEex_ReadDword(eData + 0x20)
			if theopcode == 0 and theparameter1 < baseAC and theparameter2 == 0x10 then
				baseAC = theparameter1
			end
		end)
		targetAC = targetAC + 10 - baseAC
	end
	bonusTHAC0 = bonusTHAC0 - EEex_GetActorStat(targetID, 611)
	if bit32.band(savingthrow, 0x40000) > 0 then
		bonusTHAC0 = bonusTHAC0 + EEex_GetActorStat(targetID, 4)
	end
	local attackFeedback = ex_spell_attack_feedback_string_1 .. roll
	if bonusTHAC0 >= 0 then
		attackFeedback = attackFeedback .. " + " .. bonusTHAC0 .. " = " .. (roll + bonusTHAC0) .. " : "
	else
		attackFeedback = attackFeedback .. " - " .. (bonusTHAC0 * -1) .. " = " .. (roll + bonusTHAC0) .. " : "
	end
	local hitType = 1
	if roll >= criticalHitThreshold then
		hitType = 3
		attackFeedback = attackFeedback .. ex_spell_attack_feedback_string_4
	elseif roll <= criticalMissThreshold then
		hitType = 0
		attackFeedback = attackFeedback .. ex_spell_attack_feedback_string_5
	elseif baseTHAC0 - bonusTHAC0 - roll <= targetAC then
		hitType = 2
		attackFeedback = attackFeedback .. ex_spell_attack_feedback_string_2
	else
		attackFeedback = attackFeedback .. ex_spell_attack_feedback_string_3
	end
	if bit32.band(savingthrow, 0x400000) > 0 then
		Infinity_SetToken("EX_SPLATK", attackFeedback)
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 139,
["target"] = 2,
["timing"] = 1,
["parameter1"] = ex_spell_attack_feedback_strref,
["source_id"] = sourceID
})
	end
	local targetX = EEex_ReadDword(creatureData + 0x8)
	local targetY = EEex_ReadDword(creatureData + 0xC)
	local sourceX = targetX
	local sourceY = targetY
	if hitType >= 2 then
		local spellRES = EEex_ReadLString(effectData + 0x74, 8)
		if spellRES == "" then
			spellRES = parent_resource .. "D"
		end
		if EEex_IsSprite(sourceID, true) then
			local sourceData = EEex_GetActorShare(sourceID)
			sourceX = EEex_ReadDword(sourceData + 0x8)
			sourceY = EEex_ReadDword(sourceData + 0xC)
		end
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 1,
["parameter1"] = casterlvl,
["parameter2"] = 1,
["casterlvl"] = casterlvl,
["resource"] = spellRES,
["source_x"] = sourceX,
["source_y"] = sourceY,
["target_x"] = targetX,
["target_y"] = targetY,
["source_id"] = sourceID
})
		if hitType == 3 and bit32.band(savingthrow, 0x200000) > 0 then
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 1,
["parameter1"] = casterlvl,
["parameter2"] = 1,
["casterlvl"] = casterlvl,
["resource"] = spellRES,
["source_x"] = sourceX,
["source_y"] = sourceY,
["target_x"] = targetX,
["target_y"] = targetY,
["source_id"] = sourceID
})
		end
	end
end

function MENECROP(effectData, creatureData)
	EEex_WriteDword(effectData + 0x110, 1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if not EEex_IsSprite(targetID, false) then return end
	if not EEex_GetActorSpellState(targetID, 212) then return end
--	local parent_resource = EEex_ReadLString(effectData + 0x90, 8)
--	local spellRES = EEex_ReadLString(effectData + 0x18, 8)
	local parent_resource = EEex_ReadLString(effectData + 0x18, 8)
	local spellData = EEex_DemandResData(parent_resource, "SPL")
	local spellLevel = 1
	if spellData > 0 then
		spellLevel = EEex_ReadDword(spellData + 0x34)
	end
	local savingthrow = EEex_ReadDword(effectData + 0x3C)
	local casterlvl = EEex_ReadDword(effectData + 0xC4)
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 402,
["target"] = 2,
["timing"] = 0,
["parameter1"] = 1,
["parameter2"] = 9,
["special"] = 1,
["savingthrow"] = 0x200000,
["resource"] = "EXMODMEM",
["vvcresource"] = parent_resource,
["source_id"] = targetID
})
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 17,
["target"] = 2,
["timing"] = 1,
["parameter1"] = spellLevel * -3,
["parameter2"] = 0x4000000,
["source_id"] = targetID
})
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 1,
["parameter1"] = 1,
["parameter2"] = 1,
["casterlvl"] = 1,
["resource"] = "MENECRDE",
["source_id"] = targetID
})
end


me_attacksperround = {"0", "1", "2", "3", "4", "5", "1/2", "3/2", "5/2", "7/2", "9/2"}
me_attacksperround_haste = {"0", "2", "4", "6", "8", "10", "1", "3", "5", "7", "9"}
me_classids = {"Mage", "Fighter", "Cleric", "Thief", "Bard", "Paladin", "Fighter/Mage", "Fighter/Cleric", "Fighter/Thief", "Fighter/Mage/Thief", "Druid", "Ranger", "Mage/Thief", "Cleric/Mage", "Cleric/Thief", "Fighter/Druid", "Fighter/Mage/Cleric", "Cleric/Ranger", "Sorcerer", "Monk", "Shaman"}
me_monsterclassids = {"Ankheg", "Basilisk", "Greater Basilisk", "Black Bear", "Brown Bear", "Cave Bear", "Polar Bear", "Carrion Crawler", "Wild Dog", "War Dog", "Doppelganger", "Greater Doppelganger", "Drizzt", "Elminster", "Ettercap", "Ghoul", "Revenant", "Ghast", "Gibberling", "Gnoll", "Hobgoblin", "Kobold", "Tasloi", "Xvart", "Ogre", "Ogre Mage", "Half-ogre", "Ogrillion", "Sarevok", "Sirine", "Dryad", "Nereid", "Nymph", "Skeleton", "Skeleton Warrior", "Skeleton Boneguard", "Giant Spider", "Huge Spider", "Phase Spider", "Sword Spider", "Wraith Spider", "Volo", "Wolf", "Worg", "Dire Wolf", "Winter Wolf", "Vampiric Wolf", "Dread Wolf", "Wyvern", "Olive Slime", "Mustard Jelly", "Ochre Jelly", "Gray Ooze", "Green Slime", "Innocent", "Flaming Fist", "Werewolf", "Wolfwere", "Death Knight", "Demon", "Beholder", "Mind Flayer", "Vampire", "Vampyre", "Otyugh", "Rakshasa", "Troll", "Umber Hulk", "Sahuagin", "Shadow", "Spectre", "Wraith", "Kuo-toa", "Mist Creature", "Cat", "Duergar", "Mephit", "Mimic", "Devil", "Giant", "Orc", "Iron Golem", "Flesh Golem", "Stone Golem", "Clay Golem", "Air Elemental", "Fire Elemental", "Earth Elemental", "Fat Spider Woman", "Red Dragon", "Shadow Dragon", "Silver Dragon", "Djinni", "Dao", "Efreeti", "Noble Djinni", "Noble Efreeti", "Zombie", "Prey", "Predator", "Long Sword", "Mage", "Fighter", "Cleric", "Thief", "Bard", "Paladin", "Druid", "Ranger", "Wizard Eye", "Watcher", "Amnian Soldier", "Town Guard", "creature of unknown class", "creature of unknown class", "creature of unknown", "creature of unknown class", "creature of unknown class", "Water Elemental", "Green Dragon", "Neothelid", "Spectral Troll", "Wight", "creature of unknown class", "creature of unknown class"}
me_kitids = {[64] = "Abjurer", [128] = "Conjurer", [256] = "Diviner", [512] = "Enchanter", [1024] = "Illusionist", [2048] = "Invoker", [4096] = "Necromancer", [8192] = "Transmuter", [16385] = "Berserker", [16386] = "Wizard Slayer", [16387] = "Kensai", [16388] = "Cavalier", [16389] = "Inquisitor", [16390] = "Undead Hunter", [16391] = "Archer", [16392] = "Stalker", [16393] = "Beastmaster", [16394] = "Assassin", [16395] = "Bounty Hunter", [16396] = "Swashbuckler", [16397] = "Blade", [16398] = "Jester", [16399] = "Skald", [16400] = "Totemic Druid", [16401] = "Shapeshifter", [16402] = "Avenger", [16403] = "Priest of Talos", [16404] = "Priest of Helm", [16405] = "Priest of Lathander", [16416] = "Blackguard", [16417] = "Shadowdancer", [16418] = "Dwarven Defender", [16419] = "Dragon Disciple", [16420] = "Dark Moon Monk", [16421] = "Sun Soul Monk", [16424] = "Priest of Tyr", [16425] = "Priest of Tempus", [1073741824] = "Barbarian"}
me_spellidstype = {[1] = "SPPR", [2] = "SPWI", [3] = "SPIN", [4] = "SPCL"}
me_proficiency = {[0x1] = 89, [0x2] = 90, [0x4] = 91, [0x8] = 92, [0x10] = 93, [0x20] = 94, [0x40] = 95, [0x80] = 96, [0x100] = 97, [0x200] = 98, [0x400] = 99, [0x800] = 100, [0x1000] = 101, [0x2000] = 102, [0x4000] = 103, [0x8000] = 104, [0x10000] = 105, [0x20000] = 106, [0x40000] = 107, [0x80000] = 108, [0x100000] = 111, [0x200000] = 112, [0x400000] = 113, [0x800000] = 114, [0x1000000] = 115}
me_multiclass_classes = {
[7] = {2, 1},
[8] = {2, 3},
[9] = {2, 4},
[10] = {2, 1, 4},
[13] = {1, 4},
[14] = {3, 1},
[15] = {3, 4},
[16] = {2, 11},
[17] = {2, 1, 3},
[18] = {3, 12}
}
me_multiclass_dual = {
[7] = {8, 16},
[8] = {8, 32},
[9] = {8, 64},
[10] = {8, 16, 64},
[13] = {16, 64},
[14] = {32, 16},
[15] = {32, 64},
[16] = {8, 128},
[17] = {8, 16, 32},
[18] = {32, 256}
}
me_resistance_opcode = {
[14] = {30, 0x46D},
[15] = {28, 0x46E},
[16] = {29, 0x46F},
[17] = {27, 0x470},
[19] = {84, 0x472},
[20] = {85, 0x473},
[21] = {86, 0x474},
[22] = {87, 0x475},
[23] = {88, 0x476},
[24] = {89, 0x477},
[73] = {31, 0},
[74] = {173, 0}
}
me_damage_resistance = {
[0] = {22, 87, 32431},
[1] = {17, 27, 32436},
[2] = {15, 28, 32434},
[4] = {16, 29, 32433},
[8] = {14, 30, 32428},
[16] = {23, 88, 32429},
[32] = {74, 173, 32437},
[64] = {73, 31, 32435},
[128] = {24, 89, 32432},
[256] = {21, 86, 32430},
[512] = {19, 84, 32438},
[1024] = {20, 85, 32439},
[2048] = {22, 87, 32440}
}
me_damage_resistance_base = {
[0] = 0x475,
[1] = 0x470,
[2] = 0x46E,
[4] = 0x46F,
[8] = 0x46D,
[16] = 0x476,
[128] = 0x477,
[256] = 0x474,
[512] = 0x472,
[1024] = 0x473,
[2048] = 0x475
}

function MESTATPR(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)

	me_class = EEex_GetActorClass(targetID)
	me_level1 = EEex_GetActorStat(targetID, 34)
	if (me_class >= 7 and me_class <= 10) or (me_class >= 13 and me_class <= 18) then
		me_level2 = "/" .. EEex_GetActorStat(targetID, 68)
	else
		me_level2 = ""
	end
	if me_class == 10 or me_class == 17 then
		me_level3 = "/" .. EEex_GetActorStat(targetID, 69)
	else
		me_level3 = ""
	end
	me_kit_string = ""
	me_kit_string_found = false
	for key,value in pairs(me_kitids) do
		if key == EEex_GetActorKit(targetID) then
			me_kit_string = value
			me_kit_string_found = true
		end
	end
	if EEex_GetActorKit(targetID) == -2147483648 then
		me_kit_string = "Wild Mage"
		me_kit_string_found = true
	end
	if me_kit_string_found == true then
		Infinity_DisplayString("Level " .. me_level1 .. me_level2 .. me_level3 .. " " .. me_kit_string)
	else
		if me_class >= 1 and me_class <= 21 then
			Infinity_DisplayString("Level " .. me_level1 .. me_level2 .. me_level3 .. " " .. me_classids[me_class])
		elseif me_class >= 101 and me_class <= 223 then
			Infinity_DisplayString("Level " .. me_level1 .. " " .. me_monsterclassids[me_class - 100])
		else
			Infinity_DisplayString("Level " .. me_level1 .. " creature of unknown class")
		end
	end
	
	Infinity_DisplayString("Hit Points: " .. EEex_ReadWord(creatureData + 0x438, 0x0) .. "/" .. EEex_GetActorStat(targetID, 1))
	Infinity_DisplayString("AC vs. slashing: " .. EEex_GetActorStat(targetID, 2) + EEex_GetActorStat(targetID, 6) .. "  AC vs. piercing: " .. EEex_GetActorStat(targetID, 2) + EEex_GetActorStat(targetID, 5) .. "  AC vs. crushing: " .. EEex_GetActorStat(targetID, 2) + EEex_GetActorStat(targetID, 3) .. "  AC vs. missiles: " .. EEex_GetActorStat(targetID, 2) + EEex_GetActorStat(targetID, 4))
	Infinity_DisplayString("Base THAC0: " .. EEex_GetActorStat(targetID, 7))
--	Infinity_DisplayString("Gold: " .. characters[id].gold)
--	Infinity_DisplayString("Base THAC0: " .. EEex_ReadByte(creatureData + 0x466, 0x0))
	if bit32.band(EEex_ReadDword(creatureData + 0x434), 0x8000) == 0x8000 or bit32.band(EEex_ReadDword(creatureData + 0xB30), 0x8000) == 0x8000 or EEex_GetActorStat(targetID, 155) > 0 then
		Infinity_DisplayString("Attacks per round: " .. me_attacksperround_haste[EEex_GetActorStat(targetID, 8) + 1])
	else
		Infinity_DisplayString("Attacks per round: " .. me_attacksperround[EEex_GetActorStat(targetID, 8) + 1])
	end
	Infinity_DisplayString("Attributes: ")
	if EEex_GetActorStat(targetID, 37) == 0 then
		me_strextra = ""
	elseif EEex_GetActorStat(targetID, 37) >= 100 then
		me_strextra = "/00"
	else
		me_strextra = "/" .. EEex_GetActorStat(targetID, 37)
	end
	Infinity_DisplayString("Strength: " .. EEex_GetActorStat(targetID, 36) .. me_strextra .. "  Dexterity: " .. EEex_GetActorStat(targetID, 40) .. "  Constitution: " .. EEex_GetActorStat(targetID, 41) .. "  Intelligence: " .. EEex_GetActorStat(targetID, 38) .. "  Wisdom: " .. EEex_GetActorStat(targetID, 39) .. "  Charisma: " .. EEex_GetActorStat(targetID, 42))
	Infinity_DisplayString(MEGetStat(targetID, "Slashing Resistance: ", 21, "%\n") .. MEGetStat(targetID, "Piercing Resistance: ", 23, "%\n") .. MEGetStat(targetID, "Crushing Resistance: ", 22, "%\n") .. MEGetStat(targetID, "Missile Resistance: ", 24, "%\n") .. MEGetStat(targetID, "Fire Resistance: ", 14, "%\n") .. MEGetStat(targetID, "Magical Fire Resistance: ", 19, "%\n") .. MEGetStat(targetID, "Cold Resistance: ", 15, "%\n") .. MEGetStat(targetID, "Magical Cold Resistance: ", 20, "%\n") .. MEGetStat(targetID, "Electricity Resistance: ", 16, "%\n") .. MEGetStat(targetID, "Acid Resistance: ", 17, "%\n") .. MEGetStat(targetID, "Poison Resistance: ", 74, "%\n") .. MEGetStat(targetID, "Magic Damage Resistance: ", 73, "%\n") .. MEGetStat(targetID, "Magic Resistance: ", 18, "%\n"))
	Infinity_DisplayString("Saving Throws: ")
	Infinity_DisplayString("Spell: " .. EEex_GetActorStat(targetID, 13) .. "  Death: " .. EEex_GetActorStat(targetID, 9) .. "  Breath: " .. EEex_GetActorStat(targetID, 12) .. "  Wands: " .. EEex_GetActorStat(targetID, 10) .. "  Polymorph: " .. EEex_GetActorStat(targetID, 11))
	Infinity_DisplayString(MEGetStat(targetID, "Backstab multiplier: ", 56, "x\n") .. MEGetStat(targetID, "Stoneskins remaining: ", 88, "\n") .. MEGetStat(targetID, "Casting time reduced by ", 77, "\n"))
	if EEex_GetActorStat(targetID, 79) > 0 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " casts wizard spells as if " .. EEex_GetActorStat(targetID, 79) .. " levels higher")
	end	
	if EEex_GetActorStat(targetID, 53) ~= 100 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " casts wizard spells with " .. EEex_GetActorStat(targetID, 53) .. "% the normal duration")
	end	
	if EEex_GetActorStat(targetID, 80) > 0 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " casts priest spells as if " .. EEex_GetActorStat(targetID, 80) .. " levels higher")
	end	
	if EEex_GetActorStat(targetID, 54) ~= 100 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " casts priest spells with " .. EEex_GetActorStat(targetID, 54) .. "% the normal duration")
	end	
	if EEex_GetActorStat(targetID, 76) ~= 0 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " can cast more than one spell per round")
	end
	if EEex_GetActorStat(targetID, 81) ~= 0 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " can see invisible creatures")
	end
	if EEex_GetActorStat(targetID, 191) ~= 0 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " can use any item")
	end
	if EEex_GetActorStat(targetID, 197) ~= 0 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " is immune to time stop")
	end
	if EEex_GetActorStat(targetID, 175) ~= 0 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " cannot be backstabbed")
	end
	if EEex_GetActorStat(targetID, 187) ~= 0 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " cannot be turned")
	end
	if EEex_GetActorStat(targetID, 83) ~= 0 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " cannot be reduced below " .. EEex_GetActorStat(targetID, 83) .. " HP")
	end
	if EEex_GetActorStat(targetID, 192) ~= 0 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " will backstab on each hit")
	end
	if EEex_GetActorStat(targetID, 181) == 1 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " is under the effect of Protection from Normal Weapons")
	end
	if EEex_GetActorStat(targetID, 128) == 1 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " is under the effect of Mantle")
	elseif EEex_GetActorStat(targetID, 128) == 2 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " is under the effect of Improved Mantle")
	elseif EEex_GetActorStat(targetID, 128) == 3 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " is under the effect of Absolute Immunity")
	elseif EEex_GetActorStat(targetID, 128) == 4 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " is under the effect of Protection from Magical Weapons")
	end
	if EEex_GetActorStat(targetID, 122) ~= 0 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " will reflect missile attacks")
	end
	if EEex_GetActorStat(targetID, 145) > 19 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " will deal maximum damage with each hit")
	end
	if EEex_GetActorStat(targetID, 146) > 0 then
		if EEex_GetActorStat(targetID, 146) > 19 then
			Infinity_DisplayString(EEex_GetActorName(targetID) .. " will critically hit on every attack")
		else
			Infinity_DisplayString(EEex_GetActorName(targetID) .. " will critically hit on a roll between " .. 20 - EEex_GetActorStat(targetID, 146) .. " and 20")
		end
	end
	if EEex_GetActorStat(targetID, 200) > 0 then
		Infinity_DisplayString(EEex_GetActorName(targetID) .. " has been drained " .. EEex_GetActorStat(targetID, 200) .. " levels")
	end	

end

function MEGetStat(targetID, pre, stat, post)
	if EEex_GetActorStat(targetID, stat) == 0 then
		return ""
	else
		return pre .. EEex_GetActorStat(targetID, stat) .. post
	end
end

me_ghost_walk_dest_x = {}
me_ghost_walk_dest_y = {}
me_ghost_walk_area = {}

function MEGHOWS2(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local target = EEex_ReadDword(creatureData + 0x318)
	local targetx = EEex_ReadDword(creatureData + 0x34C)
	local targety = EEex_ReadDword(creatureData + 0x350)
	local destx = EEex_ReadDword(creatureData + 0x3404)
	local desty = EEex_ReadDword(creatureData + 0x3408)
	local destx2 = EEex_ReadDword(creatureData + 0x3568)
	local desty2 = EEex_ReadDword(creatureData + 0x356C)
--	Infinity_DisplayString("Target: " .. target)
--	Infinity_DisplayString("Targeting: [" .. targetx .. "." .. targety .. "]")
--	Infinity_DisplayString("Maybe going to: [" .. destx .. "." .. desty .. "]")
	if destx > 0 or desty > 0 then
--		EEex_LuaObject = targetID
		me_ghost_walk_dest_x["" .. targetID] = destx
		me_ghost_walk_dest_y["" .. targetID] = desty
		me_ghost_walk_area["" .. targetID] = EEex_GetActorAreaRes(targetID)
--		local currentAction = EEex_ReadWord(creatureData + 0x2F8, 0x0)
--		if currentAction == 23 then
--			EEex_WriteWord(creatureData + 0x2F8, 84)
--			EEex_WriteWord(creatureData + 0x338, EEex_GetActorRequiredDirection(targetID, destx, desty))
--			EEex_WriteWord(creatureData + 0x31FE, EEex_GetActorRequiredDirection(targetID, destx, desty))
--		end
--		EEex_WriteWord(creatureData + 0x31FE, EEex_GetActorRequiredDirection(targetID, destx, desty))
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 148,
["target"] = 1,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 1,
["duration"] = 100,
["resource"] = "MEGHOWLK",
["source_x"] = x,
["source_y"] = y,
["target_x"] = destx,
["target_y"] = desty,
["source_target"] = targetID,
["source_id"] = targetID
})
	elseif destx2 > 0 or desty2 > 0 then
--		EEex_LuaObject = targetID
		me_ghost_walk_dest_x["" .. targetID] = destx2
		me_ghost_walk_dest_y["" .. targetID] = desty2
		me_ghost_walk_area["" .. targetID] = EEex_GetActorAreaRes(targetID)
--		local currentAction = EEex_ReadWord(creatureData + 0x2F8, 0x0)
--		if currentAction == 23 then
--			EEex_WriteWord(creatureData + 0x2F8, 84)
--			EEex_WriteWord(creatureData + 0x338, EEex_GetActorRequiredDirection(targetID, destx, desty))
--			EEex_WriteWord(creatureData + 0x31FE, EEex_GetActorRequiredDirection(targetID, destx, desty))
--		end
--		EEex_WriteWord(creatureData + 0x31FE, EEex_GetActorRequiredDirection(targetID, destx, desty))
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 148,
["target"] = 1,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 1,
["duration"] = 100,
["resource"] = "MEGHOWLK",
["source_x"] = x,
["source_y"] = y,
["target_x"] = destx2,
["target_y"] = desty2,
["source_target"] = targetID,
["source_id"] = targetID
})
	end
end

function MEGHOWLK(effectData, creatureData)
	local sourceID = EEex_ReadDword(creatureData + 0x34)
	if not EEex_IsSprite(sourceID) then return end
	local sourceX = EEex_ReadDword(creatureData + 0x8)
	local sourceY = EEex_ReadDword(creatureData + 0xC)
	local destx = EEex_ReadDword(creatureData + 0x3404)
	local desty = EEex_ReadDword(creatureData + 0x3408)
	local destx2 = EEex_ReadDword(creatureData + 0x3568)
	local desty2 = EEex_ReadDword(creatureData + 0x356C)
	local targetX = 0
	local targetY = 0
	local storedx = me_ghost_walk_dest_x["" .. sourceID]
	local storedy = me_ghost_walk_dest_y["" .. sourceID]
	local storedarea = me_ghost_walk_area["" .. sourceID]
	if storedarea ~= nil and EEex_GetActorAreaRes(sourceID) ~= storedarea then
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 321,
["target"] = 1,
["timing"] = 1,
["duration"] = 100,
["resource"] = "MEGHOWLK",
["source_target"] = sourceID,
["source_id"] = sourceID
})	
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 321,
["target"] = 1,
["timing"] = 1,
["duration"] = 100,
["resource"] = "MEFLYISP",
["source_target"] = sourceID,
["source_id"] = sourceID
})	
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 321,
["target"] = 1,
["timing"] = 1,
["duration"] = 100,
["resource"] = "MEETHRSP",
["source_target"] = sourceID,
["source_id"] = sourceID
})	
	elseif destx > 0 and desty > 0 and (destx ~= storedx or desty ~= storedy) then
		targetX = destx
		targetY = desty
	elseif destx2 > 0 and desty2 > 0 and (destx2 ~= storedx or desty2 ~= storedy) then
		targetX = destx2
		targetY = desty2
	end
	me_ghost_walk_area["" .. sourceID] = EEex_GetActorAreaRes(sourceID)
	if targetX <= 0 or targetY <= 0 then return end
	EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 321,
["target"] = 1,
["timing"] = 1,
["duration"] = 100,
["resource"] = "MEFLYISP",
["source_target"] = sourceID,
["source_id"] = sourceID
})	
	EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 321,
["target"] = 1,
["timing"] = 1,
["duration"] = 100,
["resource"] = "MEETHRSP",
["source_target"] = sourceID,
["source_id"] = sourceID
})	
	me_ghost_walk_dest_x["" .. sourceID] = targetX
	me_ghost_walk_dest_y["" .. sourceID] = targetY
--[[
	EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 148,
["target"] = 1,	
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 1,
["duration"] = 100,
["resource"] = "MEGHOWLK",
["source_x"] = sourceX,
["source_y"] = sourceY,
["target_x"] = targetX,
["target_y"] = targetY,
["source_target"] = sourceID,
["source_id"] = sourceID
})
--]]
	local isEthereal = EEex_GetActorStat(sourceID, 639)
	local speed = EEex_GetActorStat(sourceID, 640)
	local targetID = EEex_ReadDword(creatureData + 0x318)
	local action = EEex_GetActorCurrentAction(sourceID)
--	Infinity_DisplayString(action)
--	Infinity_DisplayString(targetID)
	if ((EEex_IsSprite(targetID) and targetID ~= sourceID) or action == 3 or action == 134) then
--		Infinity_DisplayString(action)
--		local targetLocX, targetLocY = EEex_GetActorLocation(targetID)
		local targetLocX = targetX
		local targetLocY = targetY
--		Infinity_DisplayString("ugu")
		if targetLocX > sourceX then
			targetX = targetLocX - 20
		elseif targetLocX > sourceX then
			targetX = targetLocX + 20
		end
		if targetLocY > sourceY then
			targetY = targetLocY - 20
		elseif targetLocY > sourceY then
			targetY = targetLocY + 20
		end
		local coordinateString = targetX .. "." .. targetY
		local otherCoordinateString = "0.0"
--		Infinity_DisplayString(coordinateString)
		if me_ghost_walk_positions[coordinateString] == nil or coordinateString == me_ghost_walk_actors["" .. sourceID] then
			if me_ghost_walk_actors["" .. sourceID] ~= nil then
				me_ghost_walk_positions[me_ghost_walk_actors["" .. sourceID]] = nil
			end
			me_ghost_walk_actors["" .. sourceID] = coordinateString
			me_ghost_walk_positions[coordinateString] = sourceID
		else
			local emptySlotFound = false
			if me_ghost_walk_actors["" .. sourceID] ~= nil then
				me_ghost_walk_positions[me_ghost_walk_actors["" .. sourceID]] = nil
			end
			for key,value in pairs(me_ghost_walk_offsets) do
				if not emptySlotFound then
					otherCoordinateString = (targetLocX + value[1]) .. "." .. (targetLocY + value[2])
					if otherCoordinateString == me_ghost_walk_actors["" .. sourceID] then
						emptySlotFound = true
						if me_ghost_walk_actors["" .. sourceID] ~= nil then
							me_ghost_walk_positions[me_ghost_walk_actors["" .. sourceID]] = nil
						end
						me_ghost_walk_actors["" .. sourceID] = otherCoordinateString
						me_ghost_walk_positions[otherCoordinateString] = sourceID
						targetX = targetLocX + value[1]
						targetY = targetLocY + value[2]
					end
				end
			end
			for key,value in pairs(me_ghost_walk_offsets) do
				if not emptySlotFound then
					otherCoordinateString = (targetLocX + value[1]) .. "." .. (targetLocY + value[2])
					if me_ghost_walk_positions[otherCoordinateString] == nil then
						emptySlotFound = true
						if me_ghost_walk_actors["" .. sourceID] ~= nil then
							me_ghost_walk_positions[me_ghost_walk_actors["" .. sourceID]] = nil
						end
						me_ghost_walk_actors["" .. sourceID] = otherCoordinateString
						me_ghost_walk_positions[otherCoordinateString] = sourceID
						targetX = targetLocX + value[1]
						targetY = targetLocY + value[2]
					end
				end
			end
			if not emptySlotFound then
				if me_ghost_walk_actors["" .. sourceID] ~= nil then
					me_ghost_walk_positions[me_ghost_walk_actors["" .. sourceID]] = nil
				end
				me_ghost_walk_actors["" .. sourceID] = coordinateString
				me_ghost_walk_positions[coordinateString] = sourceID
			end
		end
	end
	local theareatype = 0
	if EEex_ReadDword(EEex_GetActorShare(sourceID) + 0x14) > 0 then
		theareatype = EEex_ReadWord(EEex_ReadDword(EEex_GetActorShare(sourceID) + 0x14) + 0x40, 0x0)
	end
	if bit32.band(theareatype, 0x800) == 0 and speed > 0 then
		if isEthereal == 1 then
			EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 235,
["target"] = 1,
["parameter1"] = speed - 1,
["parameter2"] = 3,
["timing"] = 0,
["duration"] = 60,
["source_x"] = sourceX,
["source_y"] = sourceY,
["target_x"] = targetX,
["target_y"] = targetY,
["source_target"] = sourceID,
["source_id"] = sourceID,
["parent_resource"] = "MEETHRSP"
})	
		else
			EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 406,
["target"] = 1,
["timing"] = 0,
["duration"] = 60,
["source_target"] = sourceID,
["source_id"] = sourceID,
["parent_resource"] = "MEFLYISP"
})	
			EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 235,
["target"] = 1,
["parameter1"] = speed - 1,
["parameter2"] = 3,
["timing"] = 0,
["duration"] = 60,
["source_x"] = sourceX,
["source_y"] = sourceY,
["target_x"] = targetX,
["target_y"] = targetY,
["source_target"] = sourceID,
["source_id"] = sourceID,
["parent_resource"] = "MEFLYISP"
})	
		end
--		local currentAction = EEex_ReadWord(creatureData + 0x2F8, 0x0)
--		if currentAction == 23 then
--			C:Eval("ActionOverride(\"" .. EEex_GetActorScriptName(sourceID) .. "\", Face(" .. EEex_GetActorRequiredDirection(sourceID, targetX, targetY) .."))")
--			EEex_WriteWord(creatureData + 0x2F8, 84)
--			EEex_WriteWord(creatureData + 0x338, EEex_GetActorRequiredDirection(sourceID, targetX, targetY))
--		EEex_Call(EEex_Label("CGameSprite::Face"), {EEex_GetActorRequiredDirection(sourceID, targetX, targetY)}, creatureData, 0x0)
--			EEex_WriteWord(creatureData + 0x31FE, EEex_GetActorRequiredDirection(sourceID, targetX, targetY))
--		end
	end
	if EEex_GetActorStat(sourceID, 637) == 0 then
--		Infinity_DisplayString("Game reloaded?")
--[[
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 321,
["target"] = 1,
["timing"] = 1,
["duration"] = 100,
["resource"] = "MEGHOWST",
["source_target"] = sourceID,
["source_id"] = sourceID
})	
--]]
--		EEex_WriteDword(effectData + 0x110, 0x1)
    	EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 9,
--["duration"] = EEex_GetGameTick() + 3,
["resource"] = "MEGHOWST",
["parent_resource"] = "MEGHOWSA",
["source_target"] = sourceID,
["source_id"] = sourceID
})
    	EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 206,
["target"] = 2,
["parameter1"] = 0,
["parameter2"] = 0,
["timing"] = 0,
["duration"] = 3,
["resource"] = "MEGHOWSA",
["source_target"] = sourceID,
["source_id"] = sourceID
})

--[[
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 407,
["target"] = 1,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 10,
["duration"] = 1,
["resource"] = "MEGHOWST",
["source_target"] = sourceID,
["source_id"] = sourceID,
["parent_resource"] = "MEGHOWST"
})	
--]]
	end
end
me_ghost_walk_offsets = {{-20, -20}, {0, -20}, {20, -20}, {20, 0}, {20, 20}, {0, 20}, {-20, 20}, {-20, 0}, {-10, -30}, {10, -30}, {30, -10}, {30, 10}, {10, 30}, {-10, 30}, {-30, 10}, {-30, -10}}
me_ghost_walk_positions = {}
me_ghost_walk_actors = {}
me_object_target_actions = {
[3] = 1, [8] = 1, [22] = 1, [25] = 1, [31] = 1, [87] = 1, [98] = 1, [105] = 1, [134] = 1, [139] = 1, [180] = 1, [191] = 1, [208] = 1
}
function MEGHOWSP(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local sourceID = EEex_ReadDword(creatureData + 0x34)
	if not EEex_IsSprite(sourceID) then return end
	local isEthereal = EEex_GetActorStat(sourceID, 639)
	local speed = EEex_GetActorStat(sourceID, 640)
--	Infinity_DisplayString("isEthereal: " .. isEthereal .. "; speed: " .. speed)
	local sourceX = EEex_ReadDword(effectData + 0x7C)
	local sourceY = EEex_ReadDword(effectData + 0x80)
	local targetX = EEex_ReadDword(effectData + 0x84)
	local targetY = EEex_ReadDword(effectData + 0x88)
	local targetID = EEex_ReadDword(creatureData + 0x318)
	local action = EEex_GetActorCurrentAction(sourceID)
--	Infinity_DisplayString(action)
--	Infinity_DisplayString(targetID)
	if ((EEex_IsSprite(targetID) and targetID ~= sourceID) or action == 3 or action == 134) then
--		Infinity_DisplayString(action)
--		local targetLocX, targetLocY = EEex_GetActorLocation(targetID)
		local targetLocX = targetX
		local targetLocY = targetY
--		Infinity_DisplayString("ugu")
		if targetLocX > sourceX then
			targetX = targetLocX - 20
		elseif targetLocX > sourceX then
			targetX = targetLocX + 20
		end
		if targetLocY > sourceY then
			targetY = targetLocY - 20
		elseif targetLocY > sourceY then
			targetY = targetLocY + 20
		end
		local coordinateString = targetX .. "." .. targetY
		local otherCoordinateString = "0.0"
--		Infinity_DisplayString(coordinateString)
		if me_ghost_walk_positions[coordinateString] == nil or coordinateString == me_ghost_walk_actors["" .. sourceID] then
			if me_ghost_walk_actors["" .. sourceID] ~= nil then
				me_ghost_walk_positions[me_ghost_walk_actors["" .. sourceID]] = nil
			end
			me_ghost_walk_actors["" .. sourceID] = coordinateString
			me_ghost_walk_positions[coordinateString] = sourceID
		else
			local emptySlotFound = false
			if me_ghost_walk_actors["" .. sourceID] ~= nil then
				me_ghost_walk_positions[me_ghost_walk_actors["" .. sourceID]] = nil
			end
			for key,value in pairs(me_ghost_walk_offsets) do
				if not emptySlotFound then
					otherCoordinateString = (targetLocX + value[1]) .. "." .. (targetLocY + value[2])
					if otherCoordinateString == me_ghost_walk_actors["" .. sourceID] then
						emptySlotFound = true
						if me_ghost_walk_actors["" .. sourceID] ~= nil then
							me_ghost_walk_positions[me_ghost_walk_actors["" .. sourceID]] = nil
						end
						me_ghost_walk_actors["" .. sourceID] = otherCoordinateString
						me_ghost_walk_positions[otherCoordinateString] = sourceID
						targetX = targetLocX + value[1]
						targetY = targetLocY + value[2]
					end
				end
			end
			for key,value in pairs(me_ghost_walk_offsets) do
				if not emptySlotFound then
					otherCoordinateString = (targetLocX + value[1]) .. "." .. (targetLocY + value[2])
					if me_ghost_walk_positions[otherCoordinateString] == nil then
						emptySlotFound = true
						if me_ghost_walk_actors["" .. sourceID] ~= nil then
							me_ghost_walk_positions[me_ghost_walk_actors["" .. sourceID]] = nil
						end
						me_ghost_walk_actors["" .. sourceID] = otherCoordinateString
						me_ghost_walk_positions[otherCoordinateString] = sourceID
						targetX = targetLocX + value[1]
						targetY = targetLocY + value[2]
					end
				end
			end
			if not emptySlotFound then
				if me_ghost_walk_actors["" .. sourceID] ~= nil then
					me_ghost_walk_positions[me_ghost_walk_actors["" .. sourceID]] = nil
				end
				me_ghost_walk_actors["" .. sourceID] = coordinateString
				me_ghost_walk_positions[coordinateString] = sourceID
			end
		end
	end
	if speed > 0 then
		if isEthereal == 1 then
			EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 235,
["target"] = 1,
["parameter1"] = speed,
["parameter2"] = 3,
["timing"] = 1,
["duration"] = 6,
["source_x"] = sourceX,
["source_y"] = sourceY,
["target_x"] = targetX,
["target_y"] = targetY,
["source_target"] = sourceID,
["source_id"] = sourceID,
["parent_resource"] = "MEETHRSP"
})	
		else
			EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 235,
["target"] = 1,
["parameter1"] = speed,
["parameter2"] = 3,
["timing"] = 1,
["duration"] = 6,
["source_x"] = sourceX,
["source_y"] = sourceY,
["target_x"] = targetX,
["target_y"] = targetY,
["source_target"] = sourceID,
["source_id"] = sourceID,
["parent_resource"] = "MEFLYISP"
})	
		end
--		local currentAction = EEex_ReadWord(creatureData + 0x2F8, 0x0)
--		if currentAction == 23 then
--			EEex_WriteWord(creatureData + 0x2F8, 84)
--			EEex_WriteWord(creatureData + 0x338, EEex_GetActorRequiredDirection(targetID, EEex_ReadDword(effectData + 0x84), EEex_ReadDword(effectData + 0x88)))
--		EEex_Call(EEex_Label("CGameSprite::Face"), {EEex_GetActorRequiredDirection(targetID, EEex_ReadDword(effectData + 0x84), EEex_ReadDword(effectData + 0x88))}, creatureData, 0x0)
--		EEex_WriteWord(creatureData + 0x31FE, EEex_GetActorRequiredDirection(targetID, EEex_ReadDword(effectData + 0x84), EEex_ReadDword(effectData + 0x88)))
--		end
	end
end

function MEBIRDFS(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local destx = EEex_ReadDword(creatureData + 0x3404)
	local desty = EEex_ReadDword(creatureData + 0x3408)
--	Infinity_DisplayString("Going to: [" .. destx .. "." .. desty .. "]")
	if destx > 0 or desty > 0 then
		me_ghost_walk_dest_x["" .. targetID] = destx
		me_ghost_walk_dest_y["" .. targetID] = desty
		C:Eval("ActionOverride(\"MEBIRD" .. me_bird_id .. "\", FlyToPoint([" .. destx .. "." .. desty .. "], 15))")
--		C:Eval("ActionOverride(\"MEBIRD" .. me_bird_id .. "\", ReallyForceSpellPointRES(\"MEBIRDF2\", [" .. destx .. "." .. desty .. "]))")
	end
end

function MEBIRDFL(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local x = EEex_ReadDword(creatureData + 0x8)
	local y = EEex_ReadDword(creatureData + 0xc)
	local destx = EEex_ReadDword(creatureData + 0x3404)
	local desty = EEex_ReadDword(creatureData + 0x3408)
	local me_bird_id = EEex_GetActorLocal(targetID, "ME_Bird_ID")
	local storedx = me_ghost_walk_dest_x["" .. targetID]
	local storedy = me_ghost_walk_dest_y["" .. targetID]
--	Infinity_DisplayString("Location: [" .. x .. "." .. y .. "]")
--	Infinity_DisplayString("Destination: [" .. storedx .. "." .. storedy .. "]")
	if destx > 0 and desty > 0 and (destx ~= storedx or desty ~= storedy) then
		me_ghost_walk_dest_x["" .. targetID] = destx
		me_ghost_walk_dest_y["" .. targetID] = desty
		C:Eval("ActionOverride(\"MEBIRD" .. me_bird_id .. "\", FlyToPoint([" .. destx .. "." .. desty .. "], 15))")
--		C:Eval("ActionOverride(\"MEBIRD" .. me_bird_id .. "\", ReallyForceSpellPointRES(\"MEBIRDF2\", [" .. destx .. "." .. desty .. "]))")
--	elseif math.abs(x - storedx) < 10 and math.abs(y - storedy) < 10 then
--		EEex_LuaObject = targetID
--		C:Eval("ApplySpellRES(\"MEGHOWEN\", EEex_LuaObject)")
	end
end

function MECREFLG(effectData, creatureData)
	local me_modifier = EEex_ReadDword(effectData + 0x18)
	local me_operand = EEex_ReadDword(effectData + 0x1c)
	local me_cre_flags = EEex_ReadDword(creatureData + 0x424)
	if me_operand == 0 then
		me_cre_flags = me_modifier
	elseif me_operand == 1 then
		me_cre_flags = bit32.band(me_cre_flags, me_modifier)
	elseif me_operand == 2 then
		me_cre_flags = bit32.bor(me_cre_flags, me_modifier)
	elseif me_operand == 3 then
		me_cre_flags = bit32.bxor(me_cre_flags, me_modifier)
	elseif me_operand == 4 then
		me_cre_flags = bit32.band(me_cre_flags, bit32.bnot(me_modifier))
	end
	EEex_WriteDword(creatureData + 0x424, me_cre_flags)
end

function ME_Set_Creature_Flags(actorID, me_modifier, me_operand)
	local me_creatureData = EEex_GetActorShare(actorID)
	local me_cre_flags = EEex_ReadDword(me_creatureData + 0x424)
	if me_operand == 0 then
		me_cre_flags = me_modifier
	elseif me_operand == 1 then
		me_cre_flags = bit32.band(me_cre_flags, me_modifier)
	elseif me_operand == 2 then
		me_cre_flags = bit32.bor(me_cre_flags, me_modifier)
	elseif me_operand == 3 then
		me_cre_flags = bit32.bxor(me_cre_flags, me_modifier)
	elseif me_operand == 4 then
		me_cre_flags = bit32.band(me_cre_flags, bit32.bnot(me_modifier))
	end
	EEex_WriteDword(me_creatureData + 0x424, me_cre_flags)
end

function MEINKILL(effectData, creatureData)
		EEex_LuaObject = EEex_ReadDword(creatureData + 0x34)
		C:Eval("ApplySpellRES(\"MEINKILL\", EEex_LuaObject)")
end

function MESEARCH(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local is_string = EEex_ReadDword(effectData + 0x40)
	local search_end = EEex_ReadDword(effectData + 0x44)
	if is_string > 0 then
		local search_target = EEex_ReadLString(effectData + 0x18, 0x8)
		for i = 0, search_end, 1 do
			if EEex_ReadLString(creatureData + i, 0x8) == search_target then
				Infinity_DisplayString("Match found for " .. search_target .. " at offset " .. i)
			end
		end
	else
		local search_byte = EEex_ReadByte(effectData + 0x18, 0x0)
		local search_word = EEex_ReadWord(effectData + 0x18, 0x0)
		local search_dword = EEex_ReadDword(effectData + 0x18)
		for i = 0, search_end, 1 do
			if EEex_ReadDword(creatureData + i) == search_dword then
				Infinity_DisplayString("Match found for " .. search_dword .. " at offset " .. i .. " (4 bytes)")
			elseif EEex_ReadWord(creatureData + i, 0x0) == search_word then
				Infinity_DisplayString("Match found for " .. search_word .. " at offset " .. i .. " (2 bytes)")
			elseif EEex_ReadByte(creatureData + i, 0x0) == search_byte then
				Infinity_DisplayString("Match found for " .. search_byte .. " at offset " .. i .. " (1 byte)")
			end
		end
	end
end

function ME_Search_General(search_target, search_offset, search_length, is_string)
	if is_string > 0 then
		for i = 0, search_length, 1 do
			if EEex_ReadLString(search_offset + i, 0x8) == search_target then
				Infinity_DisplayString("Match found for " .. search_target .. " at offset " .. i)
			end
		end
	else
		for i = 0, search_length, 1 do
			if EEex_ReadDword(search_offset + i) == search_target then
				Infinity_DisplayString("Match found for " .. search_target .. " at offset " .. i .. " (4 bytes)")
			elseif EEex_ReadWord(search_offset + i, 0x0) == search_target then
				Infinity_DisplayString("Match found for " .. search_target .. " at offset " .. i .. " (2 bytes)")
			elseif EEex_ReadByte(search_offset + i, 0x0) == search_target then
				Infinity_DisplayString("Match found for " .. search_target .. " at offset " .. i .. " (1 byte)")
			end
		end
	end
end

function MEPRINTO(effectData, creatureData)
	local offset = EEex_ReadDword(effectData + 0x1c)
	local read_size = EEex_ReadDword(effectData + 0x40)
	if read_size == 1 then
		Infinity_DisplayString("Byte at offset " .. offset .. " is " .. EEex_ReadByte(creatureData + offset, 0x0))
	elseif read_size == 2 then
		Infinity_DisplayString("Word at offset " .. offset .. " is " .. EEex_ReadWord(creatureData + offset, 0x0))
	elseif read_size == 4 or read_size == 0 then
		Infinity_DisplayString("Dword at offset " .. offset .. " is " .. EEex_ReadDword(creatureData + offset))
	else
		Infinity_DisplayString("String at offset " .. offset .. " is " .. EEex_ReadLString(creatureData + offset, 0x8))
	end
end

function MEPRINTS(effectData, creatureData)
	local starting = EEex_ReadDword(effectData + 0x1C)
	local ending = EEex_ReadDword(effectData + 0x44)
	for i = starting, ending, 1 do
		Infinity_DisplayString(EEex_ToHex(i, 0, true) .. ": " .. EEex_ReadByte(creatureData + i, 0x0) .. ", " .. EEex_ReadWord(creatureData + i, 0x0) .. ", " .. EEex_ReadDword(creatureData + i) .. ", \"" .. EEex_ReadLString(creatureData + i, 8) .. "\"")
	end 
end
--[[
function MECORMOV(effectData, creatureData)
	local destx = EEex_ReadDword(creatureData + 0x34C)
	local desty = EEex_ReadDword(creatureData + 0x350)
	local destx2 = EEex_ReadDword(creatureData + 0x3404)
	local desty2 = EEex_ReadDword(creatureData + 0x3408)
	local destx3 = EEex_ReadDword(creatureData + 0x3568)
	local desty3 = EEex_ReadDword(creatureData + 0x356C)
--	Infinity_DisplayString("Going to: [" .. destx .. "." .. desty .. "]")
--	Infinity_DisplayString("Maybe going to: [" .. destx2 .. "." .. desty2 .. "]")
--	Infinity_DisplayString("Perhaps going to: [" .. destx3 .. "." .. desty3 .. "]")
	if destx > 0 and desty > 0 then
		EEex_LuaObject = EEex_ReadDword(creatureData + 0x34)
		if destx < 6000 and desty < 6000 then
			C:Eval("ActionOverride(EEex_LuaObject,ReallyForceSpellPointRES(\"MECORMOT\",[" .. destx .. "." .. desty .. "]))")
--		else
--			C:Eval("ActionOverride(EEex_LuaObject,ReallyForceSpellPointRES(\"MECORMOT\",[" .. destx2 .. "." .. desty2 .. "]))")
		end
	end
end
--]]

function MECORMOV(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local x = EEex_ReadDword(creatureData + 0x8)
	local y = EEex_ReadDword(creatureData + 0xC)
--	local destx = EEex_ReadDword(creatureData + 0x34C)
--	local desty = EEex_ReadDword(creatureData + 0x350)
--	local prevx = EEex_ReadDword(creatureData + 0x410)
--	local prevy = EEex_ReadDword(creatureData + 0x414)
	local destx2 = EEex_ReadDword(creatureData + 0x3404)
	local desty2 = EEex_ReadDword(creatureData + 0x3408)
--	local destx3 = EEex_ReadDword(creatureData + 0x3568)
--	local desty3 = EEex_ReadDword(creatureData + 0x356C)
	local theareatype = 0
	if EEex_ReadDword(EEex_GetActorShare(targetID) + 0x14) > 0 then
		theareatype = EEex_ReadWord(EEex_ReadDword(EEex_GetActorShare(targetID) + 0x14) + 0x40, 0x0)
	end
	if bit32.band(theareatype, 0x800) == 0 and destx2 > 0 then
--		Infinity_DisplayString("Going to: [" .. destx .. "." .. desty .. "]")
--		Infinity_DisplayString("Maybe going to: [" .. destx2 .. "." .. desty2 .. "]")
--		Infinity_DisplayString("Perhaps going to: [" .. destx3 .. "." .. desty3 .. "]")
    	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 124,
["target"] = 1,
["timing"] = 1,
["source_id"] = targetID,
["source_target"] = targetID,
["source_x"] = x,
["source_y"] = y,
["target_x"] = destx2,
["target_y"] = desty2
})
	end

end

function EEex_GetDistance(x1, y1, x2, y2)
	return math.floor((((x1 - x2) ^ 2) + ((y1 - y2) ^ 2)) ^ .5) 
end

function MEPSPMOV(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local x = EEex_ReadDword(creatureData + 0x8)
	local y = EEex_ReadDword(creatureData + 0xC)
	local destx = EEex_ReadDword(creatureData + 0x3404)
	local desty = EEex_ReadDword(creatureData + 0x3408)
	local theareatype = 0
	if EEex_ReadDword(EEex_GetActorShare(targetID) + 0x14) > 0 then
		theareatype = EEex_ReadWord(EEex_ReadDword(EEex_GetActorShare(targetID) + 0x14) + 0x40, 0x0)
	end
	if bit32.band(theareatype, 0x800) == 0 and destx > 0 and EEex_GetDistance(x, y, destx, desty) > 100 then
    	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 215,
["target"] = 1,
["timing"] = 1,
["resource"] = "DDOORH",
["parent_resource"] = "METELEPH",
["source_id"] = targetID,
["source_target"] = targetID,
["source_x"] = x,
["source_y"] = y,
["target_x"] = destx,
["target_y"] = desty
})
    	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 124,
["target"] = 1,
["timing"] = 1,
["parent_resource"] = "METELEPH",
["source_id"] = targetID,
["source_target"] = targetID,
["source_x"] = x,
["source_y"] = y,
["target_x"] = destx,
["target_y"] = desty
})
    	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 215,
["target"] = 1,
["timing"] = 1,
["resource"] = "DDOORH",
["parent_resource"] = "METELEPH",
["source_id"] = targetID,
["source_target"] = targetID,
["source_x"] = x,
["source_y"] = y,
["target_x"] = destx,
["target_y"] = desty
})
--[[
    	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 148,
["target"] = 1,
["timing"] = 1,
["parameter1"] = 1,
["parameter2"] = 2,
["resource"] = "METELEPH",
["source_id"] = targetID,
["source_target"] = targetID,
["source_x"] = x,
["source_y"] = y,
["target_x"] = destx,
["target_y"] = desty
})
--]]
	end

end


me_balance_current_hp = {}
me_balance_max_hp = {}

function MEBALCST(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	me_balance_current_hp["" .. targetID] = EEex_ReadWord(creatureData + 0x438, 0x0)
	EEex_WriteWord(creatureData + 0x438, EEex_ReadWord(effectData + 0x18, 0x0))
end

function MEBALCEN(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	EEex_WriteWord(creatureData + 0x438, me_balance_current_hp["" .. targetID])
	Infinity_DisplayString(me_balance_current_hp["" .. targetID])
	Infinity_DisplayString(EEex_ReadWord(creatureData + 0x438, 0x0))
end

function MEBALMST(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	me_balance_max_hp["" .. targetID] = EEex_ReadWord(creatureData + 0x43A, 0x0)
	EEex_WriteWord(creatureData + 0x43A, EEex_ReadWord(effectData + 0x18, 0x0))
end

function MEBALMEN(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	EEex_WriteWord(creatureData + 0x43A, me_balance_max_hp["" .. targetID])
end

function MEGOLDAB(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID == 0x0 then return end
	local g_pBaldurChitin = EEex_ReadDword(EEex_Label("g_pBaldurChitin"))
	local m_pObjectGame = EEex_ReadDword(g_pBaldurChitin + EEex_Label("CBaldurChitin::m_pObjectGame"))
	local me_gold_ability_count = math.floor((EEex_ReadDword(m_pObjectGame + 0x47E8) / EEex_ReadDword(effectData + 0x18)) + 1)
    EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 1,
["parameter1"] = me_gold_ability_count,
["parameter2"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["resource"] = "MECO326",
["source_target"] = targetID,
["source_id"] = targetID
})
end

function MEGAZE(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if targetID == 0x0 or sourceID == 0x0 then return end
	local sourceData = EEex_GetActorShare(sourceID)
	local sourcex = EEex_ReadDword(sourceData + 0x8)
	local sourcey = EEex_ReadDword(sourceData + 0xC)
--	Infinity_DisplayString(targetID)
--	Infinity_DisplayString(sourcex)
--	Infinity_DisplayString(sourcey)
	local eyeContactDirection = EEex_GetActorRequiredDirection(targetID, sourcex, sourcey)
--	Infinity_DisplayString("ugu")
	local range = EEex_ReadDword(effectData + 0x1c)
	local check_if_facing = EEex_ReadDword(effectData + 0x44)
	local sourceDirection = EEex_GetActorDirection(sourceID)
	local targetDirection = EEex_GetActorDirection(targetID)
	if check_if_facing == 1 then
		if EEex_WithinCyclicRange(eyeContactDirection, targetDirection, range, 0, 15) and (not EEex_WithinCyclicRange(sourceDirection, targetDirection, 9 - range, 0, 15)) then
--			Infinity_DisplayString("ogo")
			local res_number = EEex_ReadDword(effectData + 0x18)
    		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["resource"] = "MEGAZ" .. res_number,
["source_target"] = targetID,
["source_id"] = sourceID
})
		end
	else
		if (not EEex_WithinCyclicRange(eyeContactDirection, targetDirection, range, 0, 15)) or EEex_WithinCyclicRange(sourceDirection, targetDirection, 9 - range, 0, 15) then
			local res_number = EEex_ReadDword(effectData + 0x18)
    		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["resource"] = "MEGAZ" .. res_number,
["source_target"] = targetID,
["source_id"] = sourceID
})
		end
	end
end
--[[
function MEGAZE(effectData, creatureData)
	local range = EEex_ReadDword(effectData + 0x1c)
	local check_if_facing = EEex_ReadDword(effectData + 0x44)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID == 0x0 then return end
	local sourceDirection = EEex_GetActorDirection(sourceID)
	local targetDirection = EEex_GetActorDirection(targetID)
	if check_if_facing == 1 then
		if not (EEex_WithinCyclicRange(sourceDirection, targetDirection, range, 0, 15)) then
			local res_number = EEex_ReadDword(effectData + 0x18)
    		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 1,
["duration"] = 100,
["resource"] = "MEGAZ" .. res_number,
["source_target"] = targetID,
["source_id"] = sourceID
})
		end
	else
		if EEex_WithinCyclicRange(sourceDirection, targetDirection, range, 0, 15) then
			local res_number = EEex_ReadDword(effectData + 0x18)
    		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 1,
["duration"] = 100,
["resource"] = "MEGAZ" .. res_number,
["source_target"] = targetID,
["source_id"] = sourceID
})
		end
	end
end
--]]
function ME_FMC_ActionbarListener(config)
	local actorID = EEex_GetActorIDSelected()
	if actorID ~= 0x0 then
--		Infinity_DisplayString(config)
--		Infinity_DisplayString(EEex_GetActorClass(actorID))
	    if config == 16 and EEex_GetActorClass(actorID) == 17 then
	        EEex_SetActionbarButton(0x3, EEex_ACTIONBAR_TYPE.FIND_TRAPS)
	        EEex_SetActionbarButton(0x4, EEex_ACTIONBAR_TYPE.THIEVING)
	        EEex_SetActionbarButton(0x5, EEex_ACTIONBAR_TYPE.STEALTH)
	    end
	end
end
--EEex_AddActionbarListener(ME_FMC_ActionbarListener)

function MESETQSP(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID == 0x0 then return end
	local first_four = EEex_ReadDword(effectData + 0x18)
	local second_four = EEex_ReadDword(effectData + 0x1c)
	local slot_number = EEex_ReadDword(effectData + 0x44)
	EEex_WriteDword(creatureData + 0x275E + (0x34 * slot_number), first_four)
	EEex_WriteDword(creatureData + 0x2762 + (0x34 * slot_number), second_four)
end

function MESpellToPoint(actorID)
	EEex_AddActionHook(function(actionData)
		local spellActions = {
			[31]  = 95 , -- Spell => SpellPoint
			[113] = 114, -- ForceSpell => ForceSpellPoint
			[181] = 337, -- ReallyForceSpell => ReallyForceSpellPoint
			[191] = 192, -- SpellNoDec => SpellPointNoDec
		}
		local newActionID = spellActions[EEex_GetActionID(actionData)]
		if newActionID then
			EEex_SetActionID(actionData, newActionID)
			local targetID = EEex_GetActionTarget(actionData)
			local targetX, targetY = EEex_GetActorLocation(targetID)
			EEex_SetActionPointX(actionData, targetX)
			EEex_SetActionPointY(actionData, targetY)
		end
	end)
end

function MEACHOOK()
--	Infinity_DisplayString(actorID)
	EEex_AddActionHook(function(actionData)	
		ME_Search_General("PFIRE2", actionData, 0x1000, 1)
--		ME_Search_General(234, actionData, 0x1000, 0)
--		for i = 100, 199, 1 do
--			Infinity_DisplayString(EEex_ToHex(i, 0, true) .. ": " .. EEex_ReadByte(actionData + i, 0x0) .. ", " .. EEex_ReadWord(actionData + i, 0x0) .. ", " .. EEex_ReadDword(actionData + i) .. ", \"" .. EEex_ReadLString(actionData + i, 8) .. "\"")
--		end 
	end)
end

function MESPIN(effectData, creatureData)
	me_initial_direction = EEex_ReadWord(creatureData + 0x31FE, 0x0)
--	for i = 0, 15, 1 do
--		EEex_Call(EEex_Label("CGameSprite::Face"), {(me_initial_direction + 1) % 16}, creatureData, 0x0)
		EEex_WriteWord(creatureData + 0x31FE, (me_initial_direction + 1) % 16)
--	for j = 0, 100, 1 do
--		end
--	end
end

function MEPERMCN(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID == 0x0 then return end
	local contingencyRes = EEex_ReadLString(effectData + 0x18, 8)
	EEex_AlterActorEffect(targetID,{{"opcode",232},{"parent_resource",contingencyRes}}, {{"parameter3",0}},1)
end

me_swap_id = {}

function MESWAP(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if me_swap_id["" .. sourceID] == nil then
		me_swap_id["" .. sourceID] = targetID
	else
		local otherID = me_swap_id["" .. sourceID]
		local otherData = EEex_GetActorShare(otherID)
		EEex_ApplyEffectToActor(otherID, {
["opcode"] = 124,
["target"] = 2,
["timing"] = 1,
["parameter2"] = 3,
["source_id"] = targetID,
["source_target"] = otherID,
["source_x"] = EEex_ReadDword(creatureData + 0x8),
["source_y"] = EEex_ReadDword(creatureData + 0xC),
["target_x"] = EEex_ReadDword(otherData + 0x8),
["target_y"] = EEex_ReadDword(otherData + 0xC)
})
		me_swap_id["" .. sourceID] = nil
	end
end

function MEINHOST(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local targetID = EEex_ReadDword(creatureData + 0x318)
	if not EEex_IsSprite(sourceID) then return end
	local area = EEex_ReadDword(effectData + 0x44)
	local hostileTrigger = "MEINHOST"
	if area == 15 then
		hostileTrigger = "MEINHO15"
	elseif area == 30 then
		hostileTrigger = "MEINHO30"
	end
	if EEex_IsSprite(targetID) then
		if area == 0 and EEex_GetActorAllegiance(targetID) ~= 128 then return end
		if area > 0 and EEex_GetActorAllegiance(targetID) >= 200 then return end
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["resource"] = hostileTrigger,
["source_id"] = sourceID,
["source_target"] = targetID
})

	else
		local targetX = EEex_ReadDword(creatureData + 0x34C)
		local targetY = EEex_ReadDword(creatureData + 0x350)
		if targetX > 0 and targetY > 0 and targetX < 10000 and targetY < 10000 then
			EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 148,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["resource"] = hostileTrigger,
["source_id"] = sourceID,
["source_target"] = sourceID,
["source_x"] = EEex_ReadDword(creatureData + 0x8),
["source_y"] = EEex_ReadDword(creatureData + 0xC),
["target_x"] = targetX,
["target_y"] = targetY
})
		end
	end
end

function MEORACLE(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local string_to_display = EEex_ReadDword(effectData + 0x18)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID > 0 and EEex_GetActorStat(targetID, 642) == 1 then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 330,
["target"] = 2,
["parameter1"] = string_to_display,
["timing"] = 1,
["source_target"] = targetID
})
	end
end

me_oracle_spell_ref = {}

function MEORACL2(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local actionID = EEex_ReadDword(creatureData + 0x2F8)
	local spellRES = EEex_ReadLString(creatureData + 0x3596, 8)
	local spellIDS = EEex_ReadWord(creatureData + 0x338, 0x0)
	if actionID == 31 or actionID == 113 or actionID == 191 or actionID == 318 or actionID == 95 or actionID == 114 or actionID == 192 or actionID == 319 then
		if spellRES == "" then
			spellRES = me_spellidstype[math.floor(spellIDS / 1000)] .. spellIDS % 1000
		end
		local spellNameStrref = EEex_ReadDword(EEex_GetSpellData(spellRES) + 0x8)
		if (me_oracle_spell_ref["" .. targetID] == nil or me_oracle_spell_ref["" .. targetID] ~= spellRES) and spellNameStrref > 0 then

			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 330,
["target"] = 2,
["parameter1"] = spellNameStrref,
["timing"] = 1,
["source_target"] = targetID
})
			me_oracle_spell_ref["" .. targetID] = spellRES
		end
	else
		me_oracle_spell_ref["" .. targetID] = nil
	end
end

function MECCTSEQ(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID == 0x0 then return end
	local newSeqRes = EEex_ReadLString(effectData + 0x6C, 8)
	local baseSeqRes = EEex_ReadLString(effectData + 0x74, 8)
	EEex_AlterActorEffect(targetID,{{"opcode",256},{"parent_resource",newSeqRes}}, {{"parent_resource",baseSeqRes}},1)
end

function MEMMCDIA(effectData, creatureData)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID > 0 and sourceID > 0 then
		local sourceData = EEex_GetActorShare(sourceID)
		local targetDialogue = EEex_ReadLString(creatureData + 0x35A8, 8)
		EEex_WriteLString(sourceData + 0x35A8, targetDialogue, 8)
	end
end

function MEMMCSPL(effectData, creatureData)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID > 0 and sourceID > 0 then
		local sourceData = EEex_GetActorShare(sourceID)
		local actionID = EEex_ReadDword(creatureData + 0x2F8)
		local spellRES = EEex_ReadLString(creatureData + 0x3596, 8)
		local spellIDS = EEex_ReadWord(creatureData + 0x338, 0x0)
--		Infinity_DisplayString("actionID: " .. actionID)
--		Infinity_DisplayString("spellRES: " .. spellRES)
--		Infinity_DisplayString("spellIDS: " .. spellIDS)
		if actionID == 31 or actionID == 113 or actionID == 191 or actionID == 318 then
			local spellTargetID = EEex_ReadDword(creatureData + 0x318)
			if EEex_GetActorAllegiance(targetID) >= 200 then
				if EEex_GetActorAllegiance(spellTargetID) >= 200 then
					if spellRES == "" then
						C:Eval("ForceSpell(Myself, " .. spellIDS .. ")",sourceID)
					else
						C:Eval("ForceSpellRES(\"" .. spellRES .. "\", Myself)",sourceID)
					end
				else
					EEex_LuaObject = targetID
					if spellRES == "" then
						C:Eval("ForceSpell(" .. "EEex_LuaObject" .. ", " .. spellIDS .. ")",sourceID)
					else
						C:Eval("ForceSpellRES(\"" .. spellRES .. "\", " .. "EEex_LuaObject" .. ")",sourceID)
					end
				end
			else
				if EEex_GetActorAllegiance(spellTargetID) >= 200 then
					EEex_LuaObject = spellTargetID
					if spellRES == "" then
						C:Eval("ForceSpell(" .. "EEex_LuaObject" .. ", " .. spellIDS .. ")",sourceID)
					else
						C:Eval("ForceSpellRES(\"" .. spellRES .. "\", " .. "EEex_LuaObject" .. ")",sourceID)
					end
				elseif targetID == spellTargetID then
					if spellRES == "" then
						C:Eval("ForceSpell(Myself, " .. spellIDS .. ")",sourceID)
					else
						C:Eval("ForceSpellRES(\"" .. spellRES .. "\", Myself)",sourceID)
					end
				else
					EEex_LuaObject = targetID
					if spellRES == "" then
						C:Eval("ForceSpell(" .. "EEex_LuaObject" .. ", " .. spellIDS .. ")",sourceID)
					else
						C:Eval("ForceSpellRES(\"" .. spellRES .. "\", " .. "EEex_LuaObject" .. ")",sourceID)
					end
				end
			end
		elseif actionID == 95 or actionID == 114 or actionID == 192 or actionID == 319 then
			local spellTargetX = EEex_ReadDword(creatureData + 0x34C)
			local spellTargetY = EEex_ReadDword(creatureData + 0x350)
			if spellRES == "" then
				C:Eval("ForceSpellPoint([" .. spellTargetX .. "." .. spellTargetY .. "], " .. spellIDS .. ")",sourceID)
			else
				C:Eval("ForceSpellPointRES(\"" .. spellRES .. "\", [" .. spellTargetX .. "." .. spellTargetY .. "])",sourceID)
			end

		end
	end
end

me_copy_spell_id = {}
me_copy_spell_caster_id = {}
me_copy_spell_ref = {}

function MECOPSPL(effectData, creatureData)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local actionID = EEex_ReadDword(creatureData + 0x2F8)
	local spellRES = EEex_GetActorSpellRES(targetID)
	local spellIDS = EEex_ReadWord(creatureData + 0x338, 0x0)
	if me_copy_spell_id["" .. sourceID] ~= nil then
		if me_copy_spell_ref["" .. sourceID] == nil then
			EEex_LuaObject = me_copy_spell_id["" .. sourceID]
		else
			EEex_LuaObject = targetID
		end
	end
	if (actionID == 31 or actionID == 113 or actionID == 191 or actionID == 318 or actionID == 95 or actionID == 114 or actionID == 192 or actionID == 319) and me_copy_spell_ref["" .. sourceID] == nil then
		me_copy_spell_ref["" .. sourceID] = "" .. spellRES

	end
	if me_copy_spell_id["" .. sourceID] == nil then
		me_copy_spell_id["" .. sourceID] = targetID
	else
		if me_copy_spell_ref["" .. sourceID] ~= nil then
			local castInstantly = EEex_ReadDword(effectData + 0x44)
			if castInstantly == 0 then
				C:Eval("ForceSpellRES(\"" .. me_copy_spell_ref["" .. sourceID] .. "\", " .. "EEex_LuaObject" .. ")",sourceID)
			else
				C:Eval("ReallyForceSpellRES(\"" .. me_copy_spell_ref["" .. sourceID] .. "\", " .. "EEex_LuaObject" .. ")",sourceID)
			end
		end
		me_copy_spell_id["" .. sourceID] = nil
		me_copy_spell_ref["" .. sourceID] = nil
	end


end

function MEALTSPL(effectData, creatureData)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local actionID = EEex_ReadDword(creatureData + 0x2F8)
	local spellRES = EEex_GetActorSpellRES(targetID)
	local spellIDS = EEex_ReadWord(creatureData + 0x338, 0x0)
	local casterID = 0
	if me_copy_spell_id["" .. sourceID] ~= nil then
		if me_copy_spell_ref["" .. sourceID] == nil then
			EEex_LuaObject = me_copy_spell_id["" .. sourceID]
			casterID = targetID
		else
			EEex_LuaObject = targetID
			casterID = me_copy_spell_id["" .. sourceID]
		end
	end
	if (actionID == 31 or actionID == 113 or actionID == 191 or actionID == 318 or actionID == 95 or actionID == 114 or actionID == 192 or actionID == 319) and me_copy_spell_ref["" .. sourceID] == nil then
		me_copy_spell_ref["" .. sourceID] = "" .. spellRES
--		Infinity_DisplayString("ugu")
	end
--	Infinity_DisplayString(spellRES)
--		Infinity_DisplayString("igi")
	if me_copy_spell_id["" .. sourceID] == nil then
		me_copy_spell_id["" .. sourceID] = targetID
--		Infinity_DisplayString("aga")
	else
		if me_copy_spell_ref["" .. sourceID] ~= nil then
--			C:Eval("ActionOverride(\"" .. EEex_GetActorScriptName(casterID) .. "\", ReallyForceSpellRES(\"" .. me_copy_spell_ref["" .. sourceID] .. "\", EEex_LuaObject))")
--				Infinity_DisplayString(EEex_GetActorScriptName(casterID) .. " -> " .. EEex_GetActorScriptName(EEex_LuaObject))
				EEex_ApplyEffectToActor(casterID, {
["opcode"] = 145,
["target"] = 2,
["parameter2"] = 3,
["special"] = 1,
["timing"] = 0,
["duration"] = 4,
["source_id"] = casterID,
["source_target"] = casterID
})
				EEex_ApplyEffectToActor(EEex_LuaObject, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = EEex_GetActorStat(casterID, 34),
["parameter2"] = 2,
["timing"] = 1,
["resource"] = me_copy_spell_ref["" .. sourceID],
["source_id"] = casterID,
["source_target"] = EEex_LuaObject
})

		end
		me_copy_spell_id["" .. sourceID] = nil
		me_copy_spell_ref["" .. sourceID] = nil
	end


end

function MEEXHEAL(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local healingMultiplier = EEex_GetActorStat(sourceID, 620)
	if targetID > 0 and sourceID > 0 then
		if healingMultiplier > 0 then
			local healAmount = math.floor(EEex_ReadDword(effectData + 0x18) * healingMultiplier / 100)
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 17,
["target"] = 2,
["parameter1"] = healAmount,
["timing"] = 1,
["source_id"] = sourceID,
["source_target"] = targetID
})
		end
	end
end

function ME_IsDualClassed(actorID)
	return (bit32.band(EEex_ReadDword(EEex_GetActorShare(actorID) + 0x424), 504) > 0)
end

function ME_IsMultiClassed(actorID)
	local me_class = EEex_GetActorClass(actorID)
	return (((me_class >= 7 and me_class <= 9) or (me_class >= 13 and me_class <= 16) or (me_class == 18)) and (bit32.band(EEex_ReadDword(EEex_GetActorShare(actorID) + 0x424), 504) == 0))
end

function MEDETCRE(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID ~= 0 then
		local name = EEex_ReadDword(creatureData + 0x41C)
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 330,
["target"] = 2,
["parameter1"] = name,
["timing"] = 1,
["source_target"] = targetID
})
	end
end

function MEKILLCN(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID == 0x0 then return end
	local contingencyRes = EEex_ReadLString(effectData + 0x18, 8)
	EEex_IterateActorEffects(targetID, function(iData)
		local the_opcode = EEex_ReadDword(iData + 0x10)
		local the_parent_resource = EEex_ReadLString(iData + 0x94, 8)
		if the_opcode == 256 and the_parent_resource == contingencyRes then
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 232,
["target"] = 1,
["parameter1"] = 0,
["parameter2"] = 12,
["timing"] = 1,
["resource"] = EEex_ReadLString(iData + 0x30, 8),
["source_target"] = targetID,
["source_id"] = targetID,
["parent_resource"] = contingencyRes
})
		end
	end)

end

me_death_trigger = {}

function MEDEATCS(effectData, creatureData)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID == 0x0 or sourceID == 0x0 then return end
	local contingencyRes = EEex_ReadLString(effectData + 0x18, 8)
	EEex_IterateActorEffects(sourceID, function(eData)
		local the_opcode = EEex_ReadDword(eData + 0x10)
		local the_parent_resource = EEex_ReadLString(eData + 0x94, 8)
		if the_opcode == 232 and the_parent_resource == contingencyRes then
			me_death_trigger["" .. sourceID] = {EEex_ReadDword(eData + 0x1C), EEex_ReadLString(eData + 0x30, 8)}
		end
	end)


end

function MEDEATCN(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID == 0x0 or sourceID == 0x0 then return end
	local sourceData = EEex_GetActorShare(sourceID)
	local contingencyRes = EEex_ReadLString(effectData + 0x18, 8)
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 232,
["target"] = 1,
["parameter1"] = me_death_trigger["" .. sourceID][1],
["parameter2"] = 16,
["timing"] = 9,
["resource"] = me_death_trigger["" .. sourceID][2],
["source_target"] = targetID,
["source_id"] = sourceID,
["parent_resource"] = contingencyRes
})

end

function MEDESTSP(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local destinationSpell = EEex_ReadLString(effectData + 0x18, 8)
	local destx2 = EEex_ReadDword(creatureData + 0x3404)
	local desty2 = EEex_ReadDword(creatureData + 0x3408)
	if destx2 > 0 then
    	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 148,
["target"] = 1,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["resource"] = destinationSpell,
["source_id"] = targetID,
["source_target"] = targetID,
["source_x"] = EEex_ReadDword(creatureData + 0x8),
["source_y"] = EEex_ReadDword(creatureData + 0xC),
["target_x"] = destx2,
["target_y"] = desty2
})
	end

end

me_spell_immunity = {}
me_spell_immunity_reset = {}

function MESPLIMS(effectData, creatureData)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if sourceID == 0x0 then return end
	if me_spell_immunity_reset["" .. sourceID] == nil then
		me_spell_immunity_reset["" .. sourceID] = true
		me_spell_immunity["" .. sourceID] = {"", "", ""}
	end
	EEex_IterateActorEffects(sourceID, function(eData)
		local the_opcode = EEex_ReadDword(eData + 0x10)
		local the_special = EEex_ReadDword(eData + 0x48)
		local the_parent_resource = EEex_ReadLString(eData + 0x94, 8)
		if the_opcode == 256 then
			if the_parent_resource == "MESPLIM1" then
				me_spell_immunity["" .. sourceID][1] = EEex_ReadLString(eData + 0x30, 8)
			elseif the_parent_resource == "MESPLIM2" then
				me_spell_immunity["" .. sourceID][2] = EEex_ReadLString(eData + 0x30, 8)
			elseif the_parent_resource == "MESPLIM3" then
				me_spell_immunity["" .. sourceID][3] = EEex_ReadLString(eData + 0x30, 8)
			end
		end
	end)

end

function MESPLIM1(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID == 0x0 or sourceID == 0x0 then return end
	me_spell_immunity_reset["" .. sourceID] = nil
	local sourceData = EEex_GetActorShare(sourceID)
	local contingencyRes = EEex_ReadLString(effectData + 0x18, 8)
	if me_spell_immunity["" .. sourceID][1] ~= nil then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 206,
["target"] = 2,
["parameter1"] = 24534,
["parameter2"] = 16,
["timing"] = 0,
["duration"] = 2400,
["resource"] = me_spell_immunity["" .. sourceID][1],
["source_target"] = targetID,
["source_id"] = sourceID,
["parent_resource"] = contingencyRes
})
	end
	if me_spell_immunity["" .. sourceID][2] ~= nil then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 206,
["target"] = 2,
["parameter1"] = 24534,
["parameter2"] = 16,
["timing"] = 0,
["duration"] = 2400,
["resource"] = me_spell_immunity["" .. sourceID][2],
["source_target"] = targetID,
["source_id"] = sourceID,
["parent_resource"] = contingencyRes
})
	end
	if me_spell_immunity["" .. sourceID][3] ~= nil then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 206,
["target"] = 2,
["parameter1"] = 24534,
["parameter2"] = 16,
["timing"] = 0,
["duration"] = 2400,
["resource"] = me_spell_immunity["" .. sourceID][3],
["source_target"] = targetID,
["source_id"] = sourceID,
["parent_resource"] = contingencyRes
})
	end
end


-- Modifies the duration of all effects on the actor where the condition is true.
-- The condition is determined by the Special parameter:
-- 0: True always
-- 1: True if the effect is flagged as hostile
-- 2: True if the effect is not flagged as hostile
-- The duration is modified in a way determined by Parameter2:
-- 0: Add Parameter1 (in ticks) to the duration
-- 1: Set the duration to Parameter1 (in ticks)
-- 2: Multiply the duration by Parameter1 (as a percentage)

function MEMODDUR(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID == 0x0 then return end
	local parameter1 = EEex_ReadDword(effectData + 0x18)
	local parameter2 = EEex_ReadDword(effectData + 0x1C)
	local condition = EEex_ReadDword(effectData + 0x44)
	EEex_IterateActorEffects(targetID, function(eData)
		local the_internal_flags = EEex_ReadDword(eData + 0xCC)
		if bit32.band(the_internal_flags, 0x400000) == 0 then
			local conditionMet = false
			if condition == 0 then
				conditionMet = true
			elseif condition == 1 then
				if bit32.band(EEex_ReadDword(eData + 0x9C), 0x400) ~= 0 then
					conditionMet = true
				end
			elseif condition == 2 then
				if bit32.band(EEex_ReadDword(eData + 0x9C), 0x400) == 0 then
					conditionMet = true
				end
			end
			if conditionMet then
				EEex_WriteDword(eData + 0xCC, bit32.bor(the_internal_flags, 0x400000))
				local the_end_time = EEex_ReadDword(eData + 0x28)
				local the_start_time = EEex_ReadDword(eData + 0x6C)
				if parameter2 == 0 then
					EEex_WriteDword(eData + 0x28, the_end_time + parameter1)
				elseif parameter2 == 1 then
					EEex_WriteDword(eData + 0x28, the_start_time + parameter1)
				elseif parameter2 == 2 then
					EEex_WriteDword(eData + 0x28, the_start_time + math.floor((the_end_time - the_start_time) * parameter1 / 100))
				end
			end
		end
	end)
end

function MEIMGSCR(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local masterID = EEex_ReadDword(creatureData + 0x39F4)
	if targetID == 0 or masterID <= 0 then return end
	local masterData = EEex_GetActorShare(masterID)
	local overrideScript = EEex_ReadLString(masterData + 0x65C, 8)
	local classScript = EEex_ReadLString(masterData + 0x664, 8)
	local raceScript = EEex_ReadLString(masterData + 0x66C, 8)
	local generalScript = EEex_ReadLString(masterData + 0x674, 8)
	local defaultScript = EEex_ReadLString(masterData + 0x67C, 8)
	local specificsScript = EEex_ReadLString(masterData + 0x2A24, 8)
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 82,
["target"] = 2,
["parameter2"] = 0,
["timing"] = 9,
["resource"] = overrideScript,
["source_target"] = targetID,
["source_id"] = targetID
})
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 82,
["target"] = 2,
["parameter2"] = 2,
["timing"] = 9,
["resource"] = specificsScript,
["source_target"] = targetID,
["source_id"] = targetID
})
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 82,
["target"] = 2,
["parameter2"] = 4,
["timing"] = 9,
["resource"] = classScript,
["source_target"] = targetID,
["source_id"] = targetID
})
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 82,
["target"] = 2,
["parameter2"] = 5,
["timing"] = 9,
["resource"] = raceScript,
["source_target"] = targetID,
["source_id"] = targetID
})
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 82,
["target"] = 2,
["parameter2"] = 6,
["timing"] = 9,
["resource"] = generalScript,
["source_target"] = targetID,
["source_id"] = targetID
})
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 82,
["target"] = 2,
["parameter2"] = 7,
["timing"] = 9,
["resource"] = defaultScript,
["source_target"] = targetID,
["source_id"] = targetID
})
--	if EEex_GetActorAllegiance(targetID) <= 7 then
--		C:Eval("MakeGlobal()",targetID)
--		C:Eval("ChangeEnemyAlly(Myself,FAMILIAR)",targetID)
--		C:Eval("AddFamiliar()",targetID)
--	end
end

function MEFOOLSM(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if targetID == 0 or sourceID == 0 then return end
	local targetInt = EEex_GetActorStat(targetID, 38)
	local sourceInt = EEex_GetActorStat(sourceID, 38)
	if sourceInt > targetInt then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 12,
["target"] = 2,
["parameter1"] = (sourceInt - targetInt),
["timing"] = 9,
["source_target"] = targetID,
["source_id"] = sourceID
})
	elseif targetInt > sourceInt then
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 12,
["target"] = 2,
["parameter1"] = (targetInt - sourceInt),
["timing"] = 9,
["source_target"] = sourceID,
["source_id"] = sourceID
})
	end
end

function MEMODPRF(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID == 0 then return end
	local increment = EEex_ReadDword(effectData + 0x18)
	local proficiencies = EEex_ReadDword(effectData + 0x1C)
	local maximum = EEex_ReadDword(effectData + 0x44)
	local profBit = 1
	local profChanges = {}
	while profBit <= 0x1000000 do
--		Infinity_DisplayString(profBit .. " -> " .. bit32.band(proficiencies, profBit))
		if bit32.band(proficiencies, profBit) > 0 then
			local profCurrent = EEex_GetActorStat(targetID, me_proficiency[profBit])
--			Infinity_DisplayString(me_proficiency[profBit] .. ": " .. profCurrent)
			if profCurrent == 0 then
				EEex_ApplyEffectToActor(targetID, {
["opcode"] = 233,
["target"] = 2,
["parameter1"] = increment,
["parameter2"] = me_proficiency[profBit],
["timing"] = 9,
["source_target"] = targetID,
["source_id"] = targetID
})
			else
				if (profCurrent + increment) < maximum then
					profChanges[me_proficiency[profBit]] = profCurrent + increment
				else
					profChanges[me_proficiency[profBit]] = maximum
				end
			end
		end
		profBit = profBit * 2
	end
	EEex_IterateActorEffects(targetID, function(eData)
		local the_opcode = EEex_ReadDword(eData + 0x10)
		local the_parameter2 = EEex_ReadDword(eData + 0x20)
		if the_opcode == 233 and profChanges[the_parameter2] ~= nil then
			EEex_WriteDword(eData + 0x1C, profChanges[the_parameter2])
		end
	end)
end

function MECRTSEQ(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID == 0 then return end
	local contingencyRes = EEex_ReadLString(effectData + 0x18, 8)
	EEex_IterateActorEffects(targetID, function(eData)
		local the_opcode = EEex_ReadDword(eData + 0x10)
		local the_parent_resource = EEex_ReadLString(eData + 0x94, 8)
		if the_opcode == 256 and the_parent_resource == contingencyRes then
			local the_resource = EEex_ReadLString(eData + 0x30, 8)
			EEex_AlterActorEffect(targetID,{{"opcode",341},{"resource","MECRTSEQ"}}, {{"resource",the_resource}},1)
		end
	end)
end

function MECURSCN(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if targetID == 0x0 or sourceID == 0x0 then return end
	local contingencyRes = EEex_ReadLString(effectData + 0x18, 8)
	local duration = EEex_ReadDword(effectData + 0x44)
	EEex_IterateActorEffects(sourceID, function(eData)
		local the_opcode = EEex_ReadDword(eData + 0x10)
		local the_parent_resource = EEex_ReadLString(eData + 0x94, 8)
		if the_opcode == 232 and the_parent_resource == contingencyRes then
			local the_parameter1 = EEex_ReadDword(eData + 0x1C)
			if the_parameter1 == 2 then
				the_parameter1 = 3
			end
			local the_parameter2 = EEex_ReadDword(eData + 0x20)
			local the_resource = EEex_ReadLString(eData + 0x30, 8)
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 232,
["target"] = 2,
["parameter1"] = the_parameter1,
["parameter2"] = the_parameter2,
["timing"] = 0,
["duration"] = duration,
["resource"] = the_resource,
["source_target"] = targetID,
["source_id"] = targetID
})
		end
	end)
	EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 1,
["resource"] = contingencyRes,
["source_target"] = sourceID,
["source_id"] = sourceID
})

end

function MEPRTOPC(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if targetID == 0x0 or sourceID == 0x0 then return end
	local opcode = EEex_ReadDword(effectData + 0x1C)
	if EEex_IsImmuneToOpcode(targetID, opcode) then
		local spellRes = EEex_ReadLString(effectData + 0x90, 8)
		local immunityString = EEex_ReadDword(effectData + 0x44)
		local immunityOpcode = 318
		if immunityString ~= -1 then
			immunityOpcode = 324
		end
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = immunityOpcode,
["target"] = 2,
["timing"] = 0,
["duration"] = 0,
["resource"] = spellRes,
["special"] = immunityString,
["parent_resource"] = spellRes,
["source_target"] = targetID,
["source_id"] = sourceID
})
	end
end

function MEPRTOFF(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if targetID == 0x0 or sourceID == 0x0 then return end
	local check_value = EEex_ReadDword(effectData + 0x18)
	local offset = EEex_ReadWord(effectData + 0x1C, 0x0)
	local readSize = EEex_ReadByte(effectData + 0x1E, 0x0)
	local check_relation = EEex_ReadByte(effectData + 0x1F, 0x0)
	local check_stat = 0
	if readSize == 1 then
		check_stat = EEex_ReadByte(creatureData + offset, 0x0)
	elseif readSize == 2 then
		check_stat = EEex_ReadSignedWord(creatureData + offset, 0x0)
	else
		check_stat = EEex_ReadDword(creatureData + offset)
	end
--	Infinity_DisplayString("check_value: " .. check_value .. ", offset: " .. offset .. ", readSize: " .. readSize .. ", check_relation: " .. check_relation .. ", check_stat: " .. check_stat)
	local hasProtection = false
	if check_relation == 0 and check_stat <= check_value then
		hasProtection = true
	elseif check_relation == 1 and check_stat == check_value then
		hasProtection = true
	elseif check_relation == 2 and check_stat < check_value then
		hasProtection = true
	elseif check_relation == 3 and check_stat > check_value then
		hasProtection = true
	elseif check_relation == 4 and check_stat >= check_value then
		hasProtection = true
	elseif check_relation == 5 and check_stat ~= check_value then
		hasProtection = true
	elseif check_relation == 6 and bit32.bor(check_stat, check_value) == check_value then
		hasProtection = true
	elseif check_relation == 7 and bit32.band(check_stat, check_value) >= check_value then
		hasProtection = true
	elseif check_relation == 8 and bit32.band(check_stat, check_value) > 0 then
		hasProtection = true
	elseif check_relation == 9 and bit32.band(check_stat, check_value) == 0 then
		hasProtection = true
	elseif check_relation == 10 and bit32.bor(check_stat, check_value) > check_value then
		hasProtection = true
	elseif check_relation == 11 and bit32.band(check_stat, check_value) < check_value then
		hasProtection = true
	end
	if hasProtection then
		local spellRes = EEex_ReadLString(effectData + 0x90, 8)
		local immunityString = EEex_ReadDword(effectData + 0x44)
		local immunityOpcode = 318
		if immunityString ~= -1 then
			immunityOpcode = 324
		end
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = immunityOpcode,
["target"] = 2,
["timing"] = 0,
["duration"] = 0,
["resource"] = spellRes,
["special"] = immunityString,
["parent_resource"] = spellRes,
["source_target"] = targetID,
["source_id"] = sourceID
})
	end
end

function MEPRTSLV(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if targetID == 0x0 or sourceID == 0x0 then return end
	local level = EEex_ReadDword(effectData + 0x1C)
	if EEex_IsImmuneToSpellLevel(targetID, level, false) then
		local spellRes = EEex_ReadLString(effectData + 0x90, 8)
		local immunityString = EEex_ReadDword(effectData + 0x44)
		local immunityOpcode = 318
		if immunityString ~= -1 then
			immunityOpcode = 324
		end
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = immunityOpcode,
["target"] = 2,
["timing"] = 0,
["duration"] = 0,
["resource"] = spellRes,
["special"] = immunityString,
["parent_resource"] = spellRes,
["source_target"] = targetID,
["source_id"] = sourceID
})
	end
end

function MEPRTAIR(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local heightThreshold = EEex_ReadDword(effectData + 0x1C)
	if not EEex_IsSprite(targetID) then return end
	if EEex_IsInAir(targetID, heightThreshold) then
		local spellRes = EEex_ReadLString(effectData + 0x90, 8)
		local immunityString = EEex_ReadDword(effectData + 0x44)
		local immunityOpcode = 318
		if immunityString ~= -1 then
			immunityOpcode = 324
		end
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = immunityOpcode,
["target"] = 2,
["timing"] = 0,
["duration"] = 0,
["resource"] = spellRes,
["special"] = immunityString,
["parent_resource"] = spellRes,
["source_target"] = targetID,
["source_id"] = sourceID
})
	end
end

function MEPRTFLY(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if not EEex_IsSprite(targetID) then return end
	if EEex_IsFlying(targetID) then
		local spellRes = EEex_ReadLString(effectData + 0x90, 8)
		local immunityString = EEex_ReadDword(effectData + 0x44)
		local immunityOpcode = 318
		if immunityString ~= -1 then
			immunityOpcode = 324
		end
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = immunityOpcode,
["target"] = 2,
["timing"] = 0,
["duration"] = 0,
["resource"] = spellRes,
["special"] = immunityString,
["parent_resource"] = spellRes,
["source_target"] = targetID,
["source_id"] = sourceID
})
	end
end

function EEex_IsInAir(actorID, heightThreshold)
	local animation = EEex_GetActorAnimation(actorID)
	return (me_flying_sprite['' .. animation] ~= nil or EEex_GetActorStat(actorID, 640) > 0 or EEex_ReadDword(EEex_GetActorShare(actorID) + 0x10) < heightThreshold)
end

function EEex_IsFlying(actorID)
	local animation = EEex_GetActorAnimation(actorID)
	return (me_flying_sprite['' .. animation] ~= nil or EEex_GetActorStat(actorID, 640) > 0)
end

function EEex_IsEthereal(actorID)
	local animation = EEex_GetActorAnimation(actorID)
	return (me_ethereal_sprite['' .. animation] ~= nil or EEex_GetActorStat(actorID, 639) > 0)
end

function EEex_GetActorFullResistance(actorID, resistanceStat)
	if not EEex_IsSprite(actorID) or me_resistance_opcode[resistanceStat] == nil then return 0 end
	local base_resistance = 0
	local timing_level = 0
	if me_resistance_opcode[resistanceStat][2] ~= 0 then
		base_resistance = EEex_ReadByte(EEex_GetActorShare(actorID) + me_resistance_opcode[resistanceStat][2], 0x0)
	end
	local extra_resistance = 0
	EEex_IterateActorEffects(actorID, function(eData)
		local the_opcode = EEex_ReadDword(eData + 0x10)
		if the_opcode == me_resistance_opcode[resistanceStat][1] then
			local the_parameter1 = EEex_ReadDword(eData + 0x1C)
			local the_parameter2 = EEex_ReadDword(eData + 0x20)
			local the_timing = EEex_ReadDword(eData + 0x24)
			if the_parameter2 == 0 then
				extra_resistance = extra_resistance + the_parameter1
			elseif the_timing >= timing_level then
				timing_level = the_timing
				if the_parameter2 == 1 then
					base_resistance = the_parameter1
				elseif the_parameter2 == 2 then
					base_resistance = math.floor(base_resistance * the_parameter1 / 100)
				end
			end
		end
	end)
	return (base_resistance + extra_resistance)

end

function MEPSTACK(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local parent_resource = EEex_ReadLString(effectData + 0x90, 8)
	if targetID == 0x0 or sourceID == 0x0 then return end
	EEex_IterateActorEffects(targetID, function(eData)
		local the_sourceID = EEex_ReadDword(eData + 0x110)
		local the_parent_resource = EEex_ReadLString(eData + 0x94, 8)
		if the_sourceID == sourceID and the_parent_resource == parent_resource then
			EEex_WriteDword(eData + 0x28, EEex_ReadDword(eData + 0x6C))
		end
	end)
end

function MEPSTAC2(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local parameter5 = EEex_ReadDword(effectData + 0x64)
	local parent_resource = EEex_ReadLString(effectData + 0x90, 8)
	if targetID == 0x0 or parameter5 == 0 then return end
	EEex_IterateActorEffects(targetID, function(eData)
		local the_parameter5 = EEex_ReadDword(eData + 0x68)
		local the_parent_resource = EEex_ReadLString(eData + 0x94, 8)
		if the_parameter5 == parameter5 and the_parent_resource == parent_resource then
			EEex_WriteDword(eData + 0x28, EEex_ReadDword(eData + 0x6C))
		end
	end)
end

function MECIDSET(originatingEffectData, effectData, creatureData)
	local parameter5 = EEex_ReadDword(effectData + 0x64)
	if parameter5 == 0 then
		local sourceID = EEex_ReadDword(effectData + 0x10C)
		if EEex_IsSprite(sourceID) then
			EEex_WriteDword(effectData + 0x64, EEex_GetActorStat(sourceID, 645))
		end
	end
end

function MESPLMOD(originatingEffectData, effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if not EEex_IsSprite(targetID) or not EEex_IsSprite(sourceID) then return false end
	local parent_resource = EEex_ReadLString(effectData + 0x90, 8)
	local opcode = EEex_ReadDword(effectData + 0xC)
	local parameter1 = EEex_ReadDword(effectData + 0x18)
	local parameter2 = EEex_ReadDword(effectData + 0x1C)
	local dicenumber = EEex_ReadDword(effectData + 0x34)
	local dicesize = EEex_ReadDword(effectData + 0x38)
	local restype = EEex_ReadDword(effectData + 0x8C)
	if restype ~= 1 then return false end
	if opcode == 17 then
		local healingMultiplier = EEex_GetActorStat(sourceID, 620)
		EEex_WriteDword(effectData + 0x18, parameter1 + math.floor(parameter1 * healingMultiplier / 100))
		EEex_WriteDword(effectData + 0x34, dicenumber + math.floor(dicenumber * healingMultiplier / 100))
	end
	local savebonus = EEex_ReadDword(effectData + 0x40)
	local school = EEex_ReadDword(effectData + 0x48)
	local schoolBonus = EEex_GetActorStat(sourceID, 622 + school) + EEex_GetActorStat(sourceID, 619)
	if schoolBonus ~= 0 then
		EEex_WriteDword(effectData + 0x40, savebonus - schoolBonus)
	end
end

function MEPRINTE(originatingEffectData, effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local opcode = EEex_ReadDword(effectData + 0xC)
	Infinity_DisplayString("Opcode " .. opcode .. " on " .. EEex_GetActorName(targetID))
	if opcode == 12 then
		Infinity_DisplayString("target: " .. EEex_ReadDword(effectData + 0x20))
		Infinity_DisplayString("savingthrow: " .. EEex_ReadDword(effectData + 0x3C))
		Infinity_DisplayString("special: " .. EEex_ReadDword(effectData + 0x44))
		Infinity_DisplayString("school: " .. EEex_ReadDword(effectData + 0x48))
		Infinity_DisplayString("resist_dispel: " .. EEex_ReadDword(effectData + 0x58))
		Infinity_DisplayString("restype: " .. EEex_ReadDword(effectData + 0x8C))
		Infinity_DisplayString("parent_resource: " .. EEex_ReadLString(effectData + 0x90, 8))
		Infinity_DisplayString("resource_flags: " .. EEex_ReadDword(effectData + 0x98))
		Infinity_DisplayString("sourceslot: " .. EEex_ReadDword(effectData + 0xA0))
		Infinity_DisplayString("internal_flags: " .. EEex_ReadDword(effectData + 0xC8))
		Infinity_DisplayString("sectype: " .. EEex_ReadDword(effectData + 0xCC))
--		EEex_WriteDword(effectData + 0x1C, 131072)
	end
end

me_const_id_sync = 0

me_actor_id_const = {}
function MECNSTID(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if EEex_GetActorStat(targetID, 645) == 0 then
		if me_const_id_sync == 0 then
			me_const_id_sync = 1

			local thisID = -2
			for i = 0, 5, 1 do
				if EEex_GetActorIDPortrait(i) > 0 then
					local actorShare = EEex_GetActorShare(EEex_GetActorIDPortrait(i))
					local possibleCount = EEex_ReadDword(actorShare + 0x614) + 2
					EEex_WriteDword(actorShare + 0x614, possibleCount)
					if possibleCount > thisID then
						thisID = possibleCount
					end
				end
			end

--[[
			local thisID = EEex_GetGlobal("MECNSTID") + 1
			EEex_SetGlobal("MECNSTID", thisID)
--]]
			me_const_id_sync = 0
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 401,
["target"] = 2,
["timing"] = 9,
["parameter1"] = thisID,
["parameter2"] = 1,
["special"] = 645,
["source_target"] = targetID,
["source_id"] = targetID
})
--			if thisID > 0 then
--				me_actor_id_const[thisID] = targetID
--			end
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 403,
["target"] = 2,
["timing"] = 9,
["resource"] = "MECIDSET",
["source_target"] = targetID,
["source_id"] = targetID
})

			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 402,
["target"] = 2,
["timing"] = 9,
["resource"] = "MECIDTAB",
["source_target"] = targetID,
["source_id"] = 0
})

		else
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 402,
["target"] = 2,
["timing"] = 3,
["resource"] = "MECNSTID",
["source_target"] = targetID,
["source_id"] = targetID
})

		end
--	else
--		me_actor_id_const[EEex_GetActorStat(targetID, 645)] = targetID
	end
end

function MECIDTAB(effectData, creatureData)

	local sourceID = EEex_ReadDword(effectData + 0x10C)

	if (sourceID == 0 or sourceID == -1) then
		local targetID = EEex_ReadDword(creatureData + 0x34)
		if EEex_GetActorIDPortrait(0) == targetID or EEex_GetActorIDPortrait(0) == -1 then
--			Infinity_DisplayString("reset")
			me_actor_id_const = {}
		end
		EEex_AlterActorEffect(targetID,{{"opcode",402},{"resource","MECIDTAB"}}, {{"source_id",targetID}},1)
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["resource"] = "MECIDTA2",
["source_target"] = targetID,
["source_id"] = targetID
})
--[[
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 402,
["target"] = 2,
["timing"] = 0,
["duration"] = 0,
["resource"] = "MECIDTA2",
["source_target"] = targetID,
["source_id"] = targetID
})
--]]
	end

end

function MECIDTA2(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local constantID = EEex_GetActorStat(targetID, 645)
--	Infinity_DisplayString(constantID)
	if constantID ~= 0 then
		me_actor_id_const[constantID] = targetID

		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["resource"] = "MECIDTA3",
["source_target"] = targetID,
["source_id"] = targetID
})
	end
end

function MECIDTA3(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
--	Infinity_DisplayString(targetID)
	if not EEex_IsSprite(targetID) then return end
	EEex_IterateActorEffects(targetID, function(eData)

		local the_parameter5 = EEex_ReadDword(eData + 0x68)

		if me_actor_id_const[the_parameter5] ~= nil then
--			if EEex_IsSprite(me_actor_id_const[the_parameter5]) then
			EEex_WriteDword(eData + 0x110, me_actor_id_const[the_parameter5])
--			end
		end

	end)

end

function MEACTSPL(effectData, creatureData)

	local sourceID = EEex_ReadDword(creatureData + 0x34)
	local action = EEex_ReadWord(effectData + 0x44, 0x0)
	if action ~= EEex_ReadWord(creatureData + 0x2F8, 0x0) then return end
	local targetID = EEex_ReadDword(creatureData + 0x318)
	local spellRes = EEex_ReadLString(effectData + 0x18, 8)
	local casterlvl = EEex_ReadDword(effectData + 0xC4)
	if casterlvl < 1 then
		casterlvl = EEex_GetActorStat(sourceID, 34)
	end
	local sourceX = EEex_ReadDword(creatureData + 0x8)
	local sourceY = EEex_ReadDword(creatureData + 0xC)
	local range = bit32.band(EEex_ReadWord(effectData + 0x46, 0x0), 0x7FFF)
	local invertRangeCheck = (bit32.band(EEex_ReadWord(effectData + 0x46, 0x0), 0x8000) == 0)
	if targetID > 0 then
		local targetX = EEex_ReadDword(EEex_GetActorShare(targetID) + 0x8)
		local targetY = EEex_ReadDword(EEex_GetActorShare(targetID) + 0xC)
		if invertRangeCheck then
			if EEex_GetDistance(sourceX, sourceY, targetX, targetY) < range then return end
		else
			if EEex_GetDistance(sourceX, sourceY, targetX, targetY) >= range then return end
		end
--		EEex_WriteDword(effectData + 0x110, 0x1)
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["parameter1"] = casterlvl,
["parameter2"] = 2,
["resource"] = spellRes,
["source_target"] = targetID,
["source_id"] = sourceID,
["source_x"] = sourceX,
["source_y"] = sourceY,
["target_x"] = targetX,
["target_y"] = targetY
})
--		EEex_WriteDword(effectData + 0x110, 0x0)
	else
		local targetX = EEex_ReadDword(creatureData + 0x34C)
		local targetY = EEex_ReadDword(creatureData + 0x350)
		if invertRangeCheck then
			if EEex_GetDistance(sourceX, sourceY, targetX, targetY) < range then return end
		else
			if EEex_GetDistance(sourceX, sourceY, targetX, targetY) >= range then return end
		end
--		EEex_WriteDword(effectData + 0x110, 0x1)
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 148,
["target"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["parameter1"] = casterlvl,
["parameter2"] = 2,
["resource"] = spellRes,
["source_target"] = sourceID,
["source_id"] = sourceID,
["source_x"] = sourceX,
["source_y"] = sourceY,
["target_x"] = targetX,
["target_y"] = targetY
})
--		EEex_WriteDword(effectData + 0x110, 0x0)
	end

end

function MEEXCHSP(effectData, creatureData)
	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if not EEex_IsSprite(targetID) or not EEex_IsSprite(sourceID) then return false end
	local spellRes = EEex_ReadLString(effectData + 0x18, 8)
	local flags = EEex_ReadByte(effectData + 0x47, 0x0)
	if bit32.band(flags, 0x1) == 1 then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 1,
["parameter1"] = 1,
["parameter2"] = 2,
["resource"] = spellRes,
["internal_flags"] = 0x4000001,
["source_target"] = targetID,
["source_id"] = sourceID
})
	end
	if bit32.band(flags, 0x2) == 2 then
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 1,
["parameter1"] = 1,
["parameter2"] = 2,
["resource"] = spellRes,
["internal_flags"] = 0x4000001,
["source_target"] = sourceID,
["source_id"] = targetID
})
	end
end

function MELINKST(effectData, creatureData)
	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if not EEex_IsSprite(targetID) or not EEex_IsSprite(sourceID) then return false end
	local spellRes = EEex_ReadLString(effectData + 0x18, 8)
	local duration = EEex_ReadWord(effectData + 0x44, 0x0)
	local timing = 0
	if duration == 0 then
		timing = 9
	end
	local flags = EEex_ReadByte(effectData + 0x47, 0x0)
	if bit32.band(flags, 0x1) == 1 then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 1,
["resource"] = spellRes,
["internal_flags"] = 0x4000001,
["source_target"] = targetID,
["source_id"] = sourceID
})
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 403,
["target"] = 2,
["timing"] = timing,
["duration"] = duration,
["resource"] = spellRes,
["internal_flags"] = 0x4000001,
["parent_resource"] = spellRes,
["source_target"] = targetID,
["source_id"] = sourceID
})
	end
	if bit32.band(flags, 0x2) == 2 then
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 1,
["resource"] = spellRes,
["internal_flags"] = 0x4000001,
["source_target"] = sourceID,
["source_id"] = targetID
})
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 403,
["target"] = 2,
["timing"] = timing,
["duration"] = duration,
["resource"] = spellRes,
["internal_flags"] = 0x4000001,
["parent_resource"] = spellRes,
["source_target"] = sourceID,
["source_id"] = targetID
})
	end
end

function MELINKSO(effectData, creatureData)
	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if not EEex_IsSprite(targetID) or not EEex_IsSprite(sourceID) then return false end
	local spellRes = EEex_ReadLString(effectData + 0x18, 8)
	local parent_resource = EEex_ReadLString(effectData + 0x90, 8)
	local duration = EEex_ReadDword(effectData + 0x44)
	local timing = 0
	if duration == 0 then
		timing = 9
	end
	local constantID = math.random(0x7FFFFFFF)
--[[
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 1,
["resource"] = spellRes,
["internal_flags"] = 0x4000001,
["source_target"] = targetID,
["source_id"] = sourceID
})
--]]
	EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 401,
["target"] = 2,
["timing"] = timing,
["duration"] = duration,
["parameter1"] = constantID,
["parameter2"] = 1,
["resource"] = spellRes,
["internal_flags"] = 0x4000001,
["special"] = 660,
["parent_resource"] = parent_resource,
["source_target"] = sourceID,
["source_id"] = sourceID
})
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 402,
["target"] = 2,
["timing"] = timing,
["duration"] = duration,
["resource"] = "MELINKS2",
["resource2"] = spellRes,
["internal_flags"] = 0x4000001,
["special"] = constantID,
["parent_resource"] = parent_resource,
["source_target"] = targetID,
["source_id"] = sourceID
})
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 403,
["target"] = 2,
["timing"] = timing,
["duration"] = duration,
["resource"] = spellRes,
["internal_flags"] = 0x4000001,
["special"] = constantID,
["parent_resource"] = parent_resource,
["source_target"] = targetID,
["source_id"] = sourceID
})
end

function MELINKS2(effectData, creatureData)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if (sourceID == 0 or sourceID == -1) then
		local targetID = EEex_ReadDword(creatureData + 0x34)
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["resource"] = "MELINKS3",
["internal_flags"] = 0x4000001,
["source_target"] = targetID,
["source_id"] = targetID
})
	end
end

function MELINKS3(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if EEex_GetActorStat(targetID, 660) == 0 then return end
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	EEex_IterateActorEffects(targetID, function(eData)
		local the_opcode = EEex_ReadDword(eData + 0x10)
		local the_parameter1 = EEex_ReadDword(eData + 0x1C)
		local the_special = EEex_ReadDword(eData + 0x48)
		local the_parent_resource = EEex_ReadLString(eData + 0x94, 8)
		if the_opcode == 401 and the_special == 660 then
			EEex_IterateActorEffects(sourceID, function(eDataA)
				local the_opcodeA = EEex_ReadDword(eDataA + 0x10)
				local the_specialA = EEex_ReadDword(eDataA + 0x48)
				local the_sourceIDA = EEex_ReadDword(eDataA + 0x110)
				if the_opcodeA == 403 and the_specialA == the_parameter1 and the_sourceIDA <= 0 then
					EEex_WriteDword(eDataA + 0x110, targetID)
				end
			end)
		end
	end)
end

me_permanent_linkable_opcodes = {
[2] = 1, [3] = 1, [4] = 1, [7] = 1, [8] = 1, [9] = 1, [11] = 1, [12] = 1, [13] = 1, [14] = 1, [17] = 1, [18] = 1, [20] = 1, [23] = 1, [24] = 1, [25] = 1, [26] = 1, [32] = 1,
[41] = 1, [43] = 1, [46] = 1, [47] = 1, [48] = 1, [50] = 1, [51] = 1, [52] = 1, [55] = 1, [58] = 1, [61] = 1, [64] = 1,
[66] = 1, [70] = 1, [72] = 1, [75] = 1, [77] = 1, [79] = 1, [81] = 1, [82] = 1, [93] = 1, [94] = 1, [112] = 1, [115] = 1, [116] = 1, [117] = 1, [119] = 1, [124] = 1, [125] = 1,
[134] = 1, [135] = 1, [136] = 1, [138] = 1, [139] = 1, [141] = 1, [146] = 1, [148] = 1, [150] = 1, [151] = 1, [159] = 1, [160] = 1, [161] = 1, [162] = 1, [163] = 1, [164] = 1, [165] = 1,
[170] = 1, [174] = 1, [177] = 1, [209] = 1, [210] = 1, [211] = 1, [212] = 1, [213] = 1, [215] = 1, [216] = 1, [217] = 1, [218] = 1, [220] = 1, [221] = 1, [222] = 1, [224] = 1, [225] = 1, [229] = 1,
[236] = 1, [237] = 1, [238] = 1, [239] = 1, [240] = 1, [242] = 1, [243] = 1, [244] = 1, [255] = 1, [261] = 1, [264] = 1, [266] = 1, [269] = 1, [270] = 1, [271] = 1, [273] = 1, [274] = 1, [279] = 1,
[283] = 1, [304] = 1, [307] = 1, [311] = 1, [316] = 1, [321] = 1, [326] = 1, [327] = 1, [329] = 1, [330] = 1, [334] = 1, [337] = 1, [343] = 1
}
me_unlinkable_opcodes = {
[67] = 1, [68] = 1, [96] = 1, [103] = 1, [104] = 1, [107] = 1, [108] = 1, [127] = 1, [140] = 1, [147] = 1, [152] = 1, [168] = 1, [171] = 1, [172] = 1, [187] = 1, [192] = 1, [195] = 1, [196] = 1,
[214] = 1, [231] = 1, [234] = 1, [251] = 1, [252] = 1, [253] = 1, [254] = 1, [257] = 1, [265] = 1, [290] = 1, [298] = 1, [309] = 1, [313] = 1, [314] = 1, [315] = 1, [319] = 1, [320] = 1, [331] = 1,
[338] = 1, [339] = 1
}
function MELINKEF(originatingEffectData, effectData, creatureData)
	local internal_flags = EEex_ReadDword(effectData + 0xC8)
	if bit32.band(internal_flags, 0x4000000) == 0 then
		local targetID = EEex_ReadDword(creatureData + 0x34)
		local sourceID = EEex_ReadDword(effectData + 0x10C)
		local linkID = -1
		EEex_IterateActorEffects(targetID, function(eData)
			local the_opcode = EEex_ReadDword(eData + 0x10)
			local the_resource = EEex_ReadLString(eData + 0x30, 8)
			if the_opcode == 403 and the_resource == "MELINKEF" then
				linkID = EEex_ReadDword(eData + 0x110)
			end
		end)
		if not EEex_IsSprite(targetID) or not EEex_IsSprite(sourceID) or not EEex_IsSprite(linkID) then return false end
		local opcode = EEex_ReadDword(effectData + 0xC)
		local timing = EEex_ReadDword(effectData + 0x20)
		local resist_dispel = EEex_ReadDword(effectData + 0x58)
		if resist_dispel ~= 1 and resist_dispel ~= 3 then return false end
		if timing == 2 or timing == 5 or timing == 8 then return false end
		if me_unlinkable_opcodes[opcode] ~= nil then return false end
--		if (timing == 1 or timing == 4 or timing == 7 or timing == 9) and me_permanent_linkable_opcodes[opcode] == nil then return false end
		EEex_ApplyEffectToActor(linkID, {
["opcode"] = EEex_ReadDword(effectData + 0xC),
["target"] = EEex_ReadDword(effectData + 0x10),
["power"] = EEex_ReadDword(effectData + 0x14),
["parameter1"] = EEex_ReadDword(effectData + 0x18),
["parameter2"] = EEex_ReadDword(effectData + 0x1C),
["timing"] = EEex_ReadDword(effectData + 0x20),
["duration"] = EEex_ReadDword(effectData + 0x24),
["resource"] = EEex_ReadLString(effectData + 0x2C, 8),
["dicenumber"] = EEex_ReadDword(effectData + 0x34),
["dicesize"] = EEex_ReadDword(effectData + 0x38),
["savingthrow"] = EEex_ReadDword(effectData + 0x3C),
["savebonus"] = EEex_ReadDword(effectData + 0x40),
["special"] = EEex_ReadDword(effectData + 0x44),
["school"] = EEex_ReadDword(effectData + 0x48),
["resist_dispel"] = EEex_ReadDword(effectData + 0x58),
["parameter3"] = EEex_ReadDword(effectData + 0x5C),
["parameter4"] = EEex_ReadDword(effectData + 0x60),
["parameter5"] = EEex_ReadDword(effectData + 0x64),
["vvcresource"] = EEex_ReadLString(effectData + 0x6C, 8),
["resource2"] = EEex_ReadLString(effectData + 0x74, 8),
["source_x"] = EEex_ReadDword(effectData + 0x7C),
["source_y"] = EEex_ReadDword(effectData + 0x80),
["target_x"] = EEex_ReadDword(EEex_GetActorShare(linkID) + 0x8),
["target_y"] = EEex_ReadDword(EEex_GetActorShare(linkID) + 0xC),
["restype"] = EEex_ReadDword(effectData + 0x8C),
["parent_resource"] = EEex_ReadLString(effectData + 0x90, 8),
["resource_flags"] = EEex_ReadDword(effectData + 0x98),
["impact_projectile"] = EEex_ReadDword(effectData + 0x9C),
["sourceslot"] = EEex_ReadDword(effectData + 0xA0),
["effvar"] = EEex_ReadLString(effectData + 0xA4, 32),
["casterlvl"] = EEex_ReadDword(effectData + 0xC4),
["internal_flags"] = bit32.bor(internal_flags, 0x4000000),
["sectype"] = EEex_ReadDword(effectData + 0xCC),
["source_target"] = linkID,
["source_id"] = sourceID
})

		return false
	end
end

function MELINKVA(originatingEffectData, effectData, creatureData)
	local opcode = EEex_ReadDword(effectData + 0xC)
	if opcode ~= 12 then return false end
	local internal_flags = EEex_ReadDword(effectData + 0xC8)
	if bit32.band(internal_flags, 0x4000000) == 0 then
		local targetID = EEex_ReadDword(creatureData + 0x34)
		local sourceID = EEex_ReadDword(effectData + 0x10C)
		local linkConstantID = -1
		local linkID = -1
		EEex_IterateActorEffects(targetID, function(eData)
			local the_opcode = EEex_ReadDword(eData + 0x10)
			local the_resource = EEex_ReadLString(eData + 0x30, 8)
			if the_opcode == 403 and the_resource == "MELINKVA" then
				linkConstantID = EEex_ReadDword(eData + 0x64)
				linkID = EEex_ReadDword(eData + 0x110)
			end
		end)
		if not EEex_IsSprite(targetID) or not EEex_IsSprite(sourceID) or not EEex_IsSprite(linkID) then return false end
		local targetCurrentHP = EEex_ReadWord(creatureData + 0x438, 0x0)
		local targetMaxHP = EEex_GetActorStat(targetID, 1)
		local damage = EEex_ReadDword(effectData + 0x18)
		local healing = damage
		local damage_method = EEex_ReadWord(effectData + 0x1C, 0x0)
		local damage_type = EEex_ReadWord(effectData + 0x1E, 0x0)
		local dicenumber = EEex_ReadDword(effectData + 0x34)
		local dicesize = EEex_ReadDword(effectData + 0x38)
		if damage_method == 0 then
			for i = 1, dicenumber, 1 do
				healing = healing + math.random(dicesize)
			end
			EEex_WriteDword(effectData + 0x18, healing)
			EEex_WriteDword(effectData + 0x34, 0)
			EEex_WriteDword(effectData + 0x38, 0)
--			local resistance = EEex_GetActorFullResistance(targetID, me_damage_resistance[damage_type][1])
			local resistance = EEex_GetActorStat(targetID, me_damage_resistance[damage_type][1])
			healing = healing - math.floor(healing * resistance / 100)
		end
		if damage_method == 1 then
			healing = targetCurrentHP - damage
		elseif damage_method == 2 then
			healing = targetCurrentHP - math.floor(targetMaxHP * damage / 100)
		elseif damage_method == 3 then
			healing = math.floor(targetMaxHP * damage / 100)
		end
		if healing <= 0 then return false end
--		if (timing == 1 or timing == 4 or timing == 7 or timing == 9) and me_permanent_linkable_opcodes[opcode] == nil then return false end
		EEex_ApplyEffectToActor(linkID, {
["opcode"] = 17,
["target"] = EEex_ReadDword(effectData + 0x10),
["power"] = EEex_ReadDword(effectData + 0x14),
["parameter1"] = healing,
["timing"] = EEex_ReadDword(effectData + 0x20),
["duration"] = EEex_ReadDword(effectData + 0x24),
["resource"] = EEex_ReadLString(effectData + 0x2C, 8),
["dicenumber"] = EEex_ReadDword(effectData + 0x34),
["dicesize"] = EEex_ReadDword(effectData + 0x38),
["savingthrow"] = EEex_ReadDword(effectData + 0x3C),
["savebonus"] = EEex_ReadDword(effectData + 0x40),
["special"] = EEex_ReadDword(effectData + 0x44),
["school"] = 7,
["parameter3"] = EEex_ReadDword(effectData + 0x5C),
["parameter4"] = EEex_ReadDword(effectData + 0x60),
["parameter5"] = linkConstantID,
["vvcresource"] = EEex_ReadLString(effectData + 0x6C, 8),
["resource2"] = EEex_ReadLString(effectData + 0x74, 8),
["source_x"] = EEex_ReadDword(effectData + 0x7C),
["source_y"] = EEex_ReadDword(effectData + 0x80),
["target_x"] = EEex_ReadDword(EEex_GetActorShare(linkID) + 0x8),
["target_y"] = EEex_ReadDword(EEex_GetActorShare(linkID) + 0xC),
["restype"] = EEex_ReadDword(effectData + 0x8C),
["parent_resource"] = EEex_ReadLString(effectData + 0x90, 8),
["resource_flags"] = bit32.band(EEex_ReadDword(effectData + 0x98), 0xFFFFF9FF),
["impact_projectile"] = EEex_ReadDword(effectData + 0x9C),
["sourceslot"] = EEex_ReadDword(effectData + 0xA0),
["effvar"] = EEex_ReadLString(effectData + 0xA4, 32),
["casterlvl"] = EEex_ReadDword(effectData + 0xC4),
["internal_flags"] = bit32.bor(internal_flags, 0x4000000),
["sectype"] = 13,
["source_target"] = linkID,
["source_id"] = targetID
})

		return false
	end
end

function MESELFSP(effectData, creatureData)
	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	if not EEex_IsSprite(targetID) then return end
	local special = EEex_ReadDword(effectData + 0x44)
	if special <= 0 then
		special = 1
	end	
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = special,
["parameter2"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["resource"] = EEex_ReadLString(effectData + 0x18, 8),
["source_x"] = EEex_ReadDword(creatureData + 0x8),
["source_y"] = EEex_ReadDword(creatureData + 0xC),
["target_x"] = EEex_ReadDword(creatureData + 0x8),
["target_y"] = EEex_ReadDword(creatureData + 0xC),
["source_target"] = targetID,
["source_id"] = targetID
})
end

function MEREVRSP(effectData, creatureData)
	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if not EEex_IsSprite(targetID) or not EEex_IsSprite(sourceID) then return end
	local special = EEex_ReadDword(effectData + 0x44)
	if special <= 0 then
		special = 1
	end	
--	Infinity_DisplayString(EEex_GetActorScriptName(sourceID) .. " is being pulled to " .. EEex_GetActorScriptName(targetID))
	EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = special,
["parameter2"] = 2,
["timing"] = 9,
["resource"] = EEex_ReadLString(effectData + 0x18, 8),
["source_x"] = EEex_ReadDword(creatureData + 0x8),
["source_y"] = EEex_ReadDword(creatureData + 0xC),
["target_x"] = EEex_ReadDword(EEex_GetActorShare(sourceID) + 0x8),
["target_y"] = EEex_ReadDword(EEex_GetActorShare(sourceID) + 0xC),
["source_target"] = sourceID,
["source_id"] = targetID
})
end

function MEKNOCKB(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if not EEex_IsSprite(targetID) or not EEex_IsSprite(sourceID) then return end
	local sourceX = EEex_ReadDword(EEex_GetActorShare(sourceID) + 0x8)
	local sourceY = EEex_ReadDword(EEex_GetActorShare(sourceID) + 0xC)
	local targetX = EEex_ReadDword(creatureData + 0x8)
	local targetY = EEex_ReadDword(creatureData + 0xC)
	local parameter2 = EEex_ReadDword(effectData + 0x1C)
	local timing = EEex_ReadWord(effectData + 0x44, 0x0)
	local duration = EEex_ReadWord(effectData + 0x46, 0x0)
	local resist_dispel = EEex_ReadDword(effectData + 0x58)
	if resist_dispel == 1 then
		resist_dispel = 3
	end
	if parameter2 == 1 or parameter2 == 3 then
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 235,
["target"] = EEex_ReadDword(effectData + 0x10),
["power"] = EEex_ReadDword(effectData + 0x14),
["parameter1"] = EEex_ReadDword(effectData + 0x18),
["parameter2"] = parameter2 + 1,
["timing"] = timing,
["duration"] = duration,
["resource"] = EEex_ReadLString(effectData + 0x2C, 8),
["school"] = EEex_ReadDword(effectData + 0x48),
["resist_dispel"] = resist_dispel,
["parameter3"] = EEex_ReadDword(effectData + 0x5C),
["parameter4"] = EEex_ReadDword(effectData + 0x60),
["parameter5"] = EEex_ReadDword(effectData + 0x64),
["vvcresource"] = EEex_ReadLString(effectData + 0x6C, 8),
["resource2"] = EEex_ReadLString(effectData + 0x74, 8),
["source_x"] = targetX,
["source_y"] = targetY,
["target_x"] = sourceX,
["target_y"] = sourceY,
["restype"] = EEex_ReadDword(effectData + 0x8C),
["parent_resource"] = EEex_ReadLString(effectData + 0x90, 8),
["resource_flags"] = EEex_ReadDword(effectData + 0x98),
["impact_projectile"] = EEex_ReadDword(effectData + 0x9C),
["sourceslot"] = EEex_ReadDword(effectData + 0xA0),
["effvar"] = EEex_ReadLString(effectData + 0xA4, 32),
["casterlvl"] = EEex_ReadDword(effectData + 0xC4),
["internal_flags"] = EEex_ReadDword(effectData + 0xC8),
["sectype"] = EEex_ReadDword(effectData + 0xCC),
["source_target"] = sourceID,
["source_id"] = targetID
})
	elseif parameter2 == 2 or parameter2 == 4 then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 235,
["target"] = EEex_ReadDword(effectData + 0x10),
["power"] = EEex_ReadDword(effectData + 0x14),
["parameter1"] = EEex_ReadDword(effectData + 0x18),
["parameter2"] = parameter2 - 1,
["timing"] = timing,
["duration"] = duration,
["resource"] = EEex_ReadLString(effectData + 0x2C, 8),
["school"] = EEex_ReadDword(effectData + 0x48),
["resist_dispel"] = resist_dispel,
["parameter3"] = EEex_ReadDword(effectData + 0x5C),
["parameter4"] = EEex_ReadDword(effectData + 0x60),
["parameter5"] = EEex_ReadDword(effectData + 0x64),
["vvcresource"] = EEex_ReadLString(effectData + 0x6C, 8),
["resource2"] = EEex_ReadLString(effectData + 0x74, 8),
["source_x"] = targetX,
["source_y"] = targetY,
["target_x"] = sourceX,
["target_y"] = sourceY,
["restype"] = EEex_ReadDword(effectData + 0x8C),
["parent_resource"] = EEex_ReadLString(effectData + 0x90, 8),
["resource_flags"] = EEex_ReadDword(effectData + 0x98),
["impact_projectile"] = EEex_ReadDword(effectData + 0x9C),
["sourceslot"] = EEex_ReadDword(effectData + 0xA0),
["effvar"] = EEex_ReadLString(effectData + 0xA4, 32),
["casterlvl"] = EEex_ReadDword(effectData + 0xC4),
["internal_flags"] = EEex_ReadDword(effectData + 0xC8),
["sectype"] = EEex_ReadDword(effectData + 0xCC),
["source_target"] = targetID,
["source_id"] = sourceID
})
	end
end




function MEONCREA(effectData, creatureData)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if (sourceID == 0 or sourceID == -1) then
		local targetID = EEex_ReadDword(creatureData + 0x34)
		me_ghost_walk_positions = {}
		me_ghost_walk_actors = {}
		EEex_AlterActorEffect(targetID,{{"opcode",402},{"resource","MEONCREA"}}, {{"source_id",targetID}},1)
	end
end

function MEOFFSCR(effectData, creatureData)

	local targetID = EEex_ReadDword(creatureData + 0x34)

	local x, y = EEex_GetActorLocation(targetID)
	if EEex_ReadDword(creatureData + 0x14) <= 0 then return end
	local areaX, areaY = EEex_GetActorAreaSize(targetID)
--	local creFlags = EEex_ReadDword(creatureData + 0x424)
	if x <= 33 or y <= 25 or (areaX - x) <= 33 or (areaY - y) <= 12 then
--		EEex_WriteDword(creatureData + 0x424, bit32.bor(creFlags, 0x800000))

--		EEex_WriteDword(effectData + 0x110, 0x1)
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 287,
["target"] = 2,
["timing"] = 10,
["duration"] = 17,
["parent_resource"] = "MEOFFSCR",
["source_target"] = targetID,
["source_id"] = targetID
})
--[[
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["resource"] = "MEOFFSCR",
["source_target"] = targetID,
["source_id"] = targetID
})
--]]
--		EEex_WriteDword(effectData + 0x110, 0x0)

	else
--		EEex_WriteDword(creatureData + 0x424, bit32.band(creFlags, bit32.bnot(0x800000)))
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 9,
["resource"] = "MEOFFSCR",
["source_target"] = targetID,
["source_id"] = targetID
})
	end

end

me_bird_linkable_opcodes = {
[2] = 1, [3] = 1, [4] = 1, [5] = 1, [7] = 1, [8] = 1, [9] = 1, [11] = 1, [13] = 1, [14] = 1, [16] = 1,
[20] = 1, [22] = 1, [26] = 1, [32] = 1, [39] = 1,[40] = 1, [43] = 1, [45] = 1, [46] = 1, [47] = 1, [48] = 1, [50] = 1, [51] = 1, [52] = 1, [53] = 1,
[55] = 1, [58] = 1, [61] = 1, [63] = 1, [64] = 1, [65] = 1, [66] = 1, [68] = 1, [69] = 1, [70] = 1, [74] = 1, [75] = 1, [76] = 1, [77] = 1, [78] = 1,
[79] = 1, [80] = 1, [81] = 1, [101] = 1, [102] = 1, [109] = 1, [112] = 1, [115] = 1, [116] = 1, [119] = 1, [124] = 1, [125] = 1, [126] = 1, [134] = 1,
[135] = 1, [136] = 1, [138] = 1, [159] = 1, [160] = 1, [161] = 1, [162] = 1, [163] = 1, [164] = 1, [165] = 1, [168] = 1,
[170] = 1, [175] = 1, [176] = 1, [177] = 1, [183] = 1, [185] = 1, [186] = 1, [209] = 1, [210] = 1, [211] = 1, [212] = 1, [213] = 1,
[216] = 1, [217] = 1, [218] = 1, [220] = 1, [221] = 1, [222] = 1, [224] = 1, [225] = 1, [229] = 1, [230] = 1, [231] = 1,
[236] = 1, [237] = 1, [238] = 1, [241] = 1, [242] = 1, [243] = 1, [244] = 1, [245] = 1, [246] = 1, [247] = 1, [261] = 1, [262] = 1, [266] = 1,
[270] = 1, [271] = 1, [273] = 1, [274] = 1, [279] = 1,
[283] = 1, [291] = 1, [293] = 1, [294] = 1, [295] = 1, [297] = 1, [310] = 1, [314] = 1, [315] = 1, [316] = 1, [317] = 1, [321] = 1, [334] = 1, [337] = 1, [342] = 1, [365] = 1
}

function MELINKBI(originatingEffectData, effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local linkID = -1
	EEex_IterateActorEffects(targetID, function(eData)
		local the_opcode = EEex_ReadDword(eData + 0x10)
		local the_resource = EEex_ReadLString(eData + 0x30, 8)
		if the_opcode == 403 and the_resource == "MELINKBI" then
			linkID = EEex_ReadDword(eData + 0x110)
		end
	end)
	if not EEex_IsSprite(targetID) or not EEex_IsSprite(sourceID) or not EEex_IsSprite(linkID) or sourceID == linkID then return false end
	local opcode = EEex_ReadDword(effectData + 0xC)
	local timing = EEex_ReadDword(effectData + 0x20)
	
	if timing == 2 or timing == 5 or timing == 8 then return false end
	if me_bird_linkable_opcodes[opcode] == nil then return false end
	local internal_flags = EEex_ReadDword(effectData + 0xC8)
	if bit32.band(internal_flags, 0x4000000) ~= 0 then return end
	local new_opcode = opcode
	local new_parameter1 = EEex_ReadDword(effectData + 0x18)
	local new_parameter2 = EEex_ReadDword(effectData + 0x1C)
	local old_animation = EEex_GetActorAnimation(linkID)
	if new_opcode == 13 and me_birdtodead["" .. old_animation] ~= nil then
		new_parameter1 = 1
		new_parameter2 = 512
				EEex_ApplyEffectToActor(linkID, {
["opcode"] = 53,
["target"] = 2,
["parameter1"] = me_birdtodead["" .. old_animation],
["parameter2"] = 2,
["timing"] = 9,
["source_target"] = linkID,
["source_id"] = linkID
})
		EEex_ApplyEffectToActor(linkID, {
["opcode"] = 53,
["target"] = 2,
["parameter1"] = EEex_GetActorAnimation(targetID),
["parameter2"] = 0,
["timing"] = 0,
["source_target"] = linkID,
["source_id"] = linkID
})
	end
	EEex_ApplyEffectToActor(linkID, {
["opcode"] = new_opcode,
["target"] = EEex_ReadDword(effectData + 0x10),
["power"] = EEex_ReadDword(effectData + 0x14),
["parameter1"] = new_parameter1,
["parameter2"] = new_parameter2,
["timing"] = EEex_ReadDword(effectData + 0x20),
["duration"] = EEex_ReadDword(effectData + 0x24),
["resource"] = EEex_ReadLString(effectData + 0x2C, 8),
["dicenumber"] = EEex_ReadDword(effectData + 0x34),
["dicesize"] = EEex_ReadDword(effectData + 0x38),
["savingthrow"] = EEex_ReadDword(effectData + 0x3C),
["savebonus"] = EEex_ReadDword(effectData + 0x40),
["special"] = EEex_ReadDword(effectData + 0x44),
["school"] = EEex_ReadDword(effectData + 0x48),
["resist_dispel"] = EEex_ReadDword(effectData + 0x58),
["parameter3"] = EEex_ReadDword(effectData + 0x5C),
["parameter4"] = EEex_ReadDword(effectData + 0x60),
["parameter5"] = EEex_ReadDword(effectData + 0x64),
["vvcresource"] = EEex_ReadLString(effectData + 0x6C, 8),
["resource2"] = EEex_ReadLString(effectData + 0x74, 8),
["source_x"] = EEex_ReadDword(effectData + 0x7C),
["source_y"] = EEex_ReadDword(effectData + 0x80),
["target_x"] = EEex_ReadDword(EEex_GetActorShare(linkID) + 0x8),
["target_y"] = EEex_ReadDword(EEex_GetActorShare(linkID) + 0xC),
["restype"] = EEex_ReadDword(effectData + 0x8C),
["parent_resource"] = EEex_ReadLString(effectData + 0x90, 8),
["resource_flags"] = EEex_ReadDword(effectData + 0x98),
["impact_projectile"] = EEex_ReadDword(effectData + 0x9C),
["sourceslot"] = EEex_ReadDword(effectData + 0xA0),
["effvar"] = EEex_ReadLString(effectData + 0xA4, 32),
["casterlvl"] = EEex_ReadDword(effectData + 0xC4),
["internal_flags"] = bit32.bor(internal_flags, 0x4000000),
["sectype"] = EEex_ReadDword(effectData + 0xCC),
["source_target"] = linkID,
["source_id"] = sourceID
})
	return false
end

function MEBIRDPU(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local birdName = EEex_GetActorScriptName(sourceID)
--	Infinity_DisplayString(birdName)
	if birdName == nil or birdName == "None" then return end
	local area = EEex_ReadDword(creatureData + 0x14)
	
	if area <= 0 then return end
--	Infinity_DisplayString(area)
--	Infinity_DisplayString(EEex_ReadLString(area, 8))

	EEex_IterateActorIDs(area, function(actorID)

		local the_actorName = EEex_GetActorScriptName(actorID)
--		Infinity_DisplayString(the_actorName)
		if the_actorName == birdName .. "CRE" then
			EEex_ApplyEffectToActor(actorID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 9,
["resource"] = "MEBIRDPU",
["source_x"] = EEex_ReadDword(EEex_GetActorShare(sourceID) + 0x8),
["source_y"] = EEex_ReadDword(EEex_GetActorShare(sourceID) + 0xC),
["target_x"] = EEex_ReadDword(EEex_GetActorShare(actorID) + 0x8),
["target_y"] = EEex_ReadDword(EEex_GetActorShare(actorID) + 0xC),
["source_target"] = actorID,
["source_id"] = sourceID
})

		end

	end)

--	EEex_EvalActionsStringAsActorResume("ApplySpellRES(\"MEBIRDPU\",\"" .. birdName .. "CRE\")", sourceID)
end

--[[
function MEBIRDPU(effectData, creatureData)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if (sourceID == 0 or sourceID == -1) then
		local targetID = EEex_ReadDword(creatureData + 0x34)
--		EEex_AlterActorEffect(targetID,{{"opcode",402},{"resource","MEBIRDPU"}}, {{"source_id",targetID}},1)
		local birdName = EEex_GetActorScriptName(targetID)
		Infinity_DisplayString(birdName)
		if birdName == nil or birdName == "None" then return end
		EEex_EvalActionsStringAsActorResume("ApplySpellRES(\"MEBIRDPU\",\"" .. birdName .. "CRE\")", targetID)
	end

end
--]]
--[[
function MEBIRDPU(effectData, creatureData)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if (sourceID == 0 or sourceID == -1) then
		local targetID = EEex_ReadDword(creatureData + 0x34)
--		EEex_AlterActorEffect(targetID,{{"opcode",402},{"resource","MEBIRDPU"}}, {{"source_id",targetID}},1)
		local birdCreatureName = EEex_GetActorScriptName(targetID)
		Infinity_DisplayString(birdCreatureName)
		if birdCreatureName == nil or birdCreatureName == "None" then return end
		Infinity_DisplayString(string.sub(birdCreatureName, 1, #birdCreatureName - 3))
		EEex_EvalActionsStringAsActorResume("ApplySpellRES(\"MEBIRDP2\",\"" .. string.sub(birdCreatureName, 1, #birdCreatureName - 3) .. "\")", targetID)
	end

end
--]]

function MESHATTE(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	EEex_Call(EEex_Label("CGameSprite::Shatter"), {0x0}, creatureData, 0x0)
end

function MEHOP(effectData, creatureData)
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	EEex_Call(EEex_Label("CGameSprite::Shatter"), {0x4}, creatureData, 0x0)
--[[
	EEex_IterateActorEffects(targetID, function(eData)
		local the_opcode = EEex_ReadDword(eData + 0x10)
		local the_timing = EEex_ReadDword(eData + 0x24)
		if the_opcode == 7 and the_timing == 2 then
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 7,
["target"] = 2,
["parameter1"] = EEex_ReadDword(eData + 0x1C),
["parameter2"] = EEex_ReadDword(eData + 0x20),
["timing"] = 0,
["duration"] = 0,
["parent_resource"] = "MECLRFIX",
["sourceslot"] = EEex_ReadDword(eData + 0xA4),
["source_target"] = targetID,
["source_id"] = targetID
})
		end
	end)
--]]
end


function MEHGTST(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local animation = EEex_GetActorAnimation(targetID)
	local parameter1 = EEex_ReadDword(effectData + 0x18)
	local parameter2 = EEex_ReadDword(effectData + 0x1C)
	local special = EEex_ReadDword(effectData + 0x44)
	if special == 0 then
		local height = EEex_ReadSignedWord(creatureData + 0x618, 0x0)
--		Infinity_DisplayString(height)
		if parameter2 == 0 then
			EEex_WriteWord(creatureData + 0x618, height + parameter1)
		elseif parameter2 == 1 then
			EEex_WriteWord(creatureData + 0x618, parameter1)
		elseif parameter2 == 2 then
			EEex_WriteWord(creatureData + 0x618, math.floor(height * (parameter1 / 100)))
		end
	elseif special == 1 then
		local speed = EEex_ReadSignedWord(creatureData + 0x61A, 0x0)
--		Infinity_DisplayString(speed)
		if parameter2 == 0 then
			EEex_WriteWord(creatureData + 0x61A, speed + parameter1)
		elseif parameter2 == 1 then
			EEex_WriteWord(creatureData + 0x61A, parameter1)
		elseif parameter2 == 2 then
			EEex_WriteWord(creatureData + 0x61A, math.floor(speed * (parameter1 / 100)))
		end
	elseif special == 2 then
		local accel = EEex_ReadSignedWord(creatureData + 0x61C, 0x0)
--		Infinity_DisplayString(accel)
		if parameter2 == 0 then
			EEex_WriteWord(creatureData + 0x61C, accel + parameter1)
		elseif parameter2 == 1 then
			EEex_WriteWord(creatureData + 0x61C, parameter1)
		elseif parameter2 == 2 then
			EEex_WriteWord(creatureData + 0x61C, math.floor(accel * (parameter1 / 100)))
		end
	elseif special == 3 then
		local minHeight = EEex_ReadSignedWord(creatureData + 0x61E, 0x0)
--		Infinity_DisplayString(minHeight)
		if parameter2 == 0 then
			EEex_WriteWord(creatureData + 0x61E, minHeight + parameter1)
		elseif parameter2 == 1 then
			EEex_WriteWord(creatureData + 0x61E, parameter1)
		elseif parameter2 == 2 then
			EEex_WriteWord(creatureData + 0x61E, math.floor(minHeight * (parameter1 / 100)))
		end
	elseif special == 4 then
		local maxHeight = EEex_ReadSignedWord(creatureData + 0x620, 0x0)
--		Infinity_DisplayString(maxHeight)
		if parameter2 == 0 then
			EEex_WriteWord(creatureData + 0x620, maxHeight + parameter1)
		elseif parameter2 == 1 then
			EEex_WriteWord(creatureData + 0x620, parameter1)
		elseif parameter2 == 2 then
			EEex_WriteWord(creatureData + 0x620, math.floor(maxHeight * (parameter1 / 100)))
		end
	end
end
-- Bits for special:
--[[
0x1: Treat the minimum height as the ground (so reaching the minimum height counts as landing)
0x2: Remove source effects on landing
0x8: Cast spell on landing
--]]
function MEHGTMOD(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
--	if not EEex_IsSprite(sourceID) then return end
	local parameter1 = EEex_ReadDword(effectData + 0x18)
	local parameter2 = EEex_ReadDword(effectData + 0x1C)
	local parameter3 = EEex_ReadDword(effectData + 0x5C)
	local parameter4 = EEex_ReadDword(effectData + 0x60)
	local special = EEex_ReadDword(effectData + 0x44)
	local parent_resource = EEex_ReadLString(effectData + 0x90, 8)
	local spellRes = EEex_ReadLString(effectData + 0x18, 8)
	local casterlvl = EEex_ReadDword(effectData + 0xC4)
	local duration = EEex_ReadDword(effectData + 0x24)
	local time_applied = EEex_ReadDword(effectData + 0x68)
	local firstIteration = false
	local roofHeight = 32767
	local targetHeight = 70
	local areaRes = EEex_GetActorAreaRes(targetID)
	if me_ceiling_height[areaRes] ~= nil then
		roofHeight = me_ceiling_height[areaRes] * 2
	end

	if bit32.band(parameter4, 0x1) == 0 then
		parameter4 = bit32.bor(parameter4, 0x1)
		firstIteration = true
	end

	local animation = EEex_GetActorAnimation(targetID)
	local height = EEex_ReadSignedWord(creatureData + 0x618, 0x0) + EEex_GetActorStat(targetID, 641)
	local speed = EEex_ReadSignedWord(creatureData + 0x61A, 0x0) + EEex_GetActorStat(targetID, 642)
	local accel = EEex_ReadSignedWord(creatureData + 0x61C, 0x0) + EEex_GetActorStat(targetID, 643)
	local minHeight = EEex_GetActorStat(targetID, 647)
	local maxHeight = EEex_GetActorStat(targetID, 648)
	local centerHeight = EEex_GetActorStat(targetID, 649)

	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 9,
["resource"] = "MEGOOVER",
["source_target"] = targetID,
["source_id"] = sourceID
})
	local theareatype = 0
	if EEex_ReadDword(EEex_GetActorShare(targetID) + 0x14) > 0 then
		theareatype = EEex_ReadWord(EEex_ReadDword(EEex_GetActorShare(targetID) + 0x14) + 0x40, 0x0)
	end
	if bit32.band(theareatype, 0x1) == 1 and bit32.band(theareatype, 0x800) == 0 and height >= 100 then
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 184,
["target"] = 2,
["timing"] = 10,
["duration"] = 15,
["parameter2"] = 1,
["parent_resource"] = "MEGOOVER",
["source_target"] = targetID,
["source_id"] = targetID
})
	end
	
	if (minHeight <= 0 or bit32.band(special, 0x1) == 0x1) and (height <= minHeight and speed <= 0 and accel <= 0) then 
		EEex_WriteWord(creatureData + 0x618, 0)
		EEex_WriteWord(creatureData + 0x61A, 0)
		EEex_WriteWord(creatureData + 0x61C, -1)
		if bit32.band(special, 0x2) == 0x2 then
			EEex_WriteDword(effectData + 0x110, 0x1)
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 9,
["resource"] = parent_resource,
["parent_resource"] = parent_resource,
["source_target"] = targetID,
["source_id"] = sourceID
})
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 407,
["target"] = 2,
["parameter1"] = casterlvl,
["parameter2"] = 2,
["timing"] = 10,
["duration"] = 1,
["resource"] = "MEUNSTUC",
["casterlvl"] = casterlvl,
["parent_resource"] = "MEUNSTUC",
["source_target"] = targetID,
["source_id"] = sourceID
})
		end
		if bit32.band(special, 0x8) == 0x8 then
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = 1,
["parameter2"] = 2,
["timing"] = 9,
["resource"] = parent_resource .. "E",
["source_target"] = targetID,
["source_id"] = sourceID
})
			EEex_WriteDword(creatureData + 0x10, 0)
		end
		if bit32.band(special, 0x2) == 0x2 or bit32.band(special, 0x8) == 0x8 then
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 325,
["target"] = 2,
["timing"] = 3,
["duration"] = 0,
["source_target"] = targetID,
["source_id"] = sourceID
})
			return 
		end
	end
	if minHeight < 0 then
		minHeight = 0
	end
	if maxHeight > (roofHeight - targetHeight) and not EEex_IsEthereal(targetID) then
		if targetHeight >= roofHeight then
			maxHeight = 1
		else
			maxHeight = (roofHeight - targetHeight)
		end
	end
	if maxHeight <= 0 or maxHeight > 10000 then
		maxHeight = 10000
	end
	if minHeight >= maxHeight then
		minHeight = maxHeight - 1
	end

	if height <= minHeight then
		height = minHeight
		if speed < 0 then
			speed = 0
		end
	elseif height >= maxHeight then
		height = maxHeight - 1
		if speed > 0 then
			speed = 0
		end
	end

	height = height + speed
	if height - speed < centerHeight then
		speed = speed - accel
	elseif height - speed > centerHeight then
		speed = speed + accel
	end

	if height <= minHeight then
		height = minHeight
		if speed < 0 then
			speed = 0
		end
	elseif height >= maxHeight then
		height = maxHeight - 1
		if speed > 0 then
			speed = 0
		end
	end
	if ((minHeight > 0 and bit32.band(special, 0x1) == 0x0) or ((height > minHeight) and (height < maxHeight - 1))) and not (EEex_IsFlying(targetID)) then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 176,
["target"] = 2,
["timing"] = 3,
["parameter2"] = 1,
["duration"] = 0,
["parent_resource"] = parent_resource,
["source_target"] = targetID,
["source_id"] = sourceID
})
	end
	EEex_WriteWord(creatureData + 0x618, height)
	EEex_WriteWord(creatureData + 0x61A, speed)

	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 325,
["target"] = 2,
["timing"] = 3,
["duration"] = 0,
["source_target"] = targetID,
["source_id"] = sourceID
})
	local visualHeight = -math.ceil(height / 2)
	if visualHeight > 0 or visualHeight == -0 then
		visualHeight = 0
	end

	EEex_WriteDword(creatureData + 0x10, visualHeight)
	EEex_WriteDword(creatureData + 0x2D00, 0)
	EEex_WriteDword(effectData + 0x110, 0x1)
	if duration == time_applied and not firstIteration then
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 402,
["target"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["parameter1"] = parameter1,
["parameter2"] = parameter2,
["parameter3"] = parameter3,
["parameter4"] = parameter4,
["resource"] = "MEHGTMOD",
["special"] = special,
["casterlvl"] = casterlvl,
["parent_resource"] = parent_resource,
["source_target"] = targetID,
["source_id"] = sourceID
})
	else
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 402,
["target"] = 2,
["timing"] = 3,
["parameter1"] = parameter1,
["parameter2"] = parameter2,
["parameter3"] = parameter3,
["parameter4"] = parameter4,
["resource"] = "MEHGTMOD",
["special"] = special,
["casterlvl"] = casterlvl,
["parent_resource"] = parent_resource,
["source_target"] = targetID,
["source_id"] = sourceID
})
	end
end

function METEST(effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	EEex_WriteDword(effectData + 0x110, 0x1)

	local currentTick = EEex_GetGameTick()
	local targetTick = currentTick + 1

	Infinity_DisplayString("Tick: "..currentTick)
	EEex_WriteDword(creatureData + 0x10, -500)
--[[
	EEex_ApplyEffectToActor(targetID, {
["opcode"] = 402,
["target"] = 2,
["timing"] = 6,
["duration"] = targetTick,
["resource"] = "METEST",
["parent_resource"] = "METEST",
["source_target"] = targetID,
["source_id"] = targetID
})
--]]
end


function MEGRVGLB(effectData, creatureData)
	EEex_WriteDword(effectData + 0x110, 0x1)
	local me_grvglb_radius = 500
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local casterlvl = EEex_ReadDword(effectData + 0xC4)
	local targetX = EEex_ReadDword(creatureData + 0x8)
	local targetY = EEex_ReadDword(creatureData + 0xC)
	local centerX = EEex_ReadDword(effectData + 0x84)
	local centerY = EEex_ReadDword(effectData + 0x88)
	local horizontalDistance = math.floor((((targetX - centerX) ^ 2) + (((targetY - centerY) * 1.5) ^ 2)) ^ .5)
	if horizontalDistance > me_grvglb_radius then
		horizontalDistance = me_grvglb_radius
	end
--	Infinity_DisplayString(EEex_GetActorName(targetID) .. ": " .. horizontalDistance)
	local globeYRadius = math.floor(((me_grvglb_radius ^ 2) - (horizontalDistance ^ 2)) ^ .5)
	local globeHeight = globeYRadius + me_grvglb_radius * .8
	local globeBottom = me_grvglb_radius * .8 - globeYRadius

	local height = EEex_ReadSignedWord(creatureData + 0x618, 0x0) + EEex_GetActorStat(targetID, 641)
--	Infinity_DisplayString(EEex_GetActorName(targetID) .. "-> globeHeight: " .. globeHeight .. "; globeBottom: " .. globeBottom .. "; fullHeight: " .. fullHeight)
	if height <= globeHeight and height >= globeBottom then

		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 9,
["resource"] = "MEGRVGLB",
["parent_resource"] = parent_resource,
["source_target"] = targetID,
["source_id"] = sourceID
})

		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 401,
["target"] = 2,
["timing"] = 10,
["duration"] = 12,
["parameter1"] = globeHeight,
["parameter2"] = 1,
["special"] = 649,
["parent_resource"] = "MEGRVGLB",
["source_target"] = targetID,
["source_id"] = sourceID
})
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 401,
["target"] = 2,
["timing"] = 10,
["duration"] = 12,
["parameter1"] = 1,
["parameter2"] = 1,
["special"] = 647,
["parent_resource"] = "MEGRVGLB",
["source_target"] = targetID,
["source_id"] = sourceID
})
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 401,
["target"] = 2,
["timing"] = 10,
["duration"] = 12,
["parameter1"] = 30000,
["parameter2"] = 1,
["special"] = 648,
["parent_resource"] = "MEGRVGLB",
["source_target"] = targetID,
["source_id"] = sourceID
})
--[[
		if height >= 100 then
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 184,
["target"] = 2,
["timing"] = 10,
["duration"] = 8,
["parameter2"] = 1,
["special"] = 649,
["parent_resource"] = "MEGRVGLB",
["source_target"] = targetID,
["source_id"] = targetID
})
		end
--]]
--[[
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 407,
["target"] = 2,
["parameter1"] = casterlvl,
["parameter2"] = 2,
["timing"] = 10,
["duration"] = 1,
["resource"] = "MEGRVGLB",
["casterlvl"] = casterlvl,
["parent_resource"] = "MEGRVGLB",
["source_target"] = targetID,
["source_id"] = sourceID
})
--]]
--[[
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["parameter1"] = casterlvl,
["parameter2"] = 2,
["timing"] = 9,
["duration"] = 1,
["resource"] = "MEGRVGLB",
["casterlvl"] = casterlvl,
["parent_resource"] = "MEGRVGLA",
["source_target"] = targetID,
["source_id"] = targetID
})
--]]
		if EEex_GetActorStat(targetID, 636) == 0 then
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 401,
["target"] = 2,
["timing"] = 1,
["duration"] = 12,
["parameter1"] = 1,
["parameter2"] = 1,
["special"] = 636,
["parent_resource"] = "MEGRVGLC",
["source_target"] = targetID,
["source_id"] = sourceID
})
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 235,
["target"] = 2,
["timing"] = 6,
["duration"] = EEex_GetGameTick() + 1,
["parameter1"] = EEex_GetActorMovementRate(targetID, false),
["parameter2"] = 1,
["parent_resource"] = "MEGRVGLC",
["target_x"] = EEex_ReadDword(EEex_GetActorShare(targetID) + 0x8),
["target_y"] = EEex_ReadDword(EEex_GetActorShare(targetID) + 0xC),
["source_target"] = targetID,
["source_id"] = sourceID
})
			EEex_ApplyEffectToActor(targetID, {
["opcode"] = 402,
["target"] = 2,
["timing"] = 3,
--["duration"] = EEex_GetGameTick() + 1,
["parameter1"] = globeHeight,
["parameter2"] = 1,
["special"] = 2,
["resource"] = "MEHGTMOD",
["parent_resource"] = "MEGRVGLC",
["source_target"] = targetID,
["source_id"] = sourceID
})
		end
--[[
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 4,
["duration"] = 1,
["resource"] = "MEGRVGLB",
["parent_resource"] = "MEGRVGLB",
["source_target"] = targetID,
["source_id"] = targetID
})
--]]
	end
end

function MELOOPST(effectData, creatureData)
--	Infinity_DisplayString("ugu")
--	EEex_WriteDword(effectData + 0x110, 0x1)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	if (sourceID == 0 or sourceID == -1) then
		
		local parameter1 = EEex_ReadDword(effectData + 0x18)
		local parameter2 = EEex_ReadDword(effectData + 0x1C)
		local parameter3 = EEex_ReadDword(effectData + 0x5C)
		local parameter4 = EEex_ReadDword(effectData + 0x60)
		local special = EEex_ReadDword(effectData + 0x44)
		local vvcresource = EEex_ReadLString(effectData + 0x6C, 8)
		local parent_resource = EEex_ReadLString(effectData + 0x90, 8)
		local casterlvl = EEex_ReadDword(effectData + 0xC4)
		local targetID = EEex_ReadDword(creatureData + 0x34)
		EEex_AlterActorEffect(targetID,{{"opcode",402}, {"resource","LOOPST"}, {"parameter1",parameter1}, {"parameter2",parameter2}, {"parameter3",parameter3}, {"parameter4",parameter4}, {"special",special}}, {{"source_id",targetID}},1)
		local height = EEex_ReadSignedWord(creatureData + 0x618, 0x0)
		local speed = EEex_ReadSignedWord(creatureData + 0x61A, 0x0)
		local accel = EEex_ReadSignedWord(creatureData + 0x61C, 0x0)
		local minHeight = EEex_ReadSignedWord(creatureData + 0x61E, 0x0)
		local maxHeight = EEex_ReadSignedWord(creatureData + 0x620, 0x0)
		if minHeight < 0 then
			minHeight = 0
		end
		if maxHeight == -1 or maxHeight >= me_highestheightnumber then
			maxHeight = me_highestheightnumber - 1
		end
--		Infinity_DisplayString("height: " .. height)
--		Infinity_DisplayString("speed: " .. speed)
--		Infinity_DisplayString("accel: " .. accel)
		height = height + speed
		speed = speed + accel
		EEex_WriteWord(creatureData + 0x618, height)
		EEex_WriteWord(creatureData + 0x61A, speed)
		if height <= minHeight then
			height = minHeight
			EEex_WriteWord(creatureData + 0x618, minHeight)
			if speed <= 0 then
				speed = 0
				EEex_WriteWord(creatureData + 0x61A, 0)
			end
		elseif height > maxHeight then
			height = maxHeight
			if maxHeight <= me_highestheightnumber then
				EEex_WriteWord(creatureData + 0x618, maxHeight)
			end
		end
		local animation = EEex_GetActorAnimation(targetID)
	--	Infinity_DisplayString(me_heighttoanimation[height])
--	EEex_WriteDword(effectData + 0x110, 0x1)
		if me_heighttoanimation[height] == nil then return end
		EEex_ApplyEffectToActor(targetID, {
	["opcode"] = 53,
	["target"] = 2,
	["parameter1"] = me_heighttoanimation[height],
	["timing"] = 0,
	["parent_resource"] = parent_resource,
	["source_target"] = targetID,
	["source_id"] = sourceID
	})
		EEex_Call(EEex_Label("CGameSprite::Shatter"), {0x2}, creatureData, 0x0)
		EEex_ApplyEffectToActor(targetID, {
	["opcode"] = 53,
	["target"] = 2,
	["parameter1"] = animation,
	["timing"] = 0,
	["parent_resource"] = parent_resource,
	["source_target"] = targetID,
	["source_id"] = sourceID
	})
--	Infinity_DisplayString("ogo")

		EEex_IterateActorEffects(targetID, function(eData)
			local the_opcode = EEex_ReadDword(eData + 0x10)
			local the_timing = EEex_ReadDword(eData + 0x24)
			if the_opcode == 7 and the_timing == 2 then
				EEex_ApplyEffectToActor(targetID, {
	["opcode"] = 7,
	["target"] = 2,
	["parameter1"] = EEex_ReadDword(eData + 0x1C),
	["parameter2"] = EEex_ReadDword(eData + 0x20),
	["timing"] = 0,
	["duration"] = 0,
	["parent_resource"] = "MECLRFIX",
	["sourceslot"] = EEex_ReadDword(eData + 0xA4),
	["source_target"] = targetID,
	["source_id"] = targetID
	})
			end
		end)
--[[
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 407,
["target"] = 2,
["timing"] = 10,
["duration"] = 1,
["parameter1"] = casterlvl,
["parameter2"] = 2,
["resource"] = parent_resource,
["casterlvl"] = casterlvl,
["source_target"] = targetID,
["source_id"] = targetID
})
--]]
--[[
		EEex_ApplyEffectToActor(targetID, {
["opcode"] = 402,
["target"] = 2,
["timing"] = 3,
["duration"] = 0,
["parameter1"] = parameter1,
["parameter2"] = parameter2,
["parameter3"] = parameter3,
["parameter4"] = parameter4,
["resource"] = vvcresource,
["special"] = special,
["casterlvl"] = casterlvl,
["parent_resource"] = parent_resource,
["source_target"] = targetID,
["source_id"] = targetID
})
--]]
	end
end
--[[
To use the MESTONES function, create an opcode 403 effect, set the resource to MESTONES (all capitals), and choose parameters.

It serves like the Stoneskin opcode, except more versitile.

By default, when the last skin is removed, it will automatically remove all effects of the spell or ability that had
 included the opcode 403 effect. This way, you can include other effects that will last as long as there are skins remaining.

parameter1 - Determines how many skins there are (how many instances of damage will be blocked). If parameter1 is
 set to 65535, then the effect will block an infinite number of damage instances.

parameter2 - Determines which damage types are blocked. The number for each damage type is the same as in DAMAGES.IDS,
 with one exception: crushing damage is 0x4000. If you want to block multiple damage types, add the numbers for each
 damage type. For example, if you want the skins to block slashing, piercing, crushing, missile, and nonlethal damage,
 set parameter2 to 0x4990 (0x100 + 0x10 + 0x4000 + 0x80 + 0x800)

special - Bit flags for the effect.
Bit 0: If set, when the last skin is removed, it will not automatically remove all effects of the source spell.
Bit 1: If set, when the last skin is removed, it will cast a spell on the creature. The spell resref is specified
 by resource2 (in an EFF file). If you aren't using this from an EFF file, then the spell resref is set to the
 resref of the source spell, with an E added at the end.
Bit 2: If set, whenever a skin is removed, it will cast a spell on the source of the damage. The spell resref is specified
 by resource3 (in an EFF file). If you aren't using this from an EFF file, then the spell resref is set to the
 resref of the source spell, with an F added at the end.

If you want to make a specific damage effect bypass the MESTONES effect without removing a skin, set bit 20 of the
 special field in the damage effect. This can't be done with base weapon damage, unfortunately.
--]]
function MESTONES(originatingEffectData, effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local opcode = EEex_ReadDword(effectData + 0xC)
	if opcode ~= 12 then return false end
	local special = EEex_ReadDword(effectData + 0x44)
	if bit32.band(special, 0x100000) > 0 then return false end
	local skins_left = EEex_ReadDword(originatingEffectData + 0x18)
	if skins_left <= 0 then return false end
	local types_blocked = EEex_ReadDword(originatingEffectData + 0x1C)
	local flags = EEex_ReadDword(originatingEffectData + 0x44)
	local parent_resource = EEex_ReadLString(originatingEffectData + 0x90, 8)
	local damage_type = EEex_ReadWord(effectData + 0x1E, 0x0)
	local casterlvl = EEex_ReadDword(originatingEffectData + 0xC4)
	if (damage_type == 0 and bit32.band(types_blocked, 0x4000) > 0) or (damage_type ~= 0 and bit32.band(types_blocked, damage_type) > 0) then
		if bit32.band(flags, 0x4) > 0 then
			local hit_spell = EEex_ReadLString(originatingEffectData + 0x74, 8)
			if hit_spell == "" then
				hit_spell = parent_resource .. "F"
			end
			local damagerID = EEex_ReadDword(effectData + 0x10C)
			if EEex_IsSprite(damagerID) then
				EEex_ApplyEffectToActor(damagerID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 9,
["parameter1"] = casterlvl,
["parameter2"] = 2,
["resource"] = hit_spell,
["source_target"] = damagerID,
["source_id"] = targetID
})
			end
		end
		if skins_left ~= 65535 then
			skins_left = skins_left - 1
		end
		EEex_WriteDword(originatingEffectData + 0x18, skins_left)
		if skins_left <= 0 then
			EEex_WriteDword(originatingEffectData + 0x110, 0x1)
			if bit32.band(flags, 0x1) == 0 then
				EEex_ApplyEffectToActor(targetID, {
["opcode"] = 321,
["target"] = 2,
["timing"] = 9,
["resource"] = parent_resource,
["source_target"] = targetID,
["source_id"] = targetID
})
			end
			if bit32.band(flags, 0x2) > 0 then
				local end_spell = EEex_ReadLString(originatingEffectData + 0x6C, 8)
				if end_spell == "" then
					end_spell = parent_resource .. "E"
				end
				EEex_ApplyEffectToActor(targetID, {
["opcode"] = 146,
["target"] = 2,
["timing"] = 9,
["parameter1"] = casterlvl,
["parameter2"] = 2,
["resource"] = end_spell,
["source_target"] = targetID,
["source_id"] = targetID
})
			end
		end
		return true
	end
	return false
end

function MEMODDTP(originatingEffectData, effectData, creatureData)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local opcode = EEex_ReadDword(effectData + 0xC)
	if opcode ~= 12 then return false end
	local special = EEex_ReadDword(effectData + 0x44)
	if bit32.band(special, 0x100000) > 0 then return false end
	local damage_type = EEex_ReadWord(effectData + 0x1E, 0x0)
	local types_checked = EEex_ReadWord(originatingEffectData + 0x1C, 0x0)
	local new_damage_type = EEex_ReadWord(originatingEffectData + 0x1E, 0x0)
	if (damage_type == 0 and bit32.band(types_checked, 0x4000) > 0) or (damage_type ~= 0 and bit32.band(types_checked, damage_type) > 0) then
		EEex_WriteWord(effectData + 0x1E, new_damage_type)
	end
	return false
end

function MERANDSP(effectData, creatureData)
	EEex_WriteDword(effectData + 0x110, 0x1)
	local targetID = EEex_ReadDword(creatureData + 0x34)
	local sourceID = EEex_ReadDword(effectData + 0x10C)
	local spellRES = EEex_ReadLString(effectData + 0x18, 8)
	local casterlvl = EEex_ReadDword(effectData + 0xC4)
	local maxradius = EEex_ReadDword(effectData + 0x44)
	local targetX = EEex_ReadDword(creatureData + 0x8)
	local targetY = EEex_ReadDword(creatureData + 0xC)
	local sourceX = EEex_ReadDword(effectData + 0x84)
	local sourceY = EEex_ReadDword(effectData + 0x88)
	local deltaX = math.random(maxradius * 2 + 1) - maxradius - 1
	local deltaY = math.random(maxradius * 2 + 1) - maxradius - 1
	while math.floor((deltaX ^ 2 + deltaY ^ 2) ^ .5) > maxradius do
		deltaX = math.random(maxradius * 2 + 1) - maxradius - 1
		deltaY = math.random(maxradius * 2 + 1) - maxradius - 1
	end
		EEex_ApplyEffectToActor(sourceID, {
["opcode"] = 148,
["target"] = 2,
["timing"] = 9,
["parameter1"] = casterlvl,
["parameter2"] = 2,
["resource"] = spellRES,
["casterlvl"] = casterlvl,
["source_target"] = targetID,
["source_id"] = sourceID,
["source_x"] = sourceX,
["source_y"] = sourceY,
["target_x"] = targetX + deltaX,
["target_y"] = targetY + deltaY
})

end